var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var platform=createCommonjsModule(function(a,s){!function(){var N={function:!0,object:!0}[typeof window]&&window||this,n=s,e=a&&!a.nodeType&&a,t=n&&e&&"object"==typeof commonjsGlobal&&commonjsGlobal;!t||t.global!==t&&t.window!==t&&t.self!==t||(N=t);var i=Math.pow(2,53)-1,I=/\bOpera/,t=Object.prototype,r=t.hasOwnProperty,O=t.toString;function o(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function D(e){return e=B(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:o(e)}function M(e,t){for(var n in e)r.call(e,n)&&t(e[n],n,e)}function P(e){return null==e?o(e):O.call(e).slice(8,-1)}function F(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function L(n,r){var o=null;return function(e,t){var n=-1,r=e?e.length:0;if("number"==typeof r&&-1<r&&r<=i)for(;++n<r;)t(e[n],n,e);else M(e,t)}(n,function(e,t){o=r(o,e,t,n)}),o}function B(e){return String(e).replace(/^ +| +$/g,"")}function W(i){var t=N,e=i&&"object"==typeof i&&"String"!=P(i);e&&(t=i,i=null);var n=t.navigator||{},r=n.userAgent||"";i=i||r;var o,a,s=e?!!n.likeChrome:/\bChrome\b/.test(i)&&!/internal|\n/i.test(O.toString()),u="Object",c=e?u:"ScriptBridgingProxyObject",l=e?u:"Environment",h=e&&t.java?"JavaPackage":P(t.java),d=e?u:"RuntimeObject",p=/\bJava/.test(h)&&t.java,f=p&&P(t.environment)==l,m=p?"a":"α",g=p?"b":"β",v=t.document||{},b=t.operamini||t.opera,y=I.test(y=e&&b?b["[[Class]]"]:P(b))?y:b=null,x=i,w=[],C=null,E=i==r,_=E&&b&&"function"==typeof b.version&&b.version(),S=L([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,t){return e||RegExp("\\b"+(t.pattern||F(t))+"\\b","i").exec(i)&&(t.label||t)}),R=L(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"],function(e,t){return e||RegExp("\\b"+(t.pattern||F(t))+"\\b","i").exec(i)&&(t.label||t)}),T=A([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),u=L({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}},function(e,t,n){return e||(t[T]||t[/^[a-z]+(?: +[a-z]+\b)*/i.exec(T)]||RegExp("\\b"+F(n)+"(?:\\b|\\w*\\d)","i").exec(i))&&n}),h=L(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "],function(e,t){var n,r,o=t.pattern||F(t);return!e&&(e=RegExp("\\b"+o+"(?:/[\\d.]+|[ \\w.]*)","i").exec(i))&&(n=e,r=o,o=t.label||t,t={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"},r&&o&&/^Win/i.test(n)&&!/^Windows Phone /i.test(n)&&(t=t[/[\d.]+$/.exec(n)])&&(n="Windows "+t),n=String(n),e=n=D((n=r&&o?n.replace(RegExp(r,"i"),o):n).replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])),e});function A(e){return L(e,function(e,t){var n=t.pattern||F(t);return!e&&(e=RegExp("\\b"+n+" *\\d+[.\\w_]*","i").exec(i)||RegExp("\\b"+n+" *\\w+-[\\w]*","i").exec(i)||RegExp("\\b"+n+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(i))&&((e=String(t.label&&!RegExp(n,"i").test(t.label)?t.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),t=t.label||t,e=D(e[0].replace(RegExp(n,"i"),t).replace(RegExp("; *(?:"+t+"[_-])?","i")," ").replace(RegExp("("+t+")[-_.]?(\\w)","i"),"$1 $2"))),e})}function k(e){return L(e,function(e,t){return e||(RegExp(t+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(i)||0)[1]||null})}if(S=S&&[S],/\bAndroid\b/.test(h)&&!T&&(o=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(i))&&(T=B(o[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),u&&!T?T=A([u]):u&&T&&(T=T.replace(RegExp("^("+F(u)+")[-_.\\s]","i"),u+" ").replace(RegExp("^("+F(u)+")[-_.]?(\\w)","i"),u+" $2")),(o=/\bGoogle TV\b/.exec(T))&&(T=o[0]),/\bSimulator\b/i.test(i)&&(T=(T?T+" ":"")+"Simulator"),"Opera Mini"==R&&/\bOPiOS\b/.test(i)&&w.push("running in Turbo/Uncompressed mode"),"IE"==R&&/\blike iPhone OS\b/.test(i)?(u=(o=W(i.replace(/like iPhone OS/,""))).manufacturer,T=o.product):/^iP/.test(T)?(R=R||"Safari",h="iOS"+((o=/ OS ([\d_]+)/i.exec(i))?" "+o[1].replace(/_/g,"."):"")):"Konqueror"==R&&/^Linux\b/i.test(h)?h="Kubuntu":u&&"Google"!=u&&(/Chrome/.test(R)&&!/\bMobile Safari\b/i.test(i)||/\bVita\b/.test(T))||/\bAndroid\b/.test(h)&&/^Chrome/.test(R)&&/\bVersion\//i.test(i)?(R="Android Browser",h=/\bAndroid\b/.test(h)?h:"Android"):"Silk"==R?(/\bMobi/i.test(i)||(h="Android",w.unshift("desktop mode")),/Accelerated *= *true/i.test(i)&&w.unshift("accelerated")):"UC Browser"==R&&/\bUCWEB\b/.test(i)?w.push("speed mode"):"PaleMoon"==R&&(o=/\bFirefox\/([\d.]+)\b/.exec(i))?w.push("identifying as Firefox "+o[1]):"Firefox"==R&&(o=/\b(Mobile|Tablet|TV)\b/i.exec(i))?(h=h||"Firefox OS",T=T||o[1]):!R||(o=!/\bMinefield\b/i.test(i)&&/\b(?:Firefox|Safari)\b/.exec(R))?(R&&!T&&/[\/,]|^[^(]+?\)/.test(i.slice(i.indexOf(o+"/")+8))&&(R=null),(o=T||u||h)&&(T||u||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(h))&&(R=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(h)?h:o)+" Browser")):"Electron"==R&&(o=(/\bChrome\/([\d.]+)\b/.exec(i)||0)[1])&&w.push("Chromium "+o),_=_||k(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",F(R),"(?:Firefox|Minefield|NetFront)"]),(o=("iCab"==S&&3<parseFloat(_)?"WebKit":/\bOpera\b/.test(R)&&(/\bOPR\b/.test(i)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(i)&&!/^(?:Trident|EdgeHTML)$/.test(S)&&"WebKit"||!S&&/\bMSIE\b/i.test(i)&&("Mac OS"==h?"Tasman":"Trident")||"WebKit"==S&&/\bPlayStation\b(?! Vita\b)/i.test(R)&&"NetFront")&&(S=[o]),"IE"==R&&(o=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(i)||0)[1])?(R+=" Mobile",h="Windows Phone "+(/\+$/.test(o)?o:o+".x"),w.unshift("desktop mode")):/\bWPDesktop\b/i.test(i)?(R="IE Mobile",h="Windows Phone 8.x",w.unshift("desktop mode"),_=_||(/\brv:([\d.]+)/.exec(i)||0)[1]):"IE"!=R&&"Trident"==S&&(o=/\brv:([\d.]+)/.exec(i))&&(R&&w.push("identifying as "+R+(_?" "+_:"")),R="IE",_=o[1]),E){if(l="global",r=null!=(e=t)?typeof e[l]:"number",/^(?:boolean|number|string|undefined)$/.test(r)||"object"==r&&!e[l])P(o=t.runtime)==c?(R="Adobe AIR",h=o.flash.system.Capabilities.os):P(o=t.phantom)==d?(R="PhantomJS",_=(o=o.version||null)&&o.major+"."+o.minor+"."+o.patch):"number"==typeof v.documentMode&&(o=/\bTrident\/(\d+)/i.exec(i))?(_=[_,v.documentMode],(o=+o[1]+4)!=_[1]&&(w.push("IE "+_[1]+" mode"),S&&(S[1]=""),_[1]=o),_="IE"==R?String(_[1].toFixed(1)):_[0]):"number"==typeof v.documentMode&&/^(?:Chrome|Firefox)\b/.test(R)&&(w.push("masking as "+R+" "+_),R="IE",_="11.0",S=["Trident"],h="Windows");else if(p&&(x=(o=p.lang.System).getProperty("os.arch"),h=h||o.getProperty("os.name")+" "+o.getProperty("os.version")),f){try{_=t.require("ringo/engine").version.join("."),R="RingoJS"}catch(e){(o=t.system)&&o.global.system==t.system&&(R="Narwhal",h=h||(o[0].os||null))}R=R||"Rhino"}else"object"==typeof t.process&&!t.process.browser&&(o=t.process)&&("object"==typeof o.versions&&("string"==typeof o.versions.electron?(w.push("Node "+o.versions.node),R="Electron",_=o.versions.electron):"string"==typeof o.versions.nw&&(w.push("Chromium "+_,"Node "+o.versions.node),R="NW.js",_=o.versions.nw)),R||(R="Node.js",x=o.arch,h=o.platform,_=(_=/[\d.]+/.exec(o.version))?_[0]:null));h=h&&D(h)}if(_&&(o=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(_)||/(?:alpha|beta)(?: ?\d)?/i.exec(i+";"+(E&&n.appMinorVersion))||/\bMinefield\b/i.test(i)&&"a")&&(C=/b/i.test(o)?"beta":"alpha",_=_.replace(RegExp(o+"\\+?$"),"")+("beta"==C?g:m)+(/\d+\+?/.exec(o)||"")),"Fennec"==R||"Firefox"==R&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(h))R="Firefox Mobile";else if("Maxthon"==R&&_)_=_.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(T))"Xbox 360"==T&&(h=null),"Xbox 360"==T&&/\bIEMobile\b/.test(i)&&w.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(R)&&(!R||T||/Browser|Mobi/.test(R))||"Windows CE"!=h&&!/Mobi/i.test(i))if("IE"==R&&E)try{null===t.external&&w.unshift("platform preview")}catch(e){w.unshift("embedded")}else(/\bBlackBerry\b/.test(T)||/\bBB10\b/.test(i))&&(o=(RegExp(T.replace(/ +/g," *")+"/([.\\d]+)","i").exec(i)||0)[1]||_)?(h=((o=[o,/BB10/.test(i)])[1]?(T=null,u="BlackBerry"):"Device Software")+" "+o[0],_=null):this!=M&&"Wii"!=T&&(E&&b||/Opera/.test(R)&&/\b(?:MSIE|Firefox)\b/i.test(i)||"Firefox"==R&&/\bOS X (?:\d+\.){2,}/.test(h)||"IE"==R&&(h&&!/^Win/.test(h)&&5.5<_||/\bWindows XP\b/.test(h)&&8<_||8==_&&!/\bTrident\b/.test(i)))&&!I.test(o=W.call(M,i.replace(I,"")+";"))&&o.name&&(o="ing as "+o.name+((o=o.version)?" "+o:""),I.test(R)?(/\bIE\b/.test(o)&&"Mac OS"==h&&(h=null),o="identify"+o):(o="mask"+o,R=y?D(y.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(o)&&(h=null),E||(_=null)),S=["Presto"],w.push(o));else R+=" Mobile";(o=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(i)||0)[1])&&(o=[parseFloat(o.replace(/\.(\d)$/,".0$1")),o],"Safari"==R&&"+"==o[1].slice(-1)?(R="WebKit Nightly",C="alpha",_=o[1].slice(0,-1)):_!=o[1]&&_!=(o[2]=(/\bSafari\/([\d.]+\+?)/i.exec(i)||0)[1])||(_=null),o[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(i)||0)[1],537.36==o[0]&&537.36==o[2]&&28<=parseFloat(o[1])&&"WebKit"==S&&(S=["Blink"]),o=E&&(s||o[1])?(S&&(S[1]="like Chrome"),o[1]||((o=o[0])<530?1:o<532?2:o<532.05?3:o<533?4:o<534.03?5:o<534.07?6:o<534.1?7:o<534.13?8:o<534.16?9:o<534.24?10:o<534.3?11:o<535.01?12:o<535.02?"13+":o<535.07?15:o<535.11?16:o<535.19?17:o<536.05?18:o<536.1?19:o<537.01?20:o<537.11?"21+":o<537.13?23:o<537.18?24:o<537.24?25:o<537.36?26:"Blink"!=S?"27":"28")):(S&&(S[1]="like Safari"),(o=o[0])<400?1:o<500?2:o<526?3:o<533?4:o<534?"4+":o<535?5:o<537?6:o<538?7:o<601?8:o<602?9:o<604?10:o<606?11:o<608?12:"12"),S&&(S[1]+=" "+(o+="number"==typeof o?".x":/[.+]/.test(o)?"":"+")),"Safari"==R&&(!_||45<parseInt(_))?_=o:"Chrome"==R&&/\bHeadlessChrome/i.test(i)&&w.unshift("headless")),"Opera"==R&&(o=/\bzbov|zvav$/.exec(h))?(R+=" ",w.unshift("desktop mode"),"zvav"==o?(R+="Mini",_=null):R+="Mobile",h=h.replace(RegExp(" *"+o+"$"),"")):"Safari"==R&&/\bChrome\b/.exec(S&&S[1])?(w.unshift("desktop mode"),R="Chrome Mobile",_=null,h=/\bOS X\b/.test(h)?(u="Apple","iOS 4.3+"):null):/\bSRWare Iron\b/.test(R)&&!_&&(_=k("Chrome")),(h=_&&0==_.indexOf(o=/[\d.]+$/.exec(h))&&-1<i.indexOf("/"+o+"-")?B(h.replace(o,"")):h)&&-1!=h.indexOf(R)&&!RegExp(R+" OS").test(h)&&(h=h.replace(RegExp(" *"+F(R)+" *"),"")),S&&!/\b(?:Avant|Nook)\b/.test(R)&&(/Browser|Lunascape|Maxthon/.test(R)||"Safari"!=R&&/^iOS/.test(h)&&/\bSafari\b/.test(S[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(R)&&S[1])&&(o=S[S.length-1])&&w.push(o),w.length&&(w=["("+w.join("; ")+")"]),u&&T&&T.indexOf(u)<0&&w.push("on "+u),T&&w.push((/^on /.test(w[w.length-1])?"":"on ")+T),h&&(o=/ ([\d.+]+)$/.exec(h),a=o&&"/"==h.charAt(h.length-o[0].length-1),h={architecture:32,family:o&&!a?h.replace(o[0],""):h,version:o?o[1]:null,toString:function(){var e=this.version;return this.family+(e&&!a?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(o=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(x))&&!/\bi686\b/i.test(x)?(h&&(h.architecture=64,h.family=h.family.replace(RegExp(" *"+o),"")),R&&(/\bWOW64\b/i.test(i)||E&&/\w(?:86|32)$/.test(n.cpuClass||n.platform)&&!/\bWin64; x64\b/i.test(i))&&w.unshift("32-bit")):h&&/^OS X/.test(h.family)&&"Chrome"==R&&39<=parseFloat(_)&&(h.architecture=64),i=i||null;n={};return n.description=i,n.layout=S&&S[0],n.manufacturer=u,n.name=R,n.prerelease=C,n.product=T,n.ua=i,n.version=R&&_,n.os=h||{architecture:null,family:null,version:null,toString:function(){return"null"}},n.parse=W,n.toString=function(){return this.description||""},n.version&&w.unshift(_),n.name&&w.unshift(R),h&&R&&(h!=String(h).split(" ")[0]||h!=R.split(" ")[0]&&!T)&&w.push(T?"("+h+")":"on "+h),w.length&&(n.description=w.join(" ")),n}t=W();n&&e?M(t,function(e,t){n[t]=e}):N.platform=t}.call(commonjsGlobal)}),t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};function e(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function n(i,a,s,u){return new(s=s||Promise)(function(e,t){function n(e){try{o(u.next(e))}catch(e){t(e)}}function r(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,r)}o((u=u.apply(i,a||[])).next())})}function r(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var o=(N1.prototype.setPlatform=function(e,t){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+t+"."),this.platformName=e,this.platform=t},N1.prototype.registerFlag=function(e,t,n){this.flagRegistry[e]={evaluationFn:t,setHook:n},null!=this.urlFlags[e]&&(n=this.urlFlags[e],console.warn("Setting feature override from URL "+e+": "+n+"."),this.set(e,n))},N1.prototype.get=function(e){return e in this.flags||(this.flags[e]=this.evaluateFlag(e)),this.flags[e]},N1.prototype.getNumber=function(e){return this.get(e)},N1.prototype.getBool=function(e){return this.get(e)},N1.prototype.getFlags=function(){return this.flags},Object.defineProperty(N1.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),N1.prototype.set=function(e,t){if(null==this.flagRegistry[e])throw new Error("Cannot set flag "+e+" as it has not been registered.");this.flags[e]=t,null!=this.flagRegistry[e].setHook&&this.flagRegistry[e].setHook(t)},N1.prototype.evaluateFlag=function(e){if(null==this.flagRegistry[e])throw new Error("Cannot evaluate flag '"+e+"': no evaluation function found.");return this.flagRegistry[e].evaluationFn()},N1.prototype.setFlags=function(e){this.flags=Object.assign({},e)},N1.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},N1.prototype.populateURLFlags=function(){var r,e,n=this;void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search&&(e=this.global.location.search,r={},e.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return a(r,t[0],t[1]),t.join("=")}),"tfjsflags"in(e=r)&&e.tfjsflags.split(",").forEach(function(e){var t=e.split(":"),e=t[0],t=t[1];n.urlFlags[e]=function(e,t){if("true"===(t=t.toLowerCase())||"false"===t)return"true"===t;if(""+ +t===t)return+t;throw new Error("Could not parse value flag value "+t+" for flag "+e+".")}(e,t)}))},N1);function N1(e){this.global=e,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}function a(e,t,n){e[decodeURIComponent(t)]=decodeURIComponent(n||"")}function i(){return s}var s=null,u=new Map,c=new Map;function l(e,t){t=g(e,t);return u.get(t)}function h(e){return c.get(e)}function f(e){for(var t=u.entries(),n=[];;){var r=t.next(),o=r.done,r=r.value;if(o)break;o=r[0],r=r[1];o.split("_")[0]===e&&n.push(r)}return n}function d(e){var t=e.kernelName,n=e.backendName,r=g(t,n);if(u.has(r))throw new Error("The kernel '"+t+"' for backend '"+n+"' is already registered");u.set(r,e)}function p(e){var t=e.kernelName;c.has(t)&&console.warn("Overriding the gradient for '"+t+"'"),c.set(t,e)}function g(e,t){return t+"_"+e}function y(e){for(var t,n,r=e.length;0<r;)n=Math.random()*r|0,t=e[--r],e[r]=e[n],e[n]=t}function x(e,t,n){return Math.max(e,Math.min(t,n))}function b(e){return e%2==0?e:e+1}function w(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];return t}function C(e,t){if(!e)throw new Error("string"==typeof t?t:t())}function E(e,t,n){void 0===n&&(n=""),C(S(e,t),function(){return n+" Shapes "+e+" and "+t+" must match"})}function R(e){C(null!=e,function(){return"The input to the tensor constructor must be a non-null value."})}function I(e,t,n){if(void 0===n&&(n=!1),null==(t=void 0===t?[]:t)&&(t=[]),Array.isArray(e)||V(e)&&!n)for(var r=0;r<e.length;++r)I(e[r],t,n);else t.push(e);return t}function k(e){if(0===e.length)return 1;for(var t=e[0],n=1;n<e.length;n++)t*=e[n];return t}function S(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function A(e){return e%1==0}function D(e){if(null!=Math.tanh)return Math.tanh(e);if(e===1/0)return 1;if(e===-1/0)return-1;e=Math.exp(2*e);return(e-1)/(e+1)}function T(e){var t=Math.ceil(Math.sqrt(e));return[t,Math.ceil(e/t)]}function N(e,t){return t<=e.length?e:e+" ".repeat(t-e.length)}function F(i,a,s){return void 0===a&&(a=function(e){return 0}),new Promise(function(t,n){var r=0,o=function(){var e;i()?t():(e=a(++r),null!=s&&s<=r?n():setTimeout(o,e))};o()})}function _(e,t){for(var n=1,r=-1,o=0;o<e.length;++o)if(0<=e[o])n*=e[o];else if(-1===e[o]){if(-1!==r)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+r+" and dim "+o);r=o}else if(e[o]<0)throw Error("Shapes can not be < 0. Found "+e[o]+" at dim "+o);if(-1===r){if(0<t&&t!==n)throw Error("Size("+t+") must match the product of shape "+e);return e}if(0===n)throw Error("Cannot infer the missing size in ["+e+"] when there are 0 elements");if(t%n!=0)throw Error("The implicit shape can't be a fractional number. Got "+t+" / "+n);var i=e.slice();return i[r]=t/n,i}function O(e,t){var n=t.length;return C((e=null==e?t.map(function(e,t){return t}):[].concat(e)).every(function(e){return-n<=e&&e<n}),function(){return"All values in axis param must be in range [-"+n+", "+n+") but got axis "+e}),C(e.every(function(e){return A(e)}),function(){return"All values in axis param must be integers but got axis "+e}),e.map(function(e){return e<0?n+e:e})}function M(e,t){for(var n=[],r=[],o=null!=t&&Array.isArray(t)&&0===t.length,i=null==t||o?null:O(t,e).sort(),a=0,s=0;s<e.length;++s){if(null!=i){if(i[a]===s&&1!==e[s])throw new Error("Can't squeeze axis "+s+" since its dim '"+e[s]+"' is not 1");(null==i[a]||i[a]>s)&&1===e[s]&&(n.push(e[s]),r.push(s)),i[a]<=s&&a++}1!==e[s]&&(n.push(e[s]),r.push(s))}return{newShape:n,keptDims:r}}function B(e,t){var n=null;if(null==e||"float32"===e)n=new Float32Array(t);else if("int32"===e)n=new Int32Array(t);else{if("bool"!==e)throw new Error("Unknown data type "+e);n=new Uint8Array(t)}return n}function P(e,t){var n=null;if(null==e||"float32"===e)n=new Float32Array(t);else if("int32"===e)n=new Int32Array(t);else if("bool"===e)n=new Uint8Array(t);else{if("string"!==e)throw new Error("Unknown data type "+e);n=new Array(t)}return n}function L(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(isNaN(r)||!isFinite(r))throw Error("A tensor of type "+t+" being uploaded contains "+r+".")}}function W(e){return"bool"===e||"complex64"===e||"float32"===e||"int32"===e||"string"===e}function U(e,t){return!("complex64"===t||"float32"===t&&"complex64"!==e||"int32"===t&&"float32"!==e&&"complex64"!==e||"bool"===t&&"bool"===e)}function V(e){return e instanceof Float32Array||e instanceof Int32Array||e instanceof Uint8Array}function z(e){if("float32"===e||"int32"===e)return 4;if("complex64"===e)return 8;if("bool"===e)return 1;throw new Error("Unknown dtype "+e)}function G(e){if(null==e)return 0;var t=0;return e.forEach(function(e){return t+=e.length}),t}function H(e){return"string"==typeof e||e instanceof String}function q(e){return"boolean"==typeof e}function K(e){return"number"==typeof e}function j(e){return Array.isArray(e)?j(e[0]):e instanceof Float32Array?"float32":e instanceof Int32Array||e instanceof Uint8Array?"int32":K(e)?"float32":H(e)?"string":q(e)?"bool":"float32"}function X(e){return!!(e&&e.constructor&&e.call&&e.apply)}function Y(e,t){for(var n=t;n<e;++n)if(e%n==0)return n;return e}function $(e){var t=e.length;if(t<2)return[];var n=new Array(t-1);n[t-2]=e[t-1];for(var r=t-3;0<=r;--r)n[r]=n[r+1]*e[r+1];return n}function Q(e,t,n){if("string"===t)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(e)&&(e=I(e)),n&&L(e,t),e instanceof Float32Array&&"float32"===t||e instanceof Int32Array&&"int32"===t||e instanceof Uint8Array&&"bool"===t)return e;if(null==t||"float32"===t||"complex64"===t)return new Float32Array(e);if("int32"===t)return new Int32Array(e);if("bool"!==t)throw new Error("Unknown data type "+t);for(var r=new Uint8Array(e.length),o=0;o<r.length;++o)0!==Math.round(e[o])&&(r[o]=1);return r}function J(e,t){if(0===e.length)return t[0];var n=e.reduce(function(e,t){return e*t});if(0===n)return[];if(n!==t.length)throw new Error("["+e+"] does not match the input size.");return function e(t,n,r){var o=new Array;if(1===n.length)for(var i=n[0],a=0;a<i;a++)o[a]=r[t+a];else for(var i=n[0],s=n.slice(1),u=s.reduce(function(e,t){return e*t}),a=0;a<i;a++)o[a]=e(t+a*u,s,r);return o}(0,e,t)}function Z(e,t){for(var n=tt(e,t),r=0;r<n.length;r++)n[r]=1;return n}function tt(e,t){if(null==t||"float32"===t||"complex64"===t)return new Float32Array(e);if("int32"===t)return new Int32Array(e);if("bool"===t)return new Uint8Array(e);throw new Error("Unknown data type "+t)}function et(){return i().platform.now()}function nt(t){t.forEach(function(e){C(Number.isInteger(e)&&0<=e,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+t+"]."})})}function rt(e,t){return t=(t=void 0===t?"utf-8":t)||"utf-8",i().platform.encode(e,t)}function ot(e,t){return t=(t=void 0===t?"utf-8":t)||"utf-8",i().platform.decode(e,t)}function at(e,t,n){if(0===t)return 0;if(1===t)return e[0];for(var r=e[e.length-1],o=0;o<e.length-1;++o)r+=n[o]*e[o];return r}function it(e,t,n){if(0===t)return[];if(1===t)return[e];for(var r=new Array(t),o=0;o<r.length-1;++o)r[o]=Math.floor(e/n[o]),e-=r[o]*n[o];return r[r.length-1]=e,r}Object.freeze({shuffle:y,clamp:x,nearestLargerEven:b,sum:w,randUniform:function(e,t){var n=Math.random();return t*n+(1-n)*e},distSquared:function(e,t){for(var n=0,r=0;r<e.length;r++){var o=Number(e[r])-Number(t[r]);n+=o*o}return n},assert:C,assertShapesMatch:E,assertNonNull:R,flatten:I,sizeFromShape:k,isScalarShape:function(e){return 0===e.length},arraysEqual:S,isInt:A,tanh:D,sizeToSquarishShape:T,createShuffledIndices:function(e){for(var t=new Uint32Array(e),n=0;n<e;++n)t[n]=n;return y(t),t},rightPad:N,repeatedTry:F,inferFromImplicitShape:_,parseAxisParam:O,squeezeShape:M,getTypedArrayFromDType:B,getArrayFromDType:P,checkConversionForErrors:L,isValidDtype:W,hasEncodingLoss:U,isTypedArray:V,bytesPerElement:z,bytesFromStringArray:G,isString:H,isBoolean:q,isNumber:K,inferDtype:j,isFunction:X,nearestDivisor:Y,computeStrides:$,toTypedArray:Q,toNestedArray:J,makeOnesTypedArray:Z,makeZerosTypedArray:tt,now:et,assertNonNegativeIntegerDimensions:nt,fetch:function(e,t){return i().platform.fetch(e,t)},encodeString:rt,decodeString:ot,locToIndex:at,indexToLoc:it});var ut=(R4.prototype.profileKernel=function(o,i,e){var t,a=this,s=this.backendTimer.time(function(){t=e()});return t.forEach(function(r){r.data().then(function(n){!function(e,t,n){if("float32"===t)for(var r=0;r<e.length;r++){var o=e[r];if(isNaN(o)||!isFinite(o))return console.warn("Found "+o+" in the result of '"+n+"'")}}(n,r.dtype,o),s.then(function(e){var t="";null!=e.getExtraProfileInfo&&(t=e.getExtraProfileInfo()),a.logger.logKernelProfile(o,r,n,e.kernelMs,i,t)})})}),t},R4);function R4(e,t){this.backendTimer=e,null==(this.logger=t)&&(this.logger=new ct)}var ct=(h5.prototype.logKernelProfile=function(e,t,n,r,o,i){var a,s="number"==typeof r?N(r+"ms",9):r.error,u=N(e,25),c=t.rank,r=t.size,e=N(t.shape.toString(),14),l="";for(a in o){var h=o[a].shape||t.shape,d=h.length;l+=a+": "+d+"D "+(0<d?h:"")+" "}console.log("%c"+u+"\t%c"+s+"\t%c"+c+"D "+e+"\t%c"+r+"\t%c"+l+"\t%c"+i,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},h5);function h5(){}var lt=20,ht=3,ft=7;function dt(e,t,n,r){var o=$(t),i=function(e,t,n,r){var o=k(t),i=r[r.length-1],a=new Array(i).fill(0),t=t.length,s="complex64"===n?mt(e):e;if(1<t)for(var u=0;u<o/i;u++)for(var c=u*i,l=0;l<i;l++)a[l]=Math.max(a[l],pt(s[c+l],0,n).length);return a}(e,t,n,o),a=t.length,o=function e(t,n,r,o,i,a){void 0===a&&(a=!0);var s="complex64"===r?2:1,u=n[0],c=n.length;if(0===c)return"complex64"===r?[pt(mt(t)[0],0,r)]:"bool"===r?[vt(t[0])]:[t[0].toString()];if(1===c){if(lt<u){var l=Array.from(t.slice(0,ht*s)),h=Array.from(t.slice((u-ht)*s,u*s));return"complex64"===r&&(l=mt(l),h=mt(h)),["["+l.map(function(e,t){return pt(e,i[t],r)}).join(", ")+", ..., "+h.map(function(e,t){return pt(e,i[u-ht+t],r)}).join(", ")+"]"]}return["["+("complex64"===r?mt(t):Array.from(t)).map(function(e,t){return pt(e,i[t],r)}).join(", ")+"]"]}var d=n.slice(1),p=o.slice(1),f=o[0]*s,m=[];if(lt<u){for(var g=0;g<ht;g++){var v=(b=g*f)+f;m.push.apply(m,e(t.slice(b,v),d,r,p,i,!1))}for(m.push("..."),g=u-ht;g<u;g++)v=(b=g*f)+f,m.push.apply(m,e(t.slice(b,v),d,r,p,i,g===u-1))}else for(g=0;g<u;g++){var b,v=(b=g*f)+f;m.push.apply(m,e(t.slice(b,v),d,r,p,i,g===u-1))}var y=2===c?",":"";for(m[0]="["+m[0]+y,g=1;g<m.length-1;g++)m[g]=" "+m[g]+y;for(var x=",\n",g=2;g<c;g++)x+="\n";return m[m.length-1]=" "+m[m.length-1]+"]"+(a?"":x),m}(e,t,n,o,i),i=["Tensor"];return r&&(i.push("  dtype: "+n),i.push("  rank: "+a),i.push("  shape: ["+t+"]"),i.push("  values:")),i.push(o.map(function(e){return"    "+e}).join("\n")),i.join("\n")}function pt(e,t,n){return N(Array.isArray(e)?parseFloat(e[0].toFixed(ft))+" + "+parseFloat(e[1].toFixed(ft))+"j":H(e)?"'"+e+"'":"bool"===n?vt(e):parseFloat(e.toFixed(ft)).toString(),t)}function vt(e){return 0===e?"false":"true"}function mt(e){for(var t=[],n=0;n<e.length;n+=2)t.push([e[n],e[n+1]]);return t}var gt=(Ag.prototype.set=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];C((n=0===n.length?[0]:n).length===this.rank,function(){return"The number of provided coordinates ("+n.length+") must match the rank ("+t.rank+")"});var o=this.locToIndex(n);this.values[o]=e},Ag.prototype.get=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,r=0,o=e=0===e.length?[0]:e;r<o.length;r++){var i=o[r];if(i<0||i>=this.shape[n]){i="Requested out of range element at "+e+".   Buffer shape="+this.shape;throw new Error(i)}n++}for(var a=e[e.length-1],s=0;s<e.length-1;++s)a+=this.strides[s]*e[s];return this.values[a]},Ag.prototype.locToIndex=function(e){if(0===this.rank)return 0;if(1===this.rank)return e[0];for(var t=e[e.length-1],n=0;n<e.length-1;++n)t+=this.strides[n]*e[n];return t},Ag.prototype.indexToLoc=function(e){if(0===this.rank)return[];if(1===this.rank)return[e];for(var t=new Array(this.shape.length),n=0;n<t.length-1;++n)t[n]=Math.floor(e/this.strides[n]),e-=t[n]*this.strides[n];return t[t.length-1]=e,t},Object.defineProperty(Ag.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),Ag.prototype.toTensor=function(){return yt().makeTensor(this.values,this.shape,this.dtype)},Ag),yt=null,xt=null,bt=null;function Ag(e,t,n){var r,o=this;if(this.dtype=t,this.shape=e.slice(),this.size=k(e),null!=n&&C((r=n.length)===this.size,function(){return"Length of values '"+r+"' does not match the size inferred by the shape '"+o.size+"'."}),"complex64"===t)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=n||P(t,this.size),this.strides=$(e)}var wt=($g.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},$g.prototype.asScalar=function(){return this.throwIfDisposed(),C(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},$g.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},$g.prototype.as2D=function(e,t){return this.throwIfDisposed(),this.reshape([e,t])},$g.prototype.as3D=function(e,t,n){return this.throwIfDisposed(),this.reshape([e,t,n])},$g.prototype.as4D=function(e,t,n,r){return this.throwIfDisposed(),this.reshape([e,t,n,r])},$g.prototype.as5D=function(e,t,n,r,o){return this.throwIfDisposed(),this.reshape([e,t,n,r,o])},$g.prototype.asType=function(e){return this.throwIfDisposed(),xt.cast(this,e)},Object.defineProperty($g.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),$g.prototype.buffer=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,xt.buffer(this.shape,this.dtype,t)]}})})},$g.prototype.bufferSync=function(){return xt.buffer(this.shape,this.dtype,this.dataSync())},$g.prototype.array=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,J(this.shape,t)]}})})},$g.prototype.arraySync=function(){return J(this.shape,this.dataSync())},$g.prototype.data=function(){return n(this,void 0,void 0,function(){var t,n;return r(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),t=yt().read(this.dataId),"string"!==this.dtype?[3,2]:[4,t];case 1:n=e.sent();try{return[2,n.map(function(e){return ot(e)})]}catch(e){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}e.label=2;case 2:return[2,t]}})})},$g.prototype.dataSync=function(){this.throwIfDisposed();var e=yt().readSync(this.dataId);if("string"===this.dtype)try{return e.map(function(e){return ot(e)})}catch(e){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return e},$g.prototype.bytes=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),[4,yt().read(this.dataId)];case 1:return t=e.sent(),"string"===this.dtype?[2,t]:[2,new Uint8Array(t.buffer)]}})})},$g.prototype.dispose=function(){this.isDisposed||(yt().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty($g.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),$g.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},$g.prototype.toFloat=function(){return this.asType("float32")},$g.prototype.toInt=function(){return this.asType("int32")},$g.prototype.toBool=function(){return this.asType("bool")},$g.prototype.print=function(e){return xt.print(this,e=void 0===e?!1:e)},$g.prototype.reshape=function(e){return this.throwIfDisposed(),xt.reshape(this,e)},$g.prototype.reshapeAs=function(e){return this.throwIfDisposed(),this.reshape(e.shape)},$g.prototype.expandDims=function(e){return xt.expandDims(this,e=void 0===e?0:e)},$g.prototype.cumsum=function(e,t,n){return xt.cumsum(this,e=void 0===e?0:e,t=void 0===t?!1:t,n=void 0===n?!1:n)},$g.prototype.squeeze=function(e){return this.throwIfDisposed(),xt.squeeze(this,e)},$g.prototype.clone=function(){return this.throwIfDisposed(),xt.clone(this)},$g.prototype.oneHot=function(e,t,n){return this.throwIfDisposed(),xt.oneHot(this,e,t,n)},$g.prototype.toString=function(e){return void 0===e&&(e=!1),dt(this.dataSync(),this.shape,this.dtype,e)},$g.prototype.tile=function(e){return this.throwIfDisposed(),xt.tile(this,e)},$g.prototype.gather=function(e,t){return void 0===t&&(t=0),this.throwIfDisposed(),xt.gather(this,e,t)},$g.prototype.matMul=function(e,t,n){return void 0===t&&(t=!1),void 0===n&&(n=!1),this.throwIfDisposed(),xt.matMul(this,e,t,n)},$g.prototype.dot=function(e){return this.throwIfDisposed(),xt.dot(this,e)},$g.prototype.norm=function(e,t,n){return void 0===e&&(e="euclidean"),void 0===t&&(t=null),void 0===n&&(n=!1),this.throwIfDisposed(),xt.norm(this,e,t,n)},$g.prototype.slice=function(e,t){return this.throwIfDisposed(),xt.slice(this,e,t)},$g.prototype.reverse=function(e){return this.throwIfDisposed(),xt.reverse(this,e)},$g.prototype.concat=function(e,t){return void 0===t&&(t=0),this.throwIfDisposed(),xt.concat([this].concat(e=e instanceof $g?[e]:e),t)},$g.prototype.split=function(e,t){return void 0===t&&(t=0),this.throwIfDisposed(),xt.split(this,e,t)},$g.prototype.stack=function(e,t){return xt.stack([this,e],t=void 0===t?0:t)},$g.prototype.unstack=function(e){return xt.unstack(this,e=void 0===e?0:e)},$g.prototype.pad=function(e,t){return xt.pad(this,e,t=void 0===t?0:t)},$g.prototype.batchNormalization=function(e,t,n,r,o){return void 0===n&&(n=.001),bt("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(e,t,o,r,n)},$g.prototype.batchNorm=function(e,t,n,r,o){return void 0===o&&(o=.001),this.throwIfDisposed(),xt.batchNorm(this,e,t,n,r,o)},$g.prototype.all=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.all(this,e,t)},$g.prototype.any=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.any(this,e,t)},$g.prototype.logSumExp=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.logSumExp(this,e,t)},$g.prototype.sum=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.sum(this,e,t)},$g.prototype.prod=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.prod(this,e,t)},$g.prototype.mean=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.mean(this,e,t)},$g.prototype.min=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.min(this,e,t)},$g.prototype.max=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=!1),this.throwIfDisposed(),xt.max(this,e,t)},$g.prototype.argMin=function(e){return void 0===e&&(e=null),this.throwIfDisposed(),xt.argMin(this,e)},$g.prototype.argMax=function(e){return void 0===e&&(e=null),this.throwIfDisposed(),xt.argMax(this,e)},$g.prototype.cast=function(e){return this.throwIfDisposed(),xt.cast(this,e)},$g.prototype.add=function(e){return this.throwIfDisposed(),xt.add(this,e)},$g.prototype.addStrict=function(e){return this.throwIfDisposed(),xt.addStrict(this,e)},$g.prototype.atan2=function(e){return this.throwIfDisposed(),xt.atan2(this,e)},$g.prototype.sub=function(e){return this.throwIfDisposed(),xt.sub(this,e)},$g.prototype.subStrict=function(e){return this.throwIfDisposed(),xt.subStrict(this,e)},$g.prototype.pow=function(e){return this.throwIfDisposed(),xt.pow(this,e)},$g.prototype.powStrict=function(e){return this.throwIfDisposed(),xt.powStrict(this,e)},$g.prototype.mul=function(e){return this.throwIfDisposed(),xt.mul(this,e)},$g.prototype.mulStrict=function(e){return this.throwIfDisposed(),xt.mulStrict(this,e)},$g.prototype.div=function(e){return this.throwIfDisposed(),xt.div(this,e)},$g.prototype.divNoNan=function(e){return this.throwIfDisposed(),xt.divNoNan(this,e)},$g.prototype.floorDiv=function(e){return this.throwIfDisposed(),xt.floorDiv(this,e)},$g.prototype.divStrict=function(e){return this.throwIfDisposed(),xt.divStrict(this,e)},$g.prototype.minimum=function(e){return this.throwIfDisposed(),xt.minimum(this,e)},$g.prototype.minimumStrict=function(e){return this.throwIfDisposed(),xt.minimumStrict(this,e)},$g.prototype.maximum=function(e){return this.throwIfDisposed(),xt.maximum(this,e)},$g.prototype.maximumStrict=function(e){return this.throwIfDisposed(),xt.maximumStrict(this,e)},$g.prototype.mod=function(e){return this.throwIfDisposed(),xt.mod(this,e)},$g.prototype.modStrict=function(e){return this.throwIfDisposed(),xt.modStrict(this,e)},$g.prototype.squaredDifferenceStrict=function(e){return this.throwIfDisposed(),xt.squaredDifferenceStrict(this,e)},$g.prototype.transpose=function(e){return this.throwIfDisposed(),xt.transpose(this,e)},$g.prototype.notEqual=function(e){return this.throwIfDisposed(),xt.notEqual(this,e)},$g.prototype.notEqualStrict=function(e){return this.throwIfDisposed(),xt.notEqualStrict(this,e)},$g.prototype.less=function(e){return this.throwIfDisposed(),xt.less(this,e)},$g.prototype.lessStrict=function(e){return this.throwIfDisposed(),xt.lessStrict(this,e)},$g.prototype.equal=function(e){return this.throwIfDisposed(),xt.equal(this,e)},$g.prototype.equalStrict=function(e){return this.throwIfDisposed(),xt.equalStrict(this,e)},$g.prototype.lessEqual=function(e){return this.throwIfDisposed(),xt.lessEqual(this,e)},$g.prototype.lessEqualStrict=function(e){return this.throwIfDisposed(),xt.lessEqualStrict(this,e)},$g.prototype.greater=function(e){return this.throwIfDisposed(),xt.greater(this,e)},$g.prototype.greaterStrict=function(e){return this.throwIfDisposed(),xt.greaterStrict(this,e)},$g.prototype.greaterEqual=function(e){return this.throwIfDisposed(),xt.greaterEqual(this,e)},$g.prototype.greaterEqualStrict=function(e){return this.throwIfDisposed(),xt.greaterEqualStrict(this,e)},$g.prototype.logicalAnd=function(e){return this.throwIfDisposed(),xt.logicalAnd(this,e)},$g.prototype.logicalOr=function(e){return this.throwIfDisposed(),xt.logicalOr(this,e)},$g.prototype.logicalNot=function(){return this.throwIfDisposed(),xt.logicalNot(this)},$g.prototype.logicalXor=function(e){return this.throwIfDisposed(),xt.logicalXor(this,e)},$g.prototype.where=function(e,t){return this.throwIfDisposed(),xt.where(e,this,t)},$g.prototype.neg=function(){return this.throwIfDisposed(),xt.neg(this)},$g.prototype.ceil=function(){return this.throwIfDisposed(),xt.ceil(this)},$g.prototype.floor=function(){return this.throwIfDisposed(),xt.floor(this)},$g.prototype.sign=function(){return this.throwIfDisposed(),xt.sign(this)},$g.prototype.isNaN=function(){return this.throwIfDisposed(),xt.isNaN(this)},$g.prototype.isInf=function(){return this.throwIfDisposed(),xt.isInf(this)},$g.prototype.isFinite=function(){return this.throwIfDisposed(),xt.isFinite(this)},$g.prototype.exp=function(){return this.throwIfDisposed(),xt.exp(this)},$g.prototype.expm1=function(){return this.throwIfDisposed(),xt.expm1(this)},$g.prototype.log=function(){return this.throwIfDisposed(),xt.log(this)},$g.prototype.log1p=function(){return this.throwIfDisposed(),xt.log1p(this)},$g.prototype.sqrt=function(){return this.throwIfDisposed(),xt.sqrt(this)},$g.prototype.rsqrt=function(){return this.throwIfDisposed(),xt.rsqrt(this)},$g.prototype.square=function(){return this.throwIfDisposed(),xt.square(this)},$g.prototype.reciprocal=function(){return this.throwIfDisposed(),xt.reciprocal(this)},$g.prototype.abs=function(){return this.throwIfDisposed(),xt.abs(this)},$g.prototype.clipByValue=function(e,t){return this.throwIfDisposed(),xt.clipByValue(this,e,t)},$g.prototype.relu=function(){return this.throwIfDisposed(),xt.relu(this)},$g.prototype.relu6=function(){return this.throwIfDisposed(),xt.relu6(this)},$g.prototype.elu=function(){return this.throwIfDisposed(),xt.elu(this)},$g.prototype.selu=function(){return this.throwIfDisposed(),xt.selu(this)},$g.prototype.leakyRelu=function(e){return void 0===e&&(e=.2),this.throwIfDisposed(),xt.leakyRelu(this,e)},$g.prototype.prelu=function(e){return this.throwIfDisposed(),xt.prelu(this,e)},$g.prototype.sigmoid=function(){return this.throwIfDisposed(),xt.sigmoid(this)},$g.prototype.logSigmoid=function(){return this.throwIfDisposed(),xt.logSigmoid(this)},$g.prototype.softplus=function(){return this.throwIfDisposed(),xt.softplus(this)},$g.prototype.zerosLike=function(){return this.throwIfDisposed(),xt.zerosLike(this)},$g.prototype.onesLike=function(){return this.throwIfDisposed(),xt.onesLike(this)},$g.prototype.sin=function(){return this.throwIfDisposed(),xt.sin(this)},$g.prototype.cos=function(){return this.throwIfDisposed(),xt.cos(this)},$g.prototype.tan=function(){return this.throwIfDisposed(),xt.tan(this)},$g.prototype.asin=function(){return this.throwIfDisposed(),xt.asin(this)},$g.prototype.acos=function(){return this.throwIfDisposed(),xt.acos(this)},$g.prototype.atan=function(){return this.throwIfDisposed(),xt.atan(this)},$g.prototype.sinh=function(){return this.throwIfDisposed(),xt.sinh(this)},$g.prototype.cosh=function(){return this.throwIfDisposed(),xt.cosh(this)},$g.prototype.tanh=function(){return this.throwIfDisposed(),xt.tanh(this)},$g.prototype.asinh=function(){return this.throwIfDisposed(),xt.asinh(this)},$g.prototype.acosh=function(){return this.throwIfDisposed(),xt.acosh(this)},$g.prototype.atanh=function(){return this.throwIfDisposed(),xt.atanh(this)},$g.prototype.erf=function(){return this.throwIfDisposed(),xt.erf(this)},$g.prototype.round=function(){return this.throwIfDisposed(),xt.round(this)},$g.prototype.step=function(e){return void 0===e&&(e=0),this.throwIfDisposed(),xt.step(this,e)},$g.prototype.softmax=function(e){return void 0===e&&(e=-1),this.throwIfDisposed(),xt.softmax(this,e)},$g.prototype.logSoftmax=function(e){return void 0===e&&(e=-1),this.throwIfDisposed(),xt.logSoftmax(this,e)},$g.prototype.resizeBilinear=function(e,t){return void 0===t&&(t=!1),this.throwIfDisposed(),xt.image.resizeBilinear(this,e,t)},$g.prototype.resizeNearestNeighbor=function(e,t){return void 0===t&&(t=!1),this.throwIfDisposed(),xt.image.resizeNearestNeighbor(this,e,t)},$g.prototype.conv1d=function(e,t,n,r,o,i){return void 0===r&&(r="NWC"),void 0===o&&(o=1),this.throwIfDisposed(),xt.conv1d(this,e,t,n,r,o,i)},$g.prototype.conv2d=function(e,t,n,r,o,i){return void 0===r&&(r="NHWC"),void 0===o&&(o=[1,1]),this.throwIfDisposed(),xt.conv2d(this,e,t,n,r,o,i)},$g.prototype.conv2dTranspose=function(e,t,n,r,o){return this.throwIfDisposed(),xt.conv2dTranspose(this,e,t,n,r,o)},$g.prototype.depthwiseConv2D=function(e,t,n,r,o,i){return void 0===r&&(r="NHWC"),void 0===o&&(o=[1,1]),this.throwIfDisposed(),xt.depthwiseConv2d(this,e,t,n,r,o,i)},$g.prototype.separableConv2d=function(e,t,n,r,o,i){return void 0===o&&(o=[1,1]),void 0===i&&(i="NHWC"),this.throwIfDisposed(),xt.separableConv2d(this,e,t,n,r,o,i)},$g.prototype.avgPool=function(e,t,n,r){return this.throwIfDisposed(),xt.avgPool(this,e,t,n,r)},$g.prototype.maxPool=function(e,t,n,r){return this.throwIfDisposed(),xt.maxPool(this,e,t,n,r)},$g.prototype.localResponseNormalization=function(e,t,n,r){return xt.localResponseNormalization(this,e=void 0===e?5:e,t=void 0===t?1:t,n=void 0===n?1:n,r=void 0===r?.5:r)},$g.prototype.pool=function(e,t,n,r,o){return this.throwIfDisposed(),xt.pool(this,e,t,n,r,o)},$g.prototype.variable=function(e,t,n){return void 0===e&&(e=!0),this.throwIfDisposed(),yt().makeVariable(this,e,t,n)},$g.prototype.unsortedSegmentSum=function(e,t){return this.throwIfDisposed(),xt.unsortedSegmentSum(this,e,t)},$g.prototype.batchToSpaceND=function(e,t){return this.throwIfDisposed(),xt.batchToSpaceND(this,e,t)},$g.prototype.spaceToBatchND=function(e,t){return this.throwIfDisposed(),xt.spaceToBatchND(this,e,t)},$g.prototype.topk=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=!0),this.throwIfDisposed(),xt.topk(this,e,t)},$g.prototype.stridedSlice=function(e,t,n,r,o,i,a,s){return void 0===r&&(r=0),void 0===o&&(o=0),void 0===i&&(i=0),void 0===a&&(a=0),void 0===s&&(s=0),this.throwIfDisposed(),xt.stridedSlice(this,e,t,n,r,o,i,a,s)},$g.prototype.depthToSpace=function(e,t){return this.throwIfDisposed(),xt.depthToSpace(this,e,t)},$g.prototype.fft=function(){return this.throwIfDisposed(),xt.spectral.fft(this)},$g.prototype.ifft=function(){return this.throwIfDisposed(),xt.spectral.ifft(this)},$g.prototype.rfft=function(){return this.throwIfDisposed(),xt.spectral.rfft(this)},$g.prototype.irfft=function(){return this.throwIfDisposed(),xt.spectral.irfft(this)},$g);function $g(e,t,n,r){this.kept=!1,this.isDisposedInternal=!1,this.shape=e.slice(),this.dtype=t||"float32",this.size=k(e),this.strides=$(e),this.dataId=n,this.id=r,this.rankType=this.rank<5?this.rank.toString():"higher"}Object.defineProperty(wt,Symbol.hasInstance,{value:function(e){return!!e&&null!=e.dataId&&null!=e.shape&&null!=e.dtype}});var Ct,Et,Rt,It,kt,St=(Xj=wt,e(Yj,Xj),Yj.prototype.assign=function(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!S(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");yt().disposeTensor(this),this.dataId=e.dataId,yt().incRef(this,null)},Yj.prototype.dispose=function(){yt().disposeVariable(this),this.isDisposedInternal=!0},Yj),Xj,i9,h9,g9,f9,e9;function Yj(e,t,n,r){r=Xj.call(this,e.shape,e.dtype,e.dataId,r)||this;return r.trainable=t,r.name=n,r}Object.defineProperty(St,Symbol.hasInstance,{value:function(e){return e instanceof wt&&null!=e.assign&&e.assign instanceof Function}}),e9=Ct=Ct||{},e9.R0="R0",e9.R1="R1",e9.R2="R2",e9.R3="R3",e9.R4="R4",e9.R5="R5",e9.R6="R6",f9=Et=Et||{},f9.float32="float32",f9.int32="int32",f9.bool="int32",f9.complex64="complex64",g9=Rt=Rt||{},g9.float32="float32",g9.int32="int32",g9.bool="bool",g9.complex64="complex64",h9=It=It||{},h9.float32="float32",h9.int32="float32",h9.bool="float32",h9.complex64="complex64",i9=kt=kt||{},i9.float32="complex64",i9.int32="complex64",i9.bool="complex64",i9.complex64="complex64";var At={float32:It,int32:Et,bool:Rt,complex64:kt},Ot;function Dt(e,t){if("string"!==e&&"string"!==t)return At[e][t];if("string"===e&&"string"===t)return"string";throw new Error("Can not upcast "+e+" with "+t)}function Tt(e){return Dt(e,"int32")}function Nt(e,t){if(e.dtype===t.dtype)return[e,t];var n=Dt(e.dtype,t.dtype);return[e.cast(n),t.cast(n)]}function Ft(e,t){C(e.dtype===t.dtype,function(){return"The dtypes of the first("+e.dtype+") and second("+t.dtype+") input must match"})}function _t(e){var t=[];return function e(t,n,r){if(null!=t){if(t instanceof wt)return n.push(t),0;if(o=t,Array.isArray(o)||"object"==typeof o){var o,i,a=t;for(i in a){var s=a[i];r.has(s)||(r.add(s),e(s,n,r))}}}}(e,t,new Set),t}Object.freeze({makeTypesMatch:Nt,assertTypesMatch:Ft,isTensorInList:function(t,e){return e.some(function(e){return e.id===t.id})},getTensorsInContainer:_t});var Bt=(E9.prototype.dispose=function(){for(var e in this.registeredVariables)this.registeredVariables[e].dispose()},E9),Pt=(G9.prototype.ready=function(){return n(this,void 0,void 0,function(){var t,n,o;return r(this,function(e){switch(e.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];t=this.getSortedBackends(),n=0,e.label=1;case 1:return n<t.length?(o=t[n],[4,this.initializeBackend(o).success]):[3,5];case 2:return e.sent()?[4,this.setBackend(o)]:[3,4];case 3:return e.sent(),[2];case 4:return n++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(G9.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var e=this.initializeBackendsAndReturnBest(),t=e.name;if(e.asyncInit)throw new Error("The highest priority backend '"+t+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(t)}return this.backendInstance},enumerable:!0,configurable:!0}),G9.prototype.backendNames=function(){return Object.keys(this.registryFactory)},G9.prototype.findBackend=function(e){if(!(e in this.registry)){if(!(e in this.registryFactory))return null;if(this.initializeBackend(e).asyncInit)return null}return this.registry[e]},G9.prototype.findBackendFactory=function(e){return e in this.registryFactory?this.registryFactory[e].factory:null},G9.prototype.registerBackend=function(e,t,n){return void 0===n&&(n=1),e in this.registryFactory?(console.warn(e+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[e]={factory:t,priority:n},!0)},G9.prototype.setBackend=function(i){return n(this,void 0,void 0,function(){var t,n,o;return r(this,function(e){switch(e.label){case 0:if(null==this.registryFactory[i])throw new Error("Backend name '"+i+"' not found in registry");return this.backendName=i,null!=this.registry[i]?[3,4]:(this.backendInstance=null,t=this.initializeBackend(i),n=t.success,t.asyncInit?[4,n]:[3,2]);case 1:return o=e.sent(),[3,3];case 2:o=n,e.label=3;case 3:if(!o)return[2,!1];e.label=4;case 4:return this.backendInstance=this.registry[i],this.setupRegisteredKernels(),this.profiler=new ut(this.backendInstance),[2,!0]}})})},G9.prototype.setupRegisteredKernels=function(){var t=this;f(this.backendName).forEach(function(e){null!=e.setupFunc&&e.setupFunc(t.backendInstance)})},G9.prototype.disposeRegisteredKernels=function(t){var n=this;f(t).forEach(function(e){null!=e.disposeFunc&&e.disposeFunc(n.registry[t])})},G9.prototype.initializeBackend=function(t){var n=this,e=this.registryFactory[t];if(null==e)throw new Error("Cannot initialize backend "+t+", no registration found.");try{var r=e.factory();if(Promise.resolve(r)!==r)return this.registry[t]=r,{success:!0,asyncInit:!1};var o=++this.pendingBackendInitId,i=r.then(function(e){return!(o<n.pendingBackendInitId||(n.registry[t]=e,n.pendingBackendInit=null))}).catch(function(e){return!(o<n.pendingBackendInitId||(n.pendingBackendInit=null,console.warn("Initialization of backend "+t+" failed"),console.warn(e.stack||e.message),1))});return{success:this.pendingBackendInit=i,asyncInit:!0}}catch(n){return console.warn("Initialization of backend "+t+" failed"),console.warn(n.stack||n.message),{success:!1,asyncInit:!1}}},G9.prototype.removeBackend=function(e){if(!(e in this.registryFactory))throw new Error(e+" backend not found in registry");this.backendName===e&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,e in this.registry&&(this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e]),delete this.registryFactory[e],this.backendName===e&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},G9.prototype.getSortedBackends=function(){var n=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(e,t){return n.registryFactory[t].priority-n.registryFactory[e].priority})},G9.prototype.initializeBackendsAndReturnBest=function(){for(var e=this.getSortedBackends(),t=0;t<e.length;t++){var n=e[t],r=this.initializeBackend(n),o=r.success,r=r.asyncInit;if(r||o)return{name:n,asyncInit:r}}throw new Error("Could not initialize any backends, all backend initializations failed.")},G9.prototype.moveData=function(e,t){var n=this.state.tensorInfo.get(t),r=n.backend,o=this.readSync(t);r.disposeData(t),(n.backend=e).move(t,o,n.shape,n.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},G9.prototype.tidy=function(e,t){var n,r=this,o=null;if(null==t){if("function"!=typeof e)throw new Error("Please provide a function to tidy()");t=e}else{if("string"!=typeof e&&!(e instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof t)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");o=e}return this.scopedRun(function(){return r.startScope(o)},function(){return r.endScope(n)},function(){return(n=t())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),n})},G9.prototype.scopedRun=function(e,t,n){e();try{var r=n();return t(),r}catch(e){throw t(),e}},G9.prototype.nextTensorId=function(){return G9.nextTensorId++},G9.prototype.nextVariableId=function(){return G9.nextVariableId++},G9.prototype.clone=function(e){var t=this.makeTensorFromDataId(e.dataId,e.shape,e.dtype);return this.addTapeNode(this.state.activeScope.name,{x:e},[t],function(e){return{x:function(){return e.toFloat()}}},[]),t},G9.prototype.runKernel=function(e,t,n,r,o){return this.runKernelFunc(null,t,null,e,n,r,o)},G9.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},G9.prototype.checkKernelForMemLeak=function(e,t,n){var r=this.backend.numDataIds(),o=0;n.forEach(function(e){o+="complex64"===e.dtype?3:1});n=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],n=r-t-o-n;if(0<n)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+n+" data ids) after running '"+e+"'")},G9.prototype.runKernelFunc=function(n,r,e,o,i,a,s){var t,u=this;void 0===a&&(a=[]),void 0===s&&(s=[]);var c=[],h=this.isTapeOn();null==o&&(o=null!=this.state.activeScope?this.state.activeScope.name:"");function d(e){h&&(c=e.map(function(e){return u.keep(u.clone(e))}))}var p=this.state.numBytes,f=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var m,g=l(o,this.backendName),v=null!=g?function(){var e=u.backend.numDataIds();m=g.kernelFunc({inputs:r,attrs:i,backend:u.backend});var t=Array.isArray(m)?m:[m];u.shouldCheckForMemLeaks()&&u.checkKernelForMemLeak(o,e,t);e=t.map(function(e){var t=e.dataId,n=e.shape,e=e.dtype;return u.makeTensorFromDataId(t,n,e)}),t=e.filter(function(e,t){return s[t]});return d((a||[]).slice().concat(t)),e}:function(){var e=u.backend.numDataIds();m=u.tidy(function(){return n(u.backend,d)});var t=Array.isArray(m)?m:[m];return u.shouldCheckForMemLeaks()&&u.checkKernelForMemLeak(o,e,t),t};return this.scopedRun(function(){return u.state.kernelDepth++},function(){return u.state.kernelDepth--},function(){t=u.ENV.getBool("DEBUG")?u.profiler.profileKernel(o,r,function(){return v()}):v()}),h&&this.addTapeNode(o,r,t,e,c),this.state.profiling&&this.state.activeProfile.kernels.push({name:o,bytesAdded:this.state.numBytes-p,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-f,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(r).map(function(e){return r[e].shape}),outputShapes:t.map(function(e){return e.shape})}),Array.isArray(m)?t:t[0]},G9.prototype.makeTensor=function(e,t,n,r){if(null==e)throw new Error("Values passed to engine.makeTensor() are null");r=r||this.backend;var o=e;"string"===(n=n||"float32")&&H(e[0])&&(o=e.map(function(e){return rt(e)}));e=r.write(o,t,n),t=new wt(t,n,e,this.nextTensorId());return this.incRef(t,r),"string"===n&&(e=this.state.tensorInfo.get(e),o=G(o),this.state.numBytes+=o-e.bytes,e.bytes=o),t},G9.prototype.makeTensorFromDataId=function(e,t,n,r){e=new wt(t,n=n||"float32",e,this.nextTensorId());return this.incRef(e,r),e},G9.prototype.makeVariable=function(e,t,n,r){void 0===t&&(t=!0),n=n||this.nextVariableId().toString(),null!=r&&r!==e.dtype&&(e=e.asType(r));n=new St(e,t,n,this.nextTensorId());if(null!=this.state.registeredVariables[n.name])throw new Error("Variable with name "+n.name+" was already registered");return this.state.registeredVariables[n.name]=n,this.incRef(n,this.backend),n},G9.prototype.incRef=function(e,t){var n=this.state.tensorInfo.has(e.dataId)?this.state.tensorInfo.get(e.dataId).refCount:0;this.state.numTensors++,"string"===e.dtype&&this.state.numStringTensors++,0===n&&(this.state.numDataBuffers++,n=0,"complex64"!==e.dtype&&"string"!==e.dtype&&(n=e.size*z(e.dtype)),this.state.tensorInfo.set(e.dataId,{backend:t||this.backend,dtype:e.dtype,shape:e.shape,bytes:n,refCount:0}),this.state.numBytes+=n),this.state.tensorInfo.get(e.dataId).refCount++,e instanceof St||this.track(e)},G9.prototype.disposeTensor=function(e){var t;this.state.tensorInfo.has(e.dataId)&&(this.state.numTensors--,"string"===e.dtype&&this.state.numStringTensors--,(t=this.state.tensorInfo.get(e.dataId)).refCount<=1?("complex64"!==e.dtype&&(this.state.numBytes-=t.bytes),this.state.numDataBuffers--,t.backend.disposeData(e.dataId),this.state.tensorInfo.delete(e.dataId)):this.state.tensorInfo.get(e.dataId).refCount--)},G9.prototype.disposeVariables=function(){for(var e in this.state.registeredVariables){e=this.state.registeredVariables[e];this.disposeVariable(e)}},G9.prototype.disposeVariable=function(e){this.disposeTensor(e),null!=this.state.registeredVariables[e.name]&&delete this.state.registeredVariables[e.name]},G9.prototype.memory=function(){var e=this.backend.memory();return e.numTensors=this.state.numTensors,e.numDataBuffers=this.state.numDataBuffers,e.numBytes=this.state.numBytes,0<this.state.numStringTensors&&(e.unreliable=!0,null==e.reasons&&(e.reasons=[]),e.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),e},G9.prototype.profile=function(o){return n(this,void 0,void 0,function(){var t,n;return r(this,function(e){return this.state.profiling=!0,t=this.state.numBytes,n=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=o(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(e){return e.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-t,this.state.activeProfile.newTensors=this.state.numTensors-n,[2,this.state.activeProfile]})})},G9.prototype.isTapeOn=function(){return 0<this.state.gradientDepth&&0===this.state.kernelDepth},G9.prototype.addTapeNode=function(e,t,n,r,o){var i=this,t={id:this.state.nextTapeNodeId++,kernelName:e,inputs:t,outputs:n,saved:o},e=h(e);null!=(r=null!=e?e.gradFunc:r)&&(t.gradient=function(e){return e=e.map(function(e,t){if(null!=e)return e;e=n[t],t=tt(e.size,e.dtype);return i.makeTensor(t,e.shape,e.dtype)}),r(1<e.length?e:e[0],o)}),this.state.activeTape.push(t)},G9.prototype.keep=function(e){return e.kept=!0,e},G9.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},G9.prototype.endTape=function(){this.state.gradientDepth--},G9.prototype.startScope=function(e){var t={track:[],name:"unnamed scope",id:this.state.nextScopeId++};e&&(t.name=e),this.state.scopeStack.push(t),this.state.activeScope=t},G9.prototype.endScope=function(e){for(var t=this,e=_t(e),n=new Set(e.map(function(e){return e.id})),r=0;r<this.state.activeScope.track.length;r++){var o=this.state.activeScope.track[r];o.kept||n.has(o.id)||o.dispose()}var i=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],e.forEach(function(e){e.kept||e.scopeId!==i.id||t.track(e)})},G9.prototype.gradients=function(e,r,o,t){var u=this;if(void 0===t&&(t=!1),C(0<r.length,function(){return"gradients() received an empty list of xs."}),null!=o&&"float32"!==o.dtype)throw new Error("dy must have 'float32' dtype, but has '"+o.dtype+"'");var i=this.scopedRun(function(){return u.startTape()},function(){return u.endTape()},function(){return u.tidy("forward",e)});C(i instanceof wt,function(){return"The result y returned by f() must be a tensor."});var a=function(e,t,n){for(var r={},o={},i=0;i<t.length;i++)r[t[i].id]=!0;for(i=0;i<e.length;i++){var a=(p=e[i]).inputs;for(d in a){for(var s=a[d],u=!1,c=0;c<t.length;c++)if(r[s.id]){p.outputs.forEach(function(e){return r[e.id]=!0}),o[p.id]=u=!0;break}if(u)break}}var l={};l[n.id]=!0;for(var h={},i=e.length-1;0<=i;i--)for(a=(p=e[i]).inputs,c=0;c<p.outputs.length;c++)if(l[p.outputs[c].id]){for(var d in a)l[a[d].id]=!0,h[p.id]=!0;break}var p,f=[];for(i=0;i<e.length;i++)if(o[(p=e[i]).id]&&h[p.id]){var m={};for(d in p.inputs){var g=p.inputs[d];r[g.id]&&(m[d]=g)}var v=Object.assign({},p);v.inputs=m,v.outputs=p.outputs,f.push(v)}return f}(this.state.activeTape,r,i);if(!t&&0===a.length&&0<r.length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var e,t={};t[i.id]=null==o?(e=Z(k(n=i.shape),"float32"),Lt.makeTensor(e,n,"float32")):o,function(a,s){function e(e){var o=s[e],t=[];if(o.outputs.forEach(function(e){e=a[e.id];null!=e?t.push(e):t.push(null)}),null==o.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+o.kernelName+".");function n(e){if(!(e in i))throw new Error("Cannot backprop through input "+e+". Available gradients found: "+Object.keys(i)+".");var t=u.tidy(function(){return i[e]()});if("float32"!==t.dtype)throw new Error("Error in gradient for op "+o.kernelName+". The gradient of input "+e+" must have 'float32' dtype, but has '"+t.dtype+"'");var n,r=o.inputs[e];if(!S(t.shape,r.shape))throw new Error("Error in gradient for op "+o.kernelName+". The gradient of input '"+e+"' has shape '"+t.shape+"', which does not match the shape of the input '"+r.shape+"'");null==a[r.id]?a[r.id]=t:(n=a[r.id],a[r.id]=n.add(t),n.dispose())}var r,i=o.gradient(t);for(r in o.inputs)n(r)}for(var t=s.length-1;0<=t;t--)e(t)}(t,a);var n=r.map(function(e){return t[e.id]});return 0===u.state.gradientDepth&&(u.state.activeTape.forEach(function(e){for(var t=0,n=e.saved;t<n.length;t++)n[t].dispose()}),u.state.activeTape=null),{value:i,grads:n}})},G9.prototype.customGrad=function(i){var t=this;return C(X(i),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var r,o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];C(o.every(function(e){return e instanceof wt}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var n={};return o.forEach(function(e,t){n[t]=e}),t.runKernelFunc(function(e,t){return C((r=i.apply(void 0,o.concat([t]))).value instanceof wt,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),C(X(r.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),r.value},n,function(e,t){t=r.gradFunc(e,t),t=Array.isArray(t)?t:[t];C(t.length===o.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),C(t.every(function(e){return e instanceof wt}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var n={};return t.forEach(function(e,t){n[t]=function(){return e}}),n})}},G9.prototype.readSync=function(e){return this.state.tensorInfo.get(e).backend.readSync(e)},G9.prototype.read=function(e){return this.state.tensorInfo.get(e).backend.read(e)},G9.prototype.time=function(o){return n(this,void 0,void 0,function(){var t,n;return r(this,function(e){switch(e.label){case 0:return t=et(),[4,this.backend.time(o)];case 1:return(n=e.sent()).wallMs=et()-t,[2,n]}})})},G9.prototype.track=function(e){return null!=this.state.activeScope&&(e.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(e)),e},Object.defineProperty(G9.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),G9.prototype.reset=function(){for(var e in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new Bt,this.registry)this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},G9.nextTensorId=0,G9.nextVariableId=0,G9);function G9(e){this.ENV=e,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new Bt}function E9(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}var Lt=(Qq=function(){if(null==Ot){var e=void 0;if("undefined"!=typeof window)e=window;else if("undefined"!=typeof global)e=global;else if("undefined"!=typeof process)e=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");e=self}Ot=e}return Ot}(),null==Qq._tfengine&&(Tq=new o(Qq),Qq._tfengine=new Pt(Tq)),Tq=Qq._tfengine.ENV,s=Tq,yt=function(){return Qq._tfengine},Qq._tfengine),Tq,Qq;function Wt(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}var Ut=i();Ut.registerFlag("DEBUG",function(){return!1},function(e){e&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),Ut.registerFlag("IS_BROWSER",function(){return Wt()}),Ut.registerFlag("IS_NODE",function(){return"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node}),Ut.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),Ut.registerFlag("PROD",function(){return!1}),Ut.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return Ut.getBool("DEBUG")}),Ut.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),Ut.registerFlag("IS_TEST",function(){return!1});var Vt,zt,Gt,Ht={},qt={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0},yv,xv,wv;function Kt(e,t){Ht[e]=t}function jt(e){e in Ht||(Ht[e]=function(t){if(1!==t&&2!==t)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var e=function(){if("undefined"!=typeof OffscreenCanvas&&2===t)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}();return e.addEventListener("webglcontextlost",function(e){e.preventDefault(),delete Ht[t]},!1),1===t?e.getContext("webgl",qt)||e.getContext("experimental-webgl",qt):e.getContext("webgl2",qt)}(e));var t=Ht[e];return t.isContextLost()?(delete Ht[e],jt(e)):(t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.disable(t.BLEND),t.disable(t.DITHER),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SAMPLE_COVERAGE),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),Ht[e])}function Xt(e,t){return[t,e]}function Yt(e){e=k(e);return T(Math.ceil(e/4))}function $t(e,t){return[Math.max(1,Math.ceil(t/2)),Math.max(1,Math.ceil(e/2))]}function Qt(e,t){var n,r,o,a,s,u,c,l,h=e,t=2===i().getNumber("WEBGL_VERSION")?(n=h.R32F,r=h.R16F,o=h.RGBA16F,a=h.RGBA32F,s=h.RED,u=4,c=1,l=h.HALF_FLOAT,h.FLOAT):(n=e.RGBA,r=e.RGBA,o=e.RGBA,a=h.RGBA,s=e.RGBA,c=u=4,l=null!=t?t.HALF_FLOAT_OES:null,e.FLOAT);return{internalFormatFloat:n,internalFormatHalfFloat:r,internalFormatPackedHalfFloat:o,internalFormatPackedFloat:a,textureFormatFloat:s,downloadTextureFormat:e.RGBA,downloadUnpackNumChannels:u,defaultNumChannels:c,textureTypeHalfFloat:l,textureTypeFloat:t}}function Jt(e,t,n){n=n();return t&&function(e){var t=e.getError();if(t!==e.NO_ERROR)throw new Error("WebGL Error: "+ne(e,t))}(e),n}wv=Vt=Vt||{},wv[wv.DENSE=0]="DENSE",wv[wv.SHARED_BATCH=1]="SHARED_BATCH",xv=zt=zt||{},xv[xv.RENDER=0]="RENDER",xv[xv.UPLOAD=1]="UPLOAD",xv[xv.PIXELS=2]="PIXELS",xv[xv.DOWNLOAD=3]="DOWNLOAD",yv=Gt=Gt||{},yv[yv.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",yv[yv.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",yv[yv.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",yv[yv.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",yv[yv.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16";var Zt=5.96e-8,te=65504;function ee(e){return!!(i().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===e||Zt<Math.abs(e)&&Math.abs(e)<te)}function ne(e,t){switch(t){case e.NO_ERROR:return"NO_ERROR";case e.INVALID_ENUM:return"INVALID_ENUM";case e.INVALID_VALUE:return"INVALID_VALUE";case e.INVALID_OPERATION:return"INVALID_OPERATION";case e.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case e.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case e.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+t}}function re(e,t,n){return ke(e,t,function(){return e.getExtension(n)},'Extension "'+n+'" not supported on this browser.')}function oe(e,t,n){var r=ke(e,t,function(){return e.createShader(e.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(Jt(e,t,function(){return e.shaderSource(r,n)}),Jt(e,t,function(){return e.compileShader(r)}),!1===e.getShaderParameter(r,e.COMPILE_STATUS))throw console.log(e.getShaderInfoLog(r)),new Error("Failed to compile vertex shader.");return r}function ae(e,t,n){var r=ke(e,t,function(){return e.createShader(e.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(Jt(e,t,function(){return e.shaderSource(r,n)}),Jt(e,t,function(){return e.compileShader(r)}),!1===e.getShaderParameter(r,e.COMPILE_STATUS))throw function(e,t){var n=ue.exec(t);if(null==n)return console.log("Couldn't parse line number in error: "+t),console.log(e);for(var r=+n[1],n=e.split("\n"),o=n.length.toString().length+2,i=n.map(function(e,t){return N((t+1).toString(),o)+e}),a=0,s=0;s<i.length;s++)a=Math.max(i[s].length,a);e=i.slice(0,r-1),n=i.slice(r-1,r),r=i.slice(r);console.log(e.join("\n")),console.log(t.split("\n")[0]),console.log("%c "+N(n[0],a),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(r.join("\n"))}(n,e.getShaderInfoLog(r)),new Error("Failed to compile fragment shader.");return r}var ie,se,ue=/ERROR: [0-9]+:([0-9]+):/g;function ce(e,t){return ke(e,t,function(){return e.createProgram()},"Unable to create WebGLProgram.")}function le(e,t,n){if(Jt(e,t,function(){return e.linkProgram(n)}),!1===e.getProgramParameter(n,e.LINK_STATUS))throw console.log(e.getProgramInfoLog(n)),new Error("Failed to link vertex and fragment shaders.")}function he(e,t,n){if(Jt(e,t,function(){return e.validateProgram(n)}),!1===e.getProgramParameter(n,e.VALIDATE_STATUS))throw console.log(e.getProgramInfoLog(n)),new Error("Shader program validation failed.")}function fe(e,t,n){var r=ke(e,t,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return Jt(e,t,function(){return e.bindBuffer(e.ARRAY_BUFFER,r)}),Jt(e,t,function(){return e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW)}),r}function de(e,t,n){var r=ke(e,t,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return Jt(e,t,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r)}),Jt(e,t,function(){return e.bufferData(e.ELEMENT_ARRAY_BUFFER,n,e.STATIC_DRAW)}),r}function pe(e,t){return ke(e,t,function(){return e.createTexture()},"Unable to create WebGLTexture.")}function ve(e,t){var n=i().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(e<=0||t<=0){var r="["+e+"x"+t+"]";throw new Error("Requested texture size "+r+" is invalid.")}if(n<e||n<t)throw r="["+e+"x"+t+"]",new Error("Requested texture size "+r+" greater than WebGL maximum on this browser / GPU ["+n+"x"+n+"].")}function me(e,t){return ke(e,t,function(){return e.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function ge(e,t,n,r,o,i,a,s){var u=e.getAttribLocation(n,r);return-1!==u&&(Jt(e,t,function(){return e.bindBuffer(e.ARRAY_BUFFER,o)}),Jt(e,t,function(){return e.vertexAttribPointer(u,i,e.FLOAT,!1,a,s)}),Jt(e,t,function(){return e.enableVertexAttribArray(u)}),!0)}function ye(e,t,n,r){Se(e,r),Jt(e,t,function(){return e.activeTexture(e.TEXTURE0+r)}),Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,n)})}function xe(e,t,n,r){return ke(e,t,function(){return e.getUniformLocation(n,r)},'uniform "'+r+'" not present in program.')}function be(e,t,n){return e.getUniformLocation(t,n)}function we(e,t,n,r,o,i){Jt(e,t,function(){return ye(e,t,r,i)}),Jt(e,t,function(){return e.uniform1i(o,i)})}function Ce(e,t,n,r){Jt(e,t,function(){return e.bindFramebuffer(e.FRAMEBUFFER,r)}),Jt(e,t,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)})}function Ee(e,t,n){Jt(e,t,function(){return e.bindFramebuffer(e.FRAMEBUFFER,n)}),Jt(e,t,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0)})}function Re(e){var t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+Ie(e,t))}function Ie(e,t){switch(t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+t}}function ke(e,t,n,r){t=Jt(e,t,function(){return n()});if(null==t)throw new Error(r);return t}function Se(e,t){var n=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,t=t+e.TEXTURE0;if(t<e.TEXTURE0||n<t)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+n+"].")}function Ae(e,t){return k(e.slice(0,e.length-(t=void 0===t?2:t)))}function De(e){if(0===e.length)throw Error("Cannot get rows and columns of an empty shape array.");return[1<e.length?e[e.length-2]:1,e[e.length-1]]}function Te(e){var t=[1,1,1];return t=0!==e.length&&(1!==e.length||1!==e[0])?[Ae(e)].concat(De(e)):t}function Ne(n,e){void 0===e&&(e=!1);var t=i().getNumber("WEBGL_MAX_TEXTURE_SIZE");e&&(t*=2,1===(n=n.map(function(e,t){return t>=n.length-2?b(n[t]):n[t]})).length&&(n=[2,n[0]])),2!==n.length&&(a=M(n),n=a.newShape);var r=k(n);if(n.length<=1&&r<=t)return[1,r];if(2===n.length&&n[0]<=t&&n[1]<=t)return n;if(3===n.length&&n[0]*n[1]<=t&&n[2]<=t)return[n[0]*n[1],n[2]];if(3===n.length&&n[0]<=t&&n[1]*n[2]<=t)return[n[0],n[1]*n[2]];if(4===n.length&&n[0]*n[1]*n[2]<=t&&n[3]<=t)return[n[0]*n[1]*n[2],n[3]];if(4===n.length&&n[0]<=t&&n[1]*n[2]*n[3]<=t)return[n[0],n[1]*n[2]*n[3]];if(e){var o=Ae(n),a=2,t=2;return n.length&&(a=(e=De(n))[0],t=e[1]),T(r=o*(a/2)*(t/2)).map(function(e){return 2*e})}return T(r)}function Fe(e){return e%2==0}function _e(e,t){if(S(e=e.slice(-2),t=t.slice(-2)))return!0;if(!e.length||!t.length)return!0;if(0===e[0]||0===e[1]||0===t[0]||0===t[1])return!0;if(e.length!==t.length){var n=e.slice(-1)[0],r=t.slice(-1)[0];if(n===r)return!0;if(Fe(n)&&Fe(r)&&(1===e[0]||1===t[0]))return!0}return e[1]===t[1]&&Fe(e[0])&&Fe(t[0])}function Oe(e){return null==ie&&(e=jt(e),ie=e.getParameter(e.MAX_TEXTURE_SIZE)),ie}function Me(e){return null==se&&(e=jt(e),se=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)),Math.min(16,se)}function Be(e){if(0===e)return 0;var t=jt(e);return Pe(t,"EXT_disjoint_timer_query_webgl2")&&2===e?2:Pe(t,"EXT_disjoint_timer_query")?1:0}function Pe(e,t){return null!=e.getExtension(t)}function Le(e){try{if(null!=jt(e))return!0}catch(e){return!1}return!1}function We(e){if(0===e)return!1;var t=jt(e);if(1===e){if(!Pe(t,"OES_texture_float"))return!1}else if(!Pe(t,"EXT_color_buffer_float"))return!1;return Ve(t)}function Ue(e){if(0===e)return!1;var t=jt(e);if(1===e)return!!Pe(t,"OES_texture_float")&&!!Pe(t,"WEBGL_color_buffer_float")&&Ve(t);if(Pe(t,"EXT_color_buffer_float"))return Ve(t);if(Pe(t,"EXT_color_buffer_half_float")){var o=t.getExtension("EXT_color_buffer_half_float");return function(e){var t=Qt(e,o),n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,t.internalFormatHalfFloat,1,1,0,t.textureFormatFloat,t.textureTypeHalfFloat,null);var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);t=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;return e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(n),e.deleteFramebuffer(r),t}(t)}return!1}function Ve(e){var t=Qt(e),n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,t.internalFormatFloat,1,1,0,t.textureFormatFloat,t.textureTypeFloat,null);var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);t=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;return e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(n),e.deleteFramebuffer(r),t}function ze(e){return 2===e&&null!=jt(e).fenceSync}var Ge=Object.freeze({callAndCheck:Jt,canBeRepresented:ee,getWebGLErrorMessage:ne,getExtensionOrThrow:re,createVertexShader:oe,createFragmentShader:ae,createProgram:ce,linkProgram:le,validateProgram:he,createStaticVertexBuffer:fe,createStaticIndexBuffer:de,getNumChannels:function(){return 2===i().getNumber("WEBGL_VERSION")?1:4},createTexture:pe,validateTextureSize:ve,createFramebuffer:me,bindVertexBufferToProgramAttribute:ge,bindTextureUnit:ye,unbindTextureUnit:function(e,t,n){Se(e,n),Jt(e,t,function(){return e.activeTexture(e.TEXTURE0+n)}),Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:xe,getProgramUniformLocation:be,bindTextureToProgramUniformSampler:we,bindCanvasToFramebuffer:function(e,t){Jt(e,t,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),Jt(e,t,function(){return e.viewport(0,0,e.canvas.width,e.canvas.height)}),Jt(e,t,function(){return e.scissor(0,0,e.canvas.width,e.canvas.height)})},bindColorTextureToFramebuffer:Ce,unbindColorTextureFromFramebuffer:Ee,validateFramebuffer:Re,getFramebufferErrorMessage:Ie,getBatchDim:Ae,getRowsCols:De,getShapeAs3D:Te,getTextureShapeFromLogicalShape:Ne,isReshapeFree:_e,getWebGLMaxTextureSize:Oe,resetMaxTextureSize:function(){ie=null},resetMaxTexturesInShader:function(){se=null},getMaxTexturesInShader:Me,getWebGLDisjointQueryTimerVersion:Be,hasExtension:Pe,isWebGLVersionEnabled:Le,isCapableOfRenderingToFloatTexture:We,isDownloadFloatTextureEnabled:Ue,isWebGLFenceEnabled:ze}),He=i();function Xe(e){i().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(e+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function Ze(e,t){return Lt.tidy(e,t)}function tn(e){_t(e).forEach(function(e){return e.dispose()})}function en(e){return Lt.keep(e)}function dn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i().getBool("IS_TEST")||console.warn.apply(console,e)}function pn(e,t){var n=e;if(V(e))return"string"===t?[]:[e.length];if(!Array.isArray(e))return[];for(var r=[];Array.isArray(n)||V(n)&&"string"!==t;)r.push(n.length),n=n[0];return Array.isArray(e)&&i().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function e(t,n,r){if(r=r||[],!Array.isArray(t)&&!V(t))return C(0===n.length,function(){return"Element arr["+r.join("][")+"] is a primitive, but should be an array/TypedArray of "+n[0]+" elements"}),0;C(0<n.length,function(){return"Element arr["+r.join("][")+"] should be a primitive, but is an array of "+t.length+" elements"}),C(t.length===n[0],function(){return"Element arr["+r.join("][")+"] should have "+n[0]+" elements, but has "+t.length+" elements"});for(var o=n.slice(1),i=0;i<t.length;++i)e(t[i],o,r.concat(i))}(e,r,[]),r}function vn(e,t,n,r){if(null!=e&&("numeric"!==e&&e!==t||"numeric"===e&&"string"===t))throw new Error("Argument '"+n+"' passed to '"+r+"' must be "+e+" tensor, but got "+t+" tensor")}function mn(e,t,n,r){if(void 0===r&&(r="numeric"),e instanceof wt)return vn(r,e.dtype,t,n),e;var o=j(e);if(vn(r,o="string"!==o&&0<=["bool","int32","float32"].indexOf(r)?r:o,t,n),null==e||!V(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e){var a=null==e?"null":e.constructor.name;throw new Error("Argument '"+t+"' passed to '"+n+"' must be a Tensor or TensorLike, but got '"+a+"'")}a=pn(e,o);V(e)||Array.isArray(e)||(e=[e]);e="string"!==o?Q(e,o,i().getBool("DEBUG")):I(e,[],!0);return Lt.makeTensor(e,a,o)}function gn(e,n,r,t){if(void 0===t&&(t="numeric"),!Array.isArray(e))throw new Error("Argument "+n+" passed to "+r+" must be a `Tensor[]` or `TensorLike[]`");return e.map(function(e,t){return mn(e,n+"["+t+"]",r)},t)}function yn(e,t){for(var n=0;n<e.length;++n)if(e[e.length-n-1]!==t-1-n)return!1;return!0}function xn(e,t,n){for(var r=e.length+t.length,o=[],i=0,a=0,s=0;s<r;s++)-1===n.indexOf(s)?o.push(e[i++]):o.push(t[a++]);return o}function bn(t,e){for(var n=[],r=t.length,o=0;o<r;o++)-1===e.indexOf(o)&&n.push(t[o]);return[n,e.map(function(e){return t[e]})]}function wn(e,t){return xn(e,t.map(function(e){return 1}),t)}function Cn(e,t,n){C(yn(t,n),function(){return e+" supports only inner-most axes for now. Got axes "+t+" and rank-"+n+" input."})}function En(e,t){if(yn(e,t))return null;for(var n=[],r=0;r<t;++r)-1===e.indexOf(r)&&n.push(r);return e.forEach(function(e){return n.push(e)}),n}function Rn(e){return e.map(function(e,t){return[t,e]}).sort(function(e,t){return e[1]-t[1]}).map(function(e){return e[0]})}function In(e,t){for(var n=[],r=t-e;r<t;++r)n.push(r);return n}function kn(e,r){var o=e[0].length;e.forEach(function(e,t){C(e.length===o,function(){return"Error in concat"+o+"D: rank of tensors["+t+"] must be the same as the rank of the rest ("+o+")"})}),C(0<=r&&r<o,function(){return"Error in concat"+o+"D: axis must be between 0 and "+(o-1)+"."});var i=e[0];e.forEach(function(e,t){for(var n=0;n<o;n++)C(n===r||e[n]===i[n],function(){return"Error in concat"+o+"D: Shape of tensors["+t+"] ("+e+") does not match the shape of the rest ("+i+") along the non-concatenated axis "+t+"."})})}function Sn(e,t){for(var n=e[0].slice(),r=1;r<e.length;r++)n[t]+=e[r][t];return n}function An(e){var t=Object.keys(e);if(1!==t.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+t.length+" keys.");var r=t[0],o=e[r];r.endsWith("_")&&(r=r.substring(0,r.length-1));e=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Lt.startScope(r);try{var n=o.apply(void 0,e);return n instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),Lt.endScope(n),n}catch(e){throw Lt.endScope(null),e}};return Object.defineProperty(e,"name",{value:r,configurable:!0}),e}He.registerFlag("HAS_WEBGL",function(){return 0<He.getNumber("WEBGL_VERSION")}),He.registerFlag("WEBGL_VERSION",function(){return Le(2)?2:Le(1)?1:0}),He.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===He.get("WEBGL_VERSION")}),He.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),He.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),He.registerFlag("WEBGL_PACK",function(){return He.getBool("HAS_WEBGL")}),He.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_CLIP",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),He.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_PACK_REDUCE",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_LAZILY_UNPACK",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_CONV_IM2COL",function(){return He.getBool("WEBGL_PACK")}),He.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return Oe(He.getNumber("WEBGL_VERSION"))}),He.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return Me(He.getNumber("WEBGL_VERSION"))}),He.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var e=He.getNumber("WEBGL_VERSION");return 0===e?0:Be(e)}),He.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return 0<He.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&(e=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))));var e}),He.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return We(He.getNumber("WEBGL_VERSION"))}),He.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!He.getBool("WEBGL_FORCE_F16_TEXTURES")&&He.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),He.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return Ue(He.getNumber("WEBGL_VERSION"))}),He.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return ze(He.getNumber("WEBGL_VERSION"))}),He.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return He.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0});var bt=Xe,Dn=An({complex_:function(e,t){var n=mn(e,"real","complex"),r=mn(t,"imag","complex");return E(n.shape,r.shape,"real and imag shapes, "+n.shape+" and "+r.shape+", must match in call to tf.complex()."),Lt.runKernelFunc(function(e){return e.complex(n,r)},{$real:n,$imag:r})}}),Tn=An({real_:function(e){var t=mn(e,"input","real");return Lt.runKernelFunc(function(e){return e.real(t)},{$input:t})}}),Nn=An({imag_:function(e){var t=mn(e,"input","imag");return Lt.runKernelFunc(function(e){return e.imag(t)},{$input:t})}});function Fn(e,t,n){return _n(e,t,pn(e,n),n)}function _n(e,t,n,r){if("complex64"===(r=null==r?j(e):r))throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!V(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=t){nt(t);var o=k(t),a=k(n);C(o===a,function(){return"Based on the provided shape, ["+t+"], the tensor should have "+o+" values but has "+a});for(var s=0;s<n.length;++s){var u=n[s],u=s!==n.length-1||u!==k(t.slice(s));C(n[s]===t[s]||!u,function(){return"Error creating a new Tensor. Inferred shape ("+n+") does not match the provided shape ("+t+"). "})}}return V(e)||Array.isArray(e)||(e=[e]),t=t||n,e="string"!==r?Q(e,r,i().getBool("DEBUG")):I(e,[],!0),Lt.makeTensor(e,t,r)}function On(e,t){if((V(e)&&"string"!==t||Array.isArray(e))&&"complex64"!==t)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===t&&V(e)&&!(e instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return _n(e,[],[],t)}function Mn(e,t){R(e);var n=pn(e,t);if(1!==n.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return _n(e,null,n,t)}function Bn(e,t,n){if(R(e),null!=t&&2!==t.length)throw new Error("tensor2d() requires shape to have two numbers");var r=pn(e,n);if(2!==r.length&&1!==r.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===r.length&&null==t)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return _n(e,t,r,n)}function Pn(e,t,n){if(R(e),null!=t&&3!==t.length)throw new Error("tensor3d() requires shape to have three numbers");var r=pn(e,n);if(3!==r.length&&1!==r.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===r.length&&null==t)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return _n(e,t,r,n)}function Ln(e,t,n){if(R(e),null!=t&&4!==t.length)throw new Error("tensor4d() requires shape to have four numbers");var r=pn(e,n);if(4!==r.length&&1!==r.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===r.length&&null==t)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return _n(e,t,r,n)}function Wn(e,t,n){if(R(e),null!=t&&5!==t.length)throw new Error("tensor5d() requires shape to have five numbers");var r=pn(e,n);if(5!==r.length&&1!==r.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===r.length&&null==t)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return _n(e,t,r,n)}function Un(e,t,n){if(R(e),null!=t&&6!==t.length)throw new Error("tensor6d() requires shape to have six numbers");var r=pn(e,n);if(6!==r.length&&1!==r.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===r.length&&null==t)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return _n(e,t=t||r,r,n)}function Vn(e,t,n,r){return Lt.makeVariable(e,t=void 0===t?!0:t,n,r)}function zn(e,t){if("complex64"===(t=void 0===t?"float32":t)){var n=zn(e,"float32"),r=Gn(e,"float32");return Dn(n,r)}r=Z(k(e),t);return Lt.makeTensor(r,e,t)}function Gn(e,t){if("complex64"===(t=void 0===t?"float32":t)){var n=Gn(e,"float32"),r=Gn(e,"float32");return Dn(n,r)}r=tt(k(e),t);return Lt.makeTensor(r,e,t)}function Hn(t,n,r){return Lt.runKernelFunc(function(e){return e.fill(t,n,r)},{})}function qn(t,n,r){if(r<=0)throw new Error("The number of values should be positive.");return Lt.runKernelFunc(function(e){return e.linspace(t,n,r)},{})}function Kn(e,t,n,r){if(void 0===r&&(r="float32"),0===(n=void 0===n?1:n))throw new Error("Cannot have a step of zero");if(e===t||e<t&&n<0||t<e&&1<n)return Gn([0],r);var o=tt(Math.abs(Math.ceil((t-e)/n)),r);t<e&&1===n&&(n=-1),o[0]=e;for(var i=1;i<o.length;i++)o[i]=o[i-1]+n;return Mn(o,r)}var jn=An({onesLike_:function(e){var t=mn(e,"x","onesLike");if("complex64"!==t.dtype)return Lt.runKernelFunc(function(e){return e.onesLike(t)},{$x:t},function(e,t){return{$x:function(){return Xn(e)}}});var n=jn(Tn(t)),e=Xn(Nn(t));return Dn(n,e)}}),Xn=An({zerosLike_:function(e){var t=mn(e,"x","zerosLike");return Lt.runKernelFunc(function(e){return e.zerosLike(t)},{$x:t},function(e,t){return{$x:function(){return Xn(e)}}})}}),Yn=An({concat_:function(e,n){void 0===n&&(n=0),C(1<=e.length,function(){return"Pass at least one tensor to concat"});var t=gn(e,"tensors","concat");"complex64"===t[0].dtype&&t.forEach(function(e){if("complex64"!==e.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+e.dtype+". ")}),n=O(n,t[0].shape)[0];var r=Sn(t.map(function(e){return e.shape}),n);if(0===k(r))return Fn([],r);if(1===(t=t.filter(function(e){return 0<e.size})).length)return t[0];var o=t.map(function(e){return e.shape});kn(o,n);e=t,r={axis:n};return Lt.runKernelFunc(function(e){return e.concat(t,n)},e,function(e){var t=o.map(function(e){return e[n]});return tr(e,t,n).map(function(e){return function(){return e}})},"Concat",r)}}),$n=An({concat1d_:function(e){return Yn(e,0)}}),Qn=An({concat2d_:function(e,t){return Yn(e,t)}}),Jn=An({concat3d_:function(e,t){return Yn(e,t)}}),Zn=An({concat4d_:function(e,t){return Yn(e,t)}}),tr=An({split_:function(e,t,n){void 0===n&&(n=0);var r,o=mn(e,"x","split");return n=O(n,o.shape)[0],r="number"==typeof t?(C(o.shape[n]%t==0,function(){return"Number of splits must evenly divide the axis."}),new Array(t).fill(o.shape[n]/t)):(C(o.shape[n]===t.reduce(function(e,t){return e+t}),function(){return"The sum of sizes must match the size of the axis dimension."}),t),Lt.runKernelFunc(function(e){return e.split(o,r,n)},{$x:o},function(e){return{$x:function(){return Yn(e,n)}}})}});function er(e,t){return e(t={exports:{}},t.exports),t.exports}var nr=er(function(e){!function(e){function o(e){var r,t=this,n=(r=4022871197,function(e){e=e.toString();for(var t=0;t<e.length;t++){var n=.02519603282416938*(r+=e.charCodeAt(t));n-=r=n>>>0,r=(n*=r)>>>0,r+=4294967296*(n-=r)}return 2.3283064365386963e-10*(r>>>0)});t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1)}function i(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function t(e,t){var n=new o(e),t=t&&t.state,r=n.next;return r.int32=function(){return 4294967296*n.next()|0},r.double=function(){return r()+11102230246251564e-32*(2097152*r()|0)},r.quick=r,t&&("object"==typeof t&&i(t,n),r.state=function(){return i(n,{})}),r}e&&e.exports?e.exports=t:this.alea=t}(e)}),rr=er(function(e){!function(e){function r(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),t.next()}function o(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function t(e,t){var n=new r(e),e=t&&t.state,t=function(){return(n.next()>>>0)/4294967296};return t.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},t.int32=n.next,t.quick=t,e&&("object"==typeof e&&o(e,n),t.state=function(){return o(n,{})}),t}e&&e.exports?e.exports=t:this.xor128=t}(e)}),or=er(function(e){!function(e){function r(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,e===((t.v=0)|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),r==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function o(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function t(e,t){var n=new r(e),e=t&&t.state,t=function(){return(n.next()>>>0)/4294967296};return t.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},t.int32=n.next,t.quick=t,e&&("object"==typeof e&&o(e,n),t.state=function(){return o(n,{})}),t}e&&e.exports?e.exports=t:this.xorwow=t}(e)}),ar=er(function(e){!function(e){function r(e){var o=this;o.next=function(){var e=o.x,t=o.i,n=e[t],r=(n^=n>>>7)^n<<24;return r^=(n=e[t+1&7])^n>>>10,r^=(n=e[t+3&7])^n>>>3,r^=(n=e[t+4&7])^n<<7,n=e[t+7&7],r^=(n^=n<<13)^n<<9,e[t]=r,o.i=t+1&7,r},function(e,t){var n,r=[];if(t===(0|t))r[0]=t;else for(t=""+t,n=0;n<t.length;++n)r[7&n]=r[7&n]<<15^t.charCodeAt(n)+r[n+1&7]<<13;for(;r.length<8;)r.push(0);for(n=0;n<8&&0===r[n];++n);for(8==n?r[7]=-1:r[n],e.x=r,e.i=0,n=256;0<n;--n)e.next()}(o,e)}function o(e,t){return t.x=e.x.slice(),t.i=e.i,t}function t(e,t){var n=new r(e=null==e?+new Date:e),e=t&&t.state,t=function(){return(n.next()>>>0)/4294967296};return t.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},t.int32=n.next,t.quick=t,e&&(e.x&&o(e,n),t.state=function(){return o(n,{})}),t}e&&e.exports?e.exports=t:this.xorshift7=t}(e)}),ir=er(function(e){!function(e){function r(e){var i=this;i.next=function(){var e,t,n=i.w,r=i.X,o=i.i;return i.w=n=n+1640531527|0,t=r[o+34&127],e=r[o=o+1&127],t^=t<<13,e^=e<<17,t=r[o]=(t^=t>>>15)^(e^=e>>>12),i.i=o,t+(n^n>>>16)|0},function(e,t){var n,r,o,i,a,s=[],u=128;for(t===(0|t)?(r=t,t=null):(t+="\0",r=0,u=Math.max(u,t.length)),o=0,i=-32;i<u;++i)t&&(r^=t.charCodeAt((i+32)%t.length)),0===i&&(a=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,0<=i&&(o=0==(n=s[127&i]^=r+(a=a+1640531527|0))?o+1:0);for(128<=o&&(s[127&(t&&t.length||0)]=-1),o=127,i=512;0<i;--i)r=s[o+34&127],n=s[o=o+1&127],r^=r<<13,n^=n<<17,s[o]=(r^=r>>>15)^(n^=n>>>12);e.w=a,e.X=s,e.i=o}(i,e)}function o(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function t(e,t){var n=new r(e=null==e?+new Date:e),e=t&&t.state,t=function(){return(n.next()>>>0)/4294967296};return t.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},t.int32=n.next,t.quick=t,e&&(e.X&&o(e,n),t.state=function(){return o(n,{})}),t}e&&e.exports?e.exports=t:this.xor4096=t}(e)}),sr=er(function(e){!function(e){function r(e){var o=this,t="";o.next=function(){var e=(e=o.b)<<25^e>>>7^(t=o.c),t=t-(n=o.d)|0,n=n<<24^n>>>8^(r=o.a),r=r-e|0;return o.b=e=e<<20^e>>>12^t,o.c=t=t-n|0,o.d=n<<16^t>>>16^r,o.a=r-e|0},o.a=0,o.b=0,o.c=-1640531527,o.d=1367130551,e===Math.floor(e)?(o.a=e/4294967296|0,o.b=0|e):t+=e;for(var n=0;n<t.length+20;n++)o.b^=0|t.charCodeAt(n),o.next()}function o(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function t(e,t){var n=new r(e),e=t&&t.state,t=function(){return(n.next()>>>0)/4294967296};return t.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},t.int32=n.next,t.quick=t,e&&("object"==typeof e&&o(e,n),t.state=function(){return o(n,{})}),t}e&&e.exports?e.exports=t:this.tychei=t}(e)}),ur=er(function(t){!function(i,a){var s,u=this,c=256,l=6,h="random",d=a.pow(c,l),p=a.pow(2,52),f=2*p,m=c-1;function e(e,t,n){var r=[],e=b(function e(t,n){var r,o=[],i=typeof t;if(n&&"object"==i)for(r in t)try{o.push(e(t[r],n-1))}catch(e){}return o.length?o:"string"==i?t:t+"\0"}((t=1==t?{entropy:!0}:t||{}).entropy?[e,y(i)]:null==e?function(){try{var e;return s&&(e=s.randomBytes)?e=e(c):(e=new Uint8Array(c),(u.crypto||u.msCrypto).getRandomValues(e)),y(e)}catch(e){var t=u.navigator,t=t&&t.plugins;return[+new Date,u,t,u.screen,y(i)]}}():e,3),r),o=new g(r),r=function(){for(var e=o.g(l),t=d,n=0;e<p;)e=(e+n)*c,t*=c,n=o.g(1);for(;f<=e;)e/=2,t/=2,n>>>=1;return(e+n)/t};return r.int32=function(){return 0|o.g(4)},r.quick=function(){return o.g(4)/4294967296},r.double=r,b(y(o.S),i),(t.pass||n||function(e,t,n,r){return r&&(r.S&&v(r,o),e.state=function(){return v(o,{})}),n?(a[h]=e,t):e})(r,e,"global"in t?t.global:this==a,t.state)}function g(e){var t,n=e.length,a=this,r=0,o=a.i=a.j=0,i=a.S=[];for(n||(e=[n++]);r<c;)i[r]=r++;for(r=0;r<c;r++)i[r]=i[o=m&o+e[r%n]+(t=i[r])],i[o]=t;(a.g=function(e){for(var t,n=0,r=a.i,o=a.j,i=a.S;e--;)t=i[r=m&r+1],n=n*c+i[m&(i[r]=i[o=m&o+t])+(i[o]=t)];return a.i=r,a.j=o,n})(c)}function v(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function b(e,t){for(var n,r=e+"",o=0;o<r.length;)t[m&o]=m&(n^=19*t[m&o])+r.charCodeAt(o++);return y(t)}function y(e){return String.fromCharCode.apply(0,e)}if(a["seed"+h]=e,b(a.random(),i),t.exports){t.exports=e;try{s=require("crypto")}catch(e){}}}([],Math)});ur.alea=nr,ur.xor128=rr,ur.xorwow=or,ur.xorshift7=ar,ur.xor4096=ir,ur.tychei=sr;var cr=ur.alea,lr=(eG.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var e=this.nextVal;return this.nextVal=NaN,e}for(var t=!1;!t;){for(var n=void 0,r=void 0,o=void 0;1<=(o=(n=2*this.random()-1)*n+(r=2*this.random()-1)*r)||0===o;);var i=Math.sqrt(-2*Math.log(o)/o),a=this.mean+this.stdDev*n*i,s=this.mean+this.stdDev*r*i;this.truncated&&!this.isValidTruncated(a)||(t=!0)}return this.truncated&&!this.isValidTruncated(s)||(this.nextVal=this.convertValue(s)),this.convertValue(a)},eG.prototype.convertValue=function(e){return null==this.dtype||"float32"===this.dtype?e:Math.round(e)},eG.prototype.isValidTruncated=function(e){return e<=this.upper&&e>=this.lower},eG),hr=(vG.prototype.nextValue=function(){for(var e,t,n,r,o;;){for(;n=this.randn.nextValue(),(o=1+this.c*n)<=0;);if(o*=o*o,e=1-.331*(r=n*n)*r,t=.5*r+this.d*(1-o+Math.log(o)),(r=this.randu())<e||Math.log(r)<t)break}return o=1/this.beta*this.d*o,this.alpha<1&&(o*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(o)},vG.prototype.convertValue=function(e){return"float32"===this.dtype?e:Math.round(e)},vG),fr=(IG.prototype.convertValue=function(e){return this.canReturnFloat()?e:Math.round(e)},IG.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},IG);function IG(e,t,n,r){var o=this;if(void 0===e&&(e=0),void 0===t&&(t=1),this.canReturnFloat=function(){return null==o.dtype||"float32"===o.dtype},this.min=e,this.range=t-e,this.dtype=n,"number"==typeof(r=null==r?Math.random():r)&&(r=r.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+e+" - "+t+" <= 1 and dtype is not float");this.random=cr(r)}function vG(e,t,n,r){this.alpha=e,this.beta=1/t,this.dtype=n;r=r||Math.random();this.randu=cr(r.toString()),this.randn=new lr(0,1,n,!1,this.randu()),this.d=e<1?e+2/3:e-1/3,this.c=1/Math.sqrt(9*this.d)}function eG(e,t,n,r,o){this.mean=e,this.stdDev=t,this.dtype=n,this.nextVal=NaN,this.truncated=r,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);o=o||Math.random();this.random=cr(o.toString())}function dr(e,t,n){return t=(t=void 0===t?"float32":t)||"float32",nt(e),new gt(e,t,n)}function pr(e,t){void 0===t&&(t=!1),console.log(e.toString(t))}var vr=An({batchToSpaceND_:function(e,t,n){var r=mn(e,"x","batchToSpaceND"),o=t.reduce(function(e,t){return e*t});return C(r.rank>=1+t.length,function(){return"input rank is "+r.rank+" but should be > than blockShape.length "+t.length}),C(n.length===t.length,function(){return"crops.length is "+n.length+" but should be equal to blockShape.length  "+t.length}),C(r.shape[0]%o==0,function(){return"input tensor batch is "+r.shape[0]+" but is not divisible by the product of the elements of blockShape "+t.join(" * ")+" === "+o}),Lt.runKernelFunc(function(e){return e.batchToSpaceND(r,t,n)},{$x:r},function(e){return{$x:function(){return e.spaceToBatchND(t,n)}}})}}),mr=An({broadcastTo_:function(e,t){var n=mn(e,"broadcastTo","x"),r=n.shape;if(t.some(function(e){return!(0<e)||e%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+t+"].");if(t.length<n.rank)throw new Error("broadcastTo(): shape.length="+t.length+" < input.rank="+n.rank+".");if(t.length>n.rank){for(var o=n.shape.slice();o.length<t.length;)o.unshift(1);n=n.reshape(o)}for(var i=Array.from(t),a=t.length-1;0<=a;a--)if(n.shape[a]===t[a])i[a]=1;else if(1!==n.shape[a])throw new Error("broadcastTo(): ["+r+"] cannot be broadcast to ["+t+"].");var s=i.map(function(e,t){return 1<e?t:-1}).filter(function(e){return 0<=e});return 0===s.length?n.clone():Lt.runKernelFunc(function(e){return e.tile(n,i)},{input:n},function(e){return{input:function(){return e.sum(s,!0)}}})}}),gr=An({cast_:function(e,t){var n=mn(e,"x","cast");if(!W(t))throw new Error("Failed to cast to unknown dtype "+t);if("string"===t&&"string"!==n.dtype||"string"!==t&&"string"===n.dtype)throw new Error("Only strings can be casted to strings");return Lt.runKernelFunc(function(e){return e.cast(n,t)},{x:n},function(e){return{x:function(){return e.clone()}}},"Cast",{dtype:t})}}),yr=An({clone_:function(e){var t=mn(e,"x","clone",null);return Lt.runKernelFunc(function(){return Lt.makeTensorFromDataId(t.dataId,t.shape,t.dtype)},{$x:t},function(e){return{$x:function(){return e.toFloat()}}})}}),xr=An({cumsum_:function(e,t,n,r){void 0===t&&(t=0),void 0===n&&(n=!1),void 0===r&&(r=!1);var o=mn(e,"x","cumsum"),e=En([t|=0],o.rank),i=o;null!=e&&(i=o.transpose(e));var a=In(1,o.rank)[0],o=Lt.runKernelFunc(function(e){return e.cumsum(i,a,n,r)},{permutedX:i},function(e){return{permutedX:function(){return e.cumsum(t,n,!r)}}});return o=null!=e?o.transpose(e):o}}),br=An({depthToSpace_:function(e,t,n){void 0===n&&(n="NHWC");var r=mn(e,"x","depthToSpace"),o="NHWC"===n?r.shape[1]:r.shape[2],i="NHWC"===n?r.shape[2]:r.shape[3],a="NHWC"===n?r.shape[3]:r.shape[1];return C(0<=o*t,function(){return"Negative dimension size caused by overflow when multiplying\n      "+o+" and "+t+"  for depthToSpace with input shape\n      "+r.shape}),C(0<=i*t,function(){return"Negative dimension size caused by overflow when multiplying\n      "+i+" and "+t+" for depthToSpace with input shape\n          "+r.shape}),C(a%(t*t)==0,function(){return"Dimension size must be evenly divisible by "+t*t+" but is "+a+" for depthToSpace with input shape "+r.shape}),Lt.runKernelFunc(function(e){return e.depthToSpace(r,t,n)},{$x:r})}}),wr=An({expandDims_:function(e,t){void 0===t&&(t=0);var n=mn(e,"x","expandDims",null);C(t<=n.rank,function(){return"Axis must be <= rank of the tensor"});e=n.shape.slice();return t<0&&(C(-(n.rank+1)<=t,function(){return"Axis must be in the interval ["+-(n.rank+1)+", "+n.rank+"]"}),t=n.rank+t+1),e.splice(t,0,1),Or(n,e)}}),Cr=An({eye_:function(e,t,n,r){for(var o=dr([e,t=null==t?e:t],r=void 0===r?"float32":r),i=e<=t?e:t,a=0;a<i;++a)o.set(1,a,a);t=o.toTensor().as2D(e,t);if(null==n)return t;if(1===n.length)return Lr(wr(t,0),[n[0],1,1]);if(2===n.length)return Lr(wr(wr(t,0),0),[n[0],n[1],1,1]);if(3===n.length)return Lr(wr(wr(wr(t,0),0),0),[n[0],n[1],n[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+n.length+"D.")}}),Er=An({multinomial_:function(e,t,n,r){void 0===r&&(r=!1);var o=mn(e,"logits","multinomial"),i=o.size,e=o.rank;if(i<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+i+".");if(2<e)throw new Error("Rank of probabilities must be 1 or 2, but is "+e);n=n||Math.random();var a=1===e?o.as2D(1,-1):o,o=Lt.runKernelFunc(function(e){return e.multinomial(a,r,t,n)},{logits2D:a});return 1===e?o.as1D():o}}),Rr=An({oneHot_:function(e,t,n,r){if(void 0===n&&(n=1),void 0===r&&(r=0),t<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+t);var e=(o=mn(e,"indices","oneHot","int32")).shape.concat([t]),o=o.flatten();return Lt.runKernelFunc(function(e){return e.oneHot(o,t,n,r)},{$indices:o},function(e){return{$indices:function(){return Gn(o.shape,"float32")}}}).reshape(e)}}),Ir=An({pad_:function(e,n,t){void 0===t&&(t=0);var r=mn(e,"x","pad");if(0===r.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");e={paddings:n,constantValue:t};return Lt.runKernelFunc(function(e){return e.pad(r,n,t)},{x:r},function(e){var t=n.map(function(e){return e[0]});return{x:function(){return e.slice(t,r.shape)}}},"PadV2",e)}}),kr=An({pad1d_:function(e,t,n){return void 0===n&&(n=0),C(2===t.length,function(){return"Invalid number of paddings. Must be length of 2."}),Ir(e,[t],n)}}),Sr=An({pad2d_:function(e,t,n){return void 0===n&&(n=0),C(2===t.length&&2===t[0].length&&2===t[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ir(e,t,n)}}),Ar=An({pad3d_:function(e,t,n){return void 0===n&&(n=0),C(3===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ir(e,t,n)}}),Dr=An({pad4d_:function(e,t,n){return void 0===n&&(n=0),C(4===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length&&2===t[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ir(e,t,n)}}),Tr=An({rand_:function(e,t,n){var r=k(e),o=null;if(null==n||"float32"===n)o=new Float32Array(r);else if("int32"===n)o=new Int32Array(r);else{if("bool"!==n)throw new Error("Unknown data type "+n);o=new Uint8Array(r)}for(var i=0;i<r;i++)o[i]=t();return Lt.makeTensor(o,e,n)}}),Nr=An({randomNormal_:function(e,t,n,r,o){if(void 0===t&&(t=0),void 0===n&&(n=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var i=new lr(t,n,r,!1,o),a=dr(e,r),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),Fr=An({randomGamma_:function(e,t,n,r,o){if(null==(n=void 0===n?1:n)&&(n=1),"float32"!==(r=null==(r=void 0===r?"float32":r)?"float32":r)&&"int32"!==r)throw new Error("Unsupported data type "+r);for(var i=new hr(t,n,r,o),a=dr(e,r),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),_r=An({randomUniform_:function(e,t,n,r,o){void 0===t&&(t=0),void 0===n&&(n=1);for(var i=dr(e,r=void 0===r?"float32":r),a=new fr(t,n,null,o),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),Or=An({reshape_:function(e,t){var n=mn(e,"x","reshape",null);t=_(t,n.size),C(n.size===k(t),function(){return"new shape and old shape must have the same number of elements."});e={shape:t};return Lt.runKernelFunc(function(e){return e.reshape(n,t)},{x:n},function(e){return{x:function(){return e.reshape(n.shape)}}},"Reshape",e)}}),Mr=An({spaceToBatchND_:function(e,r,o){var t=mn(e,"x","spaceToBatchND");return C(t.rank>=1+r.length,function(){return"input rank "+t.rank+" should be > than [blockShape] "+r.length}),C(o.length===r.length,function(){return"paddings.shape[0] "+o.length+" must be equal to [blockShape] "+r.length}),C(t.shape.reduce(function(e,t,n){return 0<n&&n<=r.length?e&&(t+o[n-1][0]+o[n-1][1])%r[n-1]==0:e},!0),function(){return"input spatial dimensions "+t.shape.slice(1)+" with paddings "+o.toString()+" must be divisible by blockShapes "+r.toString()}),Lt.runKernelFunc(function(e){return e.spaceToBatchND(t,r,o)},{$x:t},function(e){return{$x:function(){return e.batchToSpaceND(r,o)}}})}}),Br=An({squeeze_:function(e,t){e=mn(e,"x","squeeze");return Or(e,M(e.shape,t).newShape)}}),Pr=An({stack_:function(e,t){void 0===t&&(t=0);var n=gn(e,"tensors","stack");if(C(1<=n.length,function(){return"Pass at least one tensor to tf.stack"}),1===n.length)return n[0].expandDims(t);var e=n[0].rank,r=n[0].shape,o=n[0].dtype;C(t<=e,function(){return"Axis must be <= rank of the tensor"}),n.forEach(function(e){E(r,e.shape,"All tensors passed to stack must have matching shapes")}),n.forEach(function(e){C(o===e.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});n=n.map(function(e){return e.expandDims(t)});return Yn(n,t)}}),Lr=An({tile_:function(e,s){var n=mn(e,"x","tile",null);return C(n.rank===s.length,function(){return"Error in transpose: rank of input "+n.rank+" must match length of reps "+s+"."}),Lt.runKernelFunc(function(e,t){e=e.tile(n,s);return t([n]),e},{x:n},function(i,e){var a=e[0];return{x:function(){var e=Xn(a);if(1===a.rank)for(var t=0;t<s[0];++t)e=e.add(i.slice([t*a.shape[0]],[a.shape[0]]));else if(2===a.rank)for(t=0;t<s[0];++t)for(var n=0;n<s[1];++n)e=e.add(i.slice([t*a.shape[0],n*a.shape[1]],[a.shape[0],a.shape[1]]));else if(3===a.rank)for(t=0;t<s[0];++t)for(n=0;n<s[1];++n)for(var r=0;r<s[2];++r)e=e.add(i.slice([t*a.shape[0],n*a.shape[1],r*a.shape[2]],[a.shape[0],a.shape[1],a.shape[2]]));else{if(4!==a.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+a.rank+" tensors yet.");for(t=0;t<s[0];++t)for(n=0;n<s[1];++n)for(r=0;r<s[2];++r)for(var o=0;o<s[3];++o)e=e.add(i.slice([t*a.shape[0],n*a.shape[1],r*a.shape[2],o*a.shape[3]],[a.shape[0],a.shape[1],a.shape[2],a.shape[3]]))}return e}}},"Tile",{reps:s},[n])}}),Wr=An({truncatedNormal_:function(e,t,n,r,o){if(void 0===t&&(t=0),void 0===n&&(n=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var i=new lr(t,n,r,!0,o),a=dr(e,r),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),Ur=An({unstack_:function(e,t){t=(t=void 0===t?0:t)||0;var n=mn(e,"x","unstack");C(t>=-n.shape.length&&t<n.shape.length,function(){return"Axis = "+t+" is not in [-"+n.shape.length+", "+n.shape.length+")"}),t<0&&(t+=n.shape.length);e={axis:t};return Lt.runKernelFunc(function(e){return e.unstack(n,t)},{x:n},function(e){return{x:function(){return Pr(e,t)}}},"Unpack",e)}}),Vr=function(d,p){return n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c,l,h;return r(this,function(e){switch(e.label){case 0:return t=mn(d,"x","setdiff1d"),n=mn(p,"y","setdiff1d"),C(t.dtype===n.dtype,function(){return"x and y should have the same dtype, but got x ("+t.dtype+") and y ("+n.dtype+")."}),C(1===t.rank,function(){return"x should be 1D tensor, but got x ("+t.shape+")."}),C(1===n.rank,function(){return"y should be 1D tensor, but got y ("+n.shape+")."}),[4,t.data()];case 1:return o=e.sent(),[4,n.data()];case 2:for(i=e.sent(),a=new Set(i),l=s=0;l<o.length;l++)a.has(o[l])||s++;for(u=new gt([s],t.dtype),c=new gt([s],"int32"),h=l=0;l<o.length;l++)a.has(o[l])||(u.values[h]=o[l],c.values[h]=l,h++);return[2,[u.toTensor(),c.toTensor()]]}})})};function zr(e,t,n,r){var o=[];if(r=void 0===r?!0:r)(o=o.concat(t.slice(0))).push(e[0]/n),o=o.concat(e.slice(1));else{for(var o=o.concat(e[0]),i=t.length,a=0;a<i;++a)o=o.concat([e[a+1]/t[a],t[a]]);o=o.concat(e.slice(i+1))}return o}function Gr(e,t,n){var r=[];if(n=void 0===n?!0:n){r.push(t);for(var o=t+1;o<e;++o)o<=2*t?(r.push(o),r.push(o-(t+1))):r.push(o)}else{for(var i=[],a=[],o=1;o<e;++o)(2*t+1<=o||o%2==1?a:i).push(o);r.push.apply(r,i),r.push(0),r.push.apply(r,a)}return r}function Hr(e,t,n,r){var o=[];(r=void 0===r?!0:r)?o.push(e[0]/n):o.push(e[0]*n);for(var i=1;i<e.length;++i)i<=t.length?r?o.push(t[i-1]*e[i]):o.push(e[i]/t[i-1]):o.push(e[i]);return o}function qr(e,t){for(var n=[0],r=0;r<t;++r)n.push(e[r][0]);return n}function Kr(e,t,n){for(var r=e.slice(0,1),o=0;o<n;++o)r.push(e[o+1]-t[o][0]-t[o][1]);return r}function jr(e,t){if(e.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+e.rank+".");if(t.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if("int32"!==t.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+t.dtype+".");if(t.shape[t.rank-1]>e.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+t.shape[t.rank-1]+" vs. "+e.rank);if(0===e.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+e.shape+".");for(var n=t.shape,t=n[n.length-1],r=1,o=0;o<n.length-1;++o)r*=n[o];var i=e.shape,a=n.slice();a.pop();for(var s=1,o=t;o<e.rank;++o)s*=i[o],a.push(i[o]);t=$(e.shape).map(function(e){return e/s}).concat([1]).slice(0,t);return[a,r,s,t]}Object.freeze({prepareAndValidate:jr});var Yr=30;function $r(e){return e<=Yr?e:Y(e,Math.floor(Math.sqrt(e)))}function Qr(e,t,n){var r=1<t.rank?t.shape[t.rank-1]:1,o=1<t.rank?t.rank-1:1,i="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+n.shape+", indices.shape: "+t.shape+", shape: "+e+", sliceDim: "+r+", and batchDim: "+o+".";if(n.rank<o)throw new Error(i+" update.rank < "+o+". ");if(e.length<r+(n.rank-o))throw new Error(i+" Output shape length < "+(r+(n.rank-o)));if(n.rank!==o+e.length-r)throw new Error(i+" update.rank != "+(o+e.length-r));for(var a=0;a<o;++a)if(n.shape[a]!==t.shape[a])throw new Error(i+" updates.shape["+a+"] ("+n.shape[a]+") != indices.shape["+a+"] ("+t.shape[a]+").");for(a=0;a<n.rank-o;++a)if(n.shape[a+o]!==e[a+r])throw new Error(i+" updates.shape["+(a+o)+"] ("+n.shape[a+o]+") != shape["+(a+o)+"] ("+e[a+o]+")")}function Jr(e,t,n){if(t.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if(e.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+e.rank+".");if("int32"!==t.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+t.dtype);if(n.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+n);if(0===n.length){if(0===t.size)throw new Error("Indices specified for empty output. indices shape: "+t.shape);if(0===e.size)throw new Error("Updates specified for empty output. updates shape: "+e.shape)}Qr(n,t,e)}function Zr(e,t,n){for(var r=t.shape.length,o=1<r?t.shape[r-1]:1,i=n.length,a=1,s=o;s<i;++s)a*=n[s];r=o<1?1:o;return{sliceRank:o,numUpdates:k(t.shape)/r,sliceSize:a,strides:$(n.slice(0,o)).concat([1]),outputSize:k(n)}}function eo(t,n,r){C(t.rank===n.length,function(){return"Error in slice"+t.rank+"D: Length of begin "+n+" must match the rank of the array ("+t.rank+")."}),C(t.rank===r.length,function(){return"Error in slice"+t.rank+"D: Length of size "+r+" must match the rank of the array ("+t.rank+")."});for(var e=0;e<t.rank;++e)!function(e){C(n[e]+r[e]<=t.shape[e],function(){return"Error in slice"+t.rank+"D: begin["+e+"] + size["+e+"] ("+(n[e]+r[e])+") would overflow input.shape["+e+"] ("+t.shape[e]+")"})}(e)}function no(e){for(var t=[],n=0;0<e;)1&e&&t.push(n),e/=2,n++;return t}function ro(e,t,n){for(var r=[],o=0;o<e.length;o++)r[o]=Math.ceil((t[o]-e[o])/n[o]);return r}function oo(e,t,n,r,o){t=t[o],n=n[o]||1;(e&1<<o||null==t)&&(t=0<n?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);o=r[o];return t<0&&(t+=o),x(0,t,o-1)}function ao(e,t,n,r,o){t=t[o],n=n[o]||1;(e&1<<o||null==t)&&(t=0<n?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);o=r[o];return t<0&&(t+=o),0<n?x(0,t,o):x(-1,t,o-1)}function io(e,t,n){for(var r=n.length,o=0;o<n.length;o++)if(1<n[o]){r=o;break}for(o=r+1;o<n.length;o++)if(0<t[o]||n[o]!==e[o])return!1;return!0}function so(e,t){for(var n=0<e.length?e[e.length-1]:1,r=0;r<e.length-1;r++)n+=e[r]*t[r];return n}function po(e,t){C(X(e),function(){return"The f passed in variableGrads(f) must be a function"}),C(null==t||Array.isArray(t)&&t.every(function(e){return e instanceof St}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var n=null!=t;if(!n)for(var r in t=[],Lt.registeredVariables)t.push(Lt.registeredVariables[r]);var n=n?t.filter(function(e){return!e.trainable}):null,o=t.length;C(0<(t=t.filter(function(e){return e.trainable})).length,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+o+" variables is trainable."});var e=Lt.gradients(e,t,null,!0),i=e.value,a=e.grads;C(a.some(function(e){return null!=e}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),C(0===i.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+i.rank+" tensor"});var s={};return t.forEach(function(e,t){null!=a[t]&&(s[e.name]=a[t])}),null!=n&&n.forEach(function(e){return s[e.name]=null}),{value:i,grads:s}}function vo(e){return Lt.customGrad(e)}Object.freeze({validateUpdateShape:Qr,validateInput:Jr,calculateShapes:Zr}),Object.freeze({assertParamsValid:eo,maskToAxes:no,computeOutShape:ro,startForAxis:oo,stopForAxis:ao,isSliceContinous:io,computeFlatOffset:so});var go=An({softmax_:function(e,o){void 0===o&&(o=-1);var n=mn(e,"logits","softmax","float32");if((o=-1===o?n.rank-1:o)!==n.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+n.rank+" and dim was "+o);return Lt.runKernelFunc(function(e,t){e=e.softmax(n,o);return t([e]),e},{logits:n},function(e,t){var n=t[0],r=e.mul(n);return{logits:function(){return r.sub(r.sum([o],!0).mul(n))}}},"Softmax",{dim:o},[],[!0])}}),yo=An({logSoftmax_:function(e,r){void 0===r&&(r=-1);e=mn(e,"logits","logSoftmax");if((r=-1===r?e.rank-1:r)!==e.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and axis was "+r);return vo(function(e,t){var n=e.max(r,!0),n=e.sub(n),n=n.toFloat().sub(n.exp().sum(r,!0).log());return t([n]),{value:n,gradFunc:function(e,t){t=t[0].exp();return e.sub(e.sum(r,!0).mul(t))}}})(e)}}),xo=(jN.prototype.get=function(e){return this.data.has(e)||this.dataMover.moveData(this.backend,e),this.data.get(e)},jN.prototype.set=function(e,t){this.dataIdsCount++,this.data.set(e,t)},jN.prototype.has=function(e){return this.data.has(e)},jN.prototype.delete=function(e){return this.dataIdsCount--,this.data.delete(e)},jN.prototype.numDataIds=function(){return this.dataIdsCount},jN),bo=(rN.prototype.time=function(e){return wo("time")},rN.prototype.read=function(e){return wo("read")},rN.prototype.readSync=function(e){return wo("readSync")},rN.prototype.numDataIds=function(){return wo("numDataIds")},rN.prototype.disposeData=function(e){return wo("disposeData")},rN.prototype.write=function(e,t,n){return wo("write")},rN.prototype.move=function(e,t,n,r){return wo("move")},rN.prototype.memory=function(){return wo("memory")},rN.prototype.floatPrecision=function(){return wo("floatPrecision")},rN.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},rN.prototype.batchMatMul=function(e,t,n,r){return wo("batchMatMul")},rN.prototype.fusedBatchMatMul=function(e){return e.a,e.b,e.transposeA,e.transposeB,e.bias,e.activation,e.preluActivationWeights,wo("fusedBatchMatMul")},rN.prototype.slice=function(e,t,n){return wo("slice")},rN.prototype.stridedSlice=function(e,t,n,r){return wo("stridedSlice")},rN.prototype.unstack=function(e,t){return wo("unstack")},rN.prototype.reverse=function(e,t){return wo("reverse")},rN.prototype.concat=function(e,t){return wo("concat")},rN.prototype.neg=function(e){return wo("neg")},rN.prototype.add=function(e,t){return wo("add")},rN.prototype.addN=function(e){return wo("addN")},rN.prototype.subtract=function(e,t){return wo("subtract")},rN.prototype.multiply=function(e,t){return wo("multiply")},rN.prototype.realDivide=function(e,t){return wo("realDivide")},rN.prototype.floorDiv=function(e,t){return wo("floorDiv")},rN.prototype.sum=function(e,t){return wo("sum")},rN.prototype.prod=function(e,t){return wo("prod")},rN.prototype.unsortedSegmentSum=function(e,t,n){return wo("unsortedSegmentSum")},rN.prototype.argMin=function(e,t){return wo("argMin")},rN.prototype.argMax=function(e,t){return wo("argMax")},rN.prototype.equal=function(e,t){return wo("equal")},rN.prototype.notEqual=function(e,t){return wo("notEqual")},rN.prototype.less=function(e,t){return wo("less")},rN.prototype.lessEqual=function(e,t){return wo("lessEqual")},rN.prototype.greater=function(e,t){return wo("greater")},rN.prototype.greaterEqual=function(e,t){return wo("greaterEqual")},rN.prototype.logicalNot=function(e){return wo("logicalNot")},rN.prototype.logicalAnd=function(e,t){return wo("logicalAnd")},rN.prototype.logicalOr=function(e,t){return wo("logicalOr")},rN.prototype.where=function(e){return wo("where")},rN.prototype.select=function(e,t,n){return wo("select")},rN.prototype.topk=function(e,t,n){return wo("topk")},rN.prototype.min=function(e,t){return wo("min")},rN.prototype.minimum=function(e,t){return wo("minimum")},rN.prototype.mod=function(e,t){return wo("mod")},rN.prototype.max=function(e,t){return wo("max")},rN.prototype.maximum=function(e,t){return wo("maximum")},rN.prototype.all=function(e,t){return wo("all")},rN.prototype.any=function(e,t){return wo("any")},rN.prototype.squaredDifference=function(e,t){return wo("squaredDifference")},rN.prototype.ceil=function(e){return wo("ceil")},rN.prototype.floor=function(e){return wo("floor")},rN.prototype.round=function(e){return wo("round")},rN.prototype.sign=function(e){return wo("sign")},rN.prototype.isNaN=function(e){return wo("isNaN")},rN.prototype.isInf=function(e){return wo("isInf")},rN.prototype.isFinite=function(e){return wo("isFinite")},rN.prototype.pow=function(e,t){return wo("pow")},rN.prototype.exp=function(e){return wo("exp")},rN.prototype.expm1=function(e){return wo("expm1")},rN.prototype.softmax=function(e,t){return wo("softmax")},rN.prototype.log=function(e){return wo("log")},rN.prototype.log1p=function(e){return wo("log1p")},rN.prototype.sqrt=function(e){return wo("sqrt")},rN.prototype.rsqrt=function(e){return wo("rsqrt")},rN.prototype.square=function(e){return wo("square")},rN.prototype.reciprocal=function(e){return wo("reciprocal")},rN.prototype.relu=function(e){return wo("relu")},rN.prototype.relu6=function(e){return wo("relu6")},rN.prototype.prelu=function(e,t){return wo("prelu")},rN.prototype.elu=function(e){return wo("elu")},rN.prototype.eluDer=function(e,t){return wo("eluDer")},rN.prototype.selu=function(e){return wo("selu")},rN.prototype.int=function(e){return wo("int")},rN.prototype.clip=function(e,t,n){return wo("clip")},rN.prototype.abs=function(e){return wo("abs")},rN.prototype.complexAbs=function(e){return wo("complexAbs")},rN.prototype.sigmoid=function(e){return wo("sigmoid")},rN.prototype.softplus=function(e){return wo("softplus")},rN.prototype.sin=function(e){return wo("sin")},rN.prototype.cos=function(e){return wo("cos")},rN.prototype.tan=function(e){return wo("tan")},rN.prototype.asin=function(e){return wo("asin")},rN.prototype.acos=function(e){return wo("acos")},rN.prototype.atan=function(e){return wo("atan")},rN.prototype.atan2=function(e,t){return wo("atan2")},rN.prototype.sinh=function(e){return wo("sinh")},rN.prototype.cosh=function(e){return wo("cosh")},rN.prototype.tanh=function(e){return wo("tanh")},rN.prototype.asinh=function(e){return wo("asinh")},rN.prototype.acosh=function(e){return wo("acosh")},rN.prototype.atanh=function(e){return wo("atanh")},rN.prototype.erf=function(e){return wo("erf")},rN.prototype.step=function(e,t){return wo("step")},rN.prototype.fusedConv2d=function(e){return e.input,e.filter,e.convInfo,e.bias,e.activation,e.preluActivationWeights,wo("fusedConv2d")},rN.prototype.conv2d=function(e,t,n){return wo("conv2d")},rN.prototype.conv2dDerInput=function(e,t,n){return wo("conv2dDerInput")},rN.prototype.conv2dDerFilter=function(e,t,n){return wo("conv2dDerFilter")},rN.prototype.fusedDepthwiseConv2D=function(e){return e.input,e.filter,e.convInfo,e.bias,e.activation,e.preluActivationWeights,wo("fusedDepthwiseConv2D")},rN.prototype.depthwiseConv2D=function(e,t,n){return wo("depthwiseConv2D")},rN.prototype.depthwiseConv2DDerInput=function(e,t,n){return wo("depthwiseConv2DDerInput")},rN.prototype.depthwiseConv2DDerFilter=function(e,t,n){return wo("depthwiseConv2DDerFilter")},rN.prototype.conv3d=function(e,t,n){return wo("conv3d")},rN.prototype.conv3dDerInput=function(e,t,n){return wo("conv3dDerInput")},rN.prototype.conv3dDerFilter=function(e,t,n){return wo("conv3dDerFilter")},rN.prototype.maxPool=function(e,t){return wo("maxPool")},rN.prototype.maxPoolBackprop=function(e,t,n,r){return wo("maxPoolBackprop")},rN.prototype.avgPool=function(e,t){return wo("avgPool")},rN.prototype.avgPoolBackprop=function(e,t,n){return wo("avgPoolBackprop")},rN.prototype.avgPool3d=function(e,t){return wo("avgPool3d")},rN.prototype.avgPool3dBackprop=function(e,t,n){return wo("avgPool3dBackprop")},rN.prototype.maxPool3d=function(e,t){return wo("maxPool3d")},rN.prototype.maxPool3dBackprop=function(e,t,n,r){return wo("maxPool3dBackprop")},rN.prototype.reshape=function(e,t){return wo("reshape")},rN.prototype.cast=function(e,t){return wo("cast")},rN.prototype.tile=function(e,t){return wo("tile")},rN.prototype.pad=function(e,t,n){return wo("pad")},rN.prototype.transpose=function(e,t){return wo("transpose")},rN.prototype.gather=function(e,t,n){return wo("gather")},rN.prototype.gatherND=function(e,t){return wo("gatherND")},rN.prototype.scatterND=function(e,t,n){return wo("scatterND")},rN.prototype.batchToSpaceND=function(e,t,n){return wo("batchToSpaceND")},rN.prototype.spaceToBatchND=function(e,t,n){return wo("spaceToBatchND")},rN.prototype.resizeBilinear=function(e,t,n,r){return wo("resizeBilinear")},rN.prototype.resizeBilinearBackprop=function(e,t,n){return wo("resizeBilinearBackprop")},rN.prototype.resizeNearestNeighbor=function(e,t,n,r){return wo("resizeNearestNeighbor")},rN.prototype.resizeNearestNeighborBackprop=function(e,t,n){return wo("resizeNearestNeighborBackprop")},rN.prototype.batchNormalization=function(e,t,n,r,o,i){return wo("batchNormalization")},rN.prototype.localResponseNormalization4D=function(e,t,n,r,o){return wo("localResponseNormalization4D")},rN.prototype.LRNGrad=function(e,t,n,r,o,i,a){return wo("LRNGrad")},rN.prototype.multinomial=function(e,t,n,r){return wo("multinomial")},rN.prototype.oneHot=function(e,t,n,r){return wo("oneHot")},rN.prototype.cumsum=function(e,t,n,r){return wo("cumsum")},rN.prototype.nonMaxSuppression=function(e,t,n,r,o){return wo("nonMaxSuppression")},rN.prototype.fft=function(e){return wo("fft")},rN.prototype.ifft=function(e){return wo("ifft")},rN.prototype.complex=function(e,t){return wo("complex")},rN.prototype.real=function(e){return wo("real")},rN.prototype.imag=function(e){return wo("imag")},rN.prototype.cropAndResize=function(e,t,n,r,o,i){return wo("cropAndResize")},rN.prototype.depthToSpace=function(e,t,n){return wo("depthToSpace")},rN.prototype.split=function(e,t,n){return wo("split")},rN.prototype.sparseToDense=function(e,t,n,r){return wo("sparseToDense")},rN.prototype.diag=function(e){return wo("diag")},rN.prototype.fill=function(e,t,n){return wo("fill")},rN.prototype.onesLike=function(e){return wo("onesLike")},rN.prototype.zerosLike=function(e){return wo("zerosLike")},rN.prototype.linspace=function(e,t,n){return wo("linspace")},rN.prototype.dispose=function(){return wo("dispose")},rN);function rN(){}function jN(e,t){this.backend=e,this.dataMover=t,this.data=new WeakMap,this.dataIdsCount=0}function wo(e){throw new Error("'"+e+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function Co(e,t){for(var n=e.length,r=[],o=0;o<n;o++){var i=n-1-o,a=e[i]||1;1<(t[t.length-1-o]||1)&&1===a&&r.unshift(i)}return r}function Eo(e,t){for(var n=[],r=0;r<t.length;r++){var o=e[e.length-r-1],i=t.length-r-1,a=t[i];(null==o||1===o&&1<a)&&n.unshift(i)}return n}function Ro(e,t){for(var n=[],r=Math.max(e.length,t.length),o=0;o<r;o++){var i=e[e.length-o-1];null==i&&(i=1);var a=t[t.length-o-1];if(null==a&&(a=1),1===i)n.unshift(a);else if(1===a)n.unshift(i);else{if(i!==a)throw Error("Operands could not be broadcast together with shapes "+e+" and "+t+".");n.unshift(i)}}return n}function Io(e,t,n,r,o,i,a){void 0===a&&(a="channelsLast");var s,u=To(t),t=u[0],u=u[1];if("channelsLast"===a)s=[t,u,e[3],e[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);s=[t,u,e[1],e[1]]}return So(e,s,n,r,o,i,!1,a)}function ko(e,t,n,r,o,i,a){void 0===a&&(a="NDHWC");var s,u,c=No(t),l=c[0],t=c[1],c=c[2];if("NDHWC"===a)u="channelsLast",s=[l,t,c,e[4],e[4]];else{if("NCDHW"!==a)throw new Error("Unknown dataFormat "+a);u="channelsFirst",s=[l,t,c,e[1],e[1]]}return Ao(e,s,n,r,o,!1,u,i)}function So(e,t,n,r,o,f,i,a){void 0===i&&(i=!1);var s=[-1,-1,-1,-1],u=s[0],c=s[1],l=s[2],h=s[3];if("channelsLast"===(a=void 0===a?"channelsLast":a))u=e[0],c=e[1],l=e[2],h=e[3];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);u=e[0],h=e[1],c=e[2],l=e[3]}var d,p=t[0],m=t[1],g=t[3],v=To(n),b=v[0],y=v[1],x=To(r),w=x[0],s=x[1],n=Fo(p,w),v=Fo(m,s),r=function(e,t,n,r,o,i,a){if("number"==typeof e)var s={top:e,bottom:e,left:e,right:e,type:0===e?"VALID":"NUMBER"},u=function(e,t,n,r,o){null==r&&(r=Do(e,t,n));var i=e[1],a=_o((e[0]-t+2*r)/n+1,o);C(A(a),function(){return"The output # of rows ("+a+") must be an integer. Change the stride and/or zero pad parameters"});var s=_o((i-t+2*r)/n+1,o);return C(A(s),function(){return"The output # of columns ("+s+") must be an integer. Change the stride and/or zero pad parameters"}),[a,s]}([t,n],i,r,e,f),c=u[0],l=u[1];else if("same"===e){c=Math.ceil(t/r),l=Math.ceil(n/o);var h=Math.max(0,(c-1)*r+i-t),d=Math.max(0,(l-1)*o+a-n),p=Math.floor(h/2),u=h-p,h=Math.floor(d/2);s={top:p,bottom:u,left:h,right:d-h,type:"SAME"}}else{if("valid"!==e)throw Error("Unknown padding parameter: "+e);s={top:0,bottom:0,left:0,right:0,type:"VALID"},c=Math.ceil((t-i+1)/r),l=Math.ceil((n-a+1)/o)}return{padInfo:s,outHeight:c,outWidth:l}}(o,c,l,b,y,n,v),x=r.padInfo,o=r.outHeight,r=r.outWidth,g=i?g*h:g;return"channelsFirst"===a?d=[u,g,o,r]:"channelsLast"===a&&(d=[u,o,r,g]),{batchSize:u,dataFormat:a,inHeight:c,inWidth:l,inChannels:h,outHeight:o,outWidth:r,outChannels:g,padInfo:x,strideHeight:b,strideWidth:y,filterHeight:p,filterWidth:m,effectiveFilterHeight:n,effectiveFilterWidth:v,dilationHeight:w,dilationWidth:s,inShape:e,outShape:d,filterShape:t}}function Ao(e,t,n,r,o,i,a,x){void 0===i&&(i=!1);var s=[-1,-1,-1,-1,-1],u=s[0],c=s[1],l=s[2],h=s[3],d=s[4];if("channelsLast"===(a=void 0===a?"channelsLast":a))u=e[0],c=e[1],l=e[2],h=e[3],d=e[4];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);u=e[0],d=e[1],c=e[2],l=e[3],h=e[4]}var p,f=t[0],m=t[1],g=t[2],v=t[4],b=No(n),y=b[0],w=b[1],E=b[2],_=No(r),S=_[0],R=_[1],T=_[2],k=Fo(f,S),s=Fo(m,R),n=Fo(g,T),b=function(e,t,n,r,o,i,a,s,u,c){if("number"==typeof e)var l={top:e,bottom:e,left:e,right:e,front:e,back:e,type:0===e?"VALID":"NUMBER"},h=function(e,t,n,r,o){null==r&&(r=Do(e,t,n));var i=e[1],a=e[2],s=_o((e[0]-t+2*r)/n+1,o);C(A(s),function(){return"The output # of depths ("+s+") must be an integer. Change the stride and/or zero pad parameters"});var u=_o((i-t+2*r)/n+1,o);C(A(u),function(){return"The output # of rows ("+u+") must be an integer. Change the stride and/or zero pad parameters"});var c=_o((a-t+2*r)/n+1,o);return C(A(c),function(){return"The output # of columns ("+c+") must be an integer. Change the stride and/or zero pad parameters"}),[s,u,c,1]}([t,n,r,1],s,o,e,x),d=h[0],p=h[1],f=h[2];else if("same"===e){var m=((d=Math.ceil(t/o))-1)*o+s-t,g=((p=Math.ceil(n/i))-1)*i+u-n,v=((f=Math.ceil(r/a))-1)*a+c-r,b=Math.floor(m/2),y=m-b,h=Math.floor(g/2),m=g-h,g=Math.floor(v/2);l={top:h,bottom:m,left:g,right:v-g,front:b,back:y,type:"SAME"}}else{if("valid"!==e)throw Error("Unknown padding parameter: "+e);l={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},d=Math.ceil((t-s+1)/o),p=Math.ceil((n-u+1)/i),f=Math.ceil((r-c+1)/a)}return{padInfo:l,outDepth:d,outHeight:p,outWidth:f}}(o,c,l,h,y,w,E,k,s,n),r=b.padInfo,_=b.outDepth,o=b.outHeight,b=b.outWidth,v=i?v*d:v;return"channelsFirst"===a?p=[u,v,_,o,b]:"channelsLast"===a&&(p=[u,_,o,b,v]),{batchSize:u,dataFormat:a,inDepth:c,inHeight:l,inWidth:h,inChannels:d,outDepth:_,outHeight:o,outWidth:b,outChannels:v,padInfo:r,strideDepth:y,strideHeight:w,strideWidth:E,filterDepth:f,filterHeight:m,filterWidth:g,effectiveFilterDepth:k,effectiveFilterHeight:s,effectiveFilterWidth:n,dilationDepth:S,dilationHeight:R,dilationWidth:T,inShape:e,outShape:p,filterShape:t}}function Do(e,t,n,r){r=Fo(t,r=void 0===r?1:r);return Math.floor((e[0]*(n-1)-n+r)/2)}function To(e){return"number"==typeof e?[e,e,e]:2===e.length?[e[0],e[1],1]:e}function No(e){return"number"==typeof e?[e,e,e]:e}function Fo(e,t){return t<=1?e:e+(e-1)*(t-1)}function _o(e,t){if(!t)return e;switch(t){case"round":return Math.round(e);case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:throw new Error("Unknown roundingMode "+t)}}function Oo(e){var t=To(e),n=t[0],e=t[1],t=t[2];return 1===n&&1===e&&1===t}function Mo(e,t){return Oo(e)||Oo(t)}function Bo(e){if("NHWC"===e)return"channelsLast";if("NCHW"===e)return"channelsFirst";throw new Error("Unknown dataFormat "+e)}function Po(e,t,n){if("complex64"===t){if("complex64"===e.dtype)return e.clone();var r=Gn(e.shape),o=e.toFloat(),i=n.complex(o,r);return r.dispose(),o.dispose(),i}if(!U(e.dtype,t))return Lt.makeTensorFromDataId(e.dataId,e.shape,t);if("complex64"===e.dtype){o=n.real(e),i=o.cast(t);return o.dispose(),i}if("int32"===t)return n.int(e);if("bool"!==t)throw new Error("Error in Cast: failed to cast "+e.dtype+" to "+t);t=On(0,e.dtype);return i=n.notEqual(e,t),t.dispose(),i}function Lo(e,t){return Lt.makeTensorFromDataId(e.dataId,t,e.dtype)}function Wo(e,t,n){var r=(t-e)/(n-1),o=tt(n,"float32");o[0]=e;for(var i=1;i<o.length;i++)o[i]=o[i-1]+r;return Mn(o,"float32")}function Vo(e,t){if(e.length!==t.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+e.length+", imag: "+t.length+".");for(var n=new Float32Array(2*e.length),r=0;r<n.length;r+=2)n[r]=e[r/2],n[r+1]=t[r/2];return n}function zo(e,t){return{real:e[2*t],imag:e[2*t+1]}}function Go(e,t,n,r){e[2*r]=t,e[2*r+1]=n}function Ho(e,t,n){t=(n?2:-2)*Math.PI*(e/t);return{real:Math.cos(t),imag:Math.sin(t)}}function qo(e,t,n){n=function(e,t,n){for(var r,o=0,i=e.length,a=!1;o<i;){var s=n(t,e[r=o+(i-o>>>1)]);0<s?o=r+1:(i=r,a=!s)}return a?o:-o-1}(e,t,n||Ko);e.splice(n<0?-(n+1):n,0,t)}function Ko(e,t){return t<e?1:e<t?-1:0}function jo(e,t,n,r,o){return Yo(e,t,n,r,o,0).selectedIndices}function Xo(e,t,n,r,o,i){i=Yo(e,t,n,r,o,i);return i.numValidOutputs.dispose(),{selectedIndices:i.selectedIndices,selectedScores:i.selectedScores}}function Yo(e,t,n,r,o,i,a,s){void 0===s&&(s=!1);for(var u=Array.from(t).map(function(e,t){return{score:e,boxIndex:t,suppressBeginIndex:0}}).filter(function(e){return e.score>o}).sort(Jo),c=0<i?-.5/i:0,l=[],h=[];l.length<n&&0<u.length;){var d=u.pop(),p=d.score,f=d.boxIndex,m=d.suppressBeginIndex;if(p<o)break;for(var g=!1,v=l.length-1;m<=v;--v){var b=$o(e,f,l[v]);if(r<=b){g=!0;break}if(d.score=d.score*Qo(r,c,b),d.score<=o)break}d.suppressBeginIndex=l.length,g||(d.score===p?(l.push(f),h.push(d.score)):d.score>o&&qo(u,d,Jo))}i=l.length;return s&&(l.fill(0,i),h.fill(0,i)),{selectedIndices:Mn(l,"int32"),selectedScores:Mn(h,"float32"),numValidOutputs:On(i,"int32")}}function $o(e,t,n){var r=e.subarray(4*t,4*t+4),o=e.subarray(4*n,4*n+4),i=Math.min(r[0],r[2]),a=Math.min(r[1],r[3]),s=Math.max(r[0],r[2]),u=Math.max(r[1],r[3]),c=Math.min(o[0],o[2]),t=Math.min(o[1],o[3]),e=Math.max(o[0],o[2]),n=Math.max(o[1],o[3]),r=(s-i)*(u-a),o=(e-c)*(n-t);if(r<=0||o<=0)return 0;c=Math.max(i,c),t=Math.max(a,t),e=Math.min(s,e),n=Math.min(u,n),t=Math.max(e-c,0)*Math.max(n-t,0);return t/(r+o-t)}function Qo(e,t,n){t=Math.exp(t*n*n);return n<=e?t:0}function Jo(e,t){return e.score-t.score||e.score===t.score&&t.boxIndex-e.boxIndex}function Zo(n,e,r){var o=new Array(n.rank).fill(0),i=n.shape.slice();return e.map(function(e){i[r]=e;var t=n.slice(o,i);return o[r]+=e,t})}function ta(e,t){for(var n=new Array(e.rank),r=0;r<n.length;r++)n[r]=e.shape[r]*t[r];for(var o=dr(n,e.dtype),r=0;r<o.values.length;++r){for(var i=o.indexToLoc(r),a=new Array(e.rank),s=0;s<a.length;s++)a[s]=i[s]%e.shape[s];var u=e.locToIndex(a);o.values[r]=e.values[u]}return o.toTensor()}function ea(e,t,n,r,o){for(var i=t[t.length-1],i=[e.length/i,i],a=i[0],s=i[1],u=B(n,a*r),c=B("int32",a*r),l=0;l<a;l++){for(var h=l*s,d=e.subarray(h,h+s),p=[],f=0;f<d.length;f++)p.push({value:d[f],index:f});p.sort(function(e,t){return t.value-e.value});for(var h=l*r,m=u.subarray(h,h+r),g=c.subarray(h,h+r),f=0;f<r;f++)m[f]=p[f].value,g[f]=p[f].index}t=t.slice();return t[t.length-1]=r,[Fn(u,t,n),Fn(c,t,"int32")]}function na(e,t){for(var n=[],r=0;r<t.length;r++)t[r]&&n.push(r);for(var o=dr(e,"int32"),i=dr([n.length,e.length],"int32"),r=0;r<n.length;r++){var a=o.indexToLoc(n[r]),s=r*e.length;i.values.set(a,s)}return i.toTensor()}Object.freeze({castTensor:Po,reshapeTensor:Lo,linspaceImpl:Wo,upcastType:Dt,axesAreInnerMostDims:yn,combineLocations:xn,computeOutAndReduceShapes:bn,expandShapeToKeepDim:wn,assertAxesAreInnerMostDims:Cn,getAxesPermutation:En,getUndoAxesPermutation:Rn,getInnerMostAxes:In,getBroadcastDims:Co,getReductionAxes:Eo,assertAndGetBroadcastShape:Ro,assertParamsConsistent:kn,computeOutShape:Sn,computePool2DInfo:Io,computePool3DInfo:ko,computeConv2DInfo:So,computeConv3DInfo:Ao,computeDefaultPad:Do,tupleValuesAreOne:Oo,eitherStridesOrDilationsAreOne:Mo,convertConv2DDataFormat:Bo,PARALLELIZE_THRESHOLD:Yr,computeOptimalWindowSize:$r});var ra=function(e,t){this.outputShape=[],this.outputShape=e,this.variableNames=t.map(function(e,t){return"T"+t});var n=[];this.variableNames.forEach(function(e){n.push("float v"+e+" = get"+e+"AtOutCoords();")});t=this.variableNames.map(function(e){return"v"+e}).join(" + ");this.userCode="\n      void main() {\n        "+n.join("\n        ")+"\n\n        float result = "+t+";\n        setOutput(result);\n      }\n    "},oa=function(e,t){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.variableNames=t.map(function(e,t){return"T"+t});var n=[];this.variableNames.forEach(function(e){n.push("vec4 v"+e+" = get"+e+"AtOutCoords();")});t=this.variableNames.map(function(e){return"v"+e}).join(" + ");this.userCode="\n      void main() {\n        "+n.join("\n        ")+"\n\n        vec4 result = "+t+";\n        setOutput(result);\n      }\n    "},aa=function(e,t,n){this.variableNames=["A"];var r=e.windowSize,o=e.batchSize,e=e.inSize,e=Math.ceil(e/r);n||this.variableNames.push("bestIndicesA"),this.outputShape=[o,e],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+r+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+r+"; i++) {\n          int inIdx = "+(n?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===t?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};function ia(t,e){return["x","y","z","w","u","v"].slice(0,e).map(function(e){return t+"."+e})}function sa(e,t){return 1===t?[e]:ia(e,t)}function ua(){var e,t,n,r,o,a,s,u,c,l=2===i().getNumber("WEBGL_VERSION")?(e="#version 300 es",n="out",r=t="in",o="texture",a="outputColor",s="out vec4 outputColor;",u="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",c="","\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(t="attribute",r=n="varying",o="texture2D",a="gl_FragColor",s=e="",u="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",c="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ","\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    ");return{version:e,attribute:t,varyingVs:n,varyingFs:r,texture2D:o,output:a,defineOutput:s,defineSpecialNaN:u,defineSpecialInf:c,defineRound:l}}function ca(n,e,r){void 0===r&&(r="index");var o=$(e);return o.map(function(e,t){return"int "+n[t]+" = "+r+" / "+e+"; "+(t===o.length-1?"int "+n[t+1]+" = "+r+" - "+n[t]+" * "+e:"index -= "+n[t]+" * "+e)+";"}).join("")}function la(e){e=$(e).map(function(e){return e.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+e[0]+" + coords.y * "+e[1]+" + coords.z;\n  }\n"}var ha="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function fa(e,t,n,g){var r=[];e.forEach(function(e){var t=k(e.shapeInfo.logicalShape);e.shapeInfo.isUniform?r.push("uniform float "+e.name+(1<t?"["+t+"]":"")+";"):(r.push("uniform sampler2D "+e.name+";"),r.push("uniform int offset"+e.name+";"))});var o,i=r.join("\n"),a=e.map(function(e){return function(e,t,n){var r="";r+=((n=void 0===g?!1:g)?pa:da)(e);var o,i,a,s,u,c,l,h,d,p,f=e.shapeInfo.logicalShape,m=t.logicalShape;return f.length<=m.length&&(r+=n?(i=t,a=(o=e).name,s=a.charAt(0).toUpperCase()+a.slice(1),u="get"+s+"AtOutCoords",c=o.shapeInfo.logicalShape.length,l=i.logicalShape.length,h=Co(o.shapeInfo.logicalShape,i.logicalShape),f=wa(l),d=l-c,p=["x","y","z","w","u","v"],m=0===c?"":l<2&&1<=h.length?"coords = 0;":h.map(function(e){return"coords."+p[e+d]+" = 0;"}).join("\n"),n=l<2&&0<c?"coords":o.shapeInfo.logicalShape.map(function(e,t){return"coords."+p[t+d]}).join(", "),a="return outputValue;",o=1===k(o.shapeInfo.logicalShape),i=1===k(i.logicalShape),1!==c||o||i?o&&!i?a=1===l?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ":h.length&&(l=c-1,-1<h.indexOf(c=c-2)&&-1<h.indexOf(l)?a="return vec4(outputValue.x);":-1<h.indexOf(c)?a="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":-1<h.indexOf(l)&&(a="return vec4(outputValue.xx, outputValue.zz);")):a="\n      return vec4(outputValue.xy, outputValue.xy);\n    ","\n    vec4 "+u+"() {\n      "+f+" coords = getOutputCoords();\n      "+m+"\n      vec4 outputValue = get"+s+"("+n+");\n      "+a+"\n    }\n  "):function(e,t){var n=e.name,r=n.charAt(0).toUpperCase()+n.slice(1),o="get"+r+"AtOutCoords",i=t.texShape,a=e.shapeInfo.texShape,s=e.shapeInfo.logicalShape.length,u=t.logicalShape.length;if(!e.shapeInfo.isUniform&&s===u&&null==e.shapeInfo.flatOffset&&S(a,i))return"\n      float "+o+"() {\n        return sampleTexture("+n+", resultUV);\n      }\n    ";var n=wa(u),t=Co(e.shapeInfo.logicalShape,t.logicalShape),c=u-s,l=["x","y","z","w","u","v"];return"\n    float "+o+"() {\n      "+n+" coords = getOutputCoords();\n      "+(0===s?"":u<2&&1<=t.length?"coords = 0;":t.map(function(e){return"coords."+l[e+c]+" = 0;"}).join("\n"))+"\n      return get"+r+"("+(u<2&&0<s?"coords":e.shapeInfo.logicalShape.map(function(e,t){return"coords."+l[t+c]}).join(", "))+");\n    }\n  "}(e,t)),r}(e,t,g)}).join("\n"),s=t.texShape,u=ua(),c="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+u.texture2D+"(textureSampler, uv).r;\n    }\n  ",e=u.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+u.varyingFs+" vec2 resultUV;\n    "+u.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+u.defineSpecialNaN+"\n    "+u.defineSpecialInf+"\n    "+u.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    "+va+"\n    "+ma+"\n    "+ga+"\n  ",u=t.isPacked?(o=function(e,t){switch(e.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(e){e=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];return 1===e[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+e[1]+".0);\n      }\n    ":1===e[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+e[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+e[0]+", "+e[1]+"));\n      return 2 * (resTexRC.x * "+e[1]+" + resTexRC.y);\n    }\n  "}(t);case 2:return function(e,t){var n=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)];if(S(e,t))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+n[0]+", "+n[1]+"));\n      }\n    ";e=Math.ceil(e[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n      int r = 2 * (index / "+e+");\n      int c = imod(index, "+e+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(e,t);case 3:return o=e,r=t,n=[Math.ceil(r[0]/2),Math.ceil(r[1]/2)],o=(r=Math.ceil(o[2]/2))*Math.ceil(o[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n\n      int b = index / "+o+";\n      index -= b * "+o+";\n\n      int r = 2 * (index / "+r+");\n      int c = imod(index, "+r+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(e,t){for(var n=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)],r=Math.ceil(e[e.length-1]/2),t=r*Math.ceil(e[e.length-2]/2),o=t,i="",a="b, r, c",s=2;s<e.length-1;s++)i="\n      int b"+s+" = index / "+(o*=e[e.length-s-1])+";\n      index -= b"+s+" * "+o+";\n    "+i,a="b"+s+", "+a;return"\n    ivec"+e.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+n[0]+", "+n[1]+"));\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n\n      "+i+"\n\n      int b = index / "+t+";\n      index -= b * "+t+";\n\n      int r = 2 * (index / "+r+");\n      int c = imod(index, "+r+") * 2;\n\n      return ivec"+e.length+"("+a+");\n    }\n  "}(e,t)}var n,r,o}(t.logicalShape,s),"\n    void setOutput(vec4 val) {\n      "+u.output+" = val;\n    }\n  "):(o=function(e,t){switch(e.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===t[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+t[1]+".0);\n      }\n    ":1===t[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+t[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+t[0]+", "+t[1]+"));\n      return resTexRC.x * "+t[1]+" + resTexRC.y;\n    }\n  ";case 2:return S(o=e,i=t)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+i[0]+", "+i[1]+"));\n      }\n    ":1===o[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+i[0]+", "+i[1]+"));\n        int index = resTexRC.x * "+i[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===o[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+i[0]+", "+i[1]+"));\n        int index = resTexRC.x * "+i[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+i[0]+", "+i[1]+"));\n      int index = resTexRC.x * "+i[1]+" + resTexRC.y;\n      int r = index / "+o[1]+";\n      int c = index - r * "+o[1]+";\n      return ivec2(r, c);\n    }\n  ";case 3:return a=t,s=ca(["r","c","d"],e),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+a[0]+", "+a[1]+"));\n      int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n      "+s+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return a=t,s=ca(["r","c","d","d2"],e),"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+a[0]+", "+a[1]+"));\n      int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n      "+s+"\n      return ivec4(r, c, d, d2);\n    }\n  ";case 5:return n=t,r=ca(["r","c","d","d2","d3"],e),"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+n[0]+",\n                             "+n[1]+"));\n\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n\n      "+r+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  ";case 6:return n=t,r=ca(["r","c","d","d2","d3","d4"],e),"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+n[0]+", "+n[1]+"));\n      int index = resTexRC.x * "+n[1]+" + resTexRC.y;\n\n      "+r+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  ";default:throw new Error(e.length+"-D output sampling is not yet supported")}var n,r,o,i,a,s}(t.logicalShape,s),"\n    void setOutput(float val) {\n      "+u.output+" = vec4(val, 0, 0, 0);\n    }\n  ");return g&&(e+=ya),[e,c,u,i,o,a,n].join("\n")}function da(e){var t=e.shapeInfo.logicalShape;switch(t.length){case 0:return function(e){var t=e.name,n="get"+t.charAt(0).toUpperCase()+t.slice(1);if(e.shapeInfo.isUniform)return"float "+n+"() {return "+t+";}";var r=e.shapeInfo.texShape,o=r[0],r=r[1];if(1===o&&1===r)return"\n      float "+n+"() {\n        return sampleTexture("+t+", halfCR);\n      }\n    ";e=e.shapeInfo.texShape;return"\n    float "+n+"() {\n      vec2 uv = uvFromFlat("+e[0]+", "+e[1]+", "+xa(t)+");\n      return sampleTexture("+t+", uv);\n    }\n  "}(e);case 1:return function(e){var t=e.name,n="get"+t.charAt(0).toUpperCase()+t.slice(1);if(e.shapeInfo.isUniform)return"\n      float "+n+"(int index) {\n        "+ba(e)+"\n      }\n    ";var r=e.shapeInfo.texShape,o=r[0],e=r[1];if(1===e&&1===o)return"\n      float "+n+"(int index) {\n        return sampleTexture("+t+", halfCR);\n      }\n    ";r=xa(t);return 1===e?"\n      float "+n+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+r+") + 0.5) / "+o+".0);\n        return sampleTexture("+t+", uv);\n      }\n    ":1===o?"\n      float "+n+"(int index) {\n        vec2 uv = vec2((float(index + "+r+") + 0.5) / "+e+".0, 0.5);\n        return sampleTexture("+t+", uv);\n      }\n    ":"\n    float "+n+"(int index) {\n      vec2 uv = uvFromFlat("+o+", "+e+", index + "+r+");\n      return sampleTexture("+t+", uv);\n    }\n  "}(e);case 2:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=e.shapeInfo.texShape;if(null!=o&&S(t,o)){var i=o[0];return"\n    float "+r+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+o[1]+".0, "+i+".0);\n      return sampleTexture("+n+", uv);\n    }\n  "}var a=M(t),i=a.newShape,a=a.keptDims,i=i;if(i.length<t.length)return"\n      "+da(Ca(e,i))+"\n      float "+r+"(int row, int col) {\n        return "+r+"("+Ea(["row","col"],a)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+r+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+t[1]+", 1)));\n        "+ba(e)+"\n      }\n    ";a=o[0],e=o[1],o=xa(n);return 1===e?"\n    float "+r+"(int row, int col) {\n      float index = dot(vec3(row, col, "+o+"), vec3("+t[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+a+".0);\n      return sampleTexture("+n+", uv);\n    }\n  ":1===a?"\n    float "+r+"(int row, int col) {\n      float index = dot(vec3(row, col, "+o+"), vec3("+t[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+e+".0, 0.5);\n      return sampleTexture("+n+", uv);\n    }\n  ":"\n  float "+r+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+t[1]+" + col + "+o+";\n    vec2 uv = uvFromFlat("+a+", "+e+", index);\n    return sampleTexture("+n+", uv);\n  }\n"}(e);case 3:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=t[1]*t[2],i=t[2],a=M(t),s=a.newShape,a=a.keptDims,s=s;if(s.length<t.length)return"\n        "+da(Ca(e,s))+"\n        float "+r+"(int row, int col, int depth) {\n          return "+r+"("+Ea(["row","col","depth"],a)+");\n        }\n      ";if(e.shapeInfo.isUniform)return"\n      float "+r+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+o+", "+i+", 1)));\n        "+ba(e)+"\n      }\n    ";s=e.shapeInfo.texShape,a=s[0],s=s[1],e=e.shapeInfo.flatOffset;return s===o&&null==e?"\n        float "+r+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+i+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+s+".0, "+a+".0);\n          return sampleTexture("+n+", uv);\n        }\n      ":s===i&&null==e?"\n    float "+r+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+t[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+s+".0, "+a+".0);\n      return sampleTexture("+n+", uv);\n    }\n  ":"\n      float "+r+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+o+" + col * "+i+" + depth + "+xa(n)+";\n        vec2 uv = uvFromFlat("+a+", "+s+", index);\n        return sampleTexture("+n+", uv);\n      }\n  "}(e);case 4:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=t[3],i=t[2]*o,a=t[1]*i,s=M(t),u=s.newShape,s=s.keptDims;if(u.length<t.length)return"\n      "+da(Ca(e,u))+"\n      float "+r+"(int row, int col, int depth, int depth2) {\n        return "+r+"("+Ea(["row","col","depth","depth2"],s)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+r+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+a+", "+i+", "+o+", 1)));\n        "+ba(e)+"\n      }\n    ";u=e.shapeInfo.flatOffset,s=e.shapeInfo.texShape,e=s[0],s=s[1];return s===a&&null==u?"\n      float "+r+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+i+", "+o+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+s+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":s===o&&null==u?"\n      float "+r+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+t[1]*t[2]+", "+t[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+s+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":"\n    float "+r+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+a+" + col * "+i+" +\n          depth * "+o+" + depth2;\n      vec2 uv = uvFromFlat("+e+", "+s+", index + "+xa(n)+");\n      return sampleTexture("+n+", uv);\n    }\n  "}(e);case 5:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=t[4],i=t[3]*o,a=t[2]*i,s=t[1]*a,u=M(t),c=u.newShape,u=u.keptDims;if(c.length<t.length)return"\n      "+da(Ca(e,c))+"\n      float "+r+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+r+"("+Ea(["row","col","depth","depth2","depth3"],u)+");\n      }\n    ";if(e.shapeInfo.isUniform)return"\n      float "+r+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+s+", "+a+", "+i+", "+o+")) +\n          depth3;\n        "+ba(e)+"\n      }\n    ";c=e.shapeInfo.flatOffset,u=e.shapeInfo.texShape,e=u[0],u=u[1];return u===s&&null==c?"\n      float "+r+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+a+", "+i+", "+o+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+u+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":u===o&&null==c?"\n      float "+r+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+t[1]*t[2]*t[3]+",\n               "+t[2]*t[3]+", "+t[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+u+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":"\n    float "+r+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+s+" + col * "+a+" + depth * "+i+" +\n          depth2 * "+o+" + depth3 + "+xa(n)+";\n      vec2 uv = uvFromFlat("+e+", "+u+", index);\n      return sampleTexture("+n+", uv);\n    }\n  "}(e);case 6:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=M(t),i=o.newShape,a=o.keptDims;if(i.length<t.length)return"\n      "+da(Ca(e,i))+"\n      float "+r+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+r+"("+Ea(["row","col","depth","depth2","depth3","depth4"],a)+");\n      }\n    ";var s=t[5],u=t[4]*s,c=t[3]*u,l=t[2]*c,o=t[1]*l;if(e.shapeInfo.isUniform)return"\n      float "+r+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+o+", "+l+", "+c+", "+u+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+s+", 1)));\n        "+ba(e)+"\n      }\n    ";i=e.shapeInfo.flatOffset,a=e.shapeInfo.texShape,e=a[0],a=a[1];return a===o&&null==i?"\n      float "+r+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+l+", "+c+", "+u+", "+s+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+a+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":a===s&&null==i?"\n      float "+r+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+t[1]*t[2]*t[3]*t[4]+",\n               "+t[2]*t[3]*t[4]+",\n               "+t[3]*t[4]+",\n               "+t[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+a+".0, "+e+".0);\n        return sampleTexture("+n+", uv);\n      }\n    ":"\n    float "+r+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+o+" + col * "+l+" + depth * "+c+" +\n          depth2 * "+u+" + depth3 * "+s+" + depth4 + "+xa(n)+";\n      vec2 uv = uvFromFlat("+e+", "+a+", index);\n      return sampleTexture("+n+", uv);\n    }\n  "}(e);default:throw new Error(t.length+"-D input sampling is not yet supported")}}function pa(e){var t,n,r,o;switch(e.shapeInfo.logicalShape.length){case 0:return"\n    vec4 "+("get"+(o=e.name).charAt(0).toUpperCase()+o.slice(1))+"() {\n      return "+ua().texture2D+"("+o+", halfCR);\n    }\n  ";case 1:return n=(t=e).name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=t.shapeInfo.texShape,t=[Math.ceil(o[0]/2),Math.ceil(o[1]/2)],o=ua(),"\n    vec4 "+r+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+t[0]+", "+t[1]+", index);\n      return "+o.texture2D+"("+n+", uv);\n    }\n  ";case 2:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=e.shapeInfo.texShape,i=o[0],a=o[1],e=ua();if(null!=o&&S(t,o))return"\n      vec4 "+r+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+a+".0, "+i+".0);\n\n        return "+e.texture2D+"("+n+", uv);\n      }\n    ";o=[Math.ceil(o[0]/2),Math.ceil(o[1]/2)];return"\n    vec4 "+r+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(t[1]/2)+", "+o[0]+", "+o[1]+", row, col);\n      return "+e.texture2D+"("+n+", uv);\n    }\n  "}(e);case 3:return function(e){var t=e.shapeInfo.logicalShape,n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1),o=e.shapeInfo.texShape,i=[Math.ceil(o[0]/2),Math.ceil(o[1]/2)];if(1===t[0])return"\n        "+pa(Ca(e,t.slice(1)))+"\n        vec4 "+r+"(int b, int row, int col) {\n          return "+r+"("+Ea(["b","row","col"],[1,2])+");\n        }\n      ";o=i[0],e=i[1],i=Math.ceil(t[2]/2);return"\n    vec4 "+r+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+o+", "+e+", "+i*Math.ceil(t[1]/2)+", "+i+", b, row, col);\n      return "+ua().texture2D+"("+n+", uv);\n    }\n  "}(e);default:return function(e){for(var t=e.shapeInfo.logicalShape,n=t.length,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),i=e.shapeInfo.texShape,a=[Math.ceil(i[0]/2),Math.ceil(i[1]/2)],e=a[0],i=a[1],a=Math.ceil(t[n-1]/2),s=a*Math.ceil(t[n-2]/2),u="int b, int row, int col",c="b * "+s+" + (row / 2) * "+a+" + (col / 2)",l=2;l<n-1;l++)u="int b"+l+", "+u,c="b"+l+" * "+(s*=t[n-l-1])+" + "+c;return"\n    vec4 "+o+"("+u+") {\n      int index = "+c+";\n      int texR = index / "+i+";\n      int texC = index - texR * "+i+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+i+", "+e+");\n      return "+ua().texture2D+"("+r+", uv);\n    }\n  "}(e)}}var va="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",ma="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",ga="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",ya="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function xa(e){return"offset"+e}function ba(e){var t=e.name,e=k(e.shapeInfo.logicalShape);return e<2?"return "+t+";":"\n    for (int i = 0; i < "+e+"; i++) {\n      if (i == index) {\n        return "+t+"[i];\n      }\n    }\n  "}function wa(e){if(e<=1)return"int";if(2===e)return"ivec2";if(3===e)return"ivec3";if(4===e)return"ivec4";if(5===e)return"ivec5";if(6===e)return"ivec6";throw Error("GPU for rank "+e+" is not yet supported")}function Ca(e,t){e=JSON.parse(JSON.stringify(e));return e.shapeInfo.logicalShape=t,e}function Ea(t,e){return e.map(function(e){return t[e]}).join(", ")}var Ra=function(e,t,n,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,C(2<e.length,function(){return"Packed arg"+(n.charAt(0).toUpperCase()+n.slice(1))+" supports only inputs with rank above 2."});var o=e[e.length-1],i=Math.ceil(o/t);this.outputShape=e.slice(0,-1),1<i&&this.outputShape.push(i),r||this.variableNames.push("bestIndicesA");var a,s=this.outputShape,u=s.length,c=wa(u),l=sa("coords",u);a=1===i?"\n        "+(m=wa(g=u+1))+" sourceLocR = "+m+"("+l.join()+", 0);\n        ++"+l[u-1]+";\n        "+m+" sourceLocG = "+m+"("+l.join()+", 0);\n        ++"+l[u-2]+";\n        "+m+" sourceLocA = "+m+"("+l.join()+", 0);\n        --"+l[u-1]+";\n        "+m+" sourceLocB = "+m+"("+l.join()+", 0);\n        --"+l[u-2]+";":"\n        "+c+" sourceLocR = coords;\n        ++"+l[(g=u)-1]+";\n        "+c+" sourceLocG = coords;\n        ++"+l[u-2]+";\n        "+c+" sourceLocA = coords;\n        --"+l[u-1]+";\n        "+c+" sourceLocB = coords;\n        --"+l[u-2]+";";var h=["x","y","z","w","u","v"].slice(0,g),d="."+h[g-1],p=h.map(function(e){return"int "+e}),f=sa("sourceLocR",g-1).concat("inIdx.r"),o=sa("sourceLocG",g-1).concat("inIdx.g"),e=sa("sourceLocB",g-1).concat("inIdx.b"),i=sa("sourceLocA",g-1).concat("inIdx.a"),m="max"===n?"greaterThan":"lessThan",g=r?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+f.join()+"),\n                             getBestIndicesAChannel("+o.join()+"),\n                             getBestIndicesAChannel("+e.join()+"),\n                             getBestIndicesAChannel("+i.join()+")));",i="vec4(\n            getAChannel("+f.join()+"),\n            hasNextCol ? getAChannel("+o.join()+") : 0.,\n            hasNextRow ? getAChannel("+e.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+i.join()+") : 0.)",r=r?"":"\n      float getBestIndicesAChannel("+p.join()+") {\n        return getChannel(getBestIndicesA("+h.join()+"),\n                                          vec2("+h.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+p.join()+") {\n        return getChannel(getA("+h.join()+"),\n                               vec2("+h.slice(-2).join()+"));\n      }\n      "+r+"\n      void main() {\n        "+c+" coords = getOutputCoords();\n        bool hasNextCol = "+l[u-1]+" < "+(s[u-1]-1)+";\n        bool hasNextRow = "+l[u-2]+" < "+(s[u-2]-1)+";\n        "+a+"\n        ivec4 srcIdx = ivec4(sourceLocR"+d+", sourceLocG"+d+",\n          sourceLocB"+d+", sourceLocA"+d+") * "+t+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+i+";\n\n        for (int i = 0; i < "+t+"; i++) {\n          inIdx = srcIdx;\n          "+g+"\n          vec4 candidate = "+i+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+m+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "},Ia=function(e){this.variableNames=["dy"],this.outputShape=e.inShape;var t=e.filterHeight,n=e.filterWidth,r=e.strideHeight,o=e.strideWidth,i=e.dilationHeight,a=e.dilationWidth,s=e.effectiveFilterHeight,u=e.effectiveFilterWidth,c=s-1-e.padInfo.top,l=u-1-e.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+c+", "+l+");\n      const float avgMultiplier = float("+1/(t*n)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+s+";\n            wR += "+i+") {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+u+";\n            wC+= "+a+") {\n            float dyC = float(dyCCorner + wC) / "+o+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},ka=function(e){this.variableNames=["dy"],this.outputShape=e.inShape;var t=e.filterDepth,n=e.filterHeight,r=e.filterWidth,o=e.strideDepth,i=e.strideHeight,a=e.strideWidth,s=e.dilationDepth,u=e.dilationHeight,c=e.dilationWidth,l=e.effectiveFilterDepth,h=e.effectiveFilterHeight,d=e.effectiveFilterWidth,p=l-1-e.padInfo.front,f=h-1-e.padInfo.top,m=d-1-e.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+p+", "+f+", "+m+");\n      const float avgMultiplier = float("+1/(t*n*r)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+s+") {\n          float dyD = float(dyDCorner + wD) / "+o+".0;\n\n          if (dyD < 0.0 || dyD >= "+e.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+h+";\n              wR += "+u+") {\n            float dyR = float(dyRCorner + wR) / "+i+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+d+";\n                wC += "+c+") {\n              float dyC = float(dyCCorner + wC) / "+a+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Sa=function(e,t,n,r,o,i){this.outputShape=[],this.variableNames=["x","mean","variance"],Ro(e,t),Ro(e,n);n="0.0";null!=r&&(Ro(e,r),this.variableNames.push("offset"),n="getOffsetAtOutCoords()");r="1.0";null!=o&&(Ro(e,o),this.variableNames.push("scale"),r="getScaleAtOutCoords()"),this.outputShape=e,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+n+";\n        float scale = "+r+";\n        float inv = scale * inversesqrt(variance + float("+i+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "},Aa=function(e,t,n,r,o,i){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],Ro(e,t),Ro(e,n);n="vec4(0.0)";null!=r&&(Ro(e,r),this.variableNames.push("offset"),n="getOffsetAtOutCoords()");r="vec4(1.0)";null!=o&&(Ro(e,o),this.variableNames.push("scale"),r="getScaleAtOutCoords()"),this.outputShape=e,this.userCode="\n      void main() {\n        vec4 offset = "+n+";\n        vec4 scale = "+r+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+i+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "},Da="return areal * breal - aimag * bimag;",Ta="return areal * bimag + aimag * breal;",Na=function(e,t,n){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=Ro(t,n),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+e+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "},Fa="return a + b;",_a="return a - b;",Oa="return a * b;",Ma="return (a < 0.) ? b * a : a;",Ba=function(e,t,n){this.variableNames=["A","B"],this.outputShape=Ro(t,n),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+e+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "},Pa="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",La=function(e,t,n,r){void 0===r&&(r=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=Ro(t,n);t=this.outputShape.length,n="";r&&(0===t||1===k(this.outputShape)?n="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ":(n="\n          "+wa(t)+" coords = getOutputCoords();\n        ",n+=1===t?"\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ":"\n            bool nextRowOutOfBounds =\n              ("+(r=sa("coords",t))[t-2]+" + 1) >= "+this.outputShape[t-2]+";\n            bool nextColOutOfBounds =\n              ("+r[t-1]+" + 1) >= "+this.outputShape[t-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          ")),this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+e+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+n+"\n\n        setOutput(result);\n      }\n    "},Wa=(Lca.prototype.getCustomSetupFunc=function(n,r){var o=this;return function(e,t){null==o.minLoc&&(o.minLoc=e.getUniformLocationNoThrow(t,"minVal"),o.maxLoc=e.getUniformLocationNoThrow(t,"maxVal")),e.gl.uniform1f(o.minLoc,n),e.gl.uniform1f(o.maxLoc,r)}},Lca),Ua=(Sca.prototype.getCustomSetupFunc=function(n,r){var o=this;return function(e,t){null==o.minLoc&&(o.minLoc=e.getUniformLocationNoThrow(t,"minVal"),o.maxLoc=e.getUniformLocationNoThrow(t,"maxVal")),e.gl.uniform1f(o.minLoc,n),e.gl.uniform1f(o.maxLoc,r)}},Sca),Va=function(e){this.variableNames=["real","imag"],this.outputShape=e,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "},za=function(e){this.outputShape=[],this.outputShape=Sn(e,1),this.variableNames=e.map(function(e,t){return"T"+t});var t=new Array(e.length-1);t[0]=e[0][1];for(var n=1;n<t.length;n++)t[n]=t[n-1]+e[n][1];for(var r=["if (yC < "+t[0]+") setOutput(getT0(yR, yC));"],n=1;n<t.length;n++){var o=t[n-1];r.push("else if (yC < "+t[n]+") setOutput(getT"+n+"(yR, yC-"+o+"));")}var i=t.length,a=t[t.length-1];r.push("else setOutput(getT"+i+"(yR, yC-"+a+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+r.join("\n        ")+"\n      }\n    "},Ga=function(e,t){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=Sn(e,t);var n=this.outputShape,r=n.length,o=wa(r),i=sa("coords",r),a=["x","y","z","w","u","v"].slice(0,r);this.variableNames=e.map(function(e,t){return"T"+t});var s=new Array(e.length-1);s[0]=e[0][t];for(var u=1;u<s.length;u++)s[u]=s[u-1]+e[u][t];for(var c=a[t],l=a.slice(-2),h=a.join(),d="if ("+c+" < "+s[0]+") {\n        return getChannel(\n            getT0("+h+"), vec2("+l.join()+"));\n        }",u=1;u<s.length;u++){var p=s[u-1];d+="\n        if ("+c+" < "+s[u]+"  && "+c+" >= "+s[u-1]+") {\n          return getChannel(\n            getT"+u+"("+Ha(a,c,p)+"),\n            vec2("+Ha(l,c,p)+"));\n        }"}var f=s.length,h=s[s.length-1];d+="\n        return getChannel(\n          getT"+f+"("+Ha(a,c,h)+"),\n          vec2("+Ha(l,c,h)+"));",this.userCode="\n      float getValue("+a.map(function(e){return"int "+e})+") {\n        "+d+"\n      }\n\n      void main() {\n        "+o+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+i+"), 0., 0., 0.);\n\n        "+i[r-1]+" = "+i[r-1]+" + 1;\n        if ("+i[r-1]+" < "+n[r-1]+") {\n          result.g = getValue("+i+");\n        }\n\n        "+i[r-2]+" = "+i[r-2]+" + 1;\n        if ("+i[r-2]+" < "+n[r-2]+") {\n          result.a = getValue("+i+");\n        }\n\n        "+i[r-1]+" = "+i[r-1]+" - 1;\n        if ("+i[r-2]+" < "+n[r-2]+" &&\n            "+i[r-1]+" < "+n[r-1]+") {\n          result.b = getValue("+i+");\n        }\n        setOutput(result);\n      }\n    "};function Sca(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}function Lca(e){this.variableNames=["A"],this.outputShape=e,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}function Ha(e,t,n){var r=e.indexOf(t);return e.map(function(e,t){return t===r?e+" - "+n:e}).join()}var qa=function(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;var t=e.strideHeight,n=e.strideWidth,r=e.padInfo.top,o=e.padInfo.left,i="channelsLast"===e.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n            int xR = wR + yR * "+t+" - "+r+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n              int xC = wC + yC * "+n+" - "+o+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              if ("+i+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ka=function(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var t=e.filterHeight,n=e.filterWidth,r=e.strideHeight,o=e.strideWidth,i="channelsLast"===e.dataFormat,a=t-1-e.padInfo.top,s=n-1-e.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+a+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(i?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(i?1:2)+"], coords["+(i?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+t+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+t+" - 1 - wR;\n\n          for (int wC = 0; wC < "+n+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+o+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+n+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+e.outChannels+"; d2++) {\n\n              if ("+i+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},ja=function(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;var t=e.strideDepth,n=e.strideHeight,r=e.strideWidth,o=e.padInfo.front,i=e.padInfo.top,a=e.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yF = 0; yF < "+e.outDepth+"; yF++) {\n            int xF = wF + yF * "+t+" - "+o+";\n\n            if (xF < 0 || xF >= "+e.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n              int xR = wR + yR * "+n+" - "+i+";\n\n              if (xR < 0 || xR >= "+e.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n                int xC = wC + yC * "+r+" - "+a+";\n\n                if (xC < 0 || xC >= "+e.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Xa=function(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var t=e.filterDepth,n=e.filterHeight,r=e.filterWidth,o=e.strideDepth,i=e.strideHeight,a=e.strideWidth,s=t-1-e.padInfo.front,u=n-1-e.padInfo.top,c=r-1-e.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+s+", "+u+", "+c+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+t+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+o+".0;\n\n          if (dyF < 0.0 || dyF >= "+e.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+t+" - 1 - wF;\n\n          for (int wR = 0; wR < "+n+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+i+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+n+" - 1 - wR;\n\n            for (int wC = 0; wC < "+r+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+a+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+r+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+e.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Ya=function(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;var t=e.strideHeight,n=e.strideWidth,r=e.padInfo.top,o=e.padInfo.left,i=e.outChannels/e.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+i+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n            int xR = wR + yR * "+t+" - "+r+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n              int xC = wC + yC * "+n+" - "+o+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},$a=function(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var t=e.filterHeight,n=e.filterWidth,r=e.strideHeight,o=e.strideWidth,i=t-1-e.padInfo.top,a=n-1-e.padInfo.left,s=e.outChannels/e.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+i+", "+a+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+t+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+r+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+t+" - 1 - wR;\n\n          for (int wC = 0; wC < "+n+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+o+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+n+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+s+"; dm++) {\n              int d2 = d1 * "+s+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Qa=function(e,t,n,r){void 0===t&&(t=!1),void 0===n&&(n=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.outputShape=e.outShape;var o=e.padInfo.top,i=e.padInfo.left,a=e.strideHeight,s=e.strideWidth,u=e.dilationHeight,c=e.dilationWidth,l=e.filterHeight,h=e.filterWidth,d=4*Math.floor(e.inChannels/4),p=e.inChannels%4,f="channelsLast"===e.dataFormat,m=f?1:2,g=f?2:3,v=f?3:1,b="",y="";n&&(b=r?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+n+"\n        }":"\n          float activation(float x) {\n            "+n+"\n          }\n        ",y="result = activation(result);");n=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+b+"\n\n      const ivec2 strides = ivec2("+a+", "+s+");\n      const ivec2 pads = ivec2("+o+", "+i+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+v+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+m+"], coords["+g+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+l+"; wR++) {\n          int xR = xRCorner + wR * "+u+";\n\n          if (xR < 0 || xR >= "+e.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+h+"; wC++) {\n            int xC = xCCorner + wC * "+c+";\n\n            if (xC < 0 || xC >= "+e.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+d+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+f+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1==p)+") {\n\n              if ("+f+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+d+") *\n                    getW(wR, wC, "+d+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+d+", xR, xC) *\n                    getW(wR, wC, "+d+", d2);\n              }\n\n            } else if ("+(2==p)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+d+", d2),\n                getW(wR, wC, "+d+" + 1, d2)\n              );\n\n              if ("+f+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+d+"),\n                  getX(batch, xR, xC, "+d+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+d+", xR, xC),\n                  getX(batch, "+d+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3==p)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+d+", d2),\n                getW(wR, wC, "+d+" + 1, d2),\n                getW(wR, wC, "+d+" + 2, d2)\n              );\n\n              if ("+f+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+d+"),\n                  getX(batch, xR, xC, "+d+" + 1),\n                  getX(batch, xR, xC, "+d+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+d+", xR, xC),\n                  getX(batch, "+d+" + 1, xR, xC),\n                  getX(batch, "+d+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+n+"\n        "+y+"\n        setOutput(result);\n      }\n    "},Ja=function(e){this.variableNames=["x","W"],this.outputShape=e.outShape;var t=e.padInfo.front,n=e.padInfo.top,r=e.padInfo.left,o=e.strideDepth,i=e.strideHeight,a=e.strideWidth,s=e.dilationDepth,u=e.dilationHeight,c=e.dilationWidth,l=e.filterDepth,h=e.filterHeight,d=e.filterWidth,p=4*Math.floor(e.inChannels/4),f=e.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+o+", "+i+", "+a+");\n      const ivec3 pads = ivec3("+t+", "+n+", "+r+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+l+"; wF++) {\n          int xF = xFCorner + wF * "+s+";\n\n          if (xF < 0 || xF >= "+e.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+"; wR++) {\n            int xR = xRCorner + wR * "+u+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+d+"; wC++) {\n              int xC = xCCorner + wC * "+c+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+p+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1==f)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+p+") *\n                  getW(wF, wR, wC, "+p+", d2);\n              } else if ("+(2==f)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+p+"),\n                  getX(batch, xF, xR, xC, "+p+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+p+", d2),\n                  getW(wF, wR, wC, "+p+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3==f)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+p+"),\n                  getX(batch, xF, xR, xC, "+p+" + 1),\n                  getX(batch, xF, xR, xC, "+p+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+p+", d2),\n                  getW(wF, wR, wC, "+p+" + 1, d2),\n                  getW(wF, wR, wC, "+p+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Za=function(e,t,n,r){void 0===t&&(t=!1),void 0===n&&(n=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.outputShape=e.outShape;var o=e.inHeight,i=e.inWidth,a=e.padInfo.top,s=e.padInfo.left,u=e.strideHeight,c=e.strideWidth,l=e.dilationHeight,h=e.dilationWidth,d=e.filterHeight,p=e.filterWidth,f=e.outChannels/e.inChannels,m="",e="";n&&(m=r?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+n+"\n        }":"\n          float activation(float x) {\n            "+n+"\n          }\n        ",e="result = activation(result);");n=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+m+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+a+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+f+";\n        int q = d2 - d1 * "+f+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+d+"; wR++) {\n          int xR = xRCorner + wR * "+l+";\n\n          if (xR < 0 || xR >= "+o+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+p+"; wC++) {\n            int xC = xCCorner + wC * "+h+";\n\n            if (xC < 0 || xC >= "+i+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+n+"\n        "+e+"\n        setOutput(result);\n      }\n    "},ti=function(e,t,n,r){void 0===t&&(t=!1),void 0===n&&(n=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e.outShape;for(var o,i=e.inHeight,a=e.inWidth,s=e.padInfo.top,u=e.padInfo.left,c=e.strideHeight,l=e.strideWidth,h=e.dilationHeight,d=e.dilationWidth,p=e.filterHeight,f=e.filterWidth,m=f,g="int xR; int xC; int xCOffset;",v=0;v<p;v++)for(var y=0;y<f;y++)g+="\n          vec4 xTexelR"+v+"C"+2*y+" = vec4(0.);\n          vec4 wR"+v+"C"+y+" = vec4(0.);\n          vec4 xR"+v+"C"+y+" = vec4(0.);";for(v=0;v<p;v++)for(var x=0;x<m;x++)g+="\n          xR = xRCorner + "+v*h+";\n          xC = xCCorner + "+(y=2*x)*d+";\n        ",1===l?y<f&&(g+=u%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+i+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+y+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    xTexelR"+v+"C"+y+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+v+"C"+y+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+i+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+v+"C"+y+" = vec4(previous.zw, xTexelR"+v+"C"+y+".xy);\n                } else {\n                  xR"+v+"C"+y+" = vec4(0, 0, xTexelR"+v+"C"+y+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+i+" && xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+y+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+y+" = vec4(0.);\n                }\n\n                xR"+v+"C"+y+" = xTexelR"+v+"C"+y+";\n              ",y+1<f)&&(o=u%2==0?b(d):d,d%2==0&&u%2==1||d%2!=0&&u%2!=1?(g+="\n                  xCOffset = xC + "+u%2+" + "+o+";\n\n                  if(xR >= 0 && xR < "+i+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",1<d&&(g+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+i+" &&\n                      xCOffset >= 0 && xCOffset < "+a+") {\n                      xTexelR"+v+"C"+y+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+v+"C"+y+" = vec4(0.);\n                    }\n                  "),g+="\n                  xR"+v+"C"+(y+1)+" = vec4(\n                    xTexelR"+v+"C"+y+".zw, xTexelR"+v+"C"+(y+2)+".xy);\n                "):g+="\n                  xCOffset = xC + "+o+";\n\n                  if(xR >= 0 && xR < "+i+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+v+"C"+(y+1)+" = xTexelR"+v+"C"+(y+2)+";\n                "):y<f&&(g+="\n              if(xR >= 0 && xR < "+i+") {\n            ",u%2==1?(g+="\n                xCOffset = xC + 1 - "+l+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+y+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+y+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+a+") {\n                  xTexelR"+v+"C"+(y+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+v+"C"+(y+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+y+" = vec4(\n                  xTexelR"+v+"C"+y+".zw, xTexelR"+v+"C"+(y+2)+".zw);\n              ",y+1<f&&(g+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+l+";\n                  if(xCOffset >= 0 && xCOffset < "+a+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+v+"C"+(y+1)+" = vec4(xTexelR"+v+"C"+(y+2)+".xy, final.xy);\n                ")):(g+="\n                if(xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+y+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+y+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+l+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+(y+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+(y+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+y+" = vec4(\n                  xTexelR"+v+"C"+y+".xy, xTexelR"+v+"C"+(y+2)+".xy);\n              ",y+1<f&&(g+="\n                  xR"+v+"C"+(y+1)+" = vec4(\n                    xTexelR"+v+"C"+y+".zw, xTexelR"+v+"C"+(y+2)+".zw);\n                ")),g+="}"),y<f&&(g+="\n            vec4 wTexelR"+v+"C"+y+" = getW("+v+", "+y+", d1, q);\n            wR"+v+"C"+y+" = vec4(wTexelR"+v+"C"+y+".xz, wTexelR"+v+"C"+y+".xz);\n          ",y+1<f&&(g+="\n              vec4 wTexelR"+v+"C"+(y+1)+" = getW("+v+", "+(y+1)+", d1, q);\n              wR"+v+"C"+(y+1)+" =\n                vec4(wTexelR"+v+"C"+(y+1)+".xz, wTexelR"+v+"C"+(y+1)+".xz);"));for(v=0;v<p;v++)for(y=0;y<f;y++)g+="dotProd += xR"+v+"C"+y+" * wR"+v+"C"+y+";";var w="",e="";n&&(w=r?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+n+"\n        }":"vec4 activation(vec4 x) {\n          "+n+"\n        }",e="result = activation(result);");n=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+w+"\n\n      const ivec2 strides = ivec2("+c+", "+l+");\n      const ivec2 pads = ivec2("+s+", "+u+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+g+"\n\n        vec4 result = dotProd;\n        "+n+"\n        "+e+"\n        setOutput(result);\n      }\n    "},ei=function(e,t,n,r,o){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var i=e[0],a=e[1],s=e[2],u=e[3],e=t[0],t=n[0],n=n[1];this.outputShape=[e,t,n,u];e=[a-1+".0",s-1+".0"],u=e[0],e=e[1],t=1<t?[""+(a-1)/(t-1),"(y2-y1) * height_ratio","y1*"+u+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+u],n=1<n?[""+(s-1)/(n-1),"(x2-x1) * width_ratio","x1*"+e+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+e];this.userCode="\n      const float height_ratio = float("+t[0]+");\n      const float width_ratio = float("+n[0]+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+i+") {\n          return;\n        }\n\n        float height_scale = "+t[1]+";\n        float width_scale = "+n[1]+";\n\n        float in_y = "+t[2]+";\n        if( in_y < 0.0 || in_y > "+u+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n        float in_x = "+n[2]+";\n        if( in_x < 0.0 || in_x > "+e+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+("bilinear"===r?1:0)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "},ni=function(e,t,n){this.variableNames=["x"];var r=(this.outputShape=e).length,o=e[e.length-1],e=n?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(n?"return "+o+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+wa(r)+" coords = getOutputCoords();\n        int end = "+ri(r,"coords")+";\n        float val = 0.0;\n        for (int i = "+o+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+e+" end) {\n            continue;\n          }\n          if (idx == end && "+t+") {\n            continue;\n          }\n          "+ri(r,"coords")+" = idx;\n          val += getX("+function(e){if(1===r)return e;if(2===r)return e+".x, "+e+".y";if(3===r)return"coords.x, coords.y, coords.z";if(4===r)return"coords.x, coords.y, coords.z, coords.w";throw Error("Cumulative sum for rank "+r+" is not yet supported")}("coords")+");\n        }\n        setOutput(val);\n      }\n    "};function ri(e,t){if(1===e)return""+t;if(2===e)return t+".y";if(3===e)return t+".z";if(4===e)return t+".w";throw Error("Cumulative sum for rank "+e+" is not yet supported")}var oi=function(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=Vt.DENSE;var t=Yt(e),n=ua();this.outputShape=e,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+ca(["r","c","d"],e)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+t[0]+", "+t[1]+"));\n        int index = 4 * (resTexRC.x * "+t[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+n.output+" = result;\n      }\n    "},ai=function(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=Vt.DENSE;var t=Yt(e),n=ua();this.outputShape=e,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+ca(["r","c","d"],e)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+t[0]+", "+t[1]+"));\n        int index = 4 * (resTexRC.x * "+t[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+n.output+" = result;\n      }\n    "},ii=(Jea.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},Jea.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},Jea.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},Jea.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},Jea.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},Jea),si=function(e){this.variableNames=["X"],this.outputShape=[e,e],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "},ui=function(e){this.variableNames=["A"],this.outTexUsage=zt.DOWNLOAD;var t=ua();this.outputShape=e,this.userCode="\n      "+ha+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+t.output+" = encode_float(x);\n      }\n    "},ci=function(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=zt.DOWNLOAD;var t=ua();this.outputShape=e,this.userCode="\n      "+ha+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+t.output+" = encode_float(x);\n      }\n    "},li=function(e,t,n){void 0===n&&(n=!1),this.variableNames=["A"];var r=ua(),o=t[0],t=t[1];this.outputShape=e;n=n?"floor(result * 255. + 0.5)":"result";this.userCode="\n      "+la(e)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+t+";\n        int c = imod(flatIndex, "+t+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+t+".0, "+o+".0);\n        vec4 values = "+r.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+r.output+" = vec4("+n+", 0., 0., 0.);\n      }\n    "},hi=function(e,t,n){void 0===n&&(n=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var r=ua(),o=t[0],i=t[1];this.outputShape=e;var a="",t="result";n&&(t="floor(result * 255. + 0.5)");for(var s=0;s<=1;s++)for(var u=0;u<=1;u++){var c=2*s+u;a+="\n          localCoords = coords;\n          if(localCoords[2] + "+u+" < "+e[2]+") {\n            localCoords[2] += "+u+";\n            if(localCoords[1] + "+s+" < "+e[1]+") {\n              localCoords[1] += "+s+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+i+";\n              c = imod(flatIndex, "+i+");\n              uv = (vec2(c, r) + halfCR) / vec2("+i+".0, "+o+".0);\n              values = "+r.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+c+"] = values[0];\n              } else if(offset == 1) {\n                result["+c+"] = values[1];\n              } else if(offset == 2) {\n                result["+c+"] = values[2];\n              } else {\n                result["+c+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+la(e)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+a+"\n\n        "+r.output+" = "+t+";\n      }\n    "},fi="return real * expR - imag * expI;",di="return real * expI + imag * expR;",pi=function(e,t,n){this.variableNames=["real","imag"];var r=t[1];this.outputShape=t;t=n?"2.0 * "+Math.PI:"-2.0 * "+Math.PI;this.userCode="\n      const float exponentMultiplier = "+t+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+e+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+r+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+r+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+(n?r+".0":"1.0")+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "},vi=(o4a.prototype.getCustomSetupFunc=function(n){var r=this;return function(e,t){null==r.valueLoc&&(r.valueLoc=e.getUniformLocationNoThrow(t,"value")),e.gl.uniform1f(r.valueLoc,n)}},o4a),mi=function(e,t,n){this.variableNames=["A","indices"];var r=e.slice();r[n]=t,this.outputShape=r,this.rank=r.length;r=wa(this.rank),n=function(e,t){var n=e.length;if(4<n)throw Error("Gather for rank "+n+" is not yet supported");if(1===n)return"int(getIndices(resRC))";for(var r=["resRC.x","resRC.y","resRC.z","resRC.w"],o=[],i=0;i<e.length;i++)i===t?o.push("int(getIndices("+r[i]+"))"):o.push(""+r[i]);return o.join()}(e,n);this.userCode="\n      void main() {\n        "+r+" resRC = getOutputCoords();\n        setOutput(getA("+n+"));\n      }\n    "};function o4a(e,t){this.outputShape=[],this.variableNames=["x"],this.outputShape=e,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}function Jea(e,t,n){this.variableNames=["x"],this.outputShape=[],this.outputShape=e,this.blockSize=t,this.dataFormat=n,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+t+";\n      int offset_h = imod(h, "+t+");\n      int in_w = w / "+t+";\n      int offset_w = imod(w, "+t+");\n      int offset_d = (offset_h * "+t+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}var gi=function(e,t,n){this.sliceDim=e,this.strides=t,this.variableNames=["x","indices"],this.outputShape=n;e=wa(t.length),t=wa(n.length),n=1<this.sliceDim?"strides[j]":"strides";this.userCode="\n        "+e+" strides = "+e+"("+this.strides+");\n         void main() {\n          "+t+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+n+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};function yi(e,t){var n=ua();return oe(e,t,n.version+"\n    precision highp float;\n    "+n.attribute+" vec3 clipSpacePos;\n    "+n.attribute+" vec2 uv;\n    "+n.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function xi(e,t){return fe(e,t,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function bi(e,t){return de(e,t,new Uint16Array([0,1,2,2,1,3]))}function wi(e,t,n,r,o,i,a){ve(n,r);var s=pe(e,t),u=e.TEXTURE_2D;return Jt(e,t,function(){return e.bindTexture(u,s)}),Jt(e,t,function(){return e.texParameteri(u,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE)}),Jt(e,t,function(){return e.texParameteri(u,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}),Jt(e,t,function(){return e.texParameteri(u,e.TEXTURE_MIN_FILTER,e.NEAREST)}),Jt(e,t,function(){return e.texParameteri(u,e.TEXTURE_MAG_FILTER,e.NEAREST)}),Jt(e,t,function(){return e.texImage2D(u,0,o,n,r,0,i,a,null)}),Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,null)}),s}function Ci(e,t,n,r,o){r=Xt(n,r);return wi(e,t,r[0],r[1],o.internalFormatFloat,o.textureFormatFloat,e.FLOAT)}function Ei(e,t,n,r,o){r=Xt(n,r);return wi(e,t,r[0],r[1],o.internalFormatHalfFloat,o.textureFormatFloat,o.textureTypeHalfFloat)}function Ri(e,t,n,r,o){r=Xt(n,r);return wi(e,t,r[0],r[1],e.RGBA,e.RGBA,e.UNSIGNED_BYTE)}function Ii(e,t,n,r,o){r=$t(n,r);return wi(e,t,r[0],r[1],o.internalFormatPackedFloat,e.RGBA,e.FLOAT)}function ki(e,t,n,r,o){r=$t(n,r);return wi(e,t,r[0],r[1],o.internalFormatPackedHalfFloat,e.RGBA,o.textureTypeHalfFloat)}function Si(e,t,n,r){return Jt(e,t,function(){return e.bindBuffer(e.ARRAY_BUFFER,r)}),ge(e,t,n,"clipSpacePos",r,3,20,0)&&ge(e,t,n,"uv",r,2,20,12)}function Ai(e,t,n,r,o,i,a){var s,u,c;Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,n)}),c=i instanceof Uint8Array?(s=new Uint8Array(r*o*4),u=e.UNSIGNED_BYTE,e.RGBA):(s=new Float32Array(r*o*4),u=e.FLOAT,a.internalFormatPackedFloat),s.set(i),Jt(e,t,function(){return e.texImage2D(e.TEXTURE_2D,0,c,r,o,0,e.RGBA,u,s)}),Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function Di(e,t,n,r){Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,n)}),r.data instanceof Uint8Array?Jt(e,t,function(){return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r.width,r.height,0,e.RGBA,e.UNSIGNED_BYTE,r.data)}):Jt(e,t,function(){return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}),Jt(e,t,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function Ti(e,t,n,r,o){var i=e.createBuffer();Jt(e,t,function(){return e.bindBuffer(e.PIXEL_PACK_BUFFER,i)});var a=16*n*r;return Jt(e,t,function(){return e.bufferData(e.PIXEL_PACK_BUFFER,a,e.STREAM_READ)}),Jt(e,t,function(){return e.readPixels(0,0,r,n,e.RGBA,e.FLOAT,0)}),Jt(e,t,function(){return e.bindBuffer(e.PIXEL_PACK_BUFFER,null)}),i}function Ni(e,t,n){n=new Float32Array(n);return e.bindBuffer(e.PIXEL_PACK_BUFFER,t),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,n),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),n}function Fi(e,t,n,r,o){var i=Xt(n,r),a=i[0],s=i[1],u=new Uint8Array(n*r*4);return Jt(e,t,function(){return e.readPixels(0,0,a,s,o.downloadTextureFormat,e.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function _i(e,t,n,r,o,i,a,s){a=new Float32Array((a=$t(i,a))[0]*a[1]*4);return e.bindBuffer(e.PIXEL_PACK_BUFFER,t),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,a),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),a}function Oi(e,t,n,r){var o=new Float32Array(n*r*4);return Jt(e,t,function(){return e.readPixels(0,0,r,n,e.RGBA,e.FLOAT,o)}),o}var Mi=Object.freeze({createVertexShader:yi,createVertexBuffer:xi,createIndexBuffer:bi,createFloat32MatrixTexture:Ci,createFloat16MatrixTexture:Ei,createUnsignedBytesMatrixTexture:Ri,createPackedMatrixTexture:Ii,createFloat16PackedMatrixTexture:ki,bindVertexProgramAttributeStreams:Si,uploadDenseMatrixToTexture:Ai,uploadPixelDataToTexture:Di,createBufferFromOutputTexture:Ti,downloadFloat32MatrixFromBuffer:Ni,downloadByteEncodedFloatMatrixFromOutputTexture:Fi,downloadPackedMatrixFromBuffer:_i,downloadMatrixFromPackedOutputTexture:Oi}),Bi=(Object.defineProperty(I5a.prototype,"debug",{get:function(){return i().getBool("DEBUG")},enumerable:!0,configurable:!0}),I5a.prototype.dispose=function(){var e,t=this;this.disposed||(null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing."),Jt(e=this.gl,this.debug,function(){return e.finish()}),Jt(e,this.debug,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),Jt(e,this.debug,function(){return e.deleteFramebuffer(t.framebuffer)}),Jt(e,this.debug,function(){return e.bindBuffer(e.ARRAY_BUFFER,null)}),Jt(e,this.debug,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}),Jt(e,this.debug,function(){return e.deleteBuffer(t.indexBuffer)}),this.disposed=!0)},I5a.prototype.createFloat32MatrixTexture=function(e,t){return this.throwIfDisposed(),Ci(this.gl,this.debug,e,t,this.textureConfig)},I5a.prototype.createFloat16MatrixTexture=function(e,t){return this.throwIfDisposed(),Ei(this.gl,this.debug,e,t,this.textureConfig)},I5a.prototype.createUnsignedBytesMatrixTexture=function(e,t){return this.throwIfDisposed(),Ri(this.gl,this.debug,e,t,this.textureConfig)},I5a.prototype.uploadPixelDataToTexture=function(e,t){this.throwIfDisposed(),Di(this.gl,this.debug,e,t)},I5a.prototype.uploadDenseMatrixToTexture=function(e,t,n,r){this.throwIfDisposed(),Ai(this.gl,this.debug,e,t,n,r,this.textureConfig)},I5a.prototype.createFloat16PackedMatrixTexture=function(e,t){return this.throwIfDisposed(),ki(this.gl,this.debug,e,t,this.textureConfig)},I5a.prototype.createPackedMatrixTexture=function(e,t){return this.throwIfDisposed(),Ii(this.gl,this.debug,e,t,this.textureConfig)},I5a.prototype.deleteMatrixTexture=function(e){var t=this;this.throwIfDisposed(),this.outputTexture===e&&(Ee(this.gl,this.debug,this.framebuffer),this.outputTexture=null),Jt(this.gl,this.debug,function(){return t.gl.deleteTexture(e)})},I5a.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(e,t,n){var r=this;return this.downloadMatrixDriver(e,function(){return Fi(r.gl,r.debug,t,n,r.textureConfig)})},I5a.prototype.downloadPackedMatrixFromBuffer=function(e,t,n,r,o,i){return _i(this.gl,e,0,0,0,o,i,this.textureConfig)},I5a.prototype.downloadFloat32MatrixFromBuffer=function(e,t){return Ni(this.gl,e,t)},I5a.prototype.createBufferFromTexture=function(e,t,n){this.bindTextureToFrameBuffer(e);n=Ti(this.gl,this.debug,t,n,this.textureConfig);return this.unbindTextureToFrameBuffer(),n},I5a.prototype.createAndWaitForFence=function(){var e=this.createFence(this.gl);return this.pollFence(e)},I5a.prototype.createFence=function(e){var t,n,r,o,a=this;return i().getBool("WEBGL_FENCE_API_ENABLED")?(o=(r=e).fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0),e.flush(),n=function(){var e=r.clientWaitSync(o,0,0);return e===r.ALREADY_SIGNALED||e===r.CONDITION_SATISFIED},t=o):n=0<i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(t=this.beginQuery(),this.endQuery(),function(){return a.isQueryAvailable(t,i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):function(){return!0},{query:t,isFencePassed:n}},I5a.prototype.downloadMatrixFromPackedTexture=function(e,t,n){var r=this;return this.downloadMatrixDriver(e,function(){return Oi(r.gl,r.debug,t,n)})},I5a.prototype.createProgram=function(e){this.throwIfDisposed();var t=this.gl,n=ae(t,this.debug,e),r=yi(t,this.debug),o=ce(t,this.debug);return Jt(t,this.debug,function(){return t.attachShader(o,r)}),Jt(t,this.debug,function(){return t.attachShader(o,n)}),le(t,this.debug,o),this.debug&&he(t,this.debug,o),this.vertexAttrsAreBound||(this.setProgram(o),this.vertexAttrsAreBound=Si(t,this.debug,this.program,this.vertexBuffer)),o},I5a.prototype.deleteProgram=function(e){var t=this;this.throwIfDisposed(),e===this.program&&(this.program=null),null!=e&&Jt(this.gl,this.debug,function(){return t.gl.deleteProgram(e)})},I5a.prototype.setProgram=function(e){var t=this;this.throwIfDisposed(),this.program=e,null!=this.program&&this.debug&&he(this.gl,this.debug,this.program),Jt(this.gl,this.debug,function(){return t.gl.useProgram(e)})},I5a.prototype.getUniformLocation=function(e,t,n){return void 0===n&&(n=!0),this.throwIfDisposed(),n?xe(this.gl,this.debug,e,t):be(this.gl,e,t)},I5a.prototype.getAttributeLocation=function(e,t){var n=this;return this.throwIfDisposed(),Jt(this.gl,this.debug,function(){return n.gl.getAttribLocation(e,t)})},I5a.prototype.getUniformLocationNoThrow=function(e,t){return this.throwIfDisposed(),this.gl.getUniformLocation(e,t)},I5a.prototype.setInputMatrixTexture=function(e,t,n){this.throwIfDisposed(),this.throwIfNoProgram(),we(this.gl,this.debug,this.program,e,t,n)},I5a.prototype.setOutputMatrixTexture=function(e,t,n){this.setOutputMatrixTextureDriver(e,n,t)},I5a.prototype.setOutputPackedMatrixTexture=function(e,t,n){this.throwIfDisposed();t=$t(t,n),n=t[0],t=t[1];this.setOutputMatrixTextureDriver(e,n,t)},I5a.prototype.setOutputMatrixWriteRegion=function(e,t,n,r){this.setOutputMatrixWriteRegionDriver(n,e,r,t)},I5a.prototype.setOutputPackedMatrixWriteRegion=function(e,t,n,r){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},I5a.prototype.debugValidate=function(){null!=this.program&&he(this.gl,this.debug,this.program),Re(this.gl)},I5a.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var e=this.gl;this.debug&&this.debugValidate(),Jt(e,this.debug,function(){return e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)})},I5a.prototype.blockUntilAllProgramsCompleted=function(){var e=this;this.throwIfDisposed(),Jt(this.gl,this.debug,function(){return e.gl.finish()})},I5a.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=re(this.gl,this.debug,2===i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},I5a.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},I5a.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},I5a.prototype.beginQuery=function(){if(2===i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var e=this.gl,t=this.getQueryTimerExtensionWebGL2(),n=e.createQuery();return e.beginQuery(t.TIME_ELAPSED_EXT,n),n}t=this.getQueryTimerExtensionWebGL1(),n=t.createQueryEXT();return t.beginQueryEXT(t.TIME_ELAPSED_EXT,n),n},I5a.prototype.endQuery=function(){var e,t;2!==i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(t=this.getQueryTimerExtensionWebGL1()).endQueryEXT(t.TIME_ELAPSED_EXT):(e=this.gl,t=this.getQueryTimerExtensionWebGL2(),e.endQuery(t.TIME_ELAPSED_EXT))},I5a.prototype.waitForQueryAndGetTime=function(o){return n(this,void 0,void 0,function(){var t=this;return r(this,function(e){switch(e.label){case 0:return[4,F(function(){return t.disposed||t.isQueryAvailable(o,i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return e.sent(),[2,this.getQueryTime(o,i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},I5a.prototype.getQueryTime=function(e,t){if(0===t)return null;if(2===t){var n=this.gl;return n.getQueryParameter(e,n.QUERY_RESULT)/1e6}n=this.getQueryTimerExtensionWebGL1();return n.getQueryObjectEXT(e,n.QUERY_RESULT_EXT)/1e6},I5a.prototype.isQueryAvailable=function(e,t){if(0===t)return!0;if(2!==t)return r=(n=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(e,n.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(n.GPU_DISJOINT_EXT)),r&&!this.disjoint;var t=this.gl,n=this.getQueryTimerExtensionWebGL2(),r=t.getQueryParameter(e,t.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(n.GPU_DISJOINT_EXT)),r&&!this.disjoint},I5a.prototype.pollFence=function(t){var n=this;return new Promise(function(e){n.addItemToPoll(function(){return t.isFencePassed()},function(){return e()})})},I5a.prototype.pollItems=function(){for(var e=function(e){for(var t=0;t<e.length&&e[t]();++t);return t-1}(this.itemsToPoll.map(function(e){return e.isDoneFn})),t=0;t<=e;++t)(0,this.itemsToPoll[t].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(e+1)},I5a.prototype.addItemToPoll=function(e,t){var n=this;this.itemsToPoll.push({isDoneFn:e,resolveFn:t}),1<this.itemsToPoll.length||F(function(){return n.pollItems(),0===n.itemsToPoll.length})},I5a.prototype.bindTextureToFrameBuffer=function(e){this.throwIfDisposed(),Ce(this.gl,this.debug,e,this.framebuffer),this.debug&&Re(this.gl)},I5a.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(Ce(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&Re(this.gl)):Ee(this.gl,this.debug,this.framebuffer)},I5a.prototype.downloadMatrixDriver=function(e,t){this.bindTextureToFrameBuffer(e);t=t();return this.unbindTextureToFrameBuffer(),t},I5a.prototype.setOutputMatrixTextureDriver=function(e,t,n){this.throwIfDisposed();var r=this.gl;Ce(r,this.debug,e,this.framebuffer),this.debug&&Re(r),this.outputTexture=e,Jt(r,this.debug,function(){return r.viewport(0,0,t,n)}),Jt(r,this.debug,function(){return r.scissor(0,0,t,n)})},I5a.prototype.setOutputMatrixWriteRegionDriver=function(e,t,n,r){var o=this;this.throwIfDisposed(),Jt(this.gl,this.debug,function(){return o.gl.scissor(e,t,n,r)})},I5a.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},I5a.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},I5a);function I5a(e){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var t=i().getNumber("WEBGL_VERSION");null!=e?Kt(t,this.gl=e):this.gl=jt(t);t="WEBGL_color_buffer_float";if(1===i().getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=re(this.gl,this.debug,"OES_texture_float"),Pe(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=re(this.gl,this.debug,"OES_texture_half_float");else if(i().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(t),Pe(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=re(this.gl,this.debug,"EXT_color_buffer_half_float");else if(i().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(Pe(this.gl,t="EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension(t);else{if(!Pe(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=xi(this.gl,this.debug),this.indexBuffer=bi(this.gl,this.debug),this.framebuffer=me(this.gl,this.debug),this.textureConfig=Qt(this.gl,this.textureHalfFloatExtension)}function Pi(e,o){if(e.length!==o.length)throw Error("Binary was compiled with "+e.length+" inputs, but was executed with "+o.length+" inputs");e.forEach(function(e,t){var n=e.logicalShape,r=o[t],t=r.shape;if(!S(n,t))throw Error("Binary was compiled with different shapes than the current args. Shapes "+n+" and "+t+" must match");if(!e.isUniform||!r.isUniform){e=e.texShape,r=r.isUniform?null:r.texData.texShape;if(!S(e,r))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+e+" and "+r+" must match")}})}var Li=function(e,t,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e;for(var r=n.filterWidth,o=n.inChannels,i=n.strideWidth,a=n.strideHeight,s=n.padInfo,u=n.outWidth,c=n.dilationWidth,l=n.dilationHeight,n=n.dataFormat,h=s.left,d=s.top,p=o*r,r=ua(),f="channelsLast"===n,m=f?0:1,g=f?1:2,v="",b=0;b<=1;b++)for(var y=0;y<=1;y++)v+="\n          blockIndex = rc.y + "+y+";\n          pos = rc.x + "+b+";\n\n          if(blockIndex < "+e[1]+" && pos < "+e[0]+") {\n            offsetY = int(blockIndex / ("+u+")) * "+a+" - "+d+";\n            d0 = offsetY + "+l+" * (pos / "+p+");\n\n            if(d0 < "+t[m]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+u+".) * "+i+". - "+h+".);\n              d1 = offsetX + "+c+" * (int(mod(float(pos), "+p+".) / "+o+".));\n\n              if(d1 < "+t[g]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+o+".));\n\n                if ("+f+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*b+y)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*b+y)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+v+"\n\n        "+r.output+" = result;\n      }\n    "},Wi=function(e,t,n,r,o){this.variableNames=["x"],this.outputShape=[];var i=t,t=e[3]-1;this.outputShape=e;r="float("+n+") + float("+r+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+i+"; j <= "+i+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+t+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+(.5===o?"inversesqrt("+r+")":1===o?"1.0/("+r+")":"exp(log("+r+") * float(-"+o+"));")+";\n        setOutput(val);\n      }\n    "},Ui=function(e,t,n,r,o){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=e,this.depth=e[3],this.depthRadius=t,this.bias=n,this.alpha=r,this.beta=o,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+t+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+t+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+r+") * norm + float("+n+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+r+")\n                * float("+o+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+o+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "},Vi=function(e,t,n,r,o){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var i=t,t=e[3]-1;this.outputShape=e;r="float("+n+") + float("+r+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+i+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+i+"; j <= "+i+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+t+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+(.5===o?"inversesqrt("+r+")":1===o?"1.0/("+r+")":"exp(log("+r+") * float(-"+o+"));")+";\n        setOutput(result);\n      }\n    "},zi=function(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;var t=e.strideHeight,n=e.strideWidth,r=e.dilationHeight,o=e.effectiveFilterHeight,i=e.effectiveFilterWidth,a=o-1-e.padInfo.top,s=i-1-e.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+a+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+o+";\n          wR += "+r+") {\n          float dyR = float(dyRCorner + wR) / "+t+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+i+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+n+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(o*i-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+i+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Gi=function(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;var t=e.strideDepth,n=e.strideHeight,r=e.strideWidth,o=e.dilationDepth,i=e.dilationHeight,a=e.dilationWidth,s=e.effectiveFilterDepth,u=e.effectiveFilterHeight,c=e.effectiveFilterWidth,l=s-1-e.padInfo.front,h=u-1-e.padInfo.top,d=c-1-e.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+l+", "+h+", "+d+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+s+";\n           wD += "+o+") {\n          float dyD = float(dyDCorner + wD) / "+t+".0;\n\n          if (dyD < 0.0 || dyD >= "+e.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+i+") {\n            float dyR = float(dyRCorner + wR) / "+n+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+a+") {\n              float dyC = float(dyCCorner + wC) / "+r+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(s*u*c-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+u+" * "+c+" +\n                  wR * "+c+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},Hi=function(e,t,n,r,o,i,a){void 0===n&&(n=!1),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===i&&(i=null),void 0===a&&(a=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t;var s=n?e[1]:e[2],u=Math.ceil(s/2),c=n?"i * 2, rc.y":"rc.y, i * 2",t=r?"rc.z, i * 2":"i * 2, rc.z",e=n?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],s=r?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],n="",r="";i&&(n=a?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+i+"\n        }":"vec4 activation(vec4 x) {\n          "+i+"\n        }",r="result = activation(result);");i=o?"result += getBiasAtOutCoords();":"";o&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+n+"\n\n      const float sharedDimension = "+u+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+u+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+c+");\n          vec4 b = getMatrixB(rc.x, "+t+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+e[0]+" * "+s[0]+");\n          result += ("+e[1]+" * "+s[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+i+"\n\n        "+r+"\n\n        setOutput(result);\n      }\n    "},qi=(U7a.prototype.getCustomSetupFunc=function(n){var r=this;return function(e,t){null==r.seedLoc&&(r.seedLoc=e.getUniformLocation(t,"seed")),e.gl.uniform1f(r.seedLoc,n)}},U7a),Ki=function(e,t,n,r){this.variableNames=["indices"],this.outputShape=[e,t],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+r+"), float("+n+"),\n                      float(index == coords.y)));\n      }\n    "},ji=function(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var r,t,n,o,i,a,s=(this.outputShape=e).length;0===s?this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ":(r=sa("rc",s),t=wa(s),n=function(e,t,n){if(1===e)return"rc > "+t[0];for(var r="",o=e-2;o<e;o++)r+=n[o]+" >= "+t[o],o<e-1&&(r+="||");return r}(s,e,r),o=function(e,t){if(1===s)return"";var n=r.slice(-2);return"\n    int r = "+n[0]+";\n    int c = "+n[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+e+";\n    bool rEdge = rp1 >= "+t+";\n  "}(e[e.length-1],e[e.length-2]),a=(i=e).length,e=function(e,t){for(var n=[],r=0;r<=1;r++)for(var o=0;o<=1;o++){for(var i=(0===r?"r":"rp1")+", "+(0===o?"c":"cp1"),a=2;a<e;a++)i=t[t.length-1-a]+","+i;n.push(i)}return n}(a,r),e=1===a?"getA(rc),\n            rc + 1 >= "+i[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+e[0]+"),\n          cEdge ? 0. : getA("+e[1]+"),\n          rEdge ? 0. : getA("+e[2]+"),\n          rEdge || cEdge ? 0. : getA("+e[3]+")",this.userCode="\n        void main() {\n          "+t+" rc = getOutputCoords();\n\n          if("+n+") {\n            setOutput(vec4(0));\n          } else {\n            "+o+"\n\n            setOutput(vec4("+e+"));\n          }\n        }\n      ")};function U7a(e,t,n){this.variableNames=["probs"],this.outputShape=[e,n],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(t-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(t-1)+"));\n      }\n    "}var Xi=function(n,e,t){this.variableNames=["x"],this.outputShape=e.map(function(e,t){return e[0]+n[t]+e[1]});var r=n.length,o=wa(r),i=e.map(function(e){return e[0]}).join(","),a=e.map(function(e,t){return e[0]+n[t]}).join(","),e=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,r);this.userCode=1!==r?"\n      "+o+" start = "+o+"("+i+");\n      "+o+" end = "+o+"("+a+");\n\n      void main() {\n        "+o+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+t+"));\n        } else {\n          "+o+" coords = outC - start;\n          setOutput(getX("+e+"));\n        }\n      }\n    ":"\n        int start = "+i+";\n        int end = "+a+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+t+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "},Yi=function(n,e,t){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e.map(function(e,t){return e[0]+n[t]+e[1]});for(var r=n.length,o=wa(r),i=e.map(function(e){return e[0]}).join(","),a=e.map(function(e,t){return e[0]+n[t]}).join(","),s=sa("rc",r),u=sa("source",r),e=s[r-1]+" < "+this.outputShape[r-1],c=1===r?"source":"vec2("+u.slice(-2).join()+")",l=[o+" rc = outputLoc;",s[r-1]+" += 1;\n       if("+e+") {\n      ",1===r?"":"}\n       rc = outputLoc;\n       "+s[r-2]+" += 1;\n       if("+s[r-2]+" < "+this.outputShape[r-2]+") {",1===r?"":"  "+s[r-1]+" += 1;\n         if("+e+") {"],h=1===r?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",d="",p=0,f=1===r?2:4;p<f;p++)d+="\n        "+l[p]+"\n        if ("+h+") {\n          result["+p+"] = float("+t+");\n        } else {\n          "+o+" source = rc - start;\n          result["+p+"] = getChannel(getX("+u.join()+"), "+c+");\n        }\n      ";this.userCode="\n      const "+o+" start = "+o+"("+i+");\n      const "+o+" end = "+o+"("+a+");\n\n      void main() {\n        "+o+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+(d+=1===r?"} ":"}}")+"\n        setOutput(result);\n      }\n    "},$i=function(e,t,n){if(this.variableNames=["x"],"avg"===t&&n)throw new Error("Cannot compute positions for average pool.");var r=e.filterWidth,o=e.strideHeight,i=e.strideWidth,a=e.dilationHeight,s=e.dilationWidth,u=e.effectiveFilterHeight,c=e.effectiveFilterWidth,l=e.padInfo.top,h=e.padInfo.left;this.outputShape=e.outShape;var d="avg"===t,p=d?"0.0":"-1.0 / 1e-20";n?this.userCode="\n        const ivec2 strides = ivec2("+o+", "+i+");\n        const ivec2 pads = ivec2("+l+", "+h+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+a+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+s+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+c+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ":(c="avg"===t?"avgValue / count":t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])",t=4*Math.floor(r/4),this.userCode="\n      const ivec2 strides = ivec2("+o+", "+i+");\n      const ivec2 pads = ivec2("+l+", "+h+");\n      const float initializationValue = "+p+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+e.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+p+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+u+";\n            wR += "+a+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+e.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+t+"; wC += 4) {\n            int xC = xCCorner + wC * "+s+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              getValue(batch, xR, xC + 3 * "+s+", d)\n            );\n\n            "+(d="\n      if ("+d+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ")+"\n          }\n\n          int xC = xCCorner + "+t+";\n          if ("+(1==(r=r%4))+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+d+"\n          } else if ("+(2==r)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+d+"\n          } else if ("+(3==r)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              initializationValue\n            );\n\n            "+d+"\n          }\n        }\n        setOutput("+c+");\n      }\n    ")},Qi=function(e,t,n){if(this.variableNames=["x"],"avg"===t&&n)throw new Error("Cannot compute positions for average pool.");var r=e.filterWidth,o=e.strideDepth,i=e.strideHeight,a=e.strideWidth,s=e.dilationDepth,u=e.dilationHeight,c=e.dilationWidth,l=e.effectiveFilterDepth,h=e.effectiveFilterHeight,d=e.effectiveFilterWidth,p=e.padInfo.front,f=e.padInfo.top,m=e.padInfo.left;this.outputShape=e.outShape;var g="avg"===t,v=g?"0.0":"-1.0 / 1e-20";n?this.userCode="\n        const ivec3 strides =\n            ivec3("+o+", "+i+", "+a+");\n        const ivec3 pads = ivec3("+p+", "+f+", "+m+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+l+";\n              wD += "+s+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+e.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+h+";\n                wR += "+u+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+e.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+d+";\n                  wC += "+c+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+e.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+h+" * "+d+" +\n                      wR * "+d+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ":(d="avg"===t?"avgValue / count":t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])",t=4*Math.floor(r/4),this.userCode="\n      const ivec3 strides =\n        ivec3("+o+", "+i+", "+a+");\n      const ivec3 pads = ivec3("+p+", "+f+", "+m+");\n      const float initializationValue = "+v+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+e.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+v+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+s+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+e.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+";\n            wR += "+u+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+t+"; wC += 4) {\n              int xC = xCCorner + wC * "+c+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+c+", ch)\n              );\n\n              "+(g="\n      if ("+g+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ")+"\n            }\n\n            int xC = xCCorner + "+t+";\n            if ("+(1==(r=r%4))+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+g+"\n            } else if ("+(2==r)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+g+"\n            } else if ("+(3==r)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                initializationValue\n              );\n\n              "+g+"\n            }\n          }\n          setOutput("+d+");\n        }\n      }\n    ")},Ji=function(e,t){this.variableNames=["x"];var n=e.windowSize,r=e.batchSize,o=e.inSize,i=Math.ceil(o/n);this.outputShape=[r,i];var a="0.0",s="";"prod"===t?a="1.0":"min"===t?(a="1.0 / 1e-20",s="min"):"max"===t&&(a="-1.0 / 1e-20",s="max");var u=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===t?u="sumValue":"prod"===t?u="prodValue":"all"===t?u="allValue":"any"===t&&(u="anyValue");e=4*Math.floor(n/4),r=n%4,i="\n      if ("+("sum"===t)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===t)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+s+"(values, minMaxValue);\n      }\n    ",s="vec4";"all"===t?(a="1.0",i="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",s="bvec4"):"any"===t&&(a="0.0",i="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",s="bvec4");o=0<o%n?"\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      ":"";this.userCode="\n      const float initializationValue = "+a+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+o+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+n+";\n\n        vec4 minMaxValue = vec4("+a+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+e+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+s+" values = "+s+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+i+"\n        }\n\n        int inIdx = inOffset + "+e+";\n        if ("+(1==r)+") {\n          "+s+" values = "+s+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+i+"\n        } else if ("+(2==r)+") {\n          "+s+" values = "+s+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+i+"\n        } else if ("+(3==r)+") {\n          "+s+" values = "+s+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+i+"\n        }\n        setOutput("+u+");\n      }\n    "},Zi=function(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e;for(var n="",r=0;r<4;r++){var o="thisRC = rc;";r%2==1&&(o+="thisRC.z += 1;"),1<r&&(o+="thisRC.y += 1;"),n+="\n        "+o+"\n        "+(0<r?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+r+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(0<r?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+ca(["r","c","d"],t)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+la(e)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+e[1]+";\n        int cols = "+e[2]+";\n\n        "+n+"\n\n        setOutput(result);\n      }\n    "},ts=function(e,t,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var r=t.shape,o=r[1],i=r[2],a=e.shape,s=a[1],u=a[2],c=[n&&1<s?o-1:o,n&&1<u?i-1:i],t=[n&&1<s?s-1:s,n&&1<u?u-1:u],r=c[0]/t[0],e=c[1]/t[1],a=1/r,n=1/e,c=2*Math.ceil(a)+2,t=2*Math.ceil(n)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+r+");\n        const float widthScale = float("+e+");\n\n        const float invHeightScale = float("+a+");\n        const float invWidthScale = float("+n+");\n\n        const int winHeight = int("+c+");\n        const int winWidth = int("+t+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(o-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(i-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},es=function(e,t,n,r){this.variableNames=["A"],this.outputShape=[];var o=e[0],i=e[1],a=e[2],e=e[3];this.outputShape=[o,t,n,e];e=[r&&1<t?i-1:i,r&&1<n?a-1:a],n=[r&&1<t?t-1:t,r&&1<n?n-1:n];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+e[0]/n[0]+",\n          "+e[1]/n[1]+");\n      const vec2 inputShapeRC = vec2("+i+".0, "+a+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "},ns=function(e,t,n,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var o=e[0],i=e[1],a=e[2],e=e[3];this.outputShape=[o,t,n,e];o=[r&&1<t?i-1:i,r&&1<n?a-1:a],r=[r&&1<t?t-1:t,r&&1<n?n-1:n];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+o[0]/r[0]+",\n          "+o[1]/r[1]+",\n          "+o[1]/r[1]+");\n      const vec3 inputShapeRC = vec3("+i+".0, "+a+".0,\n                                     "+a+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(e-1)+";\n        bool hasNextRow = coords.z < "+(n-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "},rs=function(e,t,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var r=t.shape,o=r[1],i=r[2],a=e.shape,s=a[1],u=a[2],c=[n&&1<s?o-1:o,n&&1<u?i-1:i],l=[n&&1<s?s-1:s,n&&1<u?u-1:u],h=c[0]/l[0],d=c[1]/l[1],t=1/h,r=1/d,e=2*Math.ceil(t)+2,a=2*Math.ceil(r)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+d+");\n\n        const float invHeightScale = float("+t+");\n        const float invWidthScale = float("+r+");\n\n        const int winHeight = int("+e+");\n        const int winWidth = int("+a+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+c[0]+") *\n                (float(dyR) / float("+l[0]+"));\n\n            float sourceFracCol =\n                float("+c[1]+") *\n                  (float(dyC) / float("+l[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+o+") - 1),\n                "+n+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+i+") - 1),\n                "+n+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},os=function(e,t,n,r){this.variableNames=["A"],this.outputShape=[];var o=e[0],i=e[1],a=e[2],e=e[3];this.outputShape=[o,t,n,e];e=[r&&1<t?i-1:i,r&&1<n?a-1:a],n=[r&&1<t?t-1:t,r&&1<n?n-1:n];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+e[0]/n[0]+",\n          "+e[1]/n[1]+");\n      const vec2 inputShapeRC = vec2("+i+".0, "+a+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(r?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "},as=function(n,r){this.variableNames=["x"];var e,t=n.length;if(4<t)throw new Error("WebGL backend: Reverse of rank-"+t+" tensor is not yet supported");this.outputShape=n,1!==t?(e=n.map(function(e,t){return t=t,-1!==r.indexOf(t)&&1!==n[t]?n[t]+" - coords["+t+"] - 1":"coords["+t+"]"}).join(","),t=wa(t),this.userCode="\n      void main() {\n        "+t+" coords = getOutputCoords();\n        setOutput(getX("+e+"));\n      }\n    "):this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+n[0]+" - coord - 1));\n        }\n      "},is=function(o,i){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var e=o.length;if(4<e)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");this.outputShape=o;var t=sa("rc",e),n=t[e-1]+" + 1 < "+this.outputShape[e-1],r=t[e-2]+" + 1 < "+this.outputShape[e-2],a=wa(e);function s(r){var e=o.map(function(e,t){return n=t,t=r,-1!==i.indexOf(n)&&1!==o[n]?o[n]+" - "+t[n]+" - 1":""+t[n];var n});return"getChannel(getX("+e.join(",")+"), vec2("+e.slice(-2).join(",")+"))"}this.userCode=1===e?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+o[0]+" - rc - 1),\n            "+o[0]+" - rc - 1);\n          if("+n+"){\n              result.g = getChannel(getX("+o[0]+" - (rc  + 1) - 1),\n                "+o[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+a+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+s(t.slice())+";\n          if("+n+"){\n            result.g = "+((a=t.slice())[e-1]="("+a[e-1]+" + 1)",s(a))+";\n          }\n          if("+r+") {\n            result.b = "+((r=t.slice())[e-2]="("+r[e-2]+" + 1)",s(r))+";\n            if("+n+") {\n              result.a = "+((t=t.slice())[e-1]="("+t[e-1]+" + 1)",t[e-2]="("+t[e-2]+" + 1)",s(t))+";\n            }\n          }\n          setOutput(result);\n        }\n    "},ss=function(e,t,n,r,o,i,a){this.variableNames=["updates","indices","defaultValue"],this.outputShape=i;var s=wa(o.length),u=wa(i.length),i="";1===n?i="i":2===n&&(i="i, j");n="";1===r?n="i":2===r&&(n="i, coords[1]"),this.userCode="\n        "+s+" strides = "+s+"("+o+");\n\n        void main() {\n          "+u+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+e+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+t+"; j++) {\n              int index = round("+("getIndices("+i+")")+");\n              flattenedIndex += index * "+(1<t?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+("getUpdates("+n+")")+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "},us=function(e,t){this.variableNames=["x","segmentIds"];var n=e.windowSize,r=e.batchSize,o=e.inSize,i=e.numSegments,a=i*Math.ceil(o/n);this.outputShape=[r,a];var s=4*Math.floor(n/4),u=n%4,e="\n        sumValue += dot(values, segFilter);\n    ",r="",a=0<o%n?"\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return -1.0;\n        }\n      ":"";this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+(r=0<o%n?"\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      ":r)+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+a+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+i+")) * float("+n+"));\n        int currentSeg = int(mod(float(outIdx), float("+i+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+s+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+e+"\n        }\n\n        int inIdx = inOffset + "+s+";\n        if ("+(1==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+e+"\n        } else if ("+(2==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+e+"\n        } else if ("+(3==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+e+"\n        }\n        setOutput(sumValue);\n      }\n    "},cs=function(e,t,n){var r,o;if(this.variableNames=["c","a","b"],this.outputShape=t,4<n)throw Error("Where for rank "+n+" is not yet supported");if(1===n)r=o="resRC";else{for(var i=["resRC.x","resRC.y","resRC.z","resRC.w"],a=[],s=[],u=0;u<t.length;u++)s.push(""+i[u]),u<e&&a.push(""+i[u]);r=a.join(),o=s.join()}n=wa(n);this.userCode="\n      void main() {\n        "+n+" resRC = getOutputCoords();\n        float cVal = getC("+r+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+o+"));\n        } else {\n          setOutput(getB("+o+"));\n        }\n      }\n    "},ls=(Kka.prototype.getCustomSetupFunc=function(n){var r=this;if(n.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+n.length+")");return function(e,t){null==r.startLoc&&(r.startLoc=e.getUniformLocationNoThrow(t,"start"),null==r.startLoc)||e.gl.uniform1iv(r.startLoc,n)}},Kka),hs=["x","y","z","w","u","v"];function Kka(e){this.variableNames=["source"],this.outputShape=e,this.rank=e.length;var t=wa(this.rank),n="uniform int start["+this.rank+"];",r=function(e){if(1===e)return"sourceLoc";if(e<=6)return hs.slice(0,e).map(function(e){return"sourceLoc."+e}).join(",");throw Error("Slicing for rank "+e+" is not yet supported")}(this.rank),e="\n        "+t+" sourceLoc;\n        "+t+" coords = getOutputCoords();\n        "+e.map(function(e,t){return"sourceLoc."+hs[t]+" = start["+t+"] + coords."+hs[t]+";"}).join("\n")+"\n      ";this.userCode="\n      "+n+"\n      void main() {\n        "+e+"\n        setOutput(getSource("+r+"));\n      }\n    "}var fs=(Yka.prototype.getCustomSetupFunc=function(n){var r=this;if(n.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+n.length+")");return function(e,t){null==r.startLoc&&(r.startLoc=e.getUniformLocationNoThrow(t,"start"),null==r.startLoc)||e.gl.uniform1iv(r.startLoc,n)}},Yka),ds=function(e,t,n){this.variableNames=["x"];var r,o=(this.outputShape=n).length,i=wa(n.length),a=wa(n.length),s="";s=1===o?"coords * strides + begin":(r=0,n.map(function(e,t){return r++,1===n.length?"coords * strides["+t+"] + begin["+t+"]":"coords["+(r-1)+"] * strides["+t+"] + begin["+t+"]"}).join(",")),this.userCode="\n      "+i+" begin = "+i+"("+e+");\n      "+i+" strides = "+i+"("+t+");\n\n      void main() {\n        "+a+" coords = getOutputCoords();\n        setOutput(getX("+s+"));\n      }\n    "},ps=(yla.prototype.acquireTexture=function(e,t,n){var r,o=vs(t,n),t=ms(e,o,n);if(t in this.freeTextures||(this.freeTextures[t]=[]),t in this.usedTextures||(this.usedTextures[t]=[]),0<this.freeTextures[t].length){this.numFreeTextures--,this.numUsedTextures++,this.log();n=this.freeTextures[t].shift();return this.usedTextures[t].push(n),n}return this.numUsedTextures++,this.log(),o===Gt.PACKED_2X2_FLOAT32?r=this.gpgpu.createPackedMatrixTexture(e[0],e[1]):o===Gt.PACKED_2X2_FLOAT16?r=this.gpgpu.createFloat16PackedMatrixTexture(e[0],e[1]):o===Gt.UNPACKED_FLOAT32?r=this.gpgpu.createFloat32MatrixTexture(e[0],e[1]):o===Gt.UNPACKED_FLOAT16?r=this.gpgpu.createFloat16MatrixTexture(e[0],e[1]):o===Gt.PACKED_4X1_UNSIGNED_BYTE&&(r=this.gpgpu.createUnsignedBytesMatrixTexture(e[0],e[1])),this.usedTextures[t].push(r),r},yla.prototype.releaseTexture=function(e,t,n,r){if(null!=this.freeTextures){r=ms(t,vs(n,r),r);r in this.freeTextures||(this.freeTextures[r]=[]),this.freeTextures[r].push(e),this.numFreeTextures++,this.numUsedTextures--;r=this.usedTextures[r],e=r.indexOf(e);if(e<0)throw new Error("Cannot release a texture that was never provided by this texture manager");r.splice(e,1),this.log()}},yla.prototype.log=function(){var e;this.logEnabled&&(e=this.numFreeTextures+this.numUsedTextures,console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+e+")"))},yla.prototype.getNumUsedTextures=function(){return this.numUsedTextures},yla.prototype.getNumFreeTextures=function(){return this.numFreeTextures},yla.prototype.dispose=function(){var t=this;if(null!=this.freeTextures){for(var e in this.freeTextures)this.freeTextures[e].forEach(function(e){t.gpgpu.deleteMatrixTexture(e)});for(var e in this.usedTextures)this.usedTextures[e].forEach(function(e){t.gpgpu.deleteMatrixTexture(e)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},yla);function yla(e){this.gpgpu=e,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}function Yka(e){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.rank=e.length;var t=wa(this.rank),n=sa("coords",this.rank),r=sa("sourceLoc",this.rank),o=1===this.rank?"sourceLoc":"vec2("+r.slice(-2).join()+")",i="getChannel(getSource("+r.join()+"), "+o+")",o="\n      result.x = "+i+";\n      if (++"+n[this.rank-1]+" < "+e[this.rank-1]+") {\n        ++"+r[this.rank-1]+";\n        result.y = "+i+";\n        --"+r[this.rank-1]+";\n      }\n    ",i=1===this.rank?"":"\n      --"+n[this.rank-1]+";\n      if (++"+n[this.rank-2]+" < "+e[this.rank-2]+") {\n        ++"+r[this.rank-2]+";\n        result.z = "+i+";\n        if (++"+n[this.rank-1]+" < "+e[this.rank-1]+") {\n          ++"+r[this.rank-1]+";\n          result.w = "+i+";\n        }\n      }\n    ",e=this.rank<=4?"sourceLoc = coords +\n            "+t+"("+e.map(function(e,t){return"start["+t+"]"}).join()+");":e.map(function(e,t){return r[t]+" = "+n[t]+" + start["+t+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+t+" coords = getOutputCoords();\n        "+t+" sourceLoc;\n        "+e+"\n        vec4 result = vec4(0.);\n        "+o+"\n        "+i+"\n        setOutput(result);\n      }\n    "}function vs(e,t){if(e===zt.UPLOAD)return Gt.PACKED_2X2_FLOAT32;if(e===zt.RENDER||null==e)return t=t,i().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?t?Gt.PACKED_2X2_FLOAT32:Gt.UNPACKED_FLOAT32:t?Gt.PACKED_2X2_FLOAT16:Gt.UNPACKED_FLOAT16;if(e===zt.DOWNLOAD||e===zt.PIXELS)return Gt.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+e)}function ms(e,t,n){return e[0]+"_"+e[1]+"_"+t+"_"+n}var gs=function(e,t){this.variableNames=["A"];for(var n=new Array(e.length),r=0;r<n.length;r++)n[r]=e[r]*t[r];this.outputShape=n,this.rank=n.length;var o=wa(this.rank),i=function(e){var t=e.length;if(5<t)throw Error("Tile for rank "+t+" is not yet supported");if(1===t)return"imod(resRC, "+e[0]+")";for(var n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],r=[],o=0;o<e.length;o++)r.push("imod("+n[o]+", "+e[o]+")");return r.join()}(e);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+i+"));\n      }\n    "},ys=function(e,t){this.variableNames=["A"];for(var n=new Array(e.length),r=0;r<n.length;r++)n[r]=e[t[r]];this.outputShape=n,this.rank=n.length;var o=wa(this.rank),i=function(e){var t=e.length;if(6<t)throw Error("Transpose for rank "+t+" is not yet supported");for(var n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],r=new Array(t),o=0;o<e.length;o++)r[e[o]]=n[o];return r.join()}(t);this.userCode="\n    void main() {\n      "+o+" resRC = getOutputCoords();\n      setOutput(getA("+i+"));\n    }\n    "},xs=function(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var n=new Array(e.length),r=0;r<n.length;r++)n[r]=e[t[r]];if(this.outputShape=n,this.rank=n.length,6<this.rank)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");for(var o=wa(this.rank),i=ia("rc",this.rank),a=new Array(this.rank),r=0;r<t.length;r++)a[t[r]]=i[r];var s="vec2("+a.slice(-2).join()+")",u="++"+i[this.rank-1]+" < "+n[this.rank-1],s="getChannel(getA("+a.join()+"), "+s+")";this.userCode="\n    void main() {\n      "+o+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+s+";\n      if("+u+") {\n        result[1] = "+s+";\n      }\n      --"+i[this.rank-1]+";\n      if(++"+i[this.rank-2]+" < "+n[this.rank-2]+") {\n        result[2] = "+s+";\n        if("+u+") {\n          result[3] = "+s+";\n        }\n      }\n      setOutput(result);\n    }\n    "},bs=1.7580993408473768,ws=1.0507009873554805,Cs=function(e,t){this.variableNames=["A"],this.outputShape=e,this.userCode="\n      float unaryOperation(float x) {\n        "+t+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Es="if (isnan(x)) return x;",Rs="return x;",Is="return abs(x);",ks=Es+"\n  return (x < 0.0) ? 0.0 : x;\n",Ss=Es+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",As="return (x >= 0.0) ? x : (exp(x) - 1.0);",Ds="\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = "+bs+";\n  float scale = "+ws+";\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n",Ts="return -x;",Ns="return ceil(x);",Fs="return floor(x);",_s="return exp(x);",Os="return exp(x) - 1.0;",Ms=Es+"\n  return sin(x);\n",Bs=Es+"\n  return cos(x);\n",Ps=Es+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n",Ls=Es+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n",Ws=Es+"\n  return atan(x);\n",Us=Es+"return log(x + sqrt(x * x + 1.0));",Vs=Es+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",zs=Es+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",Gs="return x;",Hs="return x;",qs="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",Ks="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",js="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",Xs=function(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+t+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},Ys=function(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1;var t=(this.outputShape=e).length,n=sa("rc",t),r=wa(t),e=function(e,t){if(1===e)return"rc";for(var n="",r=0;r<e;r++)n+=t[r],r<e-1&&(n+=",");return n}(t,n),n=n.slice(-2),n=t<=1?"rc":"vec2("+n.join(",")+")";this.userCode="\n      void main() {\n        "+r+" rc = getOutputCoords();\n        vec4 packedInput = getA("+e+");\n\n        setOutput(getChannel(packedInput, "+n+"));\n      }\n    "},$s={};function Qs(e,t){if(void 0===t&&(t=!1),"linear"===e)return t?Hs:Rs;if("relu"===e)return t?qs:ks;if("elu"===e)return t?js:As;if("relu6"===e)return t?Ks:Ss;if("prelu"===e)return t?Pa:Ma;throw new Error("Activation "+e+" has not been implemented for the WebGL backend.")}var Js=600,Zs=(Uma=bo,e(Vma,Uma),Vma.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},Vma.prototype.write=function(e,t,n){if(i().getBool("DEBUG")&&this.checkNumericalProblems(e),"complex64"===n&&null!=e)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var r={};return this.texData.set(r,{shape:t,dtype:n,values:e,usage:zt.UPLOAD}),r},Vma.prototype.move=function(e,t,n,r){if(i().getBool("DEBUG")&&this.checkNumericalProblems(t),"complex64"===r)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:n,dtype:r,values:t,usage:zt.UPLOAD})},Vma.prototype.readSync=function(e){var t=this.texData.get(e),n=t.values,r=t.dtype,o=t.complexTensors,i=t.slice,a=t.shape,t=t.isPacked;if(null!=i){i=new(t?Xs:Cs)(a,Gs),i=this.runWebGLProgram(i,[{dataId:e,shape:a,dtype:r}],r),a=this.readSync(i.dataId);return this.disposeData(i.dataId),a}if(null!=n)return this.convertAndCacheOnCPU(e);if("string"===r)return n;var s,n=null!=this.activeTimers;return n&&(s=et()),o="complex64"===r?Vo(o.real.dataSync(),o.imag.dataSync()):this.getValuesFromTexture(e),n&&(this.downloadWaitMs+=et()-s),this.convertAndCacheOnCPU(e,o)},Vma.prototype.read=function(g){return n(this,void 0,void 0,function(){var t,n,o,a,s,u,c,l,h,d,p,f,m;return r(this,function(e){switch(e.label){case 0:if(this.pendingRead.has(g))return t=this.pendingRead.get(g),[2,new Promise(function(e){return t.push(e)})];if(u=this.texData.get(g),m=u.values,n=u.shape,o=u.slice,a=u.dtype,s=u.complexTensors,u=u.isPacked,null!=o)return c=void 0,c=new(u?Xs:Cs)(n,Gs),u=this.runWebGLProgram(c,[{dataId:g,shape:n,dtype:a}],a),c=this.read(u.dataId),this.disposeData(u.dataId),[2,c];if(null!=m)return[2,this.convertAndCacheOnCPU(g)];if(!i().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===i().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return c=null,"complex64"!==a&&i().get("WEBGL_BUFFER_SUPPORTED")&&(l=this.decode(g),h=this.texData.get(l.dataId),c=(m=this.gpgpu).createBufferFromTexture.apply(m,[h.texture].concat(Yt(n)))),this.pendingRead.set(g,[]),"complex64"===a?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:e.sent(),e.label=2;case 2:return"complex64"!==a?[3,4]:[4,Promise.all([s.real.data(),s.imag.data()])];case 3:return d=e.sent(),h=d[0],d=d[1],d=Vo(h,d),[3,5];case 4:d=null==c?this.getValuesFromTexture(g):(f=k(n),this.gpgpu.downloadFloat32MatrixFromBuffer(c,f)),e.label=5;case 5:return null!=l&&this.disposeData(l.dataId),p=this.convertAndCacheOnCPU(g,d),f=this.pendingRead.get(g),this.pendingRead.delete(g),f.forEach(function(e){return e(p)}),this.pendingDisposal.has(g)&&(this.pendingDisposal.delete(g),this.disposeData(g),this.pendingDeletes--),[2,p]}})})},Vma.prototype.checkNumericalProblems=function(e){if(null!=e)for(var t=0;t<e.length;t++){var n=e[t];if(!ee(n)){if(i().getBool("WEBGL_RENDER_FLOAT32_CAPABLE"))throw Error("The value "+n+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'");throw Error("The value "+n+" cannot be represented on this device.")}}},Vma.prototype.getValuesFromTexture=function(e){var t=this.texData.get(e),n=t.shape,r=t.dtype,o=t.isPacked,a=k(n);if(i().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var s=this.decode(e),u=this.texData.get(s.dataId),u=(t=this.gpgpu).downloadMatrixFromPackedTexture.apply(t,[u.texture].concat(Yt(n))).subarray(0,a);return this.disposeData(s.dataId),u}o=i().getBool("WEBGL_PACK")&&!0===o,n=o?Te(n):n,o=new(o?ci:ui)(n),r=this.runWebGLProgram(o,[{shape:n,dtype:r,dataId:e}],"float32"),e=this.texData.get(r.dataId),a=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(e.texture,e.texShape[0],e.texShape[1]).subarray(0,a);return this.disposeData(r.dataId),a},Vma.prototype.time=function(u){return n(this,void 0,void 0,function(){var t,n,o,a,s;return r(this,function(e){switch(e.label){case 0:return t=this.activeTimers,a=!(n=[]),null==this.programTimersStack?(this.programTimersStack=n,a=!0):this.activeTimers.push(n),this.activeTimers=n,u(),n=I(this.activeTimers.map(function(e){return e.query})).filter(function(e){return null!=e}),o=I(this.activeTimers.map(function(e){return e.name})).filter(function(e){return null!=e}),this.activeTimers=t,a&&(this.programTimersStack=null),a={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},0<i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?[4,Promise.all(n)]:[3,2];case 1:return s=e.sent(),a.kernelMs=w(s),a.getExtraProfileInfo=function(){return s.map(function(e,t){return{name:o[t],ms:e}}).map(function(e){return e.name+": "+e.ms}).join(", ")},[3,3];case 2:a.kernelMs={error:"WebGL query timers are not supported in this environment."},e.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,a]}})})},Vma.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},Vma.prototype.startTimer=function(){return 0<i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?this.gpgpu.beginQuery():{startMs:et(),endMs:null}},Vma.prototype.endTimer=function(e){return 0<i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?this.gpgpu.endQuery():e.endMs=et(),e},Vma.prototype.getQueryTime=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){return 0<i().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?[2,this.gpgpu.waitForQueryAndGetTime(t)]:[2,t.endMs-t.startMs]})})},Vma.prototype.disposeData=function(e){if(!this.pendingDisposal.has(e)){if(this.pendingRead.has(e))return this.pendingDisposal.add(e),void this.pendingDeletes++;var t;this.texData.has(e)&&(this.releaseGPUData(e),null!=(t=this.texData.get(e).complexTensors)&&(t.real.dispose(),t.imag.dispose()),this.texData.delete(e))}},Vma.prototype.releaseGPUData=function(e){var t=this.texData.get(e),n=t.texture,r=t.dtype,o=t.texShape,i=t.usage,a=t.isPacked,s=t.slice,t=s&&s.origDataId||e,s=this.dataRefCount.get(t);1<s?this.dataRefCount.set(t,s-1):(this.dataRefCount.delete(t),null!=n&&(this.numBytesInGPU-=this.computeBytes(o,r),this.textureManager.releaseTexture(n,o,i,a)));e=this.texData.get(e);e.texture=null,e.texShape=null,e.isPacked=!1,e.slice=null},Vma.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},Vma.prototype.getDataInfo=function(e){return this.texData.get(e)},Vma.prototype.getCPUBackend=function(){return i().getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=Lt.findBackend("cpu")),this.cpuBackend):null},Vma.prototype.shouldExecuteOnCPU=function(e,t){var n=this;return void 0===t&&(t=128),null!=this.getCPUBackend()&&e.every(function(e){return null==n.texData.get(e.dataId).texture&&e.size<t})},Vma.prototype.getGPGPUContext=function(){return this.gpgpu},Vma.prototype.complex=function(e,t){var n=this.makeOutput(e.shape,"complex64");return this.texData.get(n.dataId).complexTensors={real:Lt.keep(e.clone()),imag:Lt.keep(t.clone())},n},Vma.prototype.real=function(e){return this.texData.get(e.dataId).complexTensors.real.clone()},Vma.prototype.imag=function(e){return this.texData.get(e.dataId).complexTensors.imag.clone()},Vma.prototype.slice=function(e,t,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,t,n);if(0===k(n))return Fn([],n,e.dtype);var r=this.texData.get(e.dataId).isPacked,o=io(e.shape,t,n);if(!r&&o)return this.uploadToGPU(e.dataId),this.shallowSlice(e,t,n);n=new(i().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?fs:ls)(n),t=n.getCustomSetupFunc(t);return this.compileAndRun(n,[e],null,t)},Vma.prototype.shallowSlice=function(e,t,n){var r=this.texData.get(e.dataId),o=this.makeOutput(n,e.dtype),i=this.texData.get(o.dataId);Object.assign(i,r),i.shape=n,i.dtype=e.dtype;t=so(t,e.strides);r.slice&&(t+=r.slice.flatOffset),i.slice={flatOffset:t,origDataId:r.slice&&r.slice.origDataId||e.dataId};e=this.dataRefCount.get(i.slice.origDataId)||1;return this.dataRefCount.set(i.slice.origDataId,e+1),o},Vma.prototype.stridedSlice=function(e,t,n,r){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.stridedSlice(e,t,n,r);n=ro(t,n,r);if(n.some(function(e){return 0===e}))return Fn([],n);n=new ds(t,r,n);return this.compileAndRun(n,[e])},Vma.prototype.reverse=function(e,t){t=new(i().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?is:as)(e.shape,t);return this.compileAndRun(t,[e])},Vma.prototype.concat=function(e,t){if("complex64"===e[0].dtype){var n=e.map(function(e){return Tn(e)}),r=e.map(function(e){return Nn(e)});return Dn(this.concat(n,t),this.concat(r,t))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,t);if(1===e.length)return e[0];if(e.length>i().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var o=Math.floor(e.length/2),r=this.concat(e.slice(0,o),t),o=this.concat(e.slice(o),t);return this.concat([r,o],t)}if(i().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&1<e[0].rank){var a=new Ga(e.map(function(e){return e.shape}),t);return this.compileAndRun(a,e)}o=Sn(e.map(function(e){return e.shape}),t),a=e.map(function(e){return e.as2D(-1,k(e.shape.slice(t)))}),e=new za(a.map(function(e){return e.shape}));return this.compileAndRun(e,a).reshape(o)},Vma.prototype.neg=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.neg(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Ts,e.dtype);var t=new Cs(e.shape,Ts);return this.compileAndRun(t,[e])},Vma.prototype.batchMatMul=function(e,t,n,r){var o=n?e.shape[2]:e.shape[1],i=r?t.shape[1]:t.shape[2],a=n?e.shape[1]:e.shape[2],s=e.shape[0];if((1===o||1===i)&&1e3<a){n&&(e=e.transpose([0,2,1])),r&&(t=t.transpose([0,2,1]));var u=1===i?e:e.as3D(s,a,1),c=1===i?2:1,a=1===i?t.as3D(s,1,a):t;return this.multiply(u,a).sum(c,!0)}c=Dt(e.dtype,t.dtype),r=new Hi(e.shape,[s,o,i],n,r);return this.compileAndRun(r,[e,t],c)},Vma.prototype.fusedBatchMatMul=function(e){var t=e.a,n=e.b,r=e.transposeA,o=e.transposeB,i=e.bias,a=e.activation,s=e.preluActivationWeights,u=r?t.shape[2]:t.shape[1],c=o?n.shape[1]:n.shape[2],l=t.shape[0],h=Dt(t.dtype,n.dtype),d=null!=i,e=null!=s,a=a?Qs(a,!0):null,e=new Hi(t.shape,[l,u,c],r,o,d,a,e),n=[t,n];return i&&n.push(i),s&&n.push(s),this.compileAndRun(e,n,h)},Vma.prototype.multiply=function(e,t){if("complex64"===e.dtype){var n=this.texData.get(e.dataId),r=this.texData.get(t.dataId),o=new Na(Da,e.shape,t.shape),a=new Na(Ta,e.shape,t.shape),r=[this.makeComplexComponentTensorInfo(e,n.complexTensors.real),this.makeComplexComponentTensorInfo(e,n.complexTensors.imag),this.makeComplexComponentTensorInfo(t,r.complexTensors.real),this.makeComplexComponentTensorInfo(t,r.complexTensors.imag)],o=this.compileAndRun(o,r),a=this.compileAndRun(a,r),r=this.complex(o,a);return o.dispose(),a.dispose(),r}if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.multiply(e,t);if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,Oa,e.dtype);r=new Ba(Oa,e.shape,t.shape);return this.compileAndRun(r,[e,t],e.dtype)},Vma.prototype.batchNormalization=function(e,t,n,r,o,a){var s=[e,t,n],u=null;null!=a&&(u=a.shape,s.push(a));a=null;if(null!=o&&(a=o.shape,s.push(o)),i().getBool("WEBGL_PACK_NORMALIZATION")){o=new Aa(e.shape,t.shape,n.shape,u,a,r);return this.compileAndRun(o,s)}r=new Sa(e.shape,t.shape,n.shape,u,a,r);return this.compileAndRun(r,s)},Vma.prototype.localResponseNormalization4D=function(e,t,n,r,o){o=new(i().getBool("WEBGL_PACK_NORMALIZATION")?Vi:Wi)(e.shape,t,n,r,o);return this.compileAndRun(o,[e])},Vma.prototype.LRNGrad=function(e,t,n,r,o,i,a){a=new Ui(t.shape,r,o,i,a);return this.compileAndRun(a,[t,n,e])},Vma.prototype.tile=function(e,t){if("string"===e.dtype){var n=this.readSync(e.dataId).map(function(e){return ot(e)});return ta(dr(e.shape,e.dtype,n),t)}t=new gs(e.shape,t);return this.compileAndRun(t,[e])},Vma.prototype.pad=function(e,t,n){n=new(i().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?Yi:Xi)(e.shape,t,n);return this.compileAndRun(n,[e])},Vma.prototype.transpose=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,t);t=new(i().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?xs:ys)(e.shape,t);return this.compileAndRun(t,[e])},Vma.prototype.gather=function(e,t,n){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.gather(e,t,n);n=new mi(e.shape,t.size,n);return this.compileAndRun(n,[e,t])},Vma.prototype.batchToSpaceND=function(e,t,n){C(e.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var r=t.reduce(function(e,t){return e*t}),o=zr(e.shape,t,r),i=Gr(o.length,t.length),a=Hr(e.shape,t,r),r=qr(n,t.length),t=Kr(a,n,t.length);return e.reshape(o).transpose(i).reshape(a).slice(r,t)},Vma.prototype.spaceToBatchND=function(e,t,n){C(e.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var r=t.reduce(function(e,t){return e*t}),o=[[0,0]];o.push.apply(o,n);for(var i=1+t.length;i<e.shape.length;++i)o.push([0,0]);var a=e.pad(o),s=zr(a.shape,t,r,!1),n=Gr(s.length,t.length,!1),r=Hr(a.shape,t,r,!1);return a.reshape(s).transpose(n).reshape(r)},Vma.prototype.reduce=function(e,t,n){var r=e.shape[0],o=e.shape[1],i=$r(o),r=new Ji({windowSize:i,inSize:o,batchSize:r},t),e=this.compileAndRun(r,[e],n);return 1===e.shape[1]?e:this.reduce(e,t,n)},Vma.prototype.argReduce=function(e,t,n){var r=e.shape[0],o=e.shape[1];null!=(n=void 0===n?null:n)&&(r=n.shape[0],o=n.shape[1]);var i=$r(o),o=new aa({windowSize:i,inSize:o,batchSize:r},t,null==n),r=[e];null!=n&&r.push(n);r=this.compileAndRun(o,r,"int32");return 1===r.shape[1]?r:this.argReduce(e,t,r)},Vma.prototype.argReducePacked=function(e,t,n){var r=(null!=(n=void 0===n?null:n)?n:e).shape,o=$r(r[r.length-1]),o=new Ra(r,o,t,null==n),n=this.compileAndRun(o,null==n?[e]:[e,n],"int32");return n.rank===e.rank?this.argReducePacked(e,t,n):n},Vma.prototype.sum=function(e,t){Cn("sum",t,e.rank);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n),e=Tt(e.dtype);return this.reduce(n,"sum",e).reshape(t)},Vma.prototype.prod=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.prod(e,t);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n),e=Tt(e.dtype);return this.reduce(n,"prod",e).reshape(t)},Vma.prototype.unsortedSegmentSum=function(e,t,n){var r=0,o=En([r],e.rank),i=e;null!=o&&(i=e.transpose(o),r=In(1,e.rank)[0]);var a=function(e,t,n){for(var r=[],o=e.length,i=0;i<o;i++)i!==t?r.push(e[i]):r.push(n);return r}(i.shape,r,n),r=k([i.shape[r]]),r=i.as2D(-1,r),e=Tt(e.dtype),a=this.segOpCompute(r,"unsortedSegmentSum",t,e,n).reshape(a);return a=null!=o?a.transpose(Rn(o)):a},Vma.prototype.segOpCompute=function(e,t,n,r,o){var i=e.shape[0],a=e.shape[1],s=function(e,t){var n,r=!1;for(e<=Yr?(n=e,r=!0):n=Y(e,Math.floor(Math.sqrt(e)));!r;)t<n||n===e?r=!0:n=Y(e,n+1);return n}(a,o),i=new us({windowSize:s,inSize:a,batchSize:i,numSegments:o},t),e=this.compileAndRun(i,[e,n],r);return e.shape[1]===o?e:(n=Kn(0,o).tile([a/s]),this.segOpCompute(e,t,n,r,o))},Vma.prototype.argMinMaxReduce=function(e,t,n){var r=[t];if(Cn("arg"+n.charAt(0).toUpperCase()+n.slice(1),r,e.rank),!i().getBool("WEBGL_PACK_REDUCE")||e.rank<=2){t=bn(e.shape,r),r=t[0],t=k(t[1]),t=e.as2D(-1,t);return this.argReduce(t,n).reshape(r)}return this.argReducePacked(e,n)},Vma.prototype.argMin=function(e,t){return this.argMinMaxReduce(e,t,"min")},Vma.prototype.argMax=function(e,t){return this.argMinMaxReduce(e,t,"max")},Vma.prototype.cumsum=function(e,t,n,r){if(t!==e.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(e.rank-1)+" but got axis="+t);r=new ni(e.shape,n,r);return this.compileAndRun(r,[e])},Vma.prototype.equal=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(equal(a, b));\n","bool");var n=new Ba("return float(a == b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.notEqual=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(notEqual(a, b));\n","bool");var n=new Ba("return float(a != b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.less=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.less(e,t);if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(lessThan(a, b));\n","bool");var n=new Ba("return float(a < b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.lessEqual=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(lessThanEqual(a, b));\n","bool");var n=new Ba("return float(a <= b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.greater=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.greater(e,t);if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(greaterThan(a, b));\n","bool");var n=new Ba("return float(a > b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.greaterEqual=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var n=new Ba("return float(a >= b);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.logicalNot=function(e){var t=new Cs(e.shape,"return float(!(x >= 1.0));");return this.compileAndRun(t,[e])},Vma.prototype.logicalAnd=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var n=new Ba("return float(a >= 1.0 && b >= 1.0);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.logicalOr=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var n=new Ba("return float(a >= 1.0 || b >= 1.0);",e.shape,t.shape);return this.compileAndRun(n,[e,t],"bool")},Vma.prototype.select=function(e,t,n){var r=new cs(e.rank,t.shape,t.rank);return this.compileAndRun(r,[e,t,n],Dt(t.dtype,n.dtype))},Vma.prototype.where=function(e){dn("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var t=e.dataSync();return na(e.shape,t)},Vma.prototype.topk=function(e,t,n){return ea(e.dataSync(),e.shape,e.dtype,t)},Vma.prototype.min=function(e,t){Cn("min",t,e.rank);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n);return this.reduce(n,"min",n.dtype).reshape(t)},Vma.prototype.minimum=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.minimum(e,t);var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Ba("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.mod=function(e,t){var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Ba("if (b == 0.0) return NAN;\n  return mod(a, b);",e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.max=function(e,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.max(e,t);Cn("max",t,e.rank);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n);return this.reduce(n,"max",n.dtype).reshape(t)},Vma.prototype.maximum=function(e,t){if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.maximum(e,t);var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Ba("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.all=function(e,t){Cn("all",t,e.rank);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n);return this.reduce(n,"all",n.dtype).reshape(t)},Vma.prototype.any=function(e,t){Cn("any",t,e.rank);var n=bn(e.shape,t),t=n[0],n=k(n[1]),n=e.as2D(-1,n);return this.reduce(n,"any",n.dtype).reshape(t)},Vma.prototype.realDivide=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var n=new Ba("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",e.shape,t.shape);return this.compileAndRun(n,[e,t],"float32")},Vma.prototype.floorDiv=function(e,t){if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var n=new Ba("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",e.shape,t.shape);return this.compileAndRun(n,[e,t],"int32")},Vma.prototype.add=function(e,t){if("complex64"===e.dtype&&"complex64"===t.dtype)return this.complexSeparableBinaryOp(e,t,Fa);if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.add(e,t);var n=Dt(e.dtype,t.dtype);if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,Fa,n);var r=new Ba(Fa,e.shape,t.shape);return this.compileAndRun(r,[e,t],n)},Vma.prototype.packedUnaryOp=function(e,t,n){t=new Xs(e.shape,t);return this.compileAndRun(t,[e],n)},Vma.prototype.packedBinaryOp=function(e,t,n,r,o){o=new La(n,e.shape,t.shape,o=void 0===o?!1:o);return this.compileAndRun(o,[e,t],r)},Vma.prototype.complexSeparableBinaryOp=function(i,a,s){var u=this,e=this.texData.get(i.dataId),t=this.texData.get(a.dataId),n=[[e.complexTensors.real,t.complexTensors.real],[e.complexTensors.imag,t.complexTensors.imag]].map(function(e){var t=e[0],n=e[1],r=u.makeComplexComponentTensorInfo(i,t),o=u.makeComplexComponentTensorInfo(a,n),e=new Ba(s,i.shape,a.shape);return u.compileAndRun(e,[r,o],Dt(t.dtype,n.dtype))}),e=n[0],t=n[1],n=this.complex(e,t);return e.dispose(),t.dispose(),n},Vma.prototype.makeComplexComponentTensorInfo=function(e,t){return{dataId:t.dataId,dtype:t.dtype,shape:e.shape}},Vma.prototype.addN=function(e){if(1===e.length)return e[0];if(e.length>i().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var t=Math.floor(e.length/2),n=this.addN(e.slice(0,t)),t=this.addN(e.slice(t));return this.addN([n,t])}n=e.map(function(e){return e.dtype}).reduce(function(e,t){return Dt(e,t)}),t=e.map(function(e){return e.shape}),t=new(i().getBool("WEBGL_PACK")?oa:ra)(e[0].shape,t);return this.compileAndRun(t,e,n)},Vma.prototype.subtract=function(e,t){if("complex64"===e.dtype&&"complex64"===t.dtype)return this.complexSeparableBinaryOp(e,t,_a);if(this.shouldExecuteOnCPU([e,t]))return this.cpuBackend.subtract(e,t);var n=Dt(e.dtype,t.dtype);if(i().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,t,_a,e.dtype);var r=new Ba(_a,e.shape,t.shape);return this.compileAndRun(r,[e,t],n)},Vma.prototype.pow=function(e,t){var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Ba("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",e.shape,t.shape),r=Dt(e.dtype,t.dtype);return this.compileAndRun(n,[e,t],r)},Vma.prototype.ceil=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.ceil(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Ns,e.dtype);var t=new Cs(e.shape,Ns);return this.compileAndRun(t,[e])},Vma.prototype.floor=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.floor(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Fs,e.dtype);var t=new Cs(e.shape,Fs);return this.compileAndRun(t,[e])},Vma.prototype.sign=function(e){var t=new Cs(e.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(t,[e])},Vma.prototype.isNaN=function(e){var t=new Cs(e.shape,"return float(isnan(x));");return this.compileAndRun(t,[e],"bool")},Vma.prototype.isInf=function(e){var t=new Cs(e.shape,"return float(isinf(x));");return this.compileAndRun(t,[e],"bool")},Vma.prototype.isFinite=function(e){var t=new Cs(e.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(t,[e],"bool")},Vma.prototype.round=function(e){var t=new Cs(e.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(t,[e])},Vma.prototype.exp=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.exp(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,_s,e.dtype);var t=new Cs(e.shape,_s);return this.compileAndRun(t,[e])},Vma.prototype.expm1=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.expm1(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Os,e.dtype);var t=new Cs(e.shape,Os);return this.compileAndRun(t,[e])},Vma.prototype.softmax=function(e,t){var n=O([t],e.shape),r=this.max(e,n),t=wn(r.shape,n),r=this.subtract(e,r.reshape(t)),r=this.exp(r),t=this.sum(r,n).reshape(t);return this.realDivide(r,t)},Vma.prototype.log=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.log(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",e.dtype);var t=new Cs(e.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(t,[e])},Vma.prototype.log1p=function(e){var t=new Cs(e.shape,"return log(1.0 + x);");return this.compileAndRun(t,[e])},Vma.prototype.sqrt=function(e){var t=new Cs(e.shape,"return sqrt(x);");return this.compileAndRun(t,[e])},Vma.prototype.rsqrt=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.rsqrt(e);var t=new Cs(e.shape,"return inversesqrt(x);");return this.compileAndRun(t,[e])},Vma.prototype.reciprocal=function(e){var t=new Cs(e.shape,"return 1.0 / x;");return this.compileAndRun(t,[e])},Vma.prototype.relu=function(e){var t=i().getBool("WEBGL_PACK")?new Xs(e.shape,qs):new Cs(e.shape,ks);return this.compileAndRun(t,[e])},Vma.prototype.relu6=function(e){var t=i().getBool("WEBGL_PACK")?new Xs(e.shape,Ks):new Cs(e.shape,Ss);return this.compileAndRun(t,[e])},Vma.prototype.prelu=function(e,t){var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La(Pa,e.shape,t.shape):new Ba(Ma,e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.elu=function(e){if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,js,e.dtype);var t=new Cs(e.shape,As);return this.compileAndRun(t,[e])},Vma.prototype.eluDer=function(e,t){var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",e.shape,t.shape):new Ba("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.selu=function(e){var t=new Cs(e.shape,Ds);return this.compileAndRun(t,[e])},Vma.prototype.int=function(e){var t=new Cs(e.shape,"return float(int(x));");return this.compileAndRun(t,[e],"int32")},Vma.prototype.clip=function(e,t,n){var r,n=(r=new(i().getBool("WEBGL_PACK_CLIP")?Ua:Wa)(e.shape)).getCustomSetupFunc(t,n);return this.compileAndRun(r,[e],null,n)},Vma.prototype.abs=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.abs(e);if(i().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Is,e.dtype);var t=new Cs(e.shape,Is);return this.compileAndRun(t,[e])},Vma.prototype.complexAbs=function(e){var t=this.texData.get(e.dataId),n=new Va(e.shape),t=[this.makeComplexComponentTensorInfo(e,t.complexTensors.real),this.makeComplexComponentTensorInfo(e,t.complexTensors.imag)];return this.compileAndRun(n,t)},Vma.prototype.sigmoid=function(e){var t=new Cs(e.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(t,[e])},Vma.prototype.softplus=function(e){var t=new Cs(e.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(t,[e])},Vma.prototype.sin=function(e){var t=new Cs(e.shape,Ms);return this.compileAndRun(t,[e])},Vma.prototype.cos=function(e){var t=new Cs(e.shape,Bs);return this.compileAndRun(t,[e])},Vma.prototype.tan=function(e){var t=new Cs(e.shape,"return tan(x);");return this.compileAndRun(t,[e])},Vma.prototype.asin=function(e){var t=new Cs(e.shape,Ps);return this.compileAndRun(t,[e])},Vma.prototype.acos=function(e){var t=new Cs(e.shape,Ls);return this.compileAndRun(t,[e])},Vma.prototype.atan=function(e){var t=new Cs(e.shape,Ws);return this.compileAndRun(t,[e])},Vma.prototype.atan2=function(e,t){var n=i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new La("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,t.shape):new Ba("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",e.shape,t.shape);return this.compileAndRun(n,[e,t])},Vma.prototype.sinh=function(e){var t=new Cs(e.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(t,[e])},Vma.prototype.cosh=function(e){var t=new Cs(e.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(t,[e])},Vma.prototype.tanh=function(e){var t=new Cs(e.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(t,[e])},Vma.prototype.asinh=function(e){var t=new Cs(e.shape,Us);return this.compileAndRun(t,[e])},Vma.prototype.acosh=function(e){var t=new Cs(e.shape,Vs);return this.compileAndRun(t,[e])},Vma.prototype.atanh=function(e){var t=new Cs(e.shape,zs);return this.compileAndRun(t,[e])},Vma.prototype.erf=function(e){var t=new Cs(e.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(t,[e])},Vma.prototype.step=function(e,t){t=new Cs(e.shape,Es+"\n    return x > 0.0 ? 1.0 : float("+(void 0===t?0:t)+");\n  ");return this.compileAndRun(t,[e])},Vma.prototype.conv2dByMatMul=function(e,t,n,r,o,a){var s=e.shape,u=this.texData.get(e.dataId),c=n.inChannels,l=s[0]*s[1]*s[2],h=n.outChannels,d="channelsLast"===n.dataFormat,p=s[2]%2!=0&&!!u.isPacked;if((1==l||1===h)&&1e3<c||!i().getBool("WEBGL_LAZILY_UNPACK")||!i().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!p){c=d?s[0]*s[1]*s[2]:s[0]*s[2]*s[3],p=this.reshape(e,[1,c,n.inChannels]),c=this.reshape(t,[1,n.inChannels,n.outChannels]);return this.reshape(this.fusedBatchMatMul({a:p,b:c,transposeA:!1,transposeB:!1,bias:r,activation:o,preluActivationWeights:a}),n.outShape)}var s=d?s[0]*s[1]*(s[2]+1):s[0]*s[2]*(s[3]+1),f={dataId:e.dataId,shape:[1,s,n.inChannels],dtype:e.dtype},e=u.shape;u.shape=u.shape.slice(),u.shape[u.shape.length-2]++,C(_e(u.shape,f.shape),function(){return"packed reshape "+u.shape+" to "+f.shape+" isn't free"});t=this.reshape(t,[1,n.inChannels,n.outChannels]),o=this.fusedBatchMatMul({a:f,b:t,transposeA:!1,transposeB:!1,bias:r,activation:o,preluActivationWeights:a}),a=this.texData.get(o.dataId);return C(a.isPacked,function(){return"batchMatMul result is expected to be packed"}),u.shape=e,a.shape=n.outShape,Lt.makeTensorFromDataId(o.dataId,n.outShape,o.dtype)},Vma.prototype.conv2dWithIm2Row=function(e,t,n,r,o,i){var a=n.filterWidth,s=n.filterHeight,u=n.inChannels,c=n.outWidth,l=n.outHeight,h="channelsLast"===n.dataFormat,a=a*s*u,s=l*c,u=[a,s],e=e.squeeze([0]),t=t.reshape([1,a,-1]),a=new Li(u,e.shape,n),a=this.compileAndRun(a,[e]).reshape([1,u[0],u[1]]),e=null!=r,u=null!=i,o=o?Qs(o,!0):null,o=new Hi(a.shape,[1,s,n.outChannels],!0,!1,e,o,u),t=[a,t];r&&t.push(r),u&&t.push(i);t=this.compileAndRun(o,t);return h?t.reshape([1,l,c,n.outChannels]):t.reshape([1,n.outChannels,l,c])},Vma.prototype.fusedConv2d=function(e){var t=e.input,n=e.filter,r=e.convInfo,o=e.bias,a=e.activation,s=e.preluActivationWeights;if(1===r.filterHeight&&1===r.filterWidth&&1===r.dilationHeight&&1===r.dilationWidth&&1===r.strideHeight&&1===r.strideWidth&&("SAME"===r.padInfo.type||"VALID"===r.padInfo.type))return this.conv2dByMatMul(t,n,r,o,a,s);if(i().getBool("WEBGL_CONV_IM2COL")&&1===t.shape[0])return this.conv2dWithIm2Row(t,n,r,o,a,s);var u=null!=o,e=null!=s,a=a?Qs(a,!1):null,e=new Qa(r,u,a,e),n=[t,n];return o&&n.push(o),s&&n.push(s),this.compileAndRun(e,n)},Vma.prototype.conv2d=function(e,t,n){if(1===n.filterHeight&&1===n.filterWidth&&1===n.dilationHeight&&1===n.dilationWidth&&1===n.strideHeight&&1===n.strideWidth&&("SAME"===n.padInfo.type||"VALID"===n.padInfo.type))return this.conv2dByMatMul(e,t,n);if(i().getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,t,n);n=new Qa(n);return this.compileAndRun(n,[e,t])},Vma.prototype.conv2dDerInput=function(e,t,n){n=new Ka(n);return this.compileAndRun(n,[e,t])},Vma.prototype.conv2dDerFilter=function(e,t,n){n=new qa(n);return this.compileAndRun(n,[e,t])},Vma.prototype.fusedDepthwiseConv2D=function(e){var t=e.input,n=e.filter,r=e.convInfo,o=e.bias,a=e.activation,s=e.preluActivationWeights,u=i().getBool("WEBGL_PACK_DEPTHWISECONV")&&r.strideWidth<=2&&r.outChannels/r.inChannels==1,e=a?Qs(a,u):null,a=[t,n],t=null!=o,n=null!=s;return t&&a.push(o),n&&a.push(s),n=new(u?ti:Za)(r,t,e,n),this.compileAndRun(n,a)},Vma.prototype.depthwiseConv2D=function(e,t,n){n=new(i().getBool("WEBGL_PACK_DEPTHWISECONV")&&n.strideWidth<=2&&n.outChannels/n.inChannels==1?ti:Za)(n);return this.compileAndRun(n,[e,t])},Vma.prototype.depthwiseConv2DDerInput=function(e,t,n){n=new $a(n);return this.compileAndRun(n,[e,t])},Vma.prototype.depthwiseConv2DDerFilter=function(e,t,n){n=new Ya(n);return this.compileAndRun(n,[e,t])},Vma.prototype.conv3d=function(e,t,n){n=new Ja(n);return this.compileAndRun(n,[e,t])},Vma.prototype.conv3dDerInput=function(e,t,n){n=new Xa(n);return this.compileAndRun(n,[e,t])},Vma.prototype.conv3dDerFilter=function(e,t,n){n=new ja(n);return this.compileAndRun(n,[e,t])},Vma.prototype.maxPool=function(e,t){t=new $i(t,"max",!1);return this.compileAndRun(t,[e])},Vma.prototype.avgPool=function(e,t){t=new $i(t,"avg",!1);return this.compileAndRun(t,[e],"float32")},Vma.prototype.maxPoolBackprop=function(e,t,n,r){var o=new $i(r,"max",!0),o=this.compileAndRun(o,[t]),r=new zi(r),t=this.compileAndRun(r,[e,o],t.dtype);return o.dispose(),t},Vma.prototype.avgPoolBackprop=function(e,t,n){n=new Ia(n);return this.compileAndRun(n,[e],t.dtype)},Vma.prototype.cast=function(e,t){return Po(e,t,this)},Vma.prototype.unstack=function(e,t){for(var n=e.shape[t],r=new Array(e.rank-1),o=0,i=0;i<e.rank;i++)i!==t&&(r[o++]=e.shape[i]);var a=new Array(e.rank).fill(0),s=e.shape.slice();s[t]=1;for(var u=new Array(n),i=0;i<u.length;i++)u[a[t]=i]=this.slice(e,a,s).reshape(r);return u},Vma.prototype.avgPool3d=function(e,t){t=new Qi(t,"avg",!1);return this.compileAndRun(t,[e],"float32")},Vma.prototype.avgPool3dBackprop=function(e,t,n){n=new ka(n);return this.compileAndRun(n,[e],t.dtype)},Vma.prototype.maxPool3d=function(e,t){t=new Qi(t,"max",!1);return this.compileAndRun(t,[e],"float32")},Vma.prototype.maxPool3dBackprop=function(e,t,n,r){var o=new Qi(r,"max",!0),o=this.compileAndRun(o,[t]),r=new Gi(r),t=this.compileAndRun(r,[e,o],t.dtype);return o.dispose(),t},Vma.prototype.reshape=function(e,t){var n=this.texData.get(e.dataId);if(!n.isPacked||_e(e.shape,t)||null!==n.texture&&_e(n.shape,t))return Lo(e,t);t=this.packedReshape(e,t);return Lt.makeTensorFromDataId(t.dataId,t.shape,t.dtype)},Vma.prototype.resizeBilinear=function(e,t,n,r){r=new(i().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?ns:es)(e.shape,t,n,r);return this.compileAndRun(r,[e],"float32")},Vma.prototype.resizeBilinearBackprop=function(e,t,n){n=new ts(e,t,n);return this.compileAndRun(n,[e])},Vma.prototype.resizeNearestNeighbor=function(e,t,n,r){r=new os(e.shape,t,n,r);return this.compileAndRun(r,[e])},Vma.prototype.resizeNearestNeighborBackprop=function(e,t,n){n=new rs(e,t,n);return this.compileAndRun(n,[e])},Vma.prototype.multinomial=function(e,t,n,r){var o=t?e:go(e),t=o.shape[0],e=o.shape[1],n=new qi(t,e,n),r=n.getCustomSetupFunc(r);return this.compileAndRun(n,[o],"int32",r)},Vma.prototype.oneHot=function(e,t,n,r){r=new Ki(e.size,t,n,r);return this.compileAndRun(r,[e])},Vma.prototype.diag=function(e){var t=new si(e.size);return this.compileAndRun(t,[e])},Vma.prototype.nonMaxSuppression=function(e,t,n,r,o){return dn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),jo(e.dataSync(),t.dataSync(),n,r,o)},Vma.prototype.cropAndResize=function(e,t,n,r,o,i){i=new ei(e.shape,t.shape,r,o,i);return this.compileAndRun(i,[e,t,n],"float32")},Vma.prototype.depthToSpace=function(e,t,n){C(1<t,function(){return"blockSize should be > 1 for depthToSpace, but was: "+t});var r=e.shape[0],o="NHWC"===n?e.shape[1]:e.shape[2],i="NHWC"===n?e.shape[2]:e.shape[3],a="NHWC"===n?e.shape[3]:e.shape[1],o=o*t,i=i*t,a=a/(t*t),n=new ii("NHWC"===n?[r,o,i,a]:[r,a,o,i],t,n);return this.compileAndRun(n,[e])},Vma.prototype.split=function(e,t,n){return Zo(e,t,n)},Vma.prototype.scatterND=function(e,t,n){var r=Zr(0,e,n),o=r.sliceRank,i=r.numUpdates,a=r.sliceSize,s=r.strides,u=r.outputSize,r=[u/a,a],e=e.reshape([i,o]),a=t.reshape([i,a]);if(0===u)return Lo(Fn([]),n);u=On(0),r=new ss(i,o,e.rank,a.rank,s,r);return this.compileAndRun(r,[a,e,u]).reshape(n)},Vma.prototype.sparseToDense=function(e,t,n,r){var o=Zr(0,e,n),i=o.sliceRank,a=o.numUpdates,s=o.strides,o=o.outputSize,o=new ss(a,i,e.rank,t.rank,s,[o,1],!1);return this.compileAndRun(o,[t,e,r]).reshape(n)},Vma.prototype.fft=function(e){return this.fftImpl(e,!1)},Vma.prototype.ifft=function(e){return this.fftImpl(e,!0)},Vma.prototype.fftImpl=function(e,t){var n=this.texData.get(e.dataId),r=new pi(fi,e.shape,t),t=new pi(di,e.shape,t),n=[this.makeComplexComponentTensorInfo(e,n.complexTensors.real),this.makeComplexComponentTensorInfo(e,n.complexTensors.imag)],r=this.compileAndRun(r,n),n=this.compileAndRun(t,n),e=this.complex(r,n).as2D(e.shape[0],e.shape[1]);return r.dispose(),n.dispose(),e},Vma.prototype.gatherND=function(e,t){var n=t.shape,r=n[n.length-1],o=jr(e,t),i=o[0],a=o[1],n=o[2],o=o[3],t=t.reshape([a,r]),e=e.reshape([e.size/n,n]),n=new gi(r,o,[a,n]);return this.compileAndRun(n,[e,t]).reshape(i)},Vma.prototype.fill=function(e,t,n){if("string"===(n=n||j(t))){var r=P(n,k(e));return r.fill(t),Lt.makeTensor(r,e,n,this)}e=new vi(e,t),t=e.getCustomSetupFunc(t);return this.compileAndRun(e,[],n,t)},Vma.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(e.shape,1,e.dtype)},Vma.prototype.zerosLike=function(e){return this.fill(e.shape,"string"===e.dtype?"":0,e.dtype)},Vma.prototype.linspace=function(e,t,n){return Wo(e,t,n)},Vma.prototype.makeTensorInfo=function(e,t){var n=this.write(null,e,t);return this.texData.get(n).usage=null,{dataId:n,shape:e,dtype:t}},Vma.prototype.makeOutput=function(e,t){var n=this.makeTensorInfo(e,t).dataId;return Lt.makeTensorFromDataId(n,e,t,this)},Vma.prototype.unpackTensor=function(e){var t=new Ys(e.shape);return this.runWebGLProgram(t,[e],e.dtype)},Vma.prototype.packTensor=function(e){var t=new ji(e.shape);return this.runWebGLProgram(t,[e],e.dtype,null,!0)},Vma.prototype.packedReshape=function(e,t){var n=[Ae(e.shape)].concat(De(e.shape)),r={dtype:e.dtype,shape:n,dataId:e.dataId},o=[Ae(t)].concat(De(t)),n=new Zi(o,n),e=this.runWebGLProgram(n,[r],e.dtype,null,!0);return{dataId:e.dataId,shape:t,dtype:e.dtype}},Vma.prototype.decode=function(e){var t=this.texData.get(e),n=t.isPacked,r=t.shape,o=t.dtype,t=Te(r),n=new(n?ai:oi)(t);return{dtype:o,shape:r,dataId:this.runWebGLProgram(n,[{shape:t,dtype:o,dataId:e}],o,null,!0).dataId}},Vma.prototype.runWebGLProgram=function(o,e,t,n,r){var a=this;void 0===r&&(r=!1);var s=this.makeTensorInfo(o.outputShape,t),t=this.texData.get(s.dataId);if(o.packedOutput&&(t.isPacked=!0),o.outPackingScheme===Vt.DENSE&&(d=Yt(o.outputShape),t.texShape=d.map(function(e){return 2*e})),null!=o.outTexUsage&&(t.usage=o.outTexUsage),0===k(s.shape))return t.values=B(s.dtype,0),s;var u=[],c=e.map(function(e){if("complex64"===e.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var t,n,r=a.texData.get(e.dataId);if(null==r.texture){if(!o.packedInputs&&k(e.shape)<=i().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:e.shape,texData:null,isUniform:!0,uniformValues:r.values};o.packedInputs&&(r.isPacked=!0,r.shape=e.shape)}else!!r.isPacked!=!!o.packedInputs?(e=r.isPacked?a.unpackTensor(e):a.packTensor(e),u.push(e),r=a.texData.get(e.dataId)):r.isPacked&&!_e(r.shape,e.shape)&&(n=(t=e).shape,e.shape=r.shape,e=a.packedReshape(e,n),u.push(e),r=a.texData.get(e.dataId),t.shape=n);return a.uploadToGPU(e.dataId),{shape:e.shape,texData:r,isUniform:!1}});this.uploadToGPU(s.dataId);var l,h={shape:s.shape,texData:t,isUniform:!1},d=function(e){var r="";c.concat(h).forEach(function(e){var t=null!=e.texData&&null!=e.texData.slice&&0<e.texData.slice.flatOffset,n=e.isUniform?"uniform":e.texData.texShape;r+=e.shape+"_"+n+"_"+t});var t=e.userCode;return e.constructor.name+"_"+r+"_"+t}(o),e=this.getAndSaveBinary(d,function(){return function(e,r,t,n){var o=r.userCode,a=t.map(function(e,t){var n={logicalShape:e.shape,texShape:e.isUniform?null:e.texData.texShape,isUniform:e.isUniform,isPacked:!e.isUniform&&e.texData.isPacked,flatOffset:null};return null!=e.texData&&null!=e.texData.slice&&0<e.texData.slice.flatOffset&&(n.flatOffset=e.texData.slice.flatOffset),{name:r.variableNames[t],shapeInfo:n}}),s=a.map(function(e){return e.shapeInfo}),t={logicalShape:n.shape,texShape:n.texData.texShape,isUniform:!1,isPacked:n.texData.isPacked,flatOffset:null},n=fa(a,t,o,r.packedInputs),u=e.createProgram(n),a=null,o=e.getUniformLocation(u,"NAN",!1);1===i().getNumber("WEBGL_VERSION")&&(a=e.getUniformLocation(u,"INFINITY",!1));for(var c={},l=0;l<r.variableNames.length;l++){var h=r.variableNames[l];c[h]=e.getUniformLocation(u,h,!1),c["offset"+h]=e.getUniformLocation(u,"offset"+h,!1)}return{program:r,source:n,webGLProgram:u,uniformLocations:c,inShapeInfos:s,outShapeInfo:t,infLoc:a,nanLoc:o}}(a.gpgpu,o,c,h)}),d=null!=this.activeTimers;if(d&&(l=this.startTimer()),function(a,s,e,t,n){Pi(s.inShapeInfos,e),Pi([s.outShapeInfo],[t]);var r=t.texData.texture,o=t.texData.texShape;t.texData.isPacked?a.setOutputPackedMatrixTexture(r,o[0],o[1]):a.setOutputMatrixTexture(r,o[0],o[1]),a.setProgram(s.webGLProgram),1===i().getNumber("WEBGL_VERSION")&&null!==s.infLoc&&a.gl.uniform1f(s.infLoc,1/0),null!==s.nanLoc&&a.gl.uniform1f(s.nanLoc,NaN),e.forEach(function(e,t){var n=s.program.variableNames[t],r=s.uniformLocations[n],o=s.uniformLocations["offset"+n];null!=r&&(e.isUniform?k(e.shape)<2?a.gl.uniform1f(r,e.uniformValues[0]):((n=e.uniformValues)instanceof Float32Array||(n=new Float32Array(n)),a.gl.uniform1fv(r,n)):(null!=e.texData.slice&&null!=o&&a.gl.uniform1i(o,e.texData.slice.flatOffset),a.setInputMatrixTexture(e.texData.texture,r,t)))}),null!=n&&n(a,s.webGLProgram),a.executeProgram()}(this.gpgpu,e,c,h,n),u.forEach(function(e){return a.disposeData(e.dataId)}),d&&(l=this.endTimer(l),this.activeTimers.push({name:o.constructor.name,query:this.getQueryTime(l)})),i().getBool("WEBGL_LAZILY_UNPACK")||!t.isPacked||!1!==r)return s;r=this.unpackTensor(s);return this.disposeData(s.dataId),r},Vma.prototype.compileAndRun=function(e,t,n,r,o){n=n||t[0].dtype;o=this.runWebGLProgram(e,t,n,r,o=void 0===o?!1:o);return Lt.makeTensorFromDataId(o.dataId,o.shape,o.dtype)},Vma.prototype.getAndSaveBinary=function(e,t){return e in this.binaryCache||(this.binaryCache[e]=t()),this.binaryCache[e]},Vma.prototype.getTextureManager=function(){return this.textureManager},Vma.prototype.dispose=function(){var t=this;this.disposed||(i().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(e){t.gpgpu.deleteProgram(t.binaryCache[e].webGLProgram),delete t.binaryCache[e]}),this.textureManager.dispose(),null!=this.canvas&&"undefined"!=typeof HTMLCanvasElement&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},Vma.prototype.floatPrecision=function(){var n=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=Ze(function(){if(!i().get("WEBGL_RENDER_FLOAT32_ENABLED")){var e=i().getBool("DEBUG");i().set("DEBUG",!1);var t=n.abs(On(1e-8)).dataSync()[0];if(i().set("DEBUG",e),0<t)return 32}return 16})),this.floatPrecisionValue},Vma.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},Vma.prototype.uploadToGPU=function(e){var t,n,r,o,i,a,s=this.texData.get(e),u=s.shape,c=s.dtype,l=s.values,h=s.texture,d=s.usage,p=s.isPacked;null==h&&((n=null!=this.activeTimers)&&(t=et()),null==(r=s.texShape)&&(r=Ne(u,p),s.texShape=r),null!=l?(i=Te(u),a=void 0,o=r[1],e=r[0],h=l instanceof Uint8Array,a=p?(o=(u=$t(r[0],r[1]))[0],e=u[1],new hi(i,[e,o],h)):new li(i,[e,o],h),i=this.makeTensorInfo([e,o],c),this.texData.get(i.dataId).usage=h?zt.PIXELS:zt.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(i.dataId),o,e,l),l=this.runWebGLProgram(a,[i],c,null,!0),a=this.texData.get(l.dataId),s.texture=a.texture,s.texShape=a.texShape,s.isPacked=a.isPacked,s.usage=a.usage,this.disposeData(i.dataId),this.texData.delete(l.dataId),s.values=null,n&&(this.uploadWaitMs+=et()-t)):(p=this.acquireTexture(r,d,c,p),s.texture=p))},Vma.prototype.convertAndCacheOnCPU=function(e,t){var n=this.texData.get(e),r=n.dtype;return this.releaseGPUData(e),null!=t&&(n.values=function(e,t){if("float32"===t||"complex64"===t)return e;if("int32"!==t&&"bool"!==t)throw new Error("Unknown dtype "+t);for(var n=new("int32"===t?Int32Array:Uint8Array)(e.length),r=0;r<n.length;++r)n[r]=Math.round(e[r]);return n}(t,r)),n.values},Vma.prototype.acquireTexture=function(e,t,n,r){return this.numBytesInGPU+=this.computeBytes(e,n),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024&&(n=(this.numBytesInGPU/1024/1024).toFixed(2),this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+n+" MB, most likely due to a memory leak")),this.textureManager.acquireTexture(e,t,r)},Vma.prototype.computeBytes=function(e,t){return e[0]*e[1]*z(t)},Vma),Uma;function Vma(e){var t,n,r=Uma.call(this)||this;if(r.pendingRead=new WeakMap,r.pendingDisposal=new WeakSet,r.dataRefCount=new WeakMap,r.numBytesInGPU=0,r.uploadWaitMs=0,r.downloadWaitMs=0,r.warnedAboutMemory=!1,r.pendingDeletes=0,r.disposed=!1,!i().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");return null==e?(n=jt(i().getNumber("WEBGL_VERSION")),r.binaryCache=((t=i().getNumber("WEBGL_VERSION"))in $s||($s[t]={}),$s[t]),r.gpgpu=new Bi(n),r.canvas=n.canvas,r.gpgpuCreatedLocally=!0):(r.gpgpu=e,r.binaryCache={},r.gpgpuCreatedLocally=!1,r.canvas=e.gl.canvas),r.textureManager=new ps(r.gpgpu),r.numMBBeforeWarning=null==i().global.screen?1024:i().global.screen.height*i().global.screen.width*window.devicePixelRatio*Js/1024/1024,r.texData=new xo(r,Lt),r}Wt()&&Lt.registerBackend("webgl",function(){return new Zs},2);var tu=An({square_:function(e){var n=mn(e,"x","square");return Lt.runKernelFunc(function(e,t){return t([n]),e.square(n)},{x:n},null,"Square",{},[n],[])}}),eu="SquaredDifference",nu=An({squaredDifference_:function(e,t){var n=mn(e,"a","squaredDifference"),r=mn(t,"b","squaredDifference"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e,t){e=e.squaredDifference(n,r);return t([n,r]),e},{a:n,b:r},function(e,t){var n=t[0],r=t[1],o=On(2);return{a:function(){return e.mul(n.sub(r).mul(o))},b:function(){return e.mul(r.sub(n).mul(o))}}},eu,{},[n,r],[])}}),ru=An({abs_:function(e){var n=mn(e,"x","abs");return"complex64"===n.dtype?Lt.runKernelFunc(function(e){return e.complexAbs(n)},{$x:n}):Lt.runKernelFunc(function(e,t){e=e.abs(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.mul(n.toFloat().step(-1))}}},"Abs")}}),ou=An({acos_:function(e){var n=mn(e,"x","acos");return Lt.runKernelFunc(function(e,t){e=e.acos(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.divStrict(On(1).sub(n.toFloat().square()).sqrt()).neg()}}})}}),au=An({acosh_:function(e){var n=mn(e,"x","acosh");return Lt.runKernelFunc(function(e,t){e=e.acosh(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.divStrict(n.toFloat().square().sub(1).sqrt())}}})}}),iu=An({asin_:function(e){var n=mn(e,"x","asin");return Lt.runKernelFunc(function(e,t){e=e.asin(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.divStrict(On(1).sub(n.toFloat().square()).sqrt())}}})}}),su=An({asinh_:function(e){var n=mn(e,"x","asinh");return Lt.runKernelFunc(function(e,t){e=e.asinh(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.divStrict(On(1).add(n.toFloat().square()).sqrt())}}})}}),uu=An({atan_:function(e){var n=mn(e,"x","atan");return Lt.runKernelFunc(function(e,t){e=e.atan(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(n.toFloat().square().add(1))}}})}}),cu=An({atanh_:function(e){var n=mn(e,"x","atanh");return Lt.runKernelFunc(function(e,t){e=e.atanh(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(On(1).sub(n.toFloat().square()))}}})}}),lu=An({ceil_:function(e){var t=mn(e,"x","ceil");return Lt.runKernelFunc(function(e){return e.ceil(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),hu=An({clipByValue_:function(e,r,o){var n=mn(e,"x","clipByValue");return C(r<=o,function(){return"Error in clip: min ("+r+") must be less than or equal to max ("+o+")."}),Lt.runKernelFunc(function(e,t){e=e.clip(n,r,o);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.where(n.greaterEqual(r).logicalAnd(n.lessEqual(o)),Xn(e))}}},"ClipByValue",{min:r,max:o},[n])}}),fu=An({cos_:function(e){var n=mn(e,"x","cos");return Lt.runKernelFunc(function(e,t){e=e.cos(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return n.toFloat().sin().neg().mul(e)}}},"Cos",{},[n])}}),du=An({cosh_:function(e){var n=mn(e,"x","cosh");return Lt.runKernelFunc(function(e,t){e=e.cosh(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return n.toFloat().sinh().mulStrict(e)}}})}}),pu=An({erf_:function(e){var n=mn(e,"x","erf");return C("int32"===n.dtype||"float32"===n.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===n.dtype&&(n=n.toFloat()),Lt.runKernelFunc(function(e,t){e=e.erf(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.mul(n.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),vu=An({exp_:function(e){var n=mn(e,"x","exp");return Lt.runKernelFunc(function(e,t){e=e.exp(n);return t([e]),e},{x:n},function(e,t){return{x:function(){return e.mulStrict(t[0])}}},"Exp",{},[],[!0])}}),mu=An({expm1_:function(e){var n=mn(e,"x","expm1");return Lt.runKernelFunc(function(e,t){e=e.expm1(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.mul(n.exp())}}})}}),gu=An({floor_:function(e){var t=mn(e,"x","floor");return Lt.runKernelFunc(function(e){return e.floor(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),yu=An({log_:function(e){var n=mn(e,"x","log");return Lt.runKernelFunc(function(e,t){e=e.log(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.div(n.toFloat())}}},"Log",{},[n])}}),xu=An({log1p_:function(e){var n=mn(e,"x","log1p");return Lt.runKernelFunc(function(e,t){e=e.log1p(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(n.add(1))}}})}}),bu=An({logSigmoid_:function(e){var n=mn(e,"x","logSigmoid");return Lt.runKernelFunc(function(e,t){e=e.softplus(n.neg()).neg();return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.mul(n.neg().sigmoid())}}})}}),wu=An({neg_:function(e){var t=mn(e,"x","neg");return Lt.runKernelFunc(function(e){return e.neg(t)},{x:t},function(e){return{x:function(){return e.neg()}}},"Neg",{},[t])}}),Cu=An({reciprocal_:function(e){var n=mn(e,"x","reciprocal");return Lt.runKernelFunc(function(e,t){e=e.reciprocal(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(n.square().neg())}}})}}),Eu=An({round_:function(e){var t=mn(e,"x","round");return Lt.runKernelFunc(function(e){return e.round(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),Ru=An({rsqrt_:function(e){var n=mn(e,"x","rsqrt");return Lt.runKernelFunc(function(e,t){e=e.rsqrt(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.div(n.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},[n])}}),Iu=An({sigmoid_:function(e){var n=mn(e,"x","sigmoid");return Lt.runKernelFunc(function(e,t){e=e.sigmoid(n);return t([e]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.mul(n.mul(On(1).sub(n)))}}},"Sigmoid")}}),ku=An({sign_:function(e){var t=mn(e,"x","sign");return Lt.runKernelFunc(function(e){return e.sign(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),Su=An({isNaN_:function(e){var t=mn(e,"x","isNaN");return Lt.runKernelFunc(function(e){return e.isNaN(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),Au=An({isInf_:function(e){var t=mn(e,"x","isInf");return Lt.runKernelFunc(function(e){return e.isInf(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),Du=An({isFinite_:function(e){var t=mn(e,"x","isFinite");return Lt.runKernelFunc(function(e){return e.isFinite(t)},{$x:t},function(e){return{$x:function(){return Xn(e)}}})}}),Tu=An({sin_:function(e){var n=mn(e,"x","sin");return Lt.runKernelFunc(function(e,t){e=e.sin(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return n.toFloat().cos().mul(e)}}},"Sin",{},[n])}}),Nu=An({sinh_:function(e){var n=mn(e,"x","sinh");return Lt.runKernelFunc(function(e,t){e=e.sinh(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return n.toFloat().cosh().mulStrict(e)}}})}}),Fu=An({softplus_:function(e){var n=mn(e,"x","softplus");return Lt.runKernelFunc(function(e,t){e=e.softplus(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.mul(n.sigmoid())}}})}}),_u=An({sqrt_:function(e){var n=mn(e,"x","sqrt");return Lt.runKernelFunc(function(e,t){e=e.sqrt(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(n.toFloat().sqrt().mul(2))}}})}}),Ou=An({step_:function(e,t){void 0===t&&(t=0);var n=mn(e,"x","step");return Lt.runKernelFunc(function(e){return e.step(n,t)},{$x:n},function(e){return{$x:function(){return Xn(e)}}})}}),Mu=An({tan_:function(e){var n=mn(e,"x","tan");return Lt.runKernelFunc(function(e,t){e=e.tan(n);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return e.div(n.cos().square())}}})}}),Bu=An({tanh_:function(e){var n=mn(e,"x","tanh");return Lt.runKernelFunc(function(e,t){e=e.tanh(n);return t([e]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return On(1).sub(n.square()).mulStrict(e)}}},"Tanh",{},null,[!0])}});function Pu(e,t,n,r,o,i){var a,s,u=mn(e,"x","batchNorm"),c=mn(t,"mean","batchNorm"),l=mn(n,"variance","batchNorm");return null!=o&&(a=mn(o,"scale","batchNorm")),null!=r&&(s=mn(r,"offset","batchNorm")),C(2===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),C(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),C(2===l.rank||1===l.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+l.rank+"."}),null!=a&&C(2===a.rank||1===a.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+a.rank+"."}),null!=s&&C(2===s.rank||1===s.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),Uu(u,c,l,s,a,i)}function Lu(e,t,n,r,o,i){var a,s,u=mn(e,"x","batchNorm"),c=mn(t,"mean","batchNorm"),l=mn(n,"variance","batchNorm");return null!=o&&(a=mn(o,"scale","batchNorm")),null!=r&&(s=mn(r,"offset","batchNorm")),C(3===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),C(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),C(3===l.rank||1===l.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+l.rank+"."}),null!=a&&C(3===a.rank||1===a.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+a.rank+"."}),null!=s&&C(3===s.rank||1===s.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),Uu(u,c,l,s,a,i)}function Wu(e,t,n,r,o,i){var a,s,u=mn(e,"x","batchNorm"),c=mn(t,"mean","batchNorm"),l=mn(n,"variance","batchNorm");return null!=o&&(a=mn(o,"scale","batchNorm")),null!=r&&(s=mn(r,"offset","batchNorm")),C(4===u.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),C(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),C(4===l.rank||1===l.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+l.rank+"."}),null!=a&&C(4===a.rank||1===a.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+a.rank+"."}),null!=s&&C(4===s.rank||1===s.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),Uu(u,c,l,s,a,i)}function Uu(e,t,n,r,o,p){null==p&&(p=.001);var i,a,s=mn(e,"x","batchNorm"),u=mn(t,"mean","batchNorm"),c=mn(n,"variance","batchNorm");null!=o&&(i=mn(o,"scale","batchNorm")),null!=r&&(a=mn(r,"offset","batchNorm")),C(u.rank===c.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),C(null==a||u.rank===a.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),C(null==i||u.rank===i.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."});var f=0===s.rank||1===s.rank?s.as4D(1,1,1,s.size):2===s.rank?s.as4D(1,1,s.shape[0],s.shape[1]):3===s.rank?s.as4D(1,s.shape[0],s.shape[1],s.shape[2]):s,r=[s,u,c,i];return Lt.runKernelFunc(function(e,t){e=e.batchNormalization(f,Vu(u),Vu(c),p,Vu(i),Vu(a));return t([s,u,c,i]),e},{x:s,mean:u,variance:c,scale:i,offset:a},function(t,e){var n=e[0],r=e[1],o=e[2],e=e[3],i=null==e?On(1):e,a=Eo(r.shape,f.shape),s=[];if(1===r.rank){for(var u=0;u<f.shape.length-1;++u)s.push(f.shape[u]);s.push(1)}var c=n.sub(r),l=t.mul(i),h=Ru(o.add(On(p))),d=h.mul(h).mul(h).mul(On(-.5));return{x:function(){return(1===r.rank?t.mul(Lr(h.as4D(1,1,1,r.shape[0]),s)):t.mul(h)).mul(i).reshape(n.shape)},mean:function(){var e=h.mul(On(-1)).mul(l);return(e=1===r.rank?e.sum(a):e).reshape(r.shape)},variance:function(){var e=d.mul(c).mul(l);return(e=1===r.rank?e.sum(a):e).reshape(r.shape)},scale:function(){var e=c.mul(h),e=t.mul(e);return(e=1===r.rank?e.sum(a):e).reshape(r.shape)},offset:function(){var e=t;return(e=1===r.rank?e.sum(a):e).reshape(r.shape)}}},"BatchNormalization",{varianceEpsilon:p},r).reshape(s.shape)}function Vu(e){return null==e?null:0===e.rank?e.as1D():1===e.rank?e:2===e.rank?e.as4D(1,1,e.shape[0],e.shape[1]):3===e.rank?e.as4D(1,e.shape[0],e.shape[1],e.shape[2]):e}function zu(){Xe("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var Gu=An({batchNormalization2d_:function(e,t,n,r,o,i){return void 0===r&&(r=.001),zu(),Pu(e,t,n,i,o,r)}}),Hu=An({batchNormalization3d_:function(e,t,n,r,o,i){return void 0===r&&(r=.001),zu(),Lu(e,t,n,i,o,r)}}),qu=An({batchNormalization4d_:function(e,t,n,r,o,i){return void 0===r&&(r=.001),zu(),Wu(e,t,n,i,o,r)}}),Ku=An({batchNormalization_:function(e,t,n,r,o,i){return void 0===r&&(r=.001),zu(),Uu(e,t,n,i,o,r)}}),ju=An({batchNorm_:Uu}),Xu=An({batchNorm2d_:Pu}),Yu=An({batchNorm3d_:Lu}),$u=An({batchNorm4d_:Wu}),Qu=An({logicalAnd_:function(e,t){var n=mn(e,"a","logicalAnd","bool"),r=mn(t,"b","logicalAnd","bool");return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.logicalAnd(n,r)},{a:n,b:r},null,"LogicalAnd")}}),Ju=An({logicalNot_:function(e){var t=mn(e,"x","logicalNot","bool");return Lt.runKernelFunc(function(e){return e.logicalNot(t)},{$x:t})}}),Zu=An({logicalOr_:function(e,t){var n=mn(e,"a","logicalOr","bool"),r=mn(t,"b","logicalOr","bool");return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.logicalOr(n,r)},{$a:n,$b:r})}}),tc=An({logicalXor_:function(e,t){var n=mn(e,"a","logicalXor","bool"),r=mn(t,"b","logicalXor","bool");return Ro(n.shape,r.shape),Zu(e,t).logicalAnd(Qu(e,t).logicalNot())}}),ec=An({where_:function(e,t,n){var r=mn(t,"a","where"),o=mn(n,"b","where"),i=mn(e,"condition","where","bool");return E(r.shape,o.shape,"Error in where: "),1===i.rank?C(i.shape[0]===r.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):E(i.shape,o.shape,"Error in where: "),Lt.runKernelFunc(function(e,t){e=e.select(i,r,o);return t([i]),e},{$condition:i,$a:r,$b:o},function(e,t){var n=t[0];return{$condition:function(){return Xn(n).toFloat()},$a:function(){return e.mul(n.cast(e.dtype))},$b:function(){return e.mul(n.logicalNot().cast(e.dtype))}}})}}),nc=function(o){return n(this,void 0,void 0,function(){var t,n;return r(this,function(e){switch(e.label){case 0:return[4,(t=mn(o,"condition","whereAsync","bool")).data()];case 1:return n=e.sent(),n=na(t.shape,n),o!==t&&t.dispose(),[2,n]}})})},rc=An({add_:function(e,t){var r=mn(e,"a","add"),o=mn(t,"b","add"),t=Nt(r,o),r=t[0],o=t[1],i=Ro(r.shape,o.shape);return Lt.runKernelFunc(function(e){return e.add(r,o)},{a:r,b:o},function(n){return{a:function(){var e=n,t=Eo(r.shape,i);return(e=0<t.length?e.sum(t):e).reshape(r.shape)},b:function(){var e=n,t=Eo(o.shape,i);return(e=0<t.length?e.sum(t):e).reshape(o.shape)}}},"Add")}}),oc=An({addN_:function(e){C(Array.isArray(e),function(){return"The argument passed to tf.addN() must be a list of tensors"}),C(1<=e.length,function(){return"Must pass at least one tensor to tf.addN(), but got "+e.length});var t=e.map(function(e,t){return mn(e,"tensors"+t,"addN")}),n=t[0];return t.forEach(function(e){if(e.dtype!==n.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),t.forEach(function(e){if(!S(e.shape,n.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")}),Lt.runKernelFunc(function(e){return e.addN(t)},t,function(n){var r={};return t.forEach(function(e,t){r[t]=function(){return n.clone()}}),r},"AddN")}}),ac=An({addStrict_:function(e,t){e=mn(e,"a","addStrict"),t=mn(t,"b","addStrict");return E(e.shape,t.shape,"Error in addStrict: "),e.add(t)}}),ic=An({atan2_:function(e,t){var n=mn(e,"a","atan2"),r=mn(t,"b","atan2"),t=Nt(n,r),n=t[0],r=t[1],i=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.atan2(n,r);return t([n,r]),e},{$a:n,$b:r},function(n,e){var r=e[0],o=e[1];return{$a:function(){var e=rc(r.square(),o.square()),t=n.mul(o.div(e)),e=Eo(r.shape,i);return(t=0<e.length?t.sum(e):t).reshape(r.shape)},$b:function(){var e=rc(r.square(),o.square()),t=wu(n.mul(r.div(e))),e=Eo(o.shape,i);return(t=0<e.length?t.sum(e):t).reshape(o.shape)}}})}}),sc=An({div_:function(e,t){var n=mn(e,"a","div"),r=mn(t,"b","div"),t=Nt(n,r),n=t[0],r=t[1];if("int32"===n.dtype&&"int32"===r.dtype)return lc(n,r);var i=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.realDivide(n,r);return t([n,r]),e},{a:n,b:r},function(n,e){var r=e[0],o=e[1];return{a:function(){var e=n.div(o.toFloat()),t=Eo(r.shape,i);return 0<t.length?e.sum(t).reshape(r.shape):e},b:function(){var e=n.mul(r.toFloat()),t=Eo(o.shape,i);0<t.length&&(e=e.sum(t).reshape(o.shape));t=o.square();return e.div(t.toFloat()).neg()}}},"Div")}}),uc=An({divNoNan_:function(e,t){var n=(t=Nt(n=mn(e,"a","div"),e=mn(t,"b","div")))[0],e=t[1],t=sc(n,e),n=Xn(t),e=e.equal(n);return ec(e,n,t)}}),cc=An({divStrict_:function(e,t){e=mn(e,"a","div"),t=mn(t,"b","div");return E(e.shape,t.shape,"Error in divideStrict: "),e.div(t)}}),lc=An({floorDiv_:function(e,t){var n=mn(e,"a","floorDiv"),r=mn(t,"b","floorDiv"),t=Nt(n,r),n=t[0],r=t[1],i=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.floorDiv(n,r);return t([n,r]),e},{a:n,b:r},function(n,e){var r=e[0],o=e[1];return{a:function(){var e=n.div(o.toFloat()),t=Eo(r.shape,i);return 0<t.length?e.sum(t).reshape(r.shape):e},b:function(){var e=n.mul(r.toFloat()),t=Eo(o.shape,i);0<t.length&&(e=e.sum(t).reshape(o.shape));t=o.square();return e.div(t.toFloat()).neg()}}},"FloorDiv")}}),hc=An({maximum_:function(e,t){var n=mn(e,"a","maximum"),r=mn(t,"b","maximum"),t=Nt(n,r),n=t[0],r=t[1];return"bool"===n.dtype&&(n=n.toInt(),r=r.toInt()),Ro(n.shape,r.shape),Lt.runKernelFunc(function(e,t){e=e.maximum(n,r);return t([n,r]),e},{a:n,b:r},function(e,t){var n=t[0],r=t[1];return{a:function(){return e.mul(n.greaterEqual(r).toFloat())},b:function(){return e.mul(n.less(r).toFloat())}}},"Maximum")}}),fc=An({maximumStrict_:function(e,t){e=mn(e,"a","maximumStrict"),t=mn(t,"b","maximumStrict");return E(e.shape,t.shape,"Error in maximumStrict: "),e.maximum(t)}}),dc=An({minimum_:function(e,t){var n=mn(e,"a","minimum"),r=mn(t,"b","minimum"),t=Nt(n,r),n=t[0],r=t[1];return"bool"===n.dtype&&(n=n.toInt(),r=r.toInt()),Ro(n.shape,r.shape),Lt.runKernelFunc(function(e,t){e=e.minimum(n,r);return t([n,r]),e},{a:n,b:r},function(e,t){var n=t[0],r=t[1];return{a:function(){return e.mul(n.lessEqual(r).toFloat())},b:function(){return e.mul(n.greater(r).toFloat())}}},"Minimum")}}),pc=An({minimumStrict_:function(e,t){e=mn(e,"a","minimumStrict"),t=mn(t,"b","minimumStrict");return E(e.shape,t.shape,"Error in minimumStrict: "),e.minimum(t)}}),vc=An({mod_:function(e,t){var n=mn(e,"a","mod"),r=mn(t,"b","mod"),t=Nt(n,r),n=t[0],r=t[1],i=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.mod(n,r);return t([n,r]),e},{$a:n,$b:r},function(n,e){var r=e[0],o=e[1];return{$a:function(){var e=Eo(r.shape,i);return 0<e.length?n.sum(e).reshape(r.shape):n},$b:function(){var e=n.mul(r.div(o).floor().neg()),t=Eo(o.shape,i);return 0<t.length?e.sum(t).reshape(o.shape):e}}})}}),mc=An({modStrict_:function(e,t){e=mn(e,"a","modStrict"),t=mn(t,"b","modStrict");return E(e.shape,t.shape,"Error in modStrict: "),e.mod(t)}}),gc=An({mul_:function(e,t){var n=mn(e,"a","mul"),r=mn(t,"b","mul"),t=Nt(n,r),n=t[0],r=t[1],i=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.multiply(n,r);return t([n,r]),e},{a:n,b:r},function(n,e){var r=e[0],o=e[1];return{a:function(){var e=n.mul(o.toFloat()),t=Eo(r.shape,i);return 0<t.length?e.sum(t).reshape(r.shape):e},b:function(){var e=n.mul(r.toFloat()),t=Eo(o.shape,i);return 0<t.length?e.sum(t).reshape(o.shape):e}}},"Mul")}}),yc=An({mulStrict_:function(e,t){e=mn(e,"a","mul"),t=mn(t,"b","mul");return E(e.shape,t.shape,"Error in multiplyStrict: "),e.mul(t)}}),xc=An({pow_:function(e,t){var n=mn(e,"base","pow"),r=mn(t,"exp","pow"),t=Nt(n,r),n=t[0],r=t[1],a=Ro(n.shape,r.shape);return Lt.runKernelFunc(function(e,t){e=e.pow(n,r);return t([n,r,e]),e},{a:n,b:r},function(n,e){var r=e[0],o=e[1],i=e[2];return{a:function(){var e=o.toFloat(),t=n.mul(e.mul(r.pow(e.sub(On(1))))),e=Eo(r.shape,a);return(t=0<e.length?t.sum(e):t).reshape(r.shape)},b:function(){var e=r.greater(0),t=r.log().where(e,Xn(r)),e=n.mul(i.mul(t)),t=Eo(o.shape,a);return(e=0<t.length?e.sum(t):e).reshape(o.shape)}}},"Pow",{},[n,r],[!0])}}),bc=An({powStrict_:function(e,t){return E(e.shape,t.shape,"Error in powStrict: "),e.pow(t)}}),wc=An({squaredDifferenceStrict_:function(e,t){e=mn(e,"a","squaredDifferenceStrict"),t=mn(t,"b","squaredDifferenceStrict");return E(e.shape,t.shape,"Error in squaredDifferenceStrict: "),e.squaredDifference(t)}}),Cc=An({sub_:function(e,t){var r=mn(e,"a","sub"),o=mn(t,"b","sub"),t=Nt(r,o),r=t[0],o=t[1],i=Ro(r.shape,o.shape);return Lt.runKernelFunc(function(e){return e.subtract(r,o)},{a:r,b:o},function(n){return{a:function(){var e=n,t=Eo(r.shape,i);return(e=0<t.length?e.sum(t):e).reshape(r.shape)},b:function(){var e=n,t=Eo(o.shape,i);return(e=0<t.length?e.sum(t):e).neg().reshape(o.shape)}}},"Sub")}}),Ec=An({subStrict_:function(e,t){e=mn(e,"a","subStrict"),t=mn(t,"b","subStrict");return E(e.shape,t.shape,"Error in subStrict: "),e.sub(t)}}),Rc=An({equal_:function(e,t){var n=mn(e,"a","equal"),r=mn(t,"b","equal"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.equal(n,r)},{$a:n,$b:r})}}),Ic=An({equalStrict_:function(e,t){e=mn(e,"a","equalStrict"),t=mn(t,"b","equalStrict");return E(e.shape,t.shape,"Error in equalStrict: "),e.equal(t)}}),kc=An({greater_:function(e,t){var n=mn(e,"a","greater"),r=mn(t,"b","greater"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.greater(n,r)},{a:n,b:r},null,"Greater")}}),Sc=An({greaterEqual_:function(e,t){var n=mn(e,"a","greaterEqual"),r=mn(t,"b","greaterEqual"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e,t){e=e.greaterEqual(n,r);return t([n,r]),e},{a:n,b:r},function(e,t){var n=t[0],r=t[1];return{a:function(){return Xn(n)},b:function(){return Xn(r)}}},"GreaterEqual")}}),Ac=An({greaterEqualStrict_:function(e,t){e=mn(e,"a","greaterEqualStrict"),t=mn(t,"b","greaterEqualStrict");return E(e.shape,t.shape,"Error in greaterEqualStrict: "),e.greaterEqual(t)}}),Dc=An({greaterStrict_:function(e,t){e=mn(e,"a","greaterStrict"),t=mn(t,"b","greaterStrict");return E(e.shape,t.shape,"Error in greaterStrict: "),e.greater(t)}}),Tc=An({less_:function(e,t){var n=mn(e,"a","less"),r=mn(t,"b","less"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.less(n,r)},{a:n,b:r},null,"Less")}}),Nc=An({lessEqual_:function(e,t){var n=mn(e,"a","lessEqual"),r=mn(t,"b","lessEqual"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e,t){e=e.lessEqual(n,r);return t([n,r]),e},{a:n,b:r},null,"LessEqual")}}),Fc=An({lessEqualStrict_:function(e,t){e=mn(e,"a","lessEqualStrict"),t=mn(t,"b","lessEqualStrict");return E(e.shape,t.shape,"Error in lessEqualStrict: "),e.lessEqual(t)}}),_c=An({lessStrict_:function(e,t){e=mn(e,"a","lessStrict"),t=mn(t,"b","lessStrict");return E(e.shape,t.shape,"Error in lessStrict: "),e.less(t)}}),Oc=An({notEqual_:function(e,t){var n=mn(e,"a","notEqual"),r=mn(t,"b","notEqual"),t=Nt(n,r),n=t[0],r=t[1];return Ro(n.shape,r.shape),Lt.runKernelFunc(function(e){return e.notEqual(n,r)},{a:n,b:r},null,"NotEqual")}}),Mc=An({notEqualStrict_:function(e,t){e=mn(e,"a","notEqualStrict"),t=mn(t,"b","notEqualStrict");return E(e.shape,t.shape,"Error in notEqualStrict: "),e.notEqual(t)}});function Bc(e,t){for(var n=[],r=e;r<t;++r)n.push(r);return n}function Pc(e){for(var t=[],n=0;n<e.length;++n)for(var r=0;r<e[n].length;++r)t.push(e[n][r]);return t}var Lc=An({gather_:function(e,t,u){void 0===u&&(u=0);var c=mn(e,"x","gather"),n=mn(t,"indices","gather","int32");u=O(u,c.shape)[0];t=function(e,t,n){for(var r=e.shape[n],o=[],i=1,a=1,s=0;s<n;s++)o.push(e.shape[s]),i*=e.shape[s];for(s=0;s<t.rank;s++)o.push(t.shape[s]);for(s=n+1;s<e.rank;s++)o.push(e.shape[s]),a*=e.shape[s];return{batchSize:i,sliceSize:a,dimSize:r,outputShape:o}}(c,n,u);return Lt.runKernelFunc(function(e,t){e=e.gather(c,n.flatten(),u);return t([n]),e},{x:c,indices:n},function(a,e){var s=e[0];return{x:function(){var e=c.shape,t=s.size,n=e.slice(0,u),r=n.length,o=e.slice(u,e.length).slice(1),i=o.length,e=Bc(0,r),i=Bc(r+1,r+1+i),o=Pc([n,[t],o]),o=a.reshape(o),t=s.reshape([t]),i=Pc([[r],e,i]),o=o.transpose(i),t=Wc(o,t,c.shape[u]),i=Rn(i);return t.transpose(i)},indices:function(){return s}}},"Gather",{axis:u}).reshape(t.outputShape)}}),Wc=An({unsortedSegmentSum_:function(e,t,n){var r=mn(e,"x","unsortedSegmentSum"),o=mn(t,"segmentIds","unsortedSegmentSum","int32");return C(A(n),function(){return"numSegments must be of dtype int"}),Lt.runKernelFunc(function(e,t){e=e.unsortedSegmentSum(r,o,n);return t([o]),e},{$x:r},function(e,t){var n=t[0];return{$x:function(){return function(e,t){for(var n=hc(t,Xn(t)),n=Lc(e,n),r=Sc(t,On(0,"int32")),o=n.rank-r.rank,i=0;i<o;++i)r=wr(r,i+1);r=Qu(r,zn(n.shape,"bool")),t=Xn(n);return ec(r,n,t)}(e,n)}}})}}),Uc=function(f,m,g){return n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c,l,h,d,p;return r(this,function(e){switch(e.label){case 0:for(t=mn(f,"tensor","boolMask"),n=mn(m,"mask","boolMask","bool"),o=null==g?0:g,i=n.rank,a=t.shape,C(0<i,function(){return"mask cannot be scalar"}),E(a.slice(o,o+i),n.shape,"mask's shape must match the first K dimensions of tensor's shape,"),s=1,u=o;u<o+i;u++)s*=a[u];return p=a.slice(0,o).concat([s],a.slice(o+i)),c=t.reshape(p),l=n.reshape([-1]),[4,nc(l)];case 1:return h=e.sent(),d=h.squeeze([1]),p=Lc(c,d,o),f!==t&&t.dispose(),m!==n&&n.dispose(),d.dispose(),c.dispose(),l.dispose(),h.dispose(),[2,p]}})})};function Vc(e,t,n,o,i,a,s){void 0===a&&(a="NHWC"),C(e.length===t.rank,function(){return"Length of inShape ("+e.length+") and rank of dy ("+t.rank+") must match"});var r=e,u=t,c=!1;3===t.rank&&(c=!0,u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]),r=[1,e[0],e[1],e[2]]),C(4===r.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+r.length+"."}),C(4===u.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),C(4===n.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+n.rank});var l="NHWC"===a?r[3]:r[1],h="NHWC"===a?u.shape[3]:u.shape[1];C(l===n.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+n.shape[2]+"."}),C(h===n.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+h+") must match output depth for filter "+n.shape[3]+"."}),null!=s&&C(A(i),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+s+" but got pad "+i+"."});var d=Bo(a),p=So(r,n.shape,o,1,i,s,!1,d),d=Lt.runKernelFunc(function(e,t){e=e.conv2dDerInput(u,n,p);return t([n,u]),e},{dy4D:u,filter:n},function(e,t){var n=t[0],r=t[1];return{dy4D:function(){return qc(e,n,o,i,a,1,s)},filter:function(){return jc(e,r,n.shape,o,i,a,s)}}});return c?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}function zc(e){var t="number"==typeof e?[e,e,e]:2===e.length?[e[0],e[1],1]:e,n=t[0],e=t[1],t=t[2];return 1===n&&1===e&&1===t}function Gc(e,t,n,r,o){C(e.length===t.rank,function(){return"Length of inShape ("+e.length+") and rank of dy ("+t.rank+") must match"});var i=e,a=t,s=!1;4===t.rank&&(s=!0,a=t.as5D(1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]),i=[1,e[0],e[1],e[2],e[3]]);var u=i[4],c=a.shape[4];C(5===i.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+i.length+"."}),C(5===a.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+a.rank}),C(5===n.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+n.rank}),C(u===n.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+n.shape[3]+"."}),C(c===n.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+c+") must match output depth for filter "+n.shape[4]+"."});var l=Ao(i,n.shape,r,1,o),o=Lt.runKernelFunc(function(e){return e.conv3dDerInput(a,n,l)},{dy5D:a});return s?o.as4D(o.shape[1],o.shape[2],o.shape[3],o.shape[4]):o}var Hc=An({conv1d_:function(e,t,n,r,o,i,a){void 0===o&&(o="NWC"),void 0===i&&(i=1);var s=mn(e,"x","conv1d"),u=mn(t,"filter","conv1d"),c=s,e=!1;2===s.rank&&(e=!0,c=s.as3D(1,s.shape[0],s.shape[1])),C(3===c.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+c.rank+"."}),C(3===u.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),null!=a&&C(A(r),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."}),C(c.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+c.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),C(Mo(n,i),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+n+" and dilation '"+i+"'"}),C("NWC"===o,function(){return"Error in conv1d: got dataFormat of "+o+" but only NWC is currently supported."});t=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),s=c.as4D(c.shape[0],1,c.shape[1],c.shape[2]),t=qc(s,t,[1,n],r,"NHWC",[1,i],a);return e?t.as2D(t.shape[2],t.shape[3]):t.as3D(t.shape[0],t.shape[2],t.shape[3])}}),qc=An({conv2d_:function(e,t,o,i,a,s,n){void 0===a&&(a="NHWC"),void 0===s&&(s=[1,1]);var e=mn(e,"x","conv2d"),r=mn(t,"filter","conv2d"),u=e,t=!1;3===e.rank&&(t=!0,u=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),C(4===u.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+u.rank+"."}),C(4===r.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+r.rank+"."}),null!=n&&C(A(i),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+n+" but got pad "+i+"."});var c="NHWC"===a?u.shape[3]:u.shape[1];C(c===r.shape[2],function(){return"Error in conv2d: depth of input ("+c+") must match input depth for filter "+r.shape[2]+"."}),C(Mo(o,s),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+o+" and dilations '"+s+"'"});var e=Bo(a),l=So(u.shape,r.shape,o,s,i,n,!1,e),e=[r,u],e=Lt.runKernelFunc(function(e,t){e=e.conv2d(u,r,l);return t([r,u]),e},{x:u,filter:r},function(e,t){var n=t[0],r=t[1];return C(Oo(s),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+s+"'"}),{x:function(){return Xc(r.shape,e,n,o,i,a)},filter:function(){return jc(r,e,n.shape,o,i,a)}}},"Conv2D",l,e);return t?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),Kc=An({conv3d_:function(e,t,o,i,n,a){void 0===n&&(n="NDHWC"),void 0===a&&(a=[1,1,1]);var e=mn(e,"x","conv3d"),r=mn(t,"filter","conv3d"),s=e,t=!1;4===e.rank&&(t=!0,s=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3])),C(5===s.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+s.rank+"."}),C(5===r.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+r.rank+"."}),C(s.shape[4]===r.shape[3],function(){return"Error in conv3d: depth of input ("+s.shape[4]+") must match input depth for filter "+r.shape[3]+"."}),C((e=a,zc(o)||zc(e)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+o+" and dilations '"+a+"'"}),C("NDHWC"===n,function(){return"Error in conv3d: got dataFormat of "+n+" but only NDHWC is currently supported."});var u=Ao(s.shape,r.shape,o,a,i),e=Lt.runKernelFunc(function(e,t){e=e.conv3d(s,r,u);return t([s,r]),e},{x:s,$filter:r},function(e,t){C(zc(a),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"});var n=t[0],r=t[1];return{x:function(){return Gc(n.shape,e,r,o,i)},$filter:function(){return function(e,t,n,r,o){var i=e;4===e.rank&&(i=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3]));var a=t;4===a.rank&&(a=t.as5D(1,t.shape[0],t.shape[1],t.shape[2],t.shape[3])),C(5===i.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+i.shape+"."}),C(5===a.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+a.shape+"."}),C(5===n.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+n+"."}),C(i.shape[4]===n[3],function(){return"Error in conv3dDerFilter: depth of input "+i.shape[4]+") must match input depth in filter ("+n[3]+"."}),C(a.shape[4]===n[4],function(){return"Error in conv3dDerFilter: depth of dy ("+a.shape[4]+") must match output depth for filter ("+n[4]+")."});var s=Ao(i.shape,n,r,1,o);return Lt.runKernelFunc(function(e){return e.conv3dDerFilter(i,a,s)},{x5D:i,dy5D:a})}(n,e,r.shape,o,i)}}});return t?e.as4D(e.shape[1],e.shape[2],e.shape[3],e.shape[4]):e}}),jc=An({conv2dDerFilter_:function(e,t,n,r,o,i,a){void 0===i&&(i="NHWC");var s=e;3===e.rank&&(s=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var u=t;3===u.rank&&(u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),C(4===s.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),C(4===u.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),C(4===n.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+n+"."});var c="NHWC"===i?s.shape[3]:s.shape[1],l="NHWC"===i?u.shape[3]:u.shape[1];C(c===n[2],function(){return"Error in conv2dDerFilter: depth of input "+c+") must match input depth in filter ("+n[2]+"."}),C(l===n[3],function(){return"Error in conv2dDerFilter: depth of dy ("+l+") must match output depth for filter ("+n[3]+")."}),null!=a&&C(A(o),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var i=Bo(i),h=So(s.shape,n,r,1,o,a,!1,i);return Lt.runKernelFunc(function(e){return e.conv2dDerFilter(s,u,h)},{x4D:s,dy4D:u})}}),Xc=An({conv2dDerInput_:Vc}),Yc=An({depthwiseConv2d_:function(e,t,n,r,o,i,a){void 0===i&&(i=[1,1]);var e=mn(e,"x","depthwiseConv2d"),s=mn(t,"filter","depthwiseConv2d"),u=e,t=!1;3===e.rank&&(t=!0,u=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),C(4===u.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+u.rank+"."}),C(4===s.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+s.rank+"."}),C(u.shape[3]===s.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+u.shape[3]+") must match the inChannels dimension in filter "+s.shape[2]+"."}),C(Mo(n,i=null==i?[1,1]:i),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+i+"'"}),null!=a&&C(A(r),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."});var c=So(u.shape,s.shape,n,i,r,a,!0),e=[u,s],e=Lt.runKernelFunc(function(e,t){e=e.depthwiseConv2D(u,s,c);return t([u,s]),e},{x:u,filter:s},function(e,t){C(Oo(i),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+i+"'"});var n=t[0],r=t[1];return{x:function(){return $c(n.shape,e,r,c)},filter:function(){return Qc(n,e,r.shape,c)}}},"DepthwiseConv2dNative",c,e);return t?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),$c=An({depthwiseConv2dDerInput_:function(e,t,n,r){var o=t,i=!1;3===t.rank&&(i=!0,o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));t=Lt.runKernelFunc(function(e){return e.depthwiseConv2DDerInput(o,n,r)},{dy4D:o});return i?t.as3D(t.shape[1],t.shape[2],t.shape[3]):t}}),Qc=An({depthwiseConv2dDerFilter_:function(e,t,n,r){var o=e;3===e.rank&&(o=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var i=t;return 3===i.rank&&(i=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),Lt.runKernelFunc(function(e){return e.depthwiseConv2DDerFilter(o,i,r)},{x4D:o,dy4D:i})}}),Jc=An({separableConv2d_:function(e,t,n,r,o,i,a){void 0===i&&(i=[1,1]),void 0===a&&(a="NHWC");var e=mn(e,"x","separableConv2d"),s=mn(t,"depthwiseFilter","separableConv2d"),u=mn(n,"pointwiseFilter","separableConv2d"),c=e,n=!1;if(3===e.rank&&(n=!0,c=e.as4D(1,e.shape[0],e.shape[1],e.shape[2])),"NCHW"===a)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");C(4===c.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+c.rank+"."}),C(4===s.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+s.rank+"."}),C(4===u.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+s.rank+"."}),C(1===u.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+u.shape[0]+"."}),C(1===u.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+u.shape[1]+"."});var l=s.shape[2],h=s.shape[3];C(u.shape[2]===l*h,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+l*h+", but got "+u.shape[2]+"."});i=Yc(c,s,r,o,a,i),a=qc(i,u,1,"valid",a);return n?a.as3D(a.shape[1],a.shape[2],a.shape[3]):a}}),Zc=An({conv2dTranspose_:function(e,t,n,r,o,i){return Vc(n,mn(e,"x","conv2dTranspose"),mn(t,"filter","conv2dTranspose"),r,o,"NHWC",i)}}),tl=An({conv3dTranspose_:function(e,t,n,r,o){return Gc(n,mn(e,"x","conv3dTranspose"),mn(t,"filter","conv3dTranspose"),r,o)}}),el=An({matMul_:function(e,t,o,i){void 0===o&&(o=!1),void 0===i&&(i=!1);var n=mn(e,"a","matMul"),r=mn(t,"b","matMul"),n=(d=Nt(n,r))[0],r=d[1],a=o?n.shape[n.rank-2]:n.shape[n.rank-1],s=i?r.shape[r.rank-1]:r.shape[r.rank-2],u=o?n.shape[n.rank-1]:n.shape[n.rank-2],c=i?r.shape[r.rank-2]:r.shape[r.rank-1],l=n.shape.slice(0,-2),h=r.shape.slice(0,-2),e=k(l),t=k(h);C(2<=n.rank&&2<=r.rank&&n.rank===r.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+n.rank+" and "+r.rank+"."}),C(S(l,h),function(){return"Error in matMul: outer dimensions ("+l+") and ("+h+") of Tensors with shapes "+n.shape+" and "+r.shape+" must match."}),C(a===s,function(){return"Error in matMul: inner shapes ("+a+") and ("+s+") of Tensors with shapes "+n.shape+" and "+r.shape+" and transposeA="+o+" and transposeB="+i+" must match."});var d=n.shape.slice(0,-2).concat([u,c]),p=o?n.as3D(e,a,u):n.as3D(e,u,a),f=i?r.as3D(t,c,s):r.as3D(t,s,c),c={transposeA:o,transposeB:i};return Lt.runKernelFunc(function(e,t){e=e.batchMatMul(p,f,o,i);return t([p,f]),e},{a:p,b:f},function(e,t){var n=t[0],r=t[1];return o||i?!o&&i?{a:function(){return e.matMul(r,!1,!1)},b:function(){return e.matMul(n,!0,!1)}}:o&&!i?{a:function(){return r.matMul(e,!1,!0)},b:function(){return n.matMul(e,!1,!1)}}:{a:function(){return r.matMul(e,!0,!0)},b:function(){return e.matMul(n,!0,!0)}}:{a:function(){return e.matMul(r,!1,!0)},b:function(){return n.matMul(e,!0,!1)}}},"BatchMatMul",c).reshape(d)}}),nl=An({dot_:function(e,t){var n=mn(e,"t1","dot"),r=mn(t,"t2","dot");C(!(1!==n.rank&&2!==n.rank||1!==r.rank&&2!==r.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+n.rank+" and "+r.rank+"."});var o=1===n.rank?n.size:n.shape[1],i=1===r.rank?r.size:r.shape[0];return C(o===i,function(){return"Error in dot: inner dimensions of inputs must match, but got "+o+" and "+i+"."}),1===n.rank&&1===r.rank?n.as2D(1,-1).matMul(r.as2D(-1,1)).asScalar():1===n.rank&&2===r.rank?n.as2D(1,-1).matMul(r.as2D(r.shape[0],r.shape[1])).as1D():2===n.rank&&1===r.rank?n.matMul(r.as2D(-1,1)).as1D():n.matMul(r.as2D(r.shape[0],r.shape[1]))}}),rl=An({outerProduct_:function(e,t){var n=mn(e,"v1","outerProduct"),r=mn(t,"v2","outerProduct");return C(1===n.rank&&1===r.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+n.rank+" and "+r.rank+"."}),n.as2D(-1,1).matMul(r.as2D(1,-1))}}),ol=An({reverse_:function(e,t){var n=mn(e,"x","reverse");if(0===n.rank)return n.clone();var r=O(t,n.shape);return Lt.runKernelFunc(function(e){return e.reverse(n,r)},{$x:n},function(e){return{$x:function(){return e.reverse(r)}}}).reshapeAs(n)}}),al=An({reverse1d_:function(e){var t=mn(e,"x","reverse");return C(1===t.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+t.rank+"."}),ol(t,0)}}),il=An({reverse2d_:function(e,t){var n=mn(e,"x","reverse");return C(2===n.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+n.rank+"."}),ol(n,t)}}),sl=An({reverse3d_:function(e,t){var n=mn(e,"x","reverse");return C(3===n.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+n.rank+"."}),ol(n,t)}}),ul=An({reverse4d_:function(e,t){var n=mn(e,"x","reverse");return C(4===n.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+n.rank+"."}),ol(n,t)}});function cl(e,r,o,i,a,t){var n=mn(e,"x","maxPool"),s=n,e=!1;3===n.rank&&(e=!0,s=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),null==i&&(i=[1,1]),C(4===s.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),C(Mo(o,i),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+o+" and dilations '"+i+"'"}),null!=t&&C(A(a),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+t+" but got pad "+a+"."});var u=Io(s.shape,r,o,i,a,t);if(1===u.filterWidth&&1===u.filterHeight&&S(u.inShape,u.outShape))return n.clone();n=[s],n=Lt.runKernelFunc(function(e,t){e=e.maxPool(s,u);return t([s,e]),e},{x:s},function(l,e){var t=e[0],n=e[1];return{x:function(){return function(e,t,n,r,o,i){var a=mn(l,"dy","maxPoolBackprop"),s=mn(e,"input","maxPoolBackprop"),u=mn(t,"output","maxPoolBackprop");C(s.rank===a.rank,function(){return"Rank of input ("+s.rank+") does not match rank of dy ("+a.rank+")"}),C(Mo(r,o=null==o?[1,1]:o),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+o+"'"}),C(4===a.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+a.rank+"."}),C(4===s.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+s.rank+"."});var c=Io(s.shape,n,r,o,i,void 0);return Lt.runKernelFunc(function(e){return e.maxPoolBackprop(a,s,u,c)},{$dy:a,$input:s})}(t,n,r,o,i,a)}}},"MaxPool",u,n);return e?n.as3D(n.shape[1],n.shape[2],n.shape[3]):n}function ll(e,t,n,r,o,i){var a=mn(e,"x","avgPool","float32");C(Mo(n,r=null==r?[1,1]:r),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+r+"'"});var s=a,u=!1;3===a.rank&&(u=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),C(4===s.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),null!=i&&C(A(o),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var c=Io(s.shape,t,n,r,o,i);if(1===c.filterWidth&&1===c.filterHeight&&S(c.inShape,c.outShape))return a.clone();e=(e=Lt.runKernelFunc(function(e){return e.avgPool(s,c)},{x:s},function(l){return{x:function(){return function(e,t,n,r,o){var i=mn(l,"dy","avgPoolBackprop"),a=mn(e,"input","avgPoolBackprop");C(a.rank===i.rank,function(){return"Rank of input ("+a.rank+") does not match rank of dy ("+i.rank+")"}),C(Mo(n,r=null==r?[1,1]:r),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+r+"'"});var s=a,u=i,e=!1;3===a.rank&&(e=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]),u=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),C(4===u.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+u.rank+"."}),C(4===s.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+s.rank+"."});var c=Io(s.shape,t,n,r,o),o=Lt.runKernelFunc(function(e){return e.avgPoolBackprop(u,s,c)},{dy4D:u,input4D:s});return e?o.as3D(o.shape[1],o.shape[2],o.shape[3]):o}(s,t,n,r,o)}}},"AvgPool",c)).cast(a.dtype);return u?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}var hl=An({maxPool_:function(e,t,n,r,o){return cl(e,t,n,1,r,o)}}),fl=An({avgPool_:function(e,t,n,r,o){return ll(e,t,n,1,r,o)}}),dl=An({pool_:function(e,t,n,r,o,i){null==o&&(o=[1,1]),null==i&&(i=1),0===r&&(r="valid");var a=mn(e,"x","maxPool"),s=a,u=!1;3===a.rank&&(u=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),C(Mo(i,o),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+o+"'"});var c,l,h,d,p,f,m,g,v=Io(s.shape,t,i,o,r),b=[v.dilationHeight,v.dilationWidth],e="same"===r?(d=[v.filterHeight,v.filterWidth],c=b,d=d.map(function(e,t){return e+(e-1)*(c[t]-1)}).map(function(e){return e-1}),l=d.map(function(e){return Math.floor(e/2)}),h=d.map(function(e,t){return e-l[t]}),d.map(function(e,t){return[l[t],h[t]]})):[[0,0],[0,0]],a=1===b[0]&&1===b[1],e=(d=[v.inHeight,v.inWidth],v=b,p=(e=e).map(function(e){return e[0]}),e=e.map(function(e){return e[1]}),f=d.concat(p,e),m=v.map(function(e,t){return(e-f[t]%e)%e}),g=e.map(function(e,t){return e+m[t]}),[v.map(function(e,t){return[p[t],g[t]]}),v.map(function(e,t){return[0,m[t]]})]),v=e[1],y=a?r:"valid",x=a?s:Mr(s,b,e[0]),n=("avg"===n?function(){return ll(x,t,i,1,y)}:function(){return cl(x,t,i,1,y)})(),v=a?n:vr(n,b,v);return u?v.as3D(v.shape[1],v.shape[2],v.shape[3]):v}}),pl=An({maxPool3d_:function(e,r,o,i,a,t,s){void 0===t&&(t="NDHWC");var n=mn(e,"x","maxPool3d"),u=n,e=!1;4===n.rank&&(e=!0,u=n.as5D(1,n.shape[0],n.shape[1],n.shape[2],n.shape[3])),null==s&&(s=[1,1,1]),C(5===u.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),C("NDHWC"===t,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+t}),C(Mo(o,s),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+o+" and dilations '"+s+"'"}),null!=a&&C(A(i),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+i+"."});var c=ko(u.shape,r,o,s,i,a,t),n=Lt.runKernelFunc(function(e,t){e=e.maxPool3d(u,c);return t([u,e]),e},{x:u},function(p,e){var t=e[0],n=e[1];return{x:function(){return function(e,t,n,r,o,i,a){var s=mn(p,"dy","maxPool3dBackprop"),u=mn(e,"input","maxPool3dBackprop"),e=mn(t,"output","maxPool3dBackprop"),c=s,l=u,h=e,t=!1;4===u.rank&&(t=!0,c=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3]),l=u.as5D(1,u.shape[0],u.shape[1],u.shape[2],u.shape[3]),h=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3])),C(5===c.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+c.rank+"."}),C(5===l.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+l.rank+"."}),C(5===h.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+h.rank+"."}),C(Mo(r,o=null==o?[1,1,1]:o),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+o+"'"}),null!=a&&C(A(i),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+i+"."});var d=ko(l.shape,n,r,o,i,a),n=Lt.runKernelFunc(function(e){return e.maxPool3dBackprop(c,l,h,d)},{dy5D:c,input5D:l});return t?n.as4D(n.shape[1],n.shape[2],n.shape[3],n.shape[4]):n}(t,n,r,o,s,i,a)}}});return e?n.as4D(n.shape[1],n.shape[2],n.shape[3],n.shape[4]):n}}),vl=An({avgPool3d_:function(e,t,n,r,o,i,a){void 0===i&&(i="NDHWC");var s=mn(e,"x","avgPool3d","float32"),u=s,e=!1;4===s.rank&&(e=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==a&&(a=[1,1,1]),C(5===u.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),C("NDHWC"===i,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+i}),C(Mo(n,a),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+a+"'"}),null!=o&&C(A(r),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var c=ko(u.shape,t,n,a,r,o,i),s=(s=Lt.runKernelFunc(function(e){return e.avgPool3d(u,c)},{x:u},function(h){return{x:function(){return function(e,t,n,r,o,i){var a=mn(h,"dy","avgPool3dBackprop"),s=mn(e,"input","avgPool3dBackprop"),u=a,c=s,e=!1;4===s.rank&&(e=!0,u=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3]),c=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),C(5===u.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+u.rank+"."}),C(5===c.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+c.rank+"."}),C(Mo(n,r=null==r?[1,1,1]:r),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+r+"'"}),null!=i&&C(A(o),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var l=ko(c.shape,t,n,r,o,i),t=Lt.runKernelFunc(function(e){return e.avgPool3dBackprop(u,c,l)},{dy5D:u,input5D:c});return e?t.as4D(t.shape[1],t.shape[2],t.shape[3],t.shape[4]):t}(u,t,n,a,r,o)}}})).cast(u.dtype);return e?s.as4D(s.shape[1],s.shape[2],s.shape[3],s.shape[4]):s}}),ml=An({slice_:function(e,t,n){var r,o,i=mn(e,"x","slice");if(0===i.rank)throw new Error("Slicing scalar is not possible");(r="number"==typeof t?[t].concat(new Array(i.rank-1).fill(0)):t.length<i.rank?t.concat(new Array(i.rank-t.length).fill(0)):t.slice()).forEach(function(e){C(-1!==e,function(){return"slice() does not support negative begin indexing."})}),o=(o=null==n?new Array(i.rank).fill(-1):"number"==typeof n?[n].concat(new Array(i.rank-1).fill(-1)):n.length<i.rank?n.concat(new Array(i.rank-n.length).fill(-1)):n).map(function(e,t){return 0<=e?e:(C(-1===e,function(){return"Negative size values should be exactly -1 but got "+e+" for the slice() size at index "+t+"."}),i.shape[t]-r[t])}),eo(i,r,o);var a=i.shape,n={begin:r,size:o};return Lt.runKernelFunc(function(e){return e.slice(i,r,o)},{x:i},function(e){for(var t=[],n=0;n<e.rank;n++)t.push([r[n],a[n]-r[n]-o[n]]);return{x:function(){return e.pad(t)}}},"Slice",n)}}),gl=An({slice1d_:function(e,t,n){var r=mn(e,"x","slice1d");return C(1===r.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+r.rank+" tensor"}),ml(r,[t],[n])}}),yl=An({slice2d_:function(e,t,n){var r=mn(e,"x","slice2d");return C(2===r.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+r.rank+" tensor"}),ml(r,t,n)}}),xl=An({slice3d_:function(e,t,n){var r=mn(e,"x","slice3d");return C(3===r.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+r.rank+" tensor"}),ml(r,t,n)}}),bl=An({slice4d_:function(e,t,n){var r=mn(e,"x","slice4d");return C(4===r.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+r.rank+" tensor"}),ml(r,t,n)}});function wl(t,n,r,e,o){return n.rank<r.rank&&(n=n.reshape(wn(n.shape,e))),t.rank<r.rank&&(t=t.reshape(wn(t.shape,e))),{x:function(){var e=t.mul(r.equal(n).cast(t.dtype));return null==o?e:e.transpose(o)}}}var Cl=An({all_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","all","bool"),e=O(t,r.shape),o=e,t=En(o,r.rank);null!=t&&(r=r.transpose(t),o=In(o.length,r.rank));t=Lt.runKernelFunc(function(e){return e.all(r,o)},{$x:r});if(n){e=wn(t.shape,e);return t.reshape(e)}return t}}),El=An({any_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","any","bool"),e=O(t,r.shape),o=e,t=En(o,r.rank);null!=t&&(r=r.transpose(t),o=In(o.length,r.rank));t=Lt.runKernelFunc(function(e){return e.any(r,o)},{$x:r});if(n){e=wn(t.shape,e);return t.reshape(e)}return t}}),Rl=An({argMax_:function(e,t){void 0===t&&(t=0);var n=mn(e,"x","argMax"),r=O(t=null==t?0:t,n.shape),e=En(r,n.rank);null!=e&&(n=n.transpose(e),r=In(r.length,n.rank));t={axis:r[0]},e=[n];return Lt.runKernelFunc(function(e,t){e=e.argMax(n,r[0]);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return Xn(n)}}},"ArgMax",t,e)}}),Il=An({argMin_:function(e,t){void 0===t&&(t=0);var n=mn(e,"x","argMin"),r=O(t=null==t?0:t,n.shape),t=En(r,n.rank);return null!=t&&(n=n.transpose(t),r=In(r.length,n.rank)),Lt.runKernelFunc(function(e,t){e=e.argMin(n,r[0]);return t([n]),e},{$x:n},function(e,t){var n=t[0];return{$x:function(){return Xn(n)}}})}}),kl=An({logSumExp_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","logSumExp"),e=O(t,r.shape),t=r.max(e,!0),r=r.sub(t).exp().sum(e).log(),r=t.reshape(r.shape).add(r);if(n){e=wn(r.shape,e);return r.reshape(e)}return r}}),Sl=An({max_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","max"),o=r,i=O(t,r.shape),a=i,s=En(a,r.rank);null!=s&&(r=r.transpose(s),a=In(a.length,r.rank));t=[r],t=Lt.runKernelFunc(function(e,t){e=e.max(r,a);return t([o,e]),e},{x:r},function(e,t){return wl(e,t[1],t[0],i,s)},"Max",{axes:a},t,[!0]);return n&&(n=wn(t.shape,i),t=t.reshape(n)),t}}),Al=An({mean_:function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=!1);var e=mn(e,"x","mean"),o=O(t,e.shape),i=k(bn(e.shape,o)[1]);return vo(function(n){var e=On(i);return{value:(e.dtype===n.dtype?n:n.cast(e.dtype)).div(e).sum(t,r),gradFunc:function(e){var t=n.shape.slice();return o.forEach(function(e){t[e]=1}),e.reshape(t).mul(zn(n.shape,"float32")).div(i)}}})(e)}}),Dl=An({min_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","min"),o=r,i=O(t,r.shape),a=i,s=En(a,r.rank);null!=s&&(r=r.transpose(s),a=In(a.length,r.rank));t=[r],t=Lt.runKernelFunc(function(e,t){e=e.min(r,a);return t([o,e]),e},{x:r},function(e,t){return wl(e,t[1],t[0],i,s)},"Min",{axes:a},t,[!0]);return n&&(n=wn(t.shape,i),t=t.reshape(n)),t}}),Tl=An({moments_:function(e,t,n){void 0===n&&(n=!1);var r=O(t=void 0===t?null:t,(e=mn(e,"x","moments")).shape),o=e.mean(r,n),t=o.shape;n||(t=wn(o.shape,r));t=e.toFloat().sub(o.reshape(t)).square();return{mean:o,variance:t.mean(r,n)}}}),Nl=An({sum_:function(e,t,a){void 0===t&&(t=null),void 0===a&&(a=!1);var e=mn(e,"x","sum"),s=O(t,(e="bool"===e.dtype?e.toInt():e).shape);return vo(function(n){var e=En(s,n.rank),t=s,r=n;null!=e&&(r=n.transpose(e),t=In(t.length,n.rank));function o(e){var t=n.shape.slice();return s.forEach(function(e){t[e]=1}),e.reshape(t).mul(zn(n.shape,"float32"))}var i={axes:t},e=Lt.runKernelFunc(function(e){return e.sum(r,t)},{x:r},function(e){return{x:function(){return o(e)}}},"Sum",i);return a&&(i=wn(e.shape,s),e=e.reshape(i)),{value:e,gradFunc:o}})(e)}}),Fl=An({prod_:function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var r=mn(e,"x","prod"),e=O(t,(r="bool"===r.dtype?r.toInt():r).shape),t=En(e,r.rank),o=e,i=r;null!=t&&(i=r.transpose(t),o=In(o.length,r.rank));r=Lt.runKernelFunc(function(e){return e.prod(i,o)},{permutedX:i});return n&&(e=wn(r.shape,e),r=r.reshape(e)),r}}),_l=An({elu_:function(e){var n=mn(e,"x","elu");return Lt.runKernelFunc(function(e,t){e=e.elu(n);return t([e]),e},{$x:n},function(t,e){var n=e[0];return{$x:function(){return Lt.runKernelFunc(function(e){return e.eluDer(t,n)},{dy:t,y:n})}}})}}),Ol=An({leakyRelu_:function(e,t){void 0===t&&(t=.2);e=mn(e,"x","leakyRelu");return hc(On(t).mul(e),e)}}),Ml=An({prelu_:function(e,t){var n=mn(e,"x","prelu"),r=mn(t,"alpha","prelu");return Lt.runKernelFunc(function(e,t){e=e.prelu(n,r);return t([n,r]),e},{x:n,alpha:r},function(n,e){var r=e[0],o=e[1],i=r.greater(0);return{x:function(){return ec(i,n,n.mul(o))},alpha:function(){var e=ec(i,Xn(n),n.mul(r)),t=Eo(o.shape,n.shape);return(e=0<t.length?e.sum(t):e).reshape(o.shape)}}},"Prelu")}}),Bl=An({relu_:function(e){var n=mn(e,"x","relu");return"bool"===n.dtype?n.toInt():Lt.runKernelFunc(function(e,t){e=e.relu(n);return t([n]),e},{x:n},function(e,t){var n=t[0];return{x:function(){return e.mulStrict(n.step().toFloat())}}},"Relu")}}),Pl=An({relu6_:function(e){var n=mn(e,"x","relu6");return"bool"===n.dtype?n.toInt():Lt.runKernelFunc(function(e,t){e=e.relu6(n);return t([n]),e},{x:n},function(e,t){var t=t[0],n=t.lessEqual(6).mul(t.step());return{x:function(){return e.mulStrict(n.toFloat())}}},"Relu6")}}),Ll=An({selu_:function(e){var n=mn(e,"x","selu");return Lt.runKernelFunc(function(e,t){e=e.selu(n);return t([n]),e},{$x:n},function(r,e){var o=e[0];return{$x:function(){var e=o.greater(On(0)),t=On(bs),n=On(ws),n=r.mul(n),t=r.mul(t).mul(o.toFloat().exp());return ec(e,n,t)}}})}}),Wl=An({transpose_:function(e,n){var t=mn(e,"x","transpose");if(null==n&&(n=t.shape.map(function(e,t){return t}).reverse()),C(t.rank===n.length,function(){return"Error in transpose: rank of input "+t.rank+" must match length of perm "+n+"."}),n.forEach(function(e){C(0<=e&&e<t.rank,function(){return"All entries in 'perm' must be between 0 and "+(t.rank-1)+" but got "+n})}),t.rank<=1)return t.clone();e={perm:n};return Lt.runKernelFunc(function(e){return e.transpose(t,n)},{x:t},function(e){var t=Rn(n);return{x:function(){return e.transpose(t)}}},"Transpose",e)}}),Ul=An({localResponseNormalization_:function(e,o,i,a,s){void 0===o&&(o=5),void 0===i&&(i=1),void 0===a&&(a=1),void 0===s&&(s=.5);var t=mn(e,"x","localResponseNormalization");C(4===t.rank||3===t.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+t.rank+"."}),C(A(o),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+o+"."});var n=t,r=!1;3===t.rank&&(r=!0,n=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));e=Lt.runKernelFunc(function(e,t){e=e.localResponseNormalization4D(n,o,i,a,s);return t([n,e]),e},{x4D:n},function(t,e){var n=e[0],r=e[1];return{x4D:function(){return Lt.runKernelFunc(function(e){return e.LRNGrad(t,n,r,o,i,a,s)},{})}}});return r?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),Vl=An({norm_:function(e,t,n,r){void 0===t&&(t="euclidean"),void 0===n&&(n=null),void 0===r&&(r=!1);var o=function e(t,n,r){if(void 0===r&&(r=null),0===t.rank)return t.abs();if(1!==t.rank&&null===r)return e(t.reshape([-1]),n,r);if(1===t.rank||"number"==typeof r||Array.isArray(r)&&1===r.length){if(1===n)return t.abs().sum(r);if(n===1/0)return t.abs().max(r);if(n===-1/0)return t.abs().min(r);if("euclidean"===n||2===n)return t.abs().pow(On(2,"int32")).sum(r).sqrt();throw new Error("Error in norm: invalid ord value: "+n)}if(Array.isArray(r)&&2===r.length){if(1===n)return t.abs().sum(r[0]).max(r[1]-1);if(n===1/0)return t.abs().sum(r[1]).max(r[0]);if(n===-1/0)return t.abs().sum(r[1]).min(r[0]);if("fro"===n||"euclidean"===n)return t.square().sum(r).sqrt();throw new Error("Error in norm: invalid ord value: "+n)}throw new Error("Error in norm: invalid axis: "+r)}(e=mn(e,"x","norm"),t,n),t=o.shape;return r&&(e=O(n,e.shape),t=wn(o.shape,e)),o.reshape(t)}}),zl=An({basicLSTMCell_:function(e,t,n,r,o,i){var a=mn(e,"forgetBias","basicLSTMCell"),s=mn(t,"lstmKernel","basicLSTMCell"),e=mn(n,"lstmBias","basicLSTMCell"),t=mn(r,"data","basicLSTMCell"),n=mn(o,"c","basicLSTMCell"),r=mn(i,"h","basicLSTMCell"),o=t.concat(r,1).matMul(s).add(e),i=o.shape[0],t=o.shape[1]/4,r=[i,t],s=o.slice([0,0],r),e=o.slice([0,t],r),i=o.slice([0,2*t],r),r=o.slice([0,3*t],r),i=s.sigmoid().mulStrict(e.tanh()).addStrict(n.mulStrict(a.add(i).sigmoid())),r=i.tanh().mulStrict(r.sigmoid());return[i,r]}}),Gl=An({multiRNNCell_:function(e,t,n,r){for(var t=mn(t,"data","multiRNNCell"),o=gn(n,"c","multiRNNCell"),i=gn(r,"h","multiRNNCell"),a=t,s=[],u=0;u<e.length;u++){var c=e[u](a,o[u],i[u]);s.push(c[0]),s.push(c[1]),a=c[1]}for(var l=[],h=[],u=0;u<s.length;u+=2)l.push(s[u]),h.push(s[u+1]);return[l,h]}}),Hl=An({movingAverage_:function(e,t,n,r,o){void 0===o&&(o=!0);var i=mn(e,"v","movingAverage"),a=mn(t,"x","movingAverage"),e=mn(n,"decay","movingAverage");Ft(i,a),C(S(i.shape,a.shape),function(){return"Shape mismatch in v and x"});t=On(1),n=t.sub(e),n=a.sub(i).mul(n);return o&&(C(null!=r,function(){return"When using zeroDebias: true, step is required."}),r=mn(r,"step","movingAverage"),n=n.div(t.sub(xc(e,r)))),i.add(n)}}),ql=An({stridedSlice_:function(e,t,n,r,o,i,a,s,u){if(void 0===o&&(o=0),void 0===i&&(i=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===u&&(u=0),null==r&&(r=new Array(t.length)),0!==a)throw new Error("ellipsis mask is not yet supported");var c=mn(e,"x","stridedSlice"),s=no(s),l=c.shape.slice();s.forEach(function(e){t[e]=0,n[e]=1,l.splice(e,0,1)});for(var c=c.reshape(l),h=0;h<c.rank;h++)t[h]=oo(o,t,r,c.shape,h),n[h]=ao(i,n,r,c.shape,h),r[h]=r[h]||1;var d=no(u);d.forEach(function(e){n[e]=t[e]+1,r[e]=1});s=ro(t,n,r),u=s.filter(function(e,t){return-1===d.indexOf(t)});return(r.every(function(e){return 1===e})?ml(c,t,s):Lt.runKernelFunc(function(e){return e.stridedSlice(c,t,n,r)},{$x:c})).reshape(u)}}),Kl=An({topk_:function(e,t,n){void 0===t&&(t=1),void 0===n&&(n=!0);var r=mn(e,"x","topk");if(0===r.rank)throw new Error("topk() expects the input to be of rank 1 or higher");e=r.shape[r.shape.length-1];if(e<t)throw new Error("'k' passed to topk() must be <= the last dimension ("+e+") but got "+t);e=Lt.runKernelFunc(function(e){return e.topk(r,t,n)},{$x:r});return{values:e[0],indices:e[1]}}}),jl=An({scatterND_:function(e,t,n){var r=mn(e,"indices","scatterND","int32"),o=mn(t,"updates","scatterND");return Jr(o,r,n),Lt.runKernelFunc(function(e){return e.scatterND(r,o,n)},{indices:r,updates:o},null,"ScatterNd",{shape:n})}}),Xl=An({fft_:function(e){C("complex64"===e.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+e.dtype+"."});var t=e.shape[e.shape.length-1],n=e.size/t,r=e.as2D(n,t);return Lt.runKernelFunc(function(e){return e.fft(r)},{input:e}).reshape(e.shape)}}),Yl=An({ifft_:function(e){C("complex64"===e.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+e.dtype+"."});var t=e.shape[e.shape.length-1],n=e.size/t,r=e.as2D(n,t);return Lt.runKernelFunc(function(e){return e.ifft(r)},{input:e}).reshape(e.shape)}}),$l=An({rfft_:function(e,t){C("float32"===e.dtype,function(){return"The dtype for rfft() must be real value but got "+e.dtype});var n,r,o=e.shape[e.shape.length-1],i=e.size/o;null!=t&&t<o?(n=e.shape.map(function(e){return 0}),(r=e.shape.map(function(e){return e}))[e.shape.length-1]=t,r=e.slice(n,r),o=t):null!=t&&o<t?((a=e.shape.map(function(e){return e}))[e.shape.length-1]=t-o,r=e.concat(Gn(a),e.shape.length-1),o=t):r=e;var a=r.zerosLike(),t=Dn(r,a).as2D(i,o),a=Xl(t),i=Math.floor(o/2)+1,t=Tn(a),a=Nn(a),t=t.split([i,o-i],t.shape.length-1),o=a.split([i,o-i],a.shape.length-1),a=r.shape.slice();return a[r.shape.length-1]=i,Dn(t[0],o[0]).reshape(a)}}),Ql=An({irfft_:function(e){var t=e.shape[e.shape.length-1],n=e.size/t;if(t<=2){var r=e.as2D(n,t),o=Yl(r);return Tn(o)}var i=[n,2*(t-1)],a=Tn(e).as2D(n,t),s=Nn(e).as2D(n,t),e=a.slice([0,1],[n,t-2]).reverse(1),t=s.slice([0,1],[n,t-2]).reverse(1).mul(On(-1)),e=a.concat(e,1),t=s.concat(t,1),r=Dn(e,t).as2D(i[0],i[1]),o=Yl(r);return Tn(o)}}),Jl=Object.freeze({fft:Xl,ifft:Yl,rfft:$l,irfft:Ql}),Zl=An({sparseToDense_:function(e,t,n,r){void 0===r&&(r=0);var o=mn(e,"sparseIndices","sparseToDense","int32"),i=mn(t,"sparseValues","sparseToDense"),a=mn(r,"defaultValue","sparseToDense",i.dtype);return function(e,t,n,r){if("int32"!==e.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+e.dtype+".");if(2<e.rank)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+e.shape+".");var o=0<e.rank?e.shape[0]:1,e=1<e.rank?e.shape[1]:1;if(n.length!==e)throw new Error("outputShape has incorrect number of elements:, "+n.length+", should be: "+e+".");e=t.size;if(0!==t.rank&&(1!==t.rank||e!==o))throw new Error("sparseValues has incorrect shape "+t.shape+", should be [] or ["+o+"]");if(t.dtype!==r.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(o,i,n,a),Lt.runKernelFunc(function(e){return e.sparseToDense(o,i,n,a)},{$sparseIndices:o,$sparseValues:i,$defaultValue:a})}}),th=An({gatherND_:function(e,t){var n=mn(t,"indices","gatherND","int32"),r=mn(e,"x","gatherND");return Lt.runKernelFunc(function(e){return e.gatherND(r,n)},{x:r,indices:n},null,"GatherNd")}}),eh=An({diag_:function(e){var t=mn(e,"x","diag").flatten(),e=e.shape.concat(e.shape);return Lt.runKernelFunc(function(e){return e.diag(t)},{$x:t}).reshape(e)}}),nh=An({dropout_:function(e,t,n,r){var o=mn(e,"x","dropout");if(C("float32"===o.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+o.dtype+" tensor instead."}),C(0<=t&&t<1,function(){return"rate must be a float in the range [0, 1), but got "+t+"."}),0===t)return e instanceof wt?o.clone():o;e=function(e,t){if(null==t)return e.shape.slice();if(S(e.shape,t))return t;if(e.shape.length!==t.length)return t;for(var n=[],r=0;r<e.shape.length;r++)null==t[r]&&null!=e.shape[r]?n.push(e.shape[r]):n.push(t[r]);return n}(o,n),n=1-t,n=_r(e,0,1,"float32",r).add(n).floor().div(n);return o.mul(n)}});function rh(e,t,n){for(var r=1-e%2,o=new Float32Array(e),i=0;i<e;++i){var a=2*Math.PI*i/(e+r-1);o[i]=t-n*Math.cos(a)}return Mn(o,"float32")}var oh=An({hannWindow_:function(e){return rh(e,.5,.5)}}),ah=An({hammingWindow_:function(e){return rh(e,.54,.46)}}),ih=An({frame_:function(e,t,n,r,o){void 0===r&&(r=!1),void 0===o&&(o=0);for(var i=0,a=[];i+t<=e.size;)a.push(ml(e,i,t)),i+=n;if(r)for(;i<e.size;){var s=i+t-e.size,s=Yn([ml(e,i,t-s),Hn([s],o)]);a.push(s),i+=n}return 0===a.length?Bn([],[0,t]):Yn(a).as2D(a.length,t)}}),sh=An({stft_:function(e,t,n,r,o){void 0===o&&(o=oh),null==r&&(r=Math.floor(Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))));for(var i=ih(e,t,n),a=gc(i,o(t)),s=[],u=0;u<i.shape[0];u++)s.push($l(a.slice([u,0],[1,t]),r));return Yn(s)}}),uh=Object.freeze({hannWindow:oh,hammingWindow:ah,frame:ih,stft:sh}),ch,lh=function(g,v,b){return void 0===b&&(b=1),n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c,l,h,d,p,f,m;return r(this,function(e){switch(e.label){case 0:return t=mn(g,"predictions","inTopK"),n=mn(v,"targets","inTopK"),C(1<t.rank,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+t.rank}),C(t.rank-1===n.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+t.rank+" and targets rank "+n.rank}),E(t.shape.slice(0,t.shape.length-1),n.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),o=t.shape[t.shape.length-1],C(0<b&&b<=o,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+o+"), but got "+b}),[4,t.data()];case 1:return i=e.sent(),[4,n.data()];case 2:for(a=e.sent(),s=[i.length/o,o],c=s[1],l=B("bool",u=s[0]),h=0;h<u;h++){for(d=h*c,p=i.subarray(d,d+c),f=[],m=0;m<p.length;m++)f.push({value:p[m],index:m});for(f.sort(function(e,t){return t.value-e.value}),l[h]=0,m=0;m<b;m++)if(f[m].index===a[h]){l[h]=1;break}}return g!==t&&t.dispose(),v!==n&&n.dispose(),[2,Fn(l,n.shape,"bool")]}})})},U30;U30=ch=ch||{},U30[U30.NONE=0]="NONE",U30[U30.MEAN=1]="MEAN",U30[U30.SUM=2]="SUM",U30[U30.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS";var hh=An({absoluteDifference_:function(e,t,n,r){void 0===r&&(r=ch.SUM_BY_NONZERO_WEIGHTS);var o=mn(e,"labels","absoluteDifference"),e=mn(t,"predictions","absoluteDifference"),t=null;null!=n&&(t=mn(n,"weights","absoluteDifference")),E(o.shape,e.shape,"Error in absoluteDifference: ");e=o.sub(e).abs();return fh(e,t,r)}}),fh=An({computeWeightedLoss_:function(e,t,n){void 0===n&&(n=ch.SUM_BY_NONZERO_WEIGHTS);var r=mn(e,"losses","computeWeightedLoss"),o=null,i=null==(o=null!=t?mn(t,"weights","computeWeightedLoss"):o)?r:r.mul(o);if(n===ch.NONE)return i;if(n===ch.SUM)return i.sum();if(n===ch.MEAN){if(null==o)return i.mean();e=r.size/o.size,t=i.sum().div(o.sum());return 1<e?t.div(On(e)):t}if(n!==ch.SUM_BY_NONZERO_WEIGHTS)throw Error("Unknown reduction: "+n);if(null==o)return i.sum().div(On(r.size));r=o.mul(zn(r.shape)).notEqual(On(0)).sum().toFloat();return i.sum().div(r)}}),dh=An({cosineDistance_:function(e,t,n,r,o){void 0===o&&(o=ch.SUM_BY_NONZERO_WEIGHTS);var i=mn(e,"labels","cosineDistance"),e=mn(t,"predictions","cosineDistance"),t=null;null!=r&&(t=mn(r,"weights","cosineDistance")),E(i.shape,e.shape,"Error in cosineDistance: ");n=On(1).sub(i.mul(e).sum(n,!0));return fh(n,t,o)}}),ph=An({hingeLoss_:function(e,t,n,r){void 0===r&&(r=ch.SUM_BY_NONZERO_WEIGHTS);var o=mn(e,"labels","hingeLoss"),e=mn(t,"predictions","hingeLoss"),t=null;null!=n&&(t=mn(n,"weights","hingeLoss")),E(o.shape,e.shape,"Error in hingeLoss: ");n=On(1),o=On(2).mul(o).sub(n),e=n.sub(o.mul(e)).relu();return fh(e,t,r)}}),vh=An({huberLoss_:function(e,t,n,r,o){void 0===r&&(r=1),void 0===o&&(o=ch.SUM_BY_NONZERO_WEIGHTS);var i=mn(e,"labels","huberLoss"),e=mn(t,"predictions","huberLoss"),t=null;null!=n&&(t=mn(n,"weights","huberLoss")),E(i.shape,e.shape,"Error in huberLoss: ");r=On(r),e=e.sub(i).abs(),i=dc(e,r),e=e.sub(i),e=On(.5).mul(i.square()).add(r.mul(e));return fh(e,t,o)}}),mh=An({logLoss_:function(e,t,n,r,o){void 0===r&&(r=1e-7),void 0===o&&(o=ch.SUM_BY_NONZERO_WEIGHTS);var i=mn(e,"labels","logLoss"),e=mn(t,"predictions","logLoss"),t=null;null!=n&&(t=mn(n,"weights","logLoss")),E(i.shape,e.shape,"Error in logLoss: ");n=On(1),r=On(r),r=i.mul(e.add(r).log()).neg().sub(n.sub(i).mul(n.sub(e).add(r).log()));return fh(r,t,o)}}),gh=An({meanSquaredError_:function(e,t,n,r){void 0===r&&(r=ch.SUM_BY_NONZERO_WEIGHTS);var o=mn(e,"labels","meanSquaredError"),e=mn(t,"predictions","meanSquaredError"),t=null;null!=n&&(t=mn(n,"weights","meanSquaredError")),E(o.shape,e.shape,"Error in meanSquaredError: ");e=o.squaredDifference(e);return fh(e,t,r)}}),yh=An({sigmoidCrossEntropy_:function(e,t,n,r,o){void 0===r&&(r=0),void 0===o&&(o=ch.SUM_BY_NONZERO_WEIGHTS);var i=mn(e,"multiClassLabels","sigmoidCrossEntropy"),a=mn(t,"logits","sigmoidCrossEntropy"),e=null;null!=n&&(e=mn(n,"weights","sigmoidCrossEntropy")),E(i.shape,a.shape,"Error in sigmoidCrossEntropy: "),0<r&&(t=On(r),n=On(1),r=On(.5),i=i.mul(n.sub(t)).add(r.mul(t)));a=function(e){var t=mn(i,"labels","sigmoidCrossEntropyWithLogits"),n=mn(e,"logits","sigmoidCrossEntropyWithLogits");E(t.shape,n.shape,"Error in sigmoidCrossEntropyWithLogits: ");e=n.relu(),t=n.mul(t),n=n.abs().neg().exp().log1p();return e.sub(t).add(n)}(a);return fh(a,e,o)}}),xh=An({softmaxCrossEntropy_:function(e,t,n,r,o){void 0===r&&(r=0),void 0===o&&(o=ch.SUM_BY_NONZERO_WEIGHTS);var i=mn(e,"onehotLabels","softmaxCrossEntropy"),a=mn(t,"logits","softmaxCrossEntropy"),e=null;null!=n&&(e=mn(n,"weights","softmaxCrossEntropy")),E(i.shape,a.shape,"Error in softmaxCrossEntropy: "),0<r&&(t=On(r),n=On(1),r=On(i.shape[1]),i=i.mul(n.sub(t)).add(t.div(r)));a=function(e,t,o){if((o=-1===(o=void 0===o?-1:o)?t.rank-1:o)!==t.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+t.rank+" and dim was "+o);return vo(function(e,t,n){var r=t.logSumExp([o],!0),r=t.toFloat().sub(r);return n([e,r]),{value:r.mul(e).neg().sum([o]),gradFunc:function(e,t){var n=t[0],r=t[1],t=wn(e.shape,[o]);return[e.reshape(t).mul(n.toFloat().sub(r.exp())),e.reshape(t).mul(r.exp().sub(n.toFloat()))]}}})(e,t)}(i,a);return fh(a,e,o)}}),bh=Object.freeze({get Reduction(){return ch},absoluteDifference:hh,computeWeightedLoss:fh,cosineDistance:dh,hingeLoss:ph,huberLoss:vh,logLoss:mh,meanSquaredError:gh,sigmoidCrossEntropy:yh,softmaxCrossEntropy:xh});function wh(n,r){return void 0===r&&(r=!1),Lt.tidy(function(){if(2!==n.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+n.shape.length+"D Tensor.");for(var a=n.shape[0],s=n.shape[1],u=Cr(a),c=n.clone(),l=Bn([[1]],[1,1]),h=l.clone(),e=s<=a?s:a,t=0;t<e;++t)!function(i){var e=c,t=h,n=u,r=Lt.tidy(function(){var e=c.slice([i,i],[a-i,1]),t=e.norm(),n=c.slice([i,i],[1,1]),r=Bn([[-1]]).where(n.greater(0),Bn([[1]])),n=n.sub(r.mul(t)),e=e.div(n);h=1===e.shape[0]?l.clone():l.concat(e.slice([1,0],[e.shape[0]-1,e.shape[1]]),0);n=r.matMul(n).div(t).neg(),t=c.slice([i,0],[a-i,s]),n=n.mul(h);c=0===i?t.sub(n.matMul(h.transpose().matMul(t))):(o=t.sub(n.matMul(h.transpose().matMul(t))),c.slice([0,0],[i,s]).concat(o,0));var o=u.slice([0,i],[a,u.shape[1]-i]);return u=0===i?o.sub(o.matMul(h).matMul(n.transpose())):(n=o.sub(o.matMul(h).matMul(n.transpose())),u.slice([0,0],[a,i]).concat(n,1)),[h,c,u]});h=r[0],c=r[1],u=r[2],tn([e,t,n])}(t);return!r&&s<a&&(u=u.slice([0,0],[a,s]),c=c.slice([0,0],[s,s])),[u,c]})}var Ch=An({bandPart_:function(e,t,n){if(t%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+t+".");if(n%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+n+".");var r=mn(e,"a","bandPart");if(r.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+r.rank+".");var o=r.shape,i=r.shape.slice(-2),a=i[0],s=i[1];if(!(t<=a))throw new Error("bandPart(): numLower ("+t+") must not be greater than the number of rows ("+a+").");if(!(n<=s))throw new Error("bandPart(): numUpper ("+n+") must not be greater than the number of columns ("+s+").");t<0&&(t=a),n<0&&(n=s);var e=Kn(0,a,1,"int32").reshape([-1,1]),i=Kn(0,s,1,"int32"),i=Cc(e,i),u=Qu(i.lessEqual(On(+t,"int32")),i.greaterEqual(On(-n,"int32"))),c=Gn([a,s],r.dtype);return Pr(Ur(r.reshape([-1,a,s])).map(function(e){return ec(u,e,c)})).reshape(o)}}),Eh=An({gramSchmidt_:function(t){var e;if(Array.isArray(t)){e=!1,C(null!=t&&0<t.length,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var n=t[0].shape[0],r=1;r<t.length;++r)!function(e){C(t[e].shape[0]===n,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+t[e].shape[0]+" vs. "+n+")"})}(r)}else e=!0,t=tr(t,t.shape[0],0).map(function(e){return Br(e,[0])});C(t.length<=t[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+t.length+") exceeds number of dimensions ("+t[0].shape[0]+")."});for(var o=[],i=t,r=0;r<t.length;++r)!function(r){o.push(Lt.tidy(function(){var e=i[r];if(0<r)for(var t=0;t<r;++t)var n=Nl(o[t].mulStrict(e)).mul(o[t]),e=e.sub(n);return e.div(Vl(e,"euclidean"))}))}(r);return e?Pr(o,0):o}}),Rh=An({qr_:function(e,n){if(void 0===n&&(n=!1),e.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+e.rank);if(2===e.rank)return wh(e,n);var t=e.shape.slice(0,e.shape.length-2).reduce(function(e,t){return e*t}),t=Ur(e.reshape([t,e.shape[e.shape.length-2],e.shape[e.shape.length-1]]),0),r=[],o=[];return t.forEach(function(e){var t=wh(e,n),e=t[0],t=t[1];r.push(e),o.push(t)}),[Pr(r,0).reshape(e.shape),Pr(o,0).reshape(e.shape)]}}),Ih=Object.freeze({bandPart:Ch,gramSchmidt:Eh,qr:Rh});function kh(e,t,n,r,o,i){null==r&&(r=.5),null==o&&(o=Number.NEGATIVE_INFINITY),null==i&&(i=0);var a=e.shape[0];return n=Math.min(n,a),C(0<=r&&r<=1,function(){return"iouThreshold must be in [0, 1], but was '"+r+"'"}),C(2===e.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+e.rank+"'"}),C(4===e.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+e.shape[1]}),C(1===t.rank,function(){return"scores must be a 1D tensor"}),C(t.shape[0]===a,function(){return"scores has incompatible shape with boxes. Expected "+a+", but was "+t.shape[0]}),C(0<=i&&i<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+i+"'"}),{maxOutputSize:n,iouThreshold:r,scoreThreshold:o,softNmsSigma:i}}var Sh=An({resizeBilinear_:function(e,t,r){void 0===r&&(r=!1);var n=mn(e,"images","resizeBilinear");C(3===n.rank||4===n.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+n.rank+"."}),C(2===t.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+t+"."});var o=n,i=!1;3===n.rank&&(i=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var a=t[0],s=t[1],e=Lt.runKernelFunc(function(e,t){return t([o]),e.resizeBilinear(o,a,s,r)},{x:o},function(t,n){return{x:function(){return Lt.runKernelFunc(function(e){return e.resizeBilinearBackprop(t,n[0],r)},{})}}},"ResizeBilinear",{alignCorners:r,newHeight:a,newWidth:s});return i?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),Ah=An({resizeNearestNeighbor_:function(e,t,r){void 0===r&&(r=!1);var n=mn(e,"images","resizeNearestNeighbor");C(3===n.rank||4===n.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+n.rank+"."}),C(2===t.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+t+"."}),C("float32"===n.dtype||"int32"===n.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var o=n,i=!1;3===n.rank&&(i=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var a=t[0],s=t[1],e=Lt.runKernelFunc(function(e,t){return t([o]),e.resizeNearestNeighbor(o,a,s,r)},{batchImages:o},function(t,n){return{batchImages:function(){return Lt.runKernelFunc(function(e){return e.resizeNearestNeighborBackprop(t,n[0],r)},{})}}});return i?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),Dh=An({nonMaxSuppression_:function(e,t,n,r,o){void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY);var i=mn(e,"boxes","nonMaxSuppression"),a=mn(t,"scores","nonMaxSuppression"),t=kh(i,a,n,r,o);n=t.maxOutputSize,r=t.iouThreshold,o=t.scoreThreshold;t={maxOutputSize:n,iouThreshold:r,scoreThreshold:o};return Lt.runKernelFunc(function(e){return e.nonMaxSuppression(i,a,n,r,o)},{boxes:i,scores:a},null,"NonMaxSuppressionV3",t)}}),Th=function(a,s,u,c,l){return void 0===c&&(c=.5),void 0===l&&(l=Number.NEGATIVE_INFINITY),n(this,void 0,void 0,function(){var t,n,o,i;return r(this,function(e){switch(e.label){case 0:return t=mn(a,"boxes","nonMaxSuppressionAsync"),n=mn(s,"scores","nonMaxSuppressionAsync"),o=kh(t,n,u,c,l),u=o.maxOutputSize,c=o.iouThreshold,l=o.scoreThreshold,[4,Promise.all([t.data(),n.data()])];case 1:return i=e.sent(),o=i[0],i=i[1],i=jo(o,i,u,c,l),t!==a&&t.dispose(),n!==s&&n.dispose(),[2,i]}})})},Nh=An({nonMaxSuppressionWithScore_:function(e,t,n,r,o,i){void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===i&&(i=0);var a=mn(e,"boxes","nonMaxSuppression"),e=mn(t,"scores","nonMaxSuppression"),t=kh(a,e,n,r,o,i),i={maxOutputSize:n=t.maxOutputSize,iouThreshold:r=t.iouThreshold,scoreThreshold:o=t.scoreThreshold,softNmsSigma:i=t.softNmsSigma},i=Lt.runKernel("NonMaxSuppressionV5",{boxes:a,scores:e},i);return{selectedIndices:i[0],selectedScores:i[1]}}}),Fh=function(a,s,u,c,l,h){return void 0===c&&(c=.5),void 0===l&&(l=Number.NEGATIVE_INFINITY),void 0===h&&(h=0),n(this,void 0,void 0,function(){var t,n,o,i;return r(this,function(e){switch(e.label){case 0:return t=mn(a,"boxes","nonMaxSuppressionAsync"),n=mn(s,"scores","nonMaxSuppressionAsync"),o=kh(t,n,u,c,l,h),u=o.maxOutputSize,c=o.iouThreshold,l=o.scoreThreshold,h=o.softNmsSigma,[4,Promise.all([t.data(),n.data()])];case 1:return i=e.sent(),o=i[0],i=i[1],i=Xo(o,i,u,c,l,h),t!==a&&t.dispose(),n!==s&&n.dispose(),[2,i]}})})},_h=An({cropAndResize_:function(e,t,n,r,o,i){var a=mn(e,"image","cropAndResize"),s=mn(t,"boxes","cropAndResize","float32"),u=mn(n,"boxInd","cropAndResize","int32");o=o||"bilinear",i=i||0;var c=s.shape[0];return C(4===a.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+a.rank+"."}),C(2===s.rank&&4===s.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+c+",4] but had shape "+s.shape+"."}),C(1===u.rank&&u.shape[0]===c,function(){return"Error in cropAndResize: boxInd must be have size ["+c+"] but had shape "+s.shape+"."}),C(2===r.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+r.length+"."}),C(1<=r[0]&&1<=r[1],function(){return"cropSize must be atleast [1,1], but was "+r}),C("bilinear"===o||"nearest"===o,function(){return"method must be bilinear or nearest, but was "+o}),Lt.runKernelFunc(function(e,t){return e.cropAndResize(a,s,u,r,o,i)},{images:a,boxes:s,boxInd:u},null,"CropAndResize",{method:o,extrapolationValue:i,cropSize:r})}}),Oh=Object.freeze({resizeBilinear:Sh,resizeNearestNeighbor:Ah,nonMaxSuppression:Dh,nonMaxSuppressionAsync:Th,nonMaxSuppressionWithScore:Nh,nonMaxSuppressionWithScoreAsync:Fh,cropAndResize:_h}),Mh=function(e,t){return!(0<e)||"linear"===t},Bh=function(e,t,n){if(null==n||"linear"===n)return e;if("relu"===n)return e.mul(t.step());throw new Error("Gradient for activation "+n+" has not been implemented yet.")},Ph=function(e,t){var n=t,t=Eo(e.shape,t.shape);return(n=0<t.length?n.sum(t):n).reshape(e.shape)},Lh=function(e,t,n){if("linear"===t)return e;if("relu"===t)return Bl(e);if("elu"===t)return _l(e);if("relu6"===t)return Pl(e);if("prelu"===t)return Ml(e,n);throw new Error("Unknown fused activation "+t+".")},Wh=An({fusedMatMul_:function(e){var t=e.a,n=e.b,r=e.transposeA,i=void 0!==r&&r,o=e.transposeB,a=void 0!==o&&o,s=e.bias,r=e.activation,u=void 0===r?"linear":r,o=e.preluActivationWeights;if(!1===Mh(Lt.state.gradientDepth,u)){var c=el(t,n,i,a);return null!=s&&(c=rc(c,s)),Lh(c,u,o)}var l=mn(t,"a","fused matMul"),h=mn(n,"b","fused matMul"),l=(r=Nt(l,h))[0],h=r[1],d=i?l.shape[l.rank-2]:l.shape[l.rank-1],p=a?h.shape[h.rank-1]:h.shape[h.rank-2],e=i?l.shape[l.rank-1]:l.shape[l.rank-2],c=a?h.shape[h.rank-2]:h.shape[h.rank-1],f=l.shape.slice(0,-2),m=h.shape.slice(0,-2),t=k(f),n=k(m);C(2<=l.rank&&2<=h.rank&&l.rank===h.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+l.rank+" and "+h.rank+"."}),C(S(f,m),function(){return"Error in fused matMul: outer dimensions ("+f+") and ("+m+") of Tensors with shapes "+l.shape+" and "+h.shape+" must match."}),C(d===p,function(){return"Error in fused matMul: inner shapes ("+d+") and ("+p+") of Tensors with shapes "+l.shape+" and "+h.shape+" and transposeA="+i+" and transposeB="+a+" must match."});var g,v,r=l.shape.slice(0,-2).concat([e,c]),b=i?l.as3D(t,d,e):l.as3D(t,e,d),y=a?h.as3D(n,c,p):h.as3D(n,p,c);null!=s&&Ro(r,(g=Nt(g=mn(s,"bias","fused matMul"),l)[0]).shape),null!=o&&(v=mn(o,"prelu weights","fused matMul"));c={a:b,b:y};return null!=s&&(c.bias=g),null!=o&&(c.preluActivationWeights=v),Lt.runKernelFunc(function(e,t){e=e.fusedBatchMatMul({a:b,b:y,transposeA:i,transposeB:a,bias:g,activation:u,preluActivationWeights:v});return t([b,y,e]),e},c,function(e,t){var n=t[0],r=t[1],t=t[2],o=Bh(e,t,u),t=null!=s?{bias:function(){return Ph(g,o)}}:{};return i||a?!i&&a?Object.assign({a:function(){return o.matMul(r,!1,!1)},b:function(){return o.matMul(n,!0,!1)}},t):i&&!a?Object.assign({a:function(){return r.matMul(o,!1,!0)},b:function(){return n.matMul(o,!1,!1)}},t):Object.assign({a:function(){return r.matMul(o,!0,!0)},b:function(){return o.matMul(n,!0,!0)}},t):Object.assign({a:function(){return o.matMul(r,!1,!0)},b:function(){return n.matMul(o,!0,!1)}},t)},"_FusedMatMul",{transposeA:i,transposeB:a,activation:u},[b,y],[!0]).reshape(r)}}),Uh=An({fusedConv2d_:function(e){var i,t=e.x,n=e.filter,a=e.strides,s=e.pad,r=e.dataFormat,o=void 0===r?"NHWC":r,r=e.dilations,u=void 0===r?[1,1]:r,c=e.dimRoundingMode,l=e.bias,r=e.activation,e=e.preluActivationWeights;if(!1===Mh(Lt.state.gradientDepth,i=(i=void 0===r?"linear":r)||"linear")){r=qc(t,n,a,s,o,u,c);return null!=l&&(r=rc(r,l)),Lh(r,i,e)}var t=mn(t,"x","conv2d"),h=mn(n,"filter","conv2d"),d=t,n=!1;3===t.rank&&(n=!0,d=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),C(4===d.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+d.rank+"."}),C(4===h.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+h.rank+"."}),null!=c&&C(A(s),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+c+" but got pad "+s+"."}),C(d.shape[3]===h.shape[2],function(){return"Error in conv2d: depth of input ("+d.shape[3]+") must match input depth for filter "+h.shape[2]+"."}),C(Mo(a,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+u+"'"}),C("NHWC"===o,function(){return"Error in conv2d: got dataFormat of "+o+" but only NHWC is currently supported."});var p,f,m=So(d.shape,h.shape,a,u,s,c);null!=l&&(p=Nt(p=mn(l,"bias","fused conv2d"),t)[0],Ro(m.outShape,p.shape)),null!=e&&(f=mn(e,"prelu weights","fused conv2d"));t={x:d,filter:h};null!=l&&(t.bias=p),null!=e&&(t.preluActivationWeights=f);e=[h,d],e=Lt.runKernelFunc(function(e,t){e=e.fusedConv2d({input:d,filter:h,convInfo:m,bias:p,activation:i,preluActivationWeights:f});return t([h,d,e]),e},t,function(e,t){var n=t[0],r=t[1],t=t[2],o=Bh(e,t,i);C(Oo(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});t=null!=l?{bias:function(){return Ph(p,o)}}:{};return Object.assign({x:function(){return Xc(r.shape,o,n,a,s)},filter:function(){return jc(r,o,n.shape,a,s)}},t)},"FusedConv2D",{convInfo:m,activation:i},e,[!0]);return n?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),Vh=An({fusedDepthwiseConv2d_:function(e){var t=e.x,n=e.filter,r=e.strides,o=e.pad,i=e.dataFormat,a=void 0===i?"NHWC":i,i=e.dilations,s=void 0===i?[1,1]:i,u=e.dimRoundingMode,c=e.bias,i=e.activation,l=void 0===i?"linear":i,e=e.preluActivationWeights;if(!1===Mh(Lt.state.gradientDepth,l)){a=Yc(t,n,r,o,a,s,u);return null!=c&&(a=rc(a,c)),Lh(a,l,e)}var t=mn(t,"x","depthwiseConv2d"),h=mn(n,"filter","depthwiseConv2d"),d=t,n=!1;3===t.rank&&(n=!0,d=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),C(4===d.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+d.rank+"."}),C(4===h.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+h.rank+"."}),C(d.shape[3]===h.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+d.shape[3]+") must match the inChannels dimension in filter "+h.shape[2]+"."}),C(Mo(r,s=null==s?[1,1]:s),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+s+"'"}),null!=u&&C(A(o),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+u+" but got pad "+o+"."});var p,f,m=So(d.shape,h.shape,r,s,o,u,!0);null!=c&&(p=Nt(p=mn(c,"bias","fused conv2d"),t)[0],Ro(m.outShape,p.shape)),null!=e&&(f=mn(e,"prelu weights","fused depthwiseConv2d"));t={x:d,filter:h};null!=c&&(t.bias=p),null!=e&&(t.preluActivationWeights=f);e=[h,d],e=Lt.runKernelFunc(function(e,t){e=e.fusedDepthwiseConv2D({input:d,filter:h,convInfo:m,bias:p,activation:l,preluActivationWeights:f});return t([h,d,e]),e},t,function(e,t){C(Oo(s),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+s+"'"});var n=t[0],r=t[1],t=t[2],o=Bh(e,t,l),t=null!=c?{bias:function(){return Ph(p,o)}}:{};return Object.assign({x:function(){return $c(r.shape,o,n,m)},filter:function(){return Qc(r,o,n.shape,m)}},t)},"FusedDepthwiseConv2D",{convInfo:m,activation:l},e,[!0]);return n?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),zh=Object.freeze({matMul:Wh,conv2d:Uh,depthwiseConv2d:Vh}),Gh=Object.freeze({image:Oh,linalg:Ih,losses:bh,spectral:Jl,fused:zh,signal:uh,square:tu,squaredDifference:nu,conv1d:Hc,conv2d:qc,conv3d:Kc,depthwiseConv2d:Yc,separableConv2d:Jc,conv2dTranspose:Zc,conv3dTranspose:tl,op:An,batchNormalization2d:Gu,batchNormalization3d:Hu,batchNormalization4d:qu,batchNormalization:Ku,batchNorm:ju,batchNorm2d:Xu,batchNorm3d:Yu,batchNorm4d:$u,booleanMaskAsync:Uc,complex:Dn,real:Tn,imag:Nn,concat:Yn,concat1d:$n,concat2d:Qn,concat3d:Jn,concat4d:Zn,split:tr,matMul:el,dot:nl,outerProduct:rl,reverse:ol,reverse1d:al,reverse2d:il,reverse3d:sl,reverse4d:ul,maxPool:hl,avgPool:fl,pool:dl,maxPool3d:pl,avgPool3d:vl,slice:ml,slice1d:gl,slice2d:yl,slice3d:xl,slice4d:bl,abs:ru,acos:ou,acosh:au,asin:iu,asinh:su,atan:uu,atanh:cu,ceil:lu,clipByValue:hu,cos:fu,cosh:du,erf:pu,exp:vu,expm1:mu,floor:gu,log:yu,log1p:xu,logSigmoid:bu,neg:wu,reciprocal:Cu,round:Eu,rsqrt:Ru,sigmoid:Iu,sign:ku,isNaN:Su,isInf:Au,isFinite:Du,sin:Tu,sinh:Nu,softplus:Fu,sqrt:_u,step:Ou,tan:Mu,tanh:Bu,all:Cl,any:El,argMax:Rl,argMin:Il,logSumExp:kl,max:Sl,mean:Al,min:Dl,moments:Tl,sum:Nl,prod:Fl,equal:Rc,equalStrict:Ic,greater:kc,greaterEqual:Sc,greaterEqualStrict:Ac,greaterStrict:Dc,less:Tc,lessEqual:Nc,lessEqualStrict:Fc,lessStrict:_c,notEqual:Oc,notEqualStrict:Mc,add:rc,addN:oc,addStrict:ac,atan2:ic,div:sc,divNoNan:uc,divStrict:cc,floorDiv:lc,maximum:hc,maximumStrict:fc,minimum:dc,minimumStrict:pc,mod:vc,modStrict:mc,mul:gc,mulStrict:yc,pow:xc,powStrict:bc,squaredDifferenceStrict:wc,sub:Cc,subStrict:Ec,elu:_l,leakyRelu:Ol,prelu:Ml,relu:Bl,relu6:Pl,selu:Ll,logicalAnd:Qu,logicalNot:Ju,logicalOr:Zu,logicalXor:tc,where:ec,whereAsync:nc,buffer:dr,print:pr,batchToSpaceND:vr,broadcastTo:mr,cast:gr,clone:yr,cumsum:xr,depthToSpace:br,expandDims:wr,eye:Cr,multinomial:Er,oneHot:Rr,pad:Ir,pad1d:kr,pad2d:Sr,pad3d:Ar,pad4d:Dr,rand:Tr,randomNormal:Nr,randomGamma:Fr,randomUniform:_r,reshape:Or,spaceToBatchND:Mr,squeeze:Br,stack:Pr,tile:Lr,truncatedNormal:Wr,unstack:Ur,setdiff1dAsync:Vr,fill:Hn,linspace:qn,ones:zn,range:Kn,scalar:On,tensor:Fn,tensor1d:Mn,tensor2d:Bn,tensor3d:Pn,tensor4d:Ln,tensor5d:Wn,tensor6d:Un,variable:Vn,zeros:Gn,onesLike:jn,zerosLike:Xn,transpose:Wl,softmax:go,logSoftmax:yo,localResponseNormalization:Ul,norm:Vl,gather:Lc,unsortedSegmentSum:Wc,basicLSTMCell:zl,multiRNNCell:Gl,movingAverage:Hl,stridedSlice:ql,topk:Kl,scatterND:jl,fft:Xl,ifft:Yl,rfft:$l,irfft:Ql,sparseToDense:Zl,gatherND:th,diag:eh,dropout:nh,hannWindow:oh,hammingWindow:ah,frame:ih,stft:sh,inTopKAsync:lh});function Hh(e,t){(e=!Array.isArray(e)?[e]:e).forEach(function(e){null!=e&&C("complex64"!==e.dtype,function(){return t+" does not support complex64 tensors."})})}function qh(e,t,n,r){if("linear"===n)return e.linear(t);if("relu"===n)return e.relu(t);if("elu"===n)return e.elu(t);if("relu6"===n)return e.relu6(t);if("prelu"===n)return e.prelu(t,r);throw new Error("Activation "+n+" has not been implemented for the CPU backend.")}var Kh=(t70=bo,e(u70,t70),u70.prototype.write=function(e,t,n){this.firstUse&&(this.firstUse=!1,i().get("IS_NODE")&&dn("\n============================\nHi there 👋\udc4b. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var r={};return this.data.set(r,{values:e,dtype:n}),r},u70.prototype.move=function(e,t,n,r){this.data.set(e,{values:t,dtype:r})},u70.prototype.numDataIds=function(){return this.data.numDataIds()},u70.prototype.read=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,this.readSync(t)]})})},u70.prototype.readSync=function(e){var t=this.data.get(e),n=t.dtype,t=t.complexTensors;return"complex64"===n?Vo(this.readSync(t.real.dataId),this.readSync(t.imag.dataId)):this.data.get(e).values},u70.prototype.bufferSync=function(e){var t=this.readSync(e.dataId),n=t;if("string"===e.dtype)try{n=t.map(function(e){return ot(e)})}catch(e){throw new Error("Failed to decode encoded string bytes into utf-8")}return dr(e.shape,e.dtype,n)},u70.prototype.makeOutput=function(e,t,n){e=this.write(e,t,n);return Lt.makeTensorFromDataId(e,t,n,this)},u70.prototype.disposeData=function(e){var t;this.data.has(e)&&(null!=(t=this.data.get(e).complexTensors)&&(t.real.dispose(),t.imag.dispose()),this.data.delete(e))},u70.prototype.time=function(o){return n(this,void 0,void 0,function(){var t;return r(this,function(e){return t=et(),o(),[2,{kernelMs:et()-t}]})})},u70.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},u70.prototype.complex=function(e,t){var n=this.makeOutput(null,e.shape,"complex64");return this.data.get(n.dataId).complexTensors={real:Lt.keep(e.clone()),imag:Lt.keep(t.clone())},n},u70.prototype.real=function(e){return this.data.get(e.dataId).complexTensors.real.clone()},u70.prototype.imag=function(e){return this.data.get(e.dataId).complexTensors.imag.clone()},u70.prototype.slice=function(e,n,t){if(Hh(e,"slice"),io(e.shape,n,t)){var r=so(n,e.strides),o=k(t);return Fn(this.readSync(e.dataId).subarray(r,r+o),t,e.dtype)}for(var i=dr(t,e.dtype),a=this.bufferSync(e),s=0;s<i.size;++s){var u=i.indexToLoc(s).map(function(e,t){return e+n[t]});i.values[s]=a.get.apply(a,u)}return i.toTensor()},u70.prototype.stridedSlice=function(e,t,n,r){Hh(e,"stridedSlice");n=ro(t,n,r);if(n.some(function(e){return 0===e}))return Fn([],n);for(var o=dr(n,e.dtype),i=this.bufferSync(e),a=0;a<o.size;a++){for(var s=o.indexToLoc(a),u=new Array(s.length),c=0;c<u.length;c++)u[c]=s[c]*r[c]+t[c];o.set.apply(o,[i.get.apply(i,u)].concat(s))}return o.toTensor()},u70.prototype.diag=function(e){for(var t=this.readSync(e.dataId),n=dr([e.size,e.size],e.dtype),r=n.values,o=0;o<t.length;o++)r[o*e.size+o]=t[o];return n.toTensor()},u70.prototype.unstack=function(e,t){for(var n=e.shape[t],r=new Array(e.rank-1),o=0,i=0;i<e.rank;i++)i!==t&&(r[o++]=e.shape[i]);var a=new Array(e.rank).fill(0),s=e.shape.slice();s[t]=1;for(var u=new Array(n),i=0;i<u.length;i++)u[a[t]=i]=this.slice(e,a,s).reshape(r);return u},u70.prototype.reverse=function(n,r){Hh(n,"reverse");for(var o=dr(n.shape,n.dtype),i=this.bufferSync(n),e=0;e<o.size;e++)!function(e){var e=o.indexToLoc(e),t=e.slice();r.forEach(function(e){return t[e]=n.shape[e]-1-t[e]}),o.set.apply(o,[i.get.apply(i,t)].concat(e))}(e);return o.toTensor()},u70.prototype.concat=function(e,n){var a=this;if("complex64"===e[0].dtype){var t=e.map(function(e){return Tn(e)}),r=e.map(function(e){return Nn(e)});return Dn(this.concat(t,n),this.concat(r,n))}var o,s,r=e.map(function(e){var t=k(e.shape.slice(n));return e.as2D(-1,t)}),u=Sn(r.map(function(e){return e.shape}),1),c=dr(u,e[0].dtype).values;1===r[0].shape[0]?(o=0,r.forEach(function(e){c.set(a.readSync(e.dataId),o),o+=e.size})):(s=0,r.forEach(function(e){for(var t=a.readSync(e.dataId),n=0,r=0;r<e.shape[0];++r)for(var o=r*u[1]+s,i=0;i<e.shape[1];++i)c[o+i]=t[n++];s+=e.shape[1]}));r=Sn(e.map(function(e){return e.shape}),n);return Fn(c,r,e[0].dtype)},u70.prototype.neg=function(e){return Hh(e,"neg"),this.multiply(On(-1),e)},u70.prototype.add=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(e,t,n,r){return{real:e+n,imag:t+r}}):this.broadcastedBinaryOp(e,t,Dt(e.dtype,t.dtype),function(e,t){return e+t})},u70.prototype.addN=function(e){var t=this;Hh(e,"addN");for(var n=e.map(function(e){return t.readSync(e.dataId)}),r=dr(e[0].shape,e[0].dtype),o=r.values,i=0;i<e.length;i++)for(var a=n[i],s=0;s<o.length;s++)o[s]+=a[s];return r.toTensor()},u70.prototype.softmax=function(e,t){var n=O([t],e.shape),r=this.max(e,n),t=wn(r.shape,n),r=this.subtract(e,r.reshape(t)),r=this.exp(r),t=this.sum(r,n).reshape(t);return this.realDivide(r,t)},u70.prototype.subtract=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(e,t,n,r){return{real:e-n,imag:t-r}}):this.broadcastedBinaryOp(e,t,Dt(e.dtype,t.dtype),function(e,t){return e-t})},u70.prototype.pow=function(e,t){return Hh([e,t],"pow"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){return Math.pow(e,t)})},u70.prototype.batchMatMul=function(e,t,n,r){Hh([e,t],"matMul");for(var o=n?e.shape[1]:e.shape[2],i=n?e.shape[2]:e.shape[1],a=r?t.shape[1]:t.shape[2],s=e.shape[0],u=this.readSync(e.dataId),c=this.readSync(t.dataId),n=n?[e.strides[0],1,e.strides[1]]:[e.strides[0],e.strides[1],1],l=n[0],h=n[1],d=n[2],t=r?[1,t.strides[1],t.strides[0]]:[t.strides[1],1,t.strides[0]],p=t[0],f=t[1],m=t[2],g=i*a,e=dr([s,i,a],e.dtype),v=e.values,b=this.blockSize,y=0;y<s;y++)for(var x=0;x<i;x+=b)for(var w=0;w<a;w+=b)for(var C=0;C<o;C+=b)for(var E=Math.min(x+b,i),_=Math.min(w+b,a),S=Math.min(C+b,o),R=x;R<E;R++)for(var T=w;T<_;T++){for(var A=0,k=C;k<S;k++)A+=u[y*l+R*h+k*d]*c[k*p+T*f+y*m];v[y*g+(R*a+T)]+=A}return e.toTensor()},u70.prototype.fusedBatchMatMul=function(e){var t=e.a,n=e.b,r=e.transposeA,o=e.transposeB,i=e.bias,a=e.activation,e=e.preluActivationWeights,o=this.batchMatMul(t,n,r,o);return i&&(o=this.add(o,i)),o=a?qh(this,o,a,e):o},u70.prototype.multiply=function(e,t){return"complex64"===e.dtype||"complex64"===t.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),t.cast("complex64"),function(e,t,n,r){return{real:e*n-t*r,imag:e*r+t*n}}):this.broadcastedBinaryOp(e,t,Dt(e.dtype,t.dtype),function(e,t){return e*t})},u70.prototype.realDivide=function(e,t){return Hh([e,t],"realDivide"),this.broadcastedBinaryOp(e,t,"float32",function(e,t){return e/t})},u70.prototype.floorDiv=function(e,t){return Hh([e,t],"floorDiv"),this.broadcastedBinaryOp(e,t,"int32",function(e,t){return Math.floor(e/t)})},u70.prototype.sum=function(e,t){Hh(e,"sum"),Cn("sum",t,e.rank);for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,Dt(e.dtype,"int32")),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=0,c=0;c<r;++c)u+=i[s+c];o[a]=u}return t},u70.prototype.prod=function(e,t){Hh(e,"sum");for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,Dt(e.dtype,"int32")),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=1,c=0;c<r;++c)u*=i[s+c];o[a]=u}return t},u70.prototype.unsortedSegmentSum=function(e,t,n){Hh(e,"unsortedSegmentSum");for(var r=[],o=e.rank-t.rank,i=0;i<o;++i)t=t.expandDims(i+1);for(i=0;i<n;++i){var a=On(i,"int32"),a=Rc(a,t).asType("float32").mul(e).sum(0);r.push(a)}return Pr(r)},u70.prototype.argMin=function(e,t){Hh(e,"argMin");var n=[t];Cn("argMin",n,e.rank);for(var t=bn(e.shape,n),n=t[0],t=t[1],n=Gn(n,"int32"),r=k(t),o=this.readSync(n.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0,l=0;l<r;++l){var h=i[s+l];h<u&&(u=h,c=l)}o[a]=c}return n},u70.prototype.argMax=function(e,t){Hh(e,"argMax");var n=[t];Cn("argMax",n,e.rank);for(var t=bn(e.shape,n),n=t[0],t=t[1],n=Gn(n,"int32"),r=k(t),o=this.readSync(n.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0,l=0;l<r;++l){var h=i[s+l];u<h&&(u=h,c=l)}o[a]=c}return n},u70.prototype.cumsum=function(e,t,n,r){if(Hh(e,"cumsum"),t!==e.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(e.rank-1)+" but got axis="+t);for(var t=Dt(e.dtype,"int32"),t=Gn(e.shape,t),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=e.shape[e.rank-1],s=r?function(e,t){return e+a-t-1}:function(e,t){return e+t},u=0;u<i.length;u+=a)for(var c=0;c<a;c++){var l,h=s(u,c);0===c?o[h]=n?0:i[h]:(l=s(u,c-1),o[h]=n?i[l]+o[l]:i[h]+o[l])}return t},u70.prototype.equal=function(e,t){return Hh([e,t],"equal"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e===t?1:0})},u70.prototype.notEqual=function(e,t){return Hh([e,t],"notEqual"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e!==t?1:0})},u70.prototype.less=function(e,t){return Hh([e,t],"less"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e<t?1:0})},u70.prototype.lessEqual=function(e,t){return Hh([e,t],"lessEqual"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e<=t?1:0})},u70.prototype.greater=function(e,t){return Hh([e,t],"greater"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return t<e?1:0})},u70.prototype.greaterEqual=function(e,t){return Hh([e,t],"greaterEqual"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return t<=e?1:0})},u70.prototype.logicalNot=function(e){Hh(e,"logicalNot");for(var t=this.readSync(e.dataId),n=new Uint8Array(t.length),r=0;r<t.length;++r)n[r]=t[r]?0:1;return this.makeOutput(n,e.shape,"bool")},u70.prototype.logicalAnd=function(e,t){return Hh([e,t],"logicalAnd"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e&&t})},u70.prototype.logicalOr=function(e,t){return Hh([e,t],"logicalOr"),this.broadcastedBinaryOp(e,t,"bool",function(e,t){return e||t})},u70.prototype.select=function(e,t,n){Hh([e,t,n],"select");for(var r=this.readSync(e.dataId),o=this.readSync(t.dataId),i=this.readSync(n.dataId),n=Gn(t.shape,Dt(t.dtype,n.dtype)),a=this.readSync(n.dataId),s=0,u=0===e.rank||1<e.rank||1===t.rank?1:k(t.shape.slice(1)),c=0;c<r.length;c++)for(var l=0;l<u;l++)1===r[c]?a[s++]=o[c]:a[s++]=i[c];return n},u70.prototype.where=function(e){Hh([e],"where");var t=this.readSync(e.dataId);return na(e.shape,t)},u70.prototype.topk=function(e,t,n){return Hh(e,"topk"),ea(this.readSync(e.dataId),e.shape,e.dtype,t)},u70.prototype.min=function(e,t){Hh(e,"min"),Cn("min",t,e.rank);for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,e.dtype),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0;c<r;++c){var l=i[s+c];l<u&&(u=l)}o[a]=u}return t},u70.prototype.minimum=function(e,t){return Hh([e,t],"minimum"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){return Math.min(e,t)})},u70.prototype.mod=function(e,t){return Hh([e,t],"mod"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){var n=e%t;return e<0&&t<0||0<=e&&0<=t?n:(n+t)%t})},u70.prototype.max=function(e,t){Hh(e,"max"),Cn("max",t,e.rank);for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,e.dtype),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0;c<r;++c){var l=i[s+c];u<l&&(u=l)}o[a]=u}return t},u70.prototype.maximum=function(e,t){return Hh([e,t],"maximum"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){return Math.max(e,t)})},u70.prototype.all=function(e,t){Hh(e,"all"),Cn("all",t,e.rank);for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,e.dtype),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0;c<r;++c)var l=i[s+c],u=u&&l;o[a]=u}return t},u70.prototype.any=function(e,t){Hh(e,"any"),Cn("any",t,e.rank);for(var n=bn(e.shape,t),t=n[0],n=n[1],t=Gn(t,e.dtype),r=k(n),o=this.readSync(t.dataId),i=this.readSync(e.dataId),a=0;a<o.length;++a){for(var s=a*r,u=i[s],c=0;c<r;++c)var l=i[s+c],u=u||l;o[a]=u}return t},u70.prototype.squaredDifference=function(e,t){return Hh([e,t],"squaredDifference"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){t=e-t;return t*t})},u70.prototype.ceil=function(e){Hh(e,"ceil");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)n[r]=Math.ceil(t[r]);return this.makeOutput(n,e.shape,"float32")},u70.prototype.floor=function(e){Hh(e,"floor");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)n[r]=Math.floor(t[r]);return this.makeOutput(n,e.shape,"float32")},u70.prototype.sign=function(e){Hh(e,"x");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)t[r]<0?n[r]=-1:0<t[r]?n[r]=1:n[r]=0;return this.makeOutput(n,e.shape,"float32")},u70.prototype.isNaN=function(e){Hh(e,"x");for(var t=this.readSync(e.dataId),n=new Uint8Array(t.length),r=0;r<t.length;++r)Number.isNaN(t[r])&&(n[r]=1);return this.makeOutput(n,e.shape,"bool")},u70.prototype.isInf=function(e){Hh(e,"x");for(var t=this.readSync(e.dataId),n=new Uint8Array(t.length),r=0;r<t.length;++r)Math.abs(t[r])===1/0&&(n[r]=1);return this.makeOutput(n,e.shape,"bool")},u70.prototype.isFinite=function(e){Hh(e,"x");for(var t=this.readSync(e.dataId),n=new Uint8Array(t.length),r=0;r<t.length;++r)Number.isFinite(t[r])&&(n[r]=1);return this.makeOutput(n,e.shape,"bool")},u70.prototype.round=function(e){Hh(e,"round");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r){var o=Math.floor(t[r]);t[r]-o<.5?n[r]=Math.floor(t[r]):.5<t[r]-o?n[r]=Math.ceil(t[r]):n[r]=o%2==0?o:o+1}return this.makeOutput(n,e.shape,"float32")},u70.prototype.exp=function(e){Hh(e,"exp");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)n[r]=Math.exp(t[r]);return this.makeOutput(n,e.shape,"float32")},u70.prototype.expm1=function(e){Hh(e,"expm1");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)n[r]=Math.expm1(t[r]);return this.makeOutput(n,e.shape,"float32")},u70.prototype.log=function(e){Hh(e,"log");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r){var o=t[r];n[r]=Math.log(o)}return this.makeOutput(n,e.shape,"float32")},u70.prototype.log1p=function(e){Hh(e,"log1p");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r){var o=t[r];n[r]=Math.log1p(o)}return this.makeOutput(n,e.shape,"float32")},u70.prototype.sqrt=function(e){Hh(e,"sqrt");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r){var o=t[r];n[r]=Math.sqrt(o)}return this.makeOutput(n,e.shape,"float32")},u70.prototype.rsqrt=function(e){Hh(e,"rsqrt");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r){var o=t[r];n[r]=1/Math.sqrt(o)}return this.makeOutput(n,e.shape,"float32")},u70.prototype.reciprocal=function(e){Hh(e,"reciprocal");for(var t=this.readSync(e.dataId),n=new Float32Array(t.length),r=0;r<t.length;++r)n[r]=1/t[r];return this.makeOutput(n,e.shape,"float32")},u70.prototype.linear=function(e){return e},u70.prototype.relu=function(e){Hh(e,"relu");for(var t=Gn(e.shape,e.dtype),n=this.readSync(t.dataId),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.max(0,r[o]);return t},u70.prototype.relu6=function(e){Hh(e,"relu");for(var t=Gn(e.shape,e.dtype),n=this.readSync(t.dataId),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.min(Math.max(0,r[o]),6);return t},u70.prototype.prelu=function(e,t){return Hh([e,t],"prelu"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){return e<0?t*e:e})},u70.prototype.elu=function(e){Hh(e,"elu");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r){var o=n[r];t[r]=0<=o?o:Math.exp(o)-1}return this.makeOutput(t,e.shape,"float32")},u70.prototype.eluDer=function(e,t){Hh([e,t],"eluDer");for(var n=new Float32Array(t.size),r=this.readSync(t.dataId),o=this.readSync(e.dataId),i=0;i<r.length;++i){var a=r[i];n[i]=1<=a?o[i]:o[i]*(a+1)}return this.makeOutput(n,t.shape,"float32")},u70.prototype.selu=function(e){Hh(e,"selu");for(var t=bs,n=ws,r=new Float32Array(e.size),o=this.readSync(e.dataId),i=0;i<o.length;++i){var a=o[i];r[i]=0<=a?n*a:t*(Math.exp(a)-1)}return this.makeOutput(r,e.shape,"float32")},u70.prototype.clip=function(e,t,n){Hh(e,"clip");for(var r=new Float32Array(e.size),o=this.readSync(e.dataId),i=0;i<o.length;++i){var a=o[i];r[i]=n<a?n:a<t?t:a}return this.makeOutput(r,e.shape,"float32")},u70.prototype.abs=function(e){for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.abs(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.complexAbs=function(e){for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<e.size;++r){var o=n[2*r],i=n[2*r+1];t[r]=Math.hypot(o,i)}return this.makeOutput(t,e.shape,"float32")},u70.prototype.int=function(e){Hh(e,"int");for(var t=new Int32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=n[r];return this.makeOutput(t,e.shape,"int32")},u70.prototype.sigmoid=function(e){Hh(e,"sigmoid");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=1/(1+Math.exp(-n[r]));return this.makeOutput(t,e.shape,"float32")},u70.prototype.softplus=function(e){Hh(e,"softplus");for(var t=Math.log(1.1920928955078125e-7)+2,n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var i=r[o]>-t,a=r[o]<t,s=Math.exp(r[o]),u=a?s:i?r[o]:Math.log(1+s);n[o]=u}return this.makeOutput(n,e.shape,"float32")},u70.prototype.sin=function(e){Hh(e,"sin");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.sin(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.cos=function(e){Hh(e,"cos");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.cos(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.tan=function(e){Hh(e,"tan");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.tan(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.asin=function(e){Hh(e,"asin");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.asin(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.acos=function(e){Hh(e,"acos");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.acos(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.atan=function(e){Hh(e,"atan");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.atan(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.atan2=function(e,t){return Hh([e,t],"atan2"),this.broadcastedBinaryOp(e,t,e.dtype,function(e,t){return Math.atan2(e,t)})},u70.prototype.sinh=function(e){Hh(e,"sinh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.sinh(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.cosh=function(e){Hh(e,"cosh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.cosh(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.tanh=function(e){Hh(e,"tanh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=D(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.asinh=function(e){Hh(e,"asinh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.asinh(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.acosh=function(e){Hh(e,"acosh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.acosh(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.atanh=function(e){Hh(e,"atanh");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r)t[r]=Math.atanh(n[r]);return this.makeOutput(t,e.shape,"float32")},u70.prototype.erf=function(e){Hh(e,"erf");for(var t=new Float32Array(e.size),n=this.readSync(e.dataId),r=0;r<n.length;++r){var o=Math.sign(n[r]),i=Math.abs(n[r]),a=1/(1+.3275911*i);t[r]=o*(1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-i*i))}return this.makeOutput(t,e.shape,"float32")},u70.prototype.step=function(e,t){void 0===t&&(t=0),Hh(e,"step");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var i=r[o];isNaN(i)?n[o]=NaN:n[o]=0<i?1:t}return this.makeOutput(n,e.shape,"float32")},u70.prototype.fusedConv2d=function(e){var t=e.input,n=e.filter,r=e.convInfo,o=e.bias,i=e.activation,e=e.preluActivationWeights,r=this.conv2d(t,n,r);return o&&(r=this.add(r,o)),r=i?qh(this,r,i,e):r},u70.prototype.conv2d=function(e,t,n){Hh([e,t],"conv2d");for(var r=n.filterHeight,o=n.filterWidth,i=n.dilationHeight,a=n.dilationWidth,s=n.padInfo.left,u=n.padInfo.top,c="channelsLast"===n.dataFormat,l=dr(n.outShape,e.dtype),h=e.strides[0],d=c?e.strides[1]:e.strides[2],p=c?e.strides[2]:1,f=c?1:e.strides[1],m=l.strides[0],g=c?l.strides[1]:l.strides[2],v=c?l.strides[2]:1,b=c?1:l.strides[1],y=this.readSync(e.dataId),x=this.readSync(t.dataId),w=l.values,C=0;C<n.batchSize;++C)for(var E=C*h,_=C*m,S=0;S<n.outHeight;++S)for(var R=_+S*g,T=S*n.strideHeight-u,A=0;A<r;A++){var k=T+A*i;if(!(k<0||k>=n.inHeight))for(var N=A*t.strides[0],I=E+k*d,O=0;O<n.outWidth;++O)for(var D=R+O*v,M=O*n.strideWidth-s,P=0;P<o;P++){var F=M+P*a;if(!(F<0||F>=n.inWidth))for(var L=I+F*p,B=N+P*t.strides[1],W=0;W<n.inChannels;++W){for(var H=y[L+W*f],V=0;V<n.outChannels;++V)w[D+V*b]+=H*x[B+V];B+=n.outChannels}}}return l.toTensor()},u70.prototype.conv3d=function(e,t,n){for(var r=n.filterDepth,o=n.filterHeight,i=n.filterWidth,a=n.dilationDepth,s=n.dilationHeight,u=n.dilationWidth,c=n.padInfo.front,l=n.padInfo.left,h=n.padInfo.top,d=dr(n.outShape,e.dtype),p=this.readSync(e.dataId),f=this.readSync(t.dataId),m=d.values,g=0;g<n.batchSize;++g)for(var v=g*e.strides[0],b=g*d.strides[0],y=0;y<n.outDepth;++y)for(var x=b+y*d.strides[1],w=y*n.strideDepth-c,C=0;C<r;C++){var E=w+C*a;if(!(E<0||E>=n.inDepth))for(var _=C*t.strides[0],S=v+E*e.strides[1],R=0;R<n.outHeight;++R)for(var T=x+R*d.strides[2],A=R*n.strideHeight-h,k=0;k<o;k++){var N=A+k*s;if(!(N<0||N>=n.inHeight))for(var I=_+k*t.strides[1],O=S+N*e.strides[2],D=0;D<n.outWidth;++D)for(var M=T+D*n.outChannels,P=D*n.strideWidth-l,F=0;F<i;F++){var L=P+F*u;if(!(L<0||L>=n.inWidth))for(var B=I+F*t.strides[2],W=O+L*n.inChannels,H=B,V=0;V<n.inChannels;++V){for(var U=p[W+V],z=0;z<n.outChannels;++z)m[M+z]+=U*f[H+z];H+=n.outChannels}}}}return d.toTensor()},u70.prototype.conv2dDerInput=function(e,t,n){Hh([e,t],"conv2dDerInput");for(var r=dr(n.inShape,"float32"),o=r.values,i=this.readSync(e.dataId),a=this.readSync(t.dataId),t=t.strides,s=t[0],u=t[1],c=t[2],l=n.batchSize,h=n.filterHeight,d=n.filterWidth,p=n.inChannels,f=n.inHeight,m=n.inWidth,g=n.outChannels,v=n.outHeight,b=n.outWidth,y=n.strideHeight,x=n.strideWidth,t=n.dataFormat,w=h-1-n.padInfo.top,C=d-1-n.padInfo.left,t="channelsLast"===t,E=r.strides[0],_=t?r.strides[1]:r.strides[2],S=t?r.strides[2]:1,R=t?1:r.strides[1],T=e.strides[0],A=t?e.strides[1]:e.strides[2],k=t?e.strides[2]:1,N=t?1:e.strides[1],I=0;I<l;++I)for(var O=0;O<p;++O)for(var D=0;D<f;++D)for(var M=D-w,P=Math.max(0,Math.ceil(M/y)),F=Math.min(v,(h+M)/y),L=0;L<m;++L){for(var B=L-C,W=Math.max(0,Math.ceil(B/x)),H=Math.min(b,(d+B)/x),V=0,U=P;U<F;++U)for(var z=U*y-M,G=W;G<H;++G)for(var $=T*I+A*U+k*G,j=s*(h-1-z)+u*(d-1-(G*x-B))+c*O,q=0;q<g;++q)V+=i[$+N*q]*a[j+q];o[E*I+_*D+S*L+R*O]=V}return r.toTensor()},u70.prototype.conv3dDerInput=function(e,t,n){for(var r=dr(n.inShape,"float32"),o=r.values,i=r.strides,a=i[0],s=i[1],u=i[2],c=i[3],l=this.readSync(e.dataId),e=e.strides,h=e[0],d=e[1],p=e[2],f=e[3],m=this.readSync(t.dataId),t=t.strides,g=t[0],v=t[1],b=t[2],y=t[3],x=n.batchSize,w=n.filterDepth,C=n.filterHeight,E=n.filterWidth,_=n.inChannels,S=n.inDepth,R=n.inHeight,T=n.inWidth,A=n.outChannels,k=n.outDepth,N=n.outHeight,I=n.outWidth,O=n.strideDepth,D=n.strideHeight,M=n.strideWidth,P=w-1-n.padInfo.front,F=C-1-n.padInfo.top,L=E-1-n.padInfo.left,B=0;B<x;++B)for(var W=0;W<_;++W)for(var H=0;H<S;++H)for(var V=H-P,U=Math.max(0,Math.ceil(V/O)),z=Math.min(k,(w+V)/O),G=0;G<R;++G)for(var $=G-F,j=Math.max(0,Math.ceil($/D)),q=Math.min(N,(C+$)/D),Y=0;Y<T;++Y){for(var K=Y-L,X=Math.max(0,Math.ceil(K/M)),J=Math.min(I,(E+K)/M),Z=0,Q=U;Q<z;++Q)for(var ee=Q*O-V,te=j;te<q;++te)for(var ne=te*D-$,re=X;re<J;++re)for(var oe=h*B+d*Q+p*te+f*re,ie=g*(w-1-ee)+v*(C-1-ne)+b*(E-1-(re*M-K))+y*W,ae=0;ae<A;++ae)Z+=l[oe+ae]*m[ie+ae];o[a*B+s*H+u*G+c*Y+W]=Z}return r.toTensor()},u70.prototype.conv2dDerFilter=function(e,t,n){Hh([e,t],"conv2dDerFilter");for(var r=n.strideHeight,o=n.strideWidth,i=n.filterHeight,a=n.filterWidth,s="channelsLast"===n.dataFormat,u=dr(n.filterShape,"float32"),c=n.padInfo.left,l=n.padInfo.top,h=this.bufferSync(e),d=this.bufferSync(t),p=0;p<i;++p)for(var f=Math.max(0,Math.ceil((l-p)/r)),m=Math.min(n.outHeight,(n.inHeight+l-p)/r),g=0;g<a;++g)for(var v=Math.max(0,Math.ceil((c-g)/o)),b=Math.min(n.outWidth,(n.inWidth+c-g)/o),y=0;y<n.inChannels;++y)for(var x=0;x<n.outChannels;++x){for(var w=0,C=0;C<n.batchSize;++C)for(var E=f;E<m;++E)for(var _=p+E*r-l,S=v;S<b;++S){var R=g+S*o-c;w+=s?h.get(C,_,R,y)*d.get(C,E,S,x):h.get(C,y,_,R)*d.get(C,x,E,S)}u.set(w,p,g,y,x)}return u.toTensor()},u70.prototype.conv3dDerFilter=function(e,t,n){for(var r=n.strideDepth,o=n.strideHeight,i=n.strideWidth,a=n.filterDepth,s=n.filterHeight,u=n.filterWidth,c=dr(n.filterShape,"float32"),l=c.values,h=c.strides,d=h[0],p=h[1],f=h[2],m=h[3],g=this.readSync(t.dataId),t=t.strides,v=t[0],b=t[1],y=t[2],x=t[3],w=this.readSync(e.dataId),e=e.strides,C=e[0],E=e[1],_=e[2],S=e[3],R=n.padInfo.front,T=n.padInfo.left,A=n.padInfo.top,k=0;k<a;++k)for(var N=Math.max(0,Math.ceil((R-k)/r)),I=Math.min(n.outDepth,(n.inDepth+R-k)/r),O=k*d,D=0;D<s;++D)for(var M=Math.max(0,Math.ceil((A-D)/o)),P=Math.min(n.outHeight,(n.inHeight+A-D)/o),F=D*p+O,L=0;L<u;++L)for(var B=Math.max(0,Math.ceil((T-L)/i)),W=Math.min(n.outWidth,(n.inWidth+T-L)/i),H=L*f+F,V=0;V<n.inChannels;++V)for(var U=V*m+H,z=0;z<n.outChannels;++z){for(var G=0,$=0;$<n.batchSize;++$)for(var j=$*C,q=$*v,Y=N;Y<I;++Y)for(var K=(k+Y*r-R)*E+j,X=Y*b+q,J=M;J<P;++J)for(var Z=(D+J*o-A)*_+K,Q=J*y+X,ee=B;ee<W;++ee)G+=w[(L+ee*i-T)*S+Z+V]*g[ee*x+Q+z];l[U+z]=G}return c.toTensor()},u70.prototype.fusedDepthwiseConv2D=function(e){var t=e.input,n=e.filter,r=e.convInfo,o=e.bias,i=e.activation,e=e.preluActivationWeights,r=this.depthwiseConv2D(t,n,r);return o&&(r=this.add(r,o)),r=i?qh(this,r,i,e):r},u70.prototype.depthwiseConv2D=function(e,t,n){Hh([e,t],"depthwiseConv2D");for(var r=n.filterHeight,o=n.filterWidth,i=n.dilationHeight,a=n.dilationWidth,s=n.padInfo.left,u=n.padInfo.top,c=n.outChannels/n.inChannels,l=dr(n.outShape,e.dtype),h=this.readSync(e.dataId),d=this.readSync(t.dataId),p=l.values,f=0;f<n.batchSize;++f)for(var m=f*e.strides[0],g=f*l.strides[0],v=0;v<n.outHeight;++v)for(var b=g+v*l.strides[1],y=v*n.strideHeight-s,x=0;x<r;++x){var w=y+x*i;if(!(w<0||w>=n.inHeight))for(var C=x*t.strides[0],E=m+w*e.strides[1],_=0;_<n.outWidth;++_)for(var S=b+_*l.strides[2],R=_*n.strideWidth-u,T=0;T<o;++T){var A=R+T*a;if(!(A<0||A>=n.inWidth))for(var k=C+T*t.strides[1],N=E+A*n.inChannels,I=S,O=k,D=0;D<n.inChannels;++D){for(var M=h[N+D],P=0;P<c;++P)p[I+P]+=M*d[O+P];I+=c,O+=c}}}return l.toTensor()},u70.prototype.depthwiseConv2DDerInput=function(e,t,n){Hh([e,t],"depthwiseConv2DDerInput");for(var r=dr(n.inShape,"float32"),o=r.values,i=r.strides,a=i[0],s=i[1],u=i[2],c=this.readSync(e.dataId),e=e.strides,l=e[0],h=e[1],d=e[2],p=this.readSync(t.dataId),t=t.strides,f=t[0],m=t[1],g=t[2],v=n.batchSize,b=n.filterHeight,y=n.filterWidth,x=n.inChannels,w=n.inHeight,C=n.inWidth,t=n.outChannels,E=n.outHeight,_=n.outWidth,S=n.strideHeight,R=n.strideWidth,T=b-1-n.padInfo.top,A=y-1-n.padInfo.left,k=t/x,N=0;N<v;++N)for(var I=0;I<x;++I)for(var O=0;O<w;++O)for(var D=O-T,M=Math.max(0,Math.ceil(D/S)),P=Math.min(E,(b+D)/S),F=0;F<C;++F){for(var L=F-A,B=Math.max(0,Math.ceil(L/R)),W=Math.min(_,(y+L)/R),H=0,V=M;V<P;++V)for(var U=V*S-D,z=B;z<W;++z)for(var G=l*N+h*V+d*z,$=f*(b-1-U)+m*(y-1-(z*R-L))+g*I,j=0;j<k;++j)H+=c[G+(I*k+j)]*p[$+j];o[a*N+s*O+u*F+I]=H}return r.toTensor()},u70.prototype.depthwiseConv2DDerFilter=function(e,t,n){Hh([e,t],"depthwiseConv2DDerFilter");for(var r=n.strideHeight,o=n.strideWidth,i=n.filterHeight,a=n.filterWidth,s=dr(n.filterShape,"float32"),u=n.padInfo.left,c=n.padInfo.top,l=n.outChannels/n.inChannels,h=this.bufferSync(e),d=this.bufferSync(t),p=0;p<i;++p)for(var f=Math.max(0,Math.ceil((c-p)/r)),m=Math.min(n.outHeight,(n.inHeight+c-p)/r),g=0;g<a;++g)for(var v=Math.max(0,Math.ceil((u-g)/o)),b=Math.min(n.outWidth,(n.inWidth+u-g)/o),y=0;y<n.outChannels;++y){for(var x=Math.trunc(y/l),w=y%l,C=0,E=0;E<n.batchSize;++E)for(var _=f;_<m;++_)for(var S=p+_*r-c,R=v;R<b;++R)C+=h.get(E,S,g+R*o-u,x)*d.get(E,_,R,y);s.set(C,p,g,x,w)}return s.toTensor()},u70.prototype.tile=function(e,t){return Hh(e,"tile"),ta(this.bufferSync(e),t)},u70.prototype.pad=function(n,e,t){Hh(n,"pad");var r=e.map(function(e,t){return e[0]+n.shape[t]+e[1]}),o=e.map(function(e){return e[0]}),i=this.bufferSync(n),a=dr(r,n.dtype);0!==t&&a.values.fill(t);for(var s=0;s<n.size;s++){var u=i.indexToLoc(s),c=u.map(function(e,t){return e+o[t]});a.set.apply(a,[i.get.apply(i,u)].concat(c))}return a.toTensor()},u70.prototype.transpose=function(e,t){Hh(e,"transpose");for(var n=new Array(e.rank),r=0;r<n.length;r++)n[r]=e.shape[t[r]];for(var o=this.readSync(e.dataId),i=dr(n,e.dtype),a=this.bufferSync(e),r=0;r<e.size;++r){for(var s=a.indexToLoc(r),u=new Array(s.length),c=0;c<u.length;c++)u[c]=s[t[c]];var l=i.locToIndex(u);i.values[l]=o[r]}return i.toTensor()},u70.prototype.gather=function(e,t,n){Hh([e,t],"gather");var r=e.shape.slice(),o=this.readSync(t.dataId);r[n]=o.length;for(var i=dr(r,e.dtype),a=this.bufferSync(e),s=0;s<i.size;++s){var u=i.indexToLoc(s),c=u.slice();c[n]=o[u[n]];c=a.locToIndex(c);i.values[s]=a.values[c]}return i.toTensor()},u70.prototype.batchToSpaceND=function(e,t,n){Hh([e],"batchToSpaceND");var r=t.reduce(function(e,t){return e*t}),o=zr(e.shape,t,r),i=Gr(o.length,t.length),a=Hr(e.shape,t,r),r=qr(n,t.length),t=Kr(a,n,t.length);return e.reshape(o).transpose(i).reshape(a).slice(r,t)},u70.prototype.spaceToBatchND=function(e,t,n){Hh([e],"spaceToBatchND");var r=t.reduce(function(e,t){return e*t}),o=[[0,0]];o.push.apply(o,n);for(var i=1+t.length;i<e.shape.length;++i)o.push([0,0]);var a=e.pad(o),s=zr(a.shape,t,r,!1),n=Gr(s.length,t.length,!1),r=Hr(a.shape,t,r,!1);return a.reshape(s).transpose(n).reshape(r)},u70.prototype.pool=function(e,t,n){Hh(e,"pool");for(var r=t.strideHeight,o=t.strideWidth,i=t.dilationHeight,a=t.dilationWidth,s=t.effectiveFilterHeight,u=t.effectiveFilterWidth,c=t.padInfo.top,l=t.padInfo.left,h="max"===n?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,d=this.readSync(e.dataId),p=dr(t.outShape,e.dtype),f=p.values,m=t.outShape[1]*t.outShape[2]*t.outShape[3],g=t.outShape[2]*t.outShape[3],v=t.outShape[3],b=0;b<t.batchSize;++b)for(var y=b*m,x=b*e.strides[0],w=0;w<t.inChannels;++w)for(var C=0;C<t.outHeight;++C)for(var E=C*r-c,_=Math.max(0,E),S=Math.min(t.inHeight,s+E),R=y+C*g,T=0;T<t.outWidth;++T){for(var A=T*o-l,k=Math.max(0,A),N=Math.min(t.inWidth,u+A),I=h,O=0,D=0,M=_;M<S;M+=i){for(var P=x+M*e.strides[1],F=k;F<N;F+=a){var L=d[P+F*e.strides[2]+w];"max"===n&&I<L?I=L:"avg"===n&&(O+=L,D++)}if(isNaN(I))break}f[R+T*v+w]="avg"===n?O/D:I}return p.toTensor()},u70.prototype.maxPool=function(e,t){return this.pool(e,t,"max")},u70.prototype.maxPoolPositions=function(e,t){for(var n=dr(t.outShape,"int32"),r=t.strideHeight,o=t.strideWidth,i=t.dilationHeight,a=t.dilationWidth,s=t.effectiveFilterHeight,u=t.effectiveFilterWidth,c=t.padInfo.top,l=t.padInfo.left,h=this.bufferSync(e),d=0;d<t.batchSize;++d)for(var p=0;p<t.inChannels;++p)for(var f=0;f<t.outHeight;++f){for(var m=f*r-c,g=m;g<0;)g+=i;for(var v=Math.min(t.inHeight,s+m),b=0;b<t.outWidth;++b){for(var y=b*o-l,x=y;x<0;)x+=a;for(var w=Math.min(t.inWidth,u+y),C=Number.NEGATIVE_INFINITY,E=-1,_=g;_<v;_+=i)for(var S=_-m,R=x;R<w;R+=a){var T=R-y,A=h.get(d,_,R,p);C<A&&(C=A,E=S*u+T)}n.set(E,d,f,b,p)}}return n.toTensor()},u70.prototype.maxPoolBackprop=function(e,t,n,r){Hh([t,n],"maxPoolBackprop");for(var n=this.maxPoolPositions(t,r),o=r.strideHeight,i=r.strideWidth,a=r.dilationHeight,s=r.dilationWidth,u=r.effectiveFilterHeight,c=r.effectiveFilterWidth,l=c-1-r.padInfo.left,h=u-1-r.padInfo.top,d=dr(t.shape,"float32"),p=this.bufferSync(n),f=this.bufferSync(e),m=0;m<r.batchSize;++m)for(var g=0;g<r.inChannels;++g)for(var v=0;v<r.inHeight;++v)for(var b=0;b<r.inWidth;++b){for(var y=v-h,x=b-l,w=0,C=0;C<u;C+=a){var E=(y+C)/o;if(!(E<0||E>=r.outHeight||Math.floor(E)!==E))for(var _=0;_<c;_+=s){var S,R=(x+_)/i;R<0||R>=r.outWidth||Math.floor(R)!==R||0!=(S=u*c-1-p.get(m,E,R,g)===C*c+_?1:0)&&(w+=f.get(m,E,R,g)*S)}}d.set(w,m,v,b,g)}return d.toTensor()},u70.prototype.avgPoolBackprop=function(e,t,n){Hh([e,t],"avgPoolBackprop");for(var r=n.strideHeight,o=n.strideWidth,i=n.filterHeight,a=n.filterWidth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterHeight,l=n.effectiveFilterWidth,h=l-1-n.padInfo.left,d=c-1-n.padInfo.top,p=dr(t.shape,"float32"),f=1/(i*a),m=this.bufferSync(e),g=0;g<n.batchSize;++g)for(var v=0;v<n.inChannels;++v)for(var b=0;b<n.inHeight;++b)for(var y=0;y<n.inWidth;++y){for(var x=b-d,w=y-h,C=0,E=0;E<c;E+=s){var _=(x+E)/r;if(!(_<0||_>=n.outHeight||Math.floor(_)!==_))for(var S=0;S<l;S+=u){var R=(w+S)/o;R<0||R>=n.outWidth||Math.floor(R)!==R||(C+=m.get(g,_,R,v))}}p.set(C*f,g,b,y,v)}return p.toTensor()},u70.prototype.pool3d=function(e,t,n){Hh(e,"pool3d");for(var r=t.strideDepth,o=t.strideHeight,i=t.strideWidth,a=t.dilationDepth,s=t.dilationHeight,u=t.dilationWidth,c=t.effectiveFilterDepth,l=t.effectiveFilterHeight,h=t.effectiveFilterWidth,d=t.padInfo.front,p=t.padInfo.top,f=t.padInfo.left,m="max"===n?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,g=this.readSync(e.dataId),v=dr(t.outShape,e.dtype),b=v.values,y=t.outShape[1]*t.outShape[2]*t.outShape[3]*t.outShape[4],x=t.outShape[2]*t.outShape[3]*t.outShape[4],w=t.outShape[3]*t.outShape[4],C=t.outShape[4],E=0;E<t.batchSize;++E)for(var _=E*y,S=E*e.strides[0],R=0;R<t.inChannels;++R)for(var T=0;T<t.outDepth;++T){for(var A=T*r-d,k=A;k<0;)k+=a;for(var N=Math.min(t.inDepth,c+A),I=_+T*x,O=0;O<t.outHeight;++O){for(var D=O*o-p,M=D;M<0;)M+=s;for(var P=Math.min(t.inHeight,l+D),F=I+O*w,L=0;L<t.outWidth;++L){for(var B=L*i-f,W=B;W<0;)W+=u;for(var H=Math.min(t.inWidth,h+B),B=F+L*C,V=m,U=0,z=0,G=k;G<N;G+=a){for(var $=S+G*e.strides[1],j=M;j<P;j+=s){for(var q=$+j*e.strides[2],Y=W;Y<H;Y+=u){var K=g[q+Y*e.strides[3]+R];if("max"===n&&V<K?V=K:"avg"===n&&(U+=K,z++),isNaN(V))break}if(isNaN(V))break}if(isNaN(V))break}b[B+R]="avg"===n?U/z:V}}}return v.toTensor()},u70.prototype.avgPool3d=function(e,t){return Hh(e,"avgPool3d"),this.pool3d(e,t,"avg").toFloat()},u70.prototype.avgPool3dBackprop=function(e,t,n){Hh([e,t],"avgPool3dBackprop");for(var r=n.strideDepth,o=n.strideHeight,i=n.strideWidth,a=n.filterDepth,s=n.filterHeight,u=n.filterWidth,c=n.dilationDepth,l=n.dilationHeight,h=n.dilationWidth,d=n.effectiveFilterDepth,p=n.effectiveFilterHeight,f=n.effectiveFilterWidth,m=d-1-n.padInfo.front,g=f-1-n.padInfo.left,v=p-1-n.padInfo.top,b=dr(t.shape,"float32"),y=1/(a*s*u),x=this.bufferSync(e),w=0;w<n.batchSize;++w)for(var C=0;C<n.inChannels;++C)for(var E=0;E<n.inDepth;++E)for(var _=0;_<n.inHeight;++_)for(var S=0;S<n.inWidth;++S){for(var R=E-m,T=_-v,A=S-g,k=0,N=0;N<d;N+=c){var I=(R+N)/r;if(!(I<0||I>=n.outDepth||Math.floor(I)!==I))for(var O=0;O<p;O+=l){var D=(T+O)/o;if(!(D<0||D>=n.outHeight||Math.floor(D)!==D))for(var M=0;M<f;M+=h){var P=(A+M)/i;P<0||P>=n.outWidth||Math.floor(P)!==P||(k+=x.get(w,I,D,P,C))}}}b.set(k*y,w,E,_,S,C)}return b.toTensor()},u70.prototype.maxPool3d=function(e,t){return Hh(e,"maxPool3d"),this.pool3d(e,t,"max").toFloat()},u70.prototype.maxPool3dPositions=function(e,t){for(var n=dr(t.outShape,"int32"),r=t.strideDepth,o=t.strideHeight,i=t.strideWidth,a=t.dilationDepth,s=t.dilationHeight,u=t.dilationWidth,c=t.effectiveFilterDepth,l=t.effectiveFilterHeight,h=t.effectiveFilterWidth,d=t.padInfo.front,p=t.padInfo.top,f=t.padInfo.left,m=this.bufferSync(e),g=0;g<t.batchSize;++g)for(var v=0;v<t.inChannels;++v)for(var b=0;b<t.outDepth;++b){for(var y=b*r-d,x=y;x<0;)x+=a;for(var w=Math.min(t.inDepth,c+y),C=0;C<t.outHeight;++C){for(var E=C*o-p,_=E;_<0;)_+=s;for(var S=Math.min(t.inHeight,l+E),R=0;R<t.outWidth;++R){for(var T=R*i-f,A=T;A<0;)A+=u;for(var k=Math.min(t.inWidth,h+T),N=Number.NEGATIVE_INFINITY,I=-1,O=x;O<w;O+=a)for(var D=O-y,M=_;M<S;M+=s)for(var P=M-E,F=A;F<k;F+=u){var L=F-T,B=m.get(g,O,M,F,v);N<=B&&(N=B,I=D*l*h+P*l+L)}n.set(I,g,b,C,R,v)}}}return n.toTensor()},u70.prototype.maxPool3dBackprop=function(e,t,n,r){Hh([t,n],"maxPool3dBackprop");for(var n=this.maxPool3dPositions(t,r),o=r.strideDepth,i=r.strideHeight,a=r.strideWidth,s=r.dilationDepth,u=r.dilationHeight,c=r.dilationWidth,l=r.effectiveFilterDepth,h=r.effectiveFilterHeight,d=r.effectiveFilterWidth,p=l-1-r.padInfo.front,f=d-1-r.padInfo.left,m=h-1-r.padInfo.top,g=dr(t.shape,"float32"),v=this.bufferSync(n),b=this.bufferSync(e),y=0;y<r.batchSize;++y)for(var x=0;x<r.inChannels;++x)for(var w=0;w<r.inDepth;++w)for(var C=0;C<r.inHeight;++C)for(var E=0;E<r.inWidth;++E){for(var _=w-p,S=C-m,R=E-f,T=0,A=0;A<l;A+=s){var k=(_+A)/o;if(!(k<0||k>=r.outDepth||Math.floor(k)!==k))for(var N=0;N<h;N+=u){var I=(S+N)/i;if(!(I<0||I>=r.outHeight||Math.floor(I)!==I))for(var O=0;O<d;O+=c){var D,M=(R+O)/a;M<0||M>=r.outWidth||Math.floor(M)!==M||0!=(D=l*h*d-1-v.get(y,k,I,M,x)===A*h*d+N*d+O?1:0)&&(T+=b.get(y,k,I,M,x)*D)}}}g.set(T,y,w,C,E,x)}return g.toTensor()},u70.prototype.cast=function(e,t){return Po(e,t,this)},u70.prototype.reshape=function(e,t){return Lo(e,t)},u70.prototype.avgPool=function(e,t){return Hh(e,"avgPool"),this.pool(e,t,"avg").toFloat()},u70.prototype.resizeBilinear=function(e,t,n,r){Hh(e,"resizeBilinear");for(var o=e.shape,i=o[0],a=o[1],s=o[2],u=o[3],c=this.readSync(e.dataId),l=new Float32Array(k([i,t,n,u])),o=[r&&1<t?a-1:a,r&&1<n?s-1:s],r=[r&&1<t?t-1:t,r&&1<n?n-1:n],h=0,d=o[0]/r[0],p=o[1]/r[1],f=0;f<i;f++)for(var m=0;m<t;m++)for(var g=d*m,v=Math.floor(g),b=g-v,g=Math.min(a-1,Math.ceil(g)),y=f*e.strides[0]+v*e.strides[1],x=f*e.strides[0]+g*e.strides[1],w=0;w<n;w++)for(var C=p*w,E=Math.floor(C),_=C-E,C=Math.min(s-1,Math.ceil(C)),S=y+E*e.strides[2],R=x+E*e.strides[2],T=y+C*e.strides[2],A=x+C*e.strides[2],N=0;N<u;N++){var I=c[S+N],O=c[R+N],I=I+(c[T+N]-I)*_,I=I+(O+(c[A+N]-O)*_-I)*b;l[h++]=I}return Fn(l,[i,t,n,u])},u70.prototype.resizeBilinearBackprop=function(e,t,n){Hh([e,t],"resizeBilinearBackprop");for(var r=t.shape,o=r[0],i=r[1],a=r[2],s=r[3],r=e.shape,u=r[1],c=r[2],l=new Float32Array(o*i*a*s),r=[n&&1<u?i-1:i,n&&1<c?a-1:a],n=[n&&1<u?u-1:u,n&&1<c?c-1:c],h=r[0]/n[0],d=r[1]/n[1],p=this.readSync(e.dataId),f=0,m=0;m<o;m++)for(var g=m*t.strides[0],v=0;v<u;v++)for(var b=v*h,y=Math.floor(b),x=Math.min(Math.ceil(b),i-1),w=g+y*t.strides[1],C=g+x*t.strides[1],E=b-y,_=1-E,S=0;S<c;S++)for(var R=S*d,T=Math.floor(R),A=Math.min(Math.ceil(R),a-1),k=R-T,R=1-k,N=w+T*t.strides[2],I=w+A*t.strides[2],O=C+T*t.strides[2],D=C+A*t.strides[2],M=_*R,P=_*k,F=E*R,L=E*k,B=0;B<s;B++){var W=p[f++];l[N+B]+=W*M,l[I+B]+=W*P,l[O+B]+=W*F,l[D+B]+=W*L}return Ln(l,[o,a,i,s],t.dtype)},u70.prototype.resizeNearestNeighbor=function(e,t,n,r){Hh(e,"resizeNearestNeighbor");for(var o=e.shape,i=o[0],a=o[1],s=o[2],u=o[3],c=this.readSync(e.dataId),l=new Float32Array(i*t*n*u),h=[r&&1<t?a-1:a,r&&1<n?s-1:s],o=[r&&1<t?t-1:t,r&&1<n?n-1:n],d=h[0]/o[0],p=h[1]/o[1],f=0,m=0;m<i;m++)for(var g=m*e.strides[0],v=0;v<t;v++)for(var b=d*v,y=g+Math.min(a-1,r?Math.round(b):Math.floor(b))*e.strides[1],x=0;x<n;x++)for(var w=p*x,C=y+Math.min(s-1,r?Math.round(w):Math.floor(w))*e.strides[2],E=0;E<u;E++){var _=c[C+E];l[f++]=_}return Fn(l,[i,t,n,u],e.dtype)},u70.prototype.resizeNearestNeighborBackprop=function(e,t,n){Hh([e,t],"resizeNearestNeighborBackprop");for(var r=t.shape,o=r[0],i=r[1],a=r[2],s=r[3],u=e.shape,c=u[1],l=u[2],h=new Float32Array(o*i*a*s),d=this.readSync(e.dataId),r=[n&&1<c?i-1:i,n&&1<l?a-1:a],u=[n&&1<c?c-1:c,n&&1<l?l-1:l],p=r[0]/u[0],f=r[1]/u[1],m=1/p,g=1/f,v=2*Math.ceil(m)+2,b=2*Math.ceil(g)+2,y=0;y<o;y++)for(var x=y*t.strides[0],w=0;w<i;w++)for(var C=x+w*t.strides[1],E=Math.floor(w*m),_=Math.floor(E-v/2),S=0;S<a;S++)for(var R=C+S*t.strides[2],T=Math.floor(S*g),A=Math.floor(T-b/2),k=0;k<s;k++){for(var N=0,I=0;I<v;I++){var O=I+_;if(!(O<0||c<=O)){var D=x+O*e.strides[1],O=O*p;if(w===Math.min(i-1,n?Math.round(O):Math.floor(O)))for(var M=0;M<b;M++){var P,F=M+A;F<0||l<=F||(P=D+F*e.strides[2],F=F*f,S===Math.min(a-1,n?Math.round(F):Math.floor(F))&&(N+=d[P+k]))}}}h[R+k]=N}return Ln(h,t.shape,t.dtype)},u70.prototype.batchNormalization=function(e,t,n,r,o,i){Hh([e,t,n,o,i],"batchNorm");for(var a=this.readSync(e.dataId),s=this.readSync(t.dataId),u=this.readSync(n.dataId),c=o?this.readSync(o.dataId):new Float32Array([1]),l=i?this.readSync(i.dataId):new Float32Array([0]),h=new Float32Array(a.length),d=l.length,p=c.length,f=u.length,m=s.length,g=0,v=0,b=0,y=0,x=0;x<a.length;++x)h[x]=l[g++]+(a[x]-s[v++])*c[b++]/Math.sqrt(u[y++]+r),d<=g&&(g=0),m<=v&&(v=0),p<=b&&(b=0),f<=y&&(y=0);return Ln(h,e.shape)},u70.prototype.localResponseNormalization4D=function(e,a,t,n,r){Hh(e,"localResponseNormalization4D");var s=e.shape[3],u=s-1,c=this.readSync(e.dataId),o=e.size,i=new Float32Array(o);for(var l=0;l<o;l++){var h=function(e){for(var t=e%s,n=e-t+Math.max(0,t-a),r=e-t+Math.min(t+a,u),o=0;n<=r;n++){var i=c[n];o+=i*i}return o}(l),h=c[l]*Math.pow(t+n*h,-r);i[l]=h}return Ln(i,e.shape)},u70.prototype.LRNGrad=function(e,t,n,r,o,i,a){Hh(e,"LRNGrad");for(var s=e.shape[3],u=this.readSync(e.dataId),c=this.readSync(t.dataId),l=this.readSync(n.dataId),h=new Float32Array(e.size),d=e.size,p=0;p<d;p++){for(var f=p%s,m=p-f+Math.max(0,f-r),g=p-f+Math.min(s,f+r+1),v=0,b=m;b<g;b++)v+=Math.pow(c[b],2);for(v=i*v+o,b=m;b<g;b++){var y=-2*i*a*c[b]*l[p]/v;p===b&&(y+=Math.pow(v,-a)),y*=u[p],h[b]+=y}}return Ln(h,e.shape)},u70.prototype.multinomial=function(e,t,n,r){Hh(e,"multinomial");for(var t=t?e:go(e),o=t.shape[0],i=t.shape[1],e=Gn([o,n],"int32"),a=this.readSync(e.dataId),s=this.readSync(t.dataId),u=0;u<o;++u){var c=u*i,l=new Float32Array(i-1);l[0]=s[c];for(var h=1;h<l.length;++h)l[h]=l[h-1]+s[c+h];for(var d=cr(r.toString()),p=u*n,f=0;f<n;++f){var m=d();a[p+f]=l.length;for(var g=0;g<l.length;g++)if(m<l[g]){a[p+f]=g;break}}}return e},u70.prototype.oneHot=function(e,t,n,r){Hh(e,"oneHot");var o=new Float32Array(e.size*t);o.fill(r);for(var i=this.readSync(e.dataId),a=0;a<e.size;++a)0<=i[a]&&i[a]<t&&(o[a*t+i[a]]=n);return Bn(o,[e.size,t],"int32")},u70.prototype.nonMaxSuppression=function(e,t,n,r,o){return Hh(e,"nonMaxSuppression"),jo(this.readSync(e.dataId),this.readSync(t.dataId),n,r,o)},u70.prototype.fft=function(e){return this.fftBatch(e,!1)},u70.prototype.ifft=function(e){return this.fftBatch(e,!0)},u70.prototype.fftBatch=function(e,t){for(var n=e.shape[0],r=e.shape[1],o=dr(e.shape,"float32"),i=dr(e.shape,"float32"),a=Tn(e).as2D(n,r),s=Nn(e).as2D(n,r),u=0;u<n;u++)for(var c=a.slice([u,0],[1,r]),l=s.slice([u,0],[1,r]),l=Dn(c,l),h=this.readSync(this.fftImpl(l,t).dataId),d=0;d<r;d++){var p=zo(h,d);o.values[u*r+d]=p.real,i.values[u*r+d]=p.imag}return Dn(o.toTensor(),i.toTensor()).as2D(n,r)},u70.prototype.fftImpl=function(e,t){var n=e.as1D(),r=n.size;if(this.isExponentOf2(r)){var o=this.fftRadix2(n,r,t).as2D(e.shape[0],e.shape[1]);return o=t?Dn(Tn(o).div(On(r)),Nn(o).div(On(r))):o}o=this.readSync(e.dataId),t=function(e){for(var t=new Float32Array(e.length/2),n=new Float32Array(e.length/2),r=0;r<e.length;r+=2)t[r/2]=e[r],n[r/2]=e[r+1];return{real:t,imag:n}}(this.fourierTransformByMatmul(o,r,t));return Dn(t.real,t.imag).as2D(e.shape[0],e.shape[1])},u70.prototype.isExponentOf2=function(e){return 0==(e&e-1)},u70.prototype.fftRadix2=function(e,t,n){if(1===t)return e;var r=this.readSync(e.dataId),o=t/2,e=function(e){for(var t=Math.ceil(e.length/4),n=new Float32Array(t),r=new Float32Array(t),o=0;o<e.length;o+=4)n[Math.floor(o/4)]=e[o],r[Math.floor(o/4)]=e[o+1];return{real:n,imag:r}}(r),e=Dn(e.real,e.imag).as1D(),r=function(e){for(var t=Math.floor(e.length/4),n=new Float32Array(t),r=new Float32Array(t),o=2;o<e.length;o+=4)n[Math.floor(o/4)]=e[o],r[Math.floor(o/4)]=e[o+1];return{real:n,imag:r}}(r),r=Dn(r.real,r.imag).as1D(),e=this.fftRadix2(e,o,n),r=this.fftRadix2(r,o,n),n=function(e,t){for(var n=new Float32Array(e/2),r=new Float32Array(e/2),o=0;o<Math.ceil(e/2);o++){var i=(t?2:-2)*Math.PI*(o/e);n[o]=Math.cos(i),r[o]=Math.sin(i)}return{real:n,imag:r}}(t,n),n=Dn(n.real,n.imag).mul(r),r=e.add(n),e=e.sub(n),n=Tn(r).concat(Tn(e)),e=Nn(r).concat(Nn(e));return Dn(n,e).as1D()},u70.prototype.fourierTransformByMatmul=function(e,t,n){for(var r=new Float32Array(2*t),o=0;o<t;o++){for(var i=0,a=0,s=0;s<t;s++){var u=Ho(o*s,t,n),c=zo(e,s);i+=c.real*u.real-c.imag*u.imag,a+=c.real*u.imag+c.imag*u.real}n&&(i/=t,a/=t),Go(r,i,a,o)}return r},u70.prototype.depthToSpace=function(e,t,n){C("NHWC"===n,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+n}),C(1<t,function(){return"blockSize should be > 1 for depthToSpace, but was: "+t});for(var r=e.shape[0],o=e.shape[1],i=e.shape[2],a=e.shape[3],s=o*t,u=i*t,c=a/(t*t),l=this.readSync(e.dataId),h=new Float32Array(r*s*u*c),d=0,p=0;p<r;++p)for(var f=0;f<s;++f)for(var m=Math.floor(f/t),g=f%t,v=0;v<u;++v)for(var b=Math.floor(v/t),y=(g*t+v%t)*c,x=0;x<c;++x)h[d++]=l[x+y+a*(b+i*(m+o*p))];return Ln(h,[r,s,u,c])},u70.prototype.broadcastedBinaryOp=function(i,a,e,s){var t=Ro(i.shape,a.shape),u=dr(t,e),c=this.readSync(i.dataId),l=this.readSync(a.dataId),h=Co(i.shape,t),d=Co(a.shape,t),p=u.values;if(h.length+d.length===0)for(var n=0;n<p.length;++n)p[n]=s(c[n%c.length],l[n%l.length]);else for(var f=this.bufferSync(i),m=this.bufferSync(a),n=0;n<p.length;++n)!function(e){var t=u.indexToLoc(e),n=t.slice(-i.rank);h.forEach(function(e){return n[e]=0});var r=f.locToIndex(n),o=t.slice(-a.rank);d.forEach(function(e){return o[e]=0});t=m.locToIndex(o);p[e]=s(c[r],l[t])}(n);return u.toTensor()},u70.prototype.broadcastedBinaryComplexOp=function(i,a,s){var e=Ro(i.shape,a.shape),u=dr(e,"float32"),t=dr(e,"float32"),c=this.readSync(i.dataId),l=this.readSync(a.dataId),h=Co(i.shape,e),d=Co(a.shape,e),p=u.values,f=t.values;if(h.length+d.length===0)for(var n=0;n<p.length;n++){var r=n%c.length,o=n%l.length,o=s(c[2*r],c[2*r+1],l[2*o],l[2*o+1]);p[n]=o.real,f[n]=o.imag}else for(var m=this.bufferSync(this.data.get(i.dataId).complexTensors.real),g=this.bufferSync(this.data.get(a.dataId).complexTensors.real),n=0;n<p.length;n++)!function(e){var t=u.indexToLoc(e),n=t.slice(-i.rank);h.forEach(function(e){return n[e]=0});var r=m.locToIndex(n),o=t.slice(-a.rank);d.forEach(function(e){return o[e]=0});t=g.locToIndex(o),t=s(c[2*r],c[2*r+1],l[2*t],l[2*t+1]);p[e]=t.real,f[e]=t.imag}(n);return this.complex(u.toTensor(),t.toTensor())},u70.prototype.split=function(e,t,n){return Zo(e,t,n)},u70.prototype.dispose=function(){},u70.prototype.floatPrecision=function(){return 32},u70.prototype.epsilon=function(){return 1e-7},u70.prototype.cropAndResize=function(e,t,n,r,o,i){for(var a=e.shape,s=a[0],u=a[1],c=a[2],l=a[3],h=t.shape[0],d=r[0],p=r[1],f=dr([h,d,p,l],"float32"),m=this.readSync(t.dataId),g=this.readSync(n.dataId),v=this.readSync(e.dataId),b=e.strides,y=f.strides,x=0;x<h;x++){var w=4*x,C=m[w],E=m[1+w],_=m[2+w],S=m[3+w],R=g[x];if(!(s<=R))for(var T=1<d?(_-C)*(u-1)/(d-1):0,A=1<p?(S-E)*(c-1)/(p-1):0,k=0;k<d;k++){var N,I=1<d?C*(u-1)+k*T:.5*(C+_)*(u-1);if(I<0||u-1<I)for(var O=0;O<p;O++)for(var D=0;D<l;D++){var M=D+O*y[2]+k*y[1]+x*y[0];f.values[M]=i}else if("bilinear"===o)for(var P=Math.floor(I),F=Math.ceil(I),L=I-P,O=0;O<p;O++)if((N=1<p?E*(c-1)+O*A:.5*(E+S)*(c-1))<0||c-1<N)for(D=0;D<l;D++)M=D+O*y[2]+k*y[1]+x*y[0],f.values[M]=i;else for(var B=Math.floor(N),W=Math.ceil(N),H=N-B,D=0;D<l;D++){var V=v[M=D+B*b[2]+P*b[1]+R*b[0]],U=v[M=D+W*b[2]+P*b[1]+R*b[0]],z=v[M=D+B*b[2]+F*b[1]+R*b[0]],V=V+(U-V)*H,z=z+(v[M=D+W*b[2]+F*b[1]+R*b[0]]-z)*H,M=D+O*y[2]+k*y[1]+x*y[0];f.values[M]=V+(z-V)*L}else for(O=0;O<p;++O)if((N=1<p?E*(c-1)+O*A:.5*(E+S)*(c-1))<0||c-1<N)for(D=0;D<l;D++)M=D+O*y[2]+k*y[1]+x*y[0],f.values[M]=i;else{var G=Math.round(N),$=Math.round(I);for(D=0;D<l;D++){var j=D+G*b[2]+$*b[1]+R*b[0],q=D+O*y[2]+k*y[1]+x*y[0];f.values[q]=v[j]}}}}return f.toTensor()},u70.prototype.sparseToDense=function(e,t,n,r){var o=Zr(0,e,n),i=o.sliceRank,a=o.numUpdates,s=o.sliceSize,u=o.strides,o=o.outputSize;return this.scatter(e,t,n,o,s,a,i,u,r,!1)},u70.prototype.gatherND=function(e,t){var n=t.shape,r=n[n.length-1],o=jr(e,t),n=o[0],i=o[1],a=o[2],s=o[3];if(0===i)return Fn([],n,e.dtype);for(var u=new gt([i,a],e.dtype),c=this.readSync(t.dataId),l=this.readSync(e.dataId),h=0;h<i;h++){for(var d=[],p=0,f=0;f<r;f++){var m=c[h*r+f];p+=m*s[f],d.push(m)}if(p<0||p>=e.size/a)throw new Error("Invalid indices: "+d+" does not index into "+e.shape);for(var g=0;g<a;g++)u.values[h*a+g]=l[p*a+g]}return u.toTensor().reshape(n)},u70.prototype.scatterND=function(e,t,n){var r=Zr(0,e,n),o=r.sliceRank,i=r.numUpdates,a=r.sliceSize,s=r.strides,u=r.outputSize,r=On(0);return this.scatter(e,t,n,u,a,i,o,s,r,!0)},u70.prototype.fill=function(e,t,n){var r=P(n=n||j(t),k(e));return r.fill(t),Lt.makeTensor(r,e,n,this)},u70.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(e.shape,1,e.dtype)},u70.prototype.zerosLike=function(e){var t=P(e.dtype,k(e.shape));return this.makeOutput(t,e.shape,e.dtype)},u70.prototype.linspace=function(e,t,n){return Wo(e,t,n)},u70.prototype.scatter=function(e,t,n,r,o,i,a,s,u,c){var l=[r/o,o],h=this.readSync(e.dataId),d=this.readSync(t.dataId);if(0===r)return Fn([],n,t.dtype);var p=new gt(l,t.dtype);p.values.fill(this.readSync(u.dataId)[0]);for(var f=0;f<i;f++){for(var m=[],g=0,v=0;v<a;v++){var b=h[f*a+v];m.push(b),g+=b*s[v]}if(g<0||r/o<=g)throw new Error("Invalid indices: "+m+" does not index into "+n);for(var y=0;y<o;y++)c?p.values[g*o+y]+=d[f*o+y]:p.values[g*o+y]=0===t.rank?d[0]:d[f*o+y]}return p.toTensor().reshape(n)},u70),t70;function u70(){var e=t70.call(this)||this;return e.blockSize=48,e.firstUse=!0,e.data=new xo(e,Lt),e}Lt.registerBackend("cpu",function(){return new Kh},1);for(var jh=0,Xh=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(e){var t=e.inputs,n=e.backend,r=e.attrs,o=t.boxes,i=t.scores,a=r.maxOutputSize,e=r.iouThreshold,t=r.scoreThreshold,r=r.softNmsSigma,n=n;Hh(o,"NonMaxSuppressionWithScore");r=Xo(n.data.get(o.dataId).values,n.data.get(i.dataId).values,a,e,t,r);return[r.selectedIndices,r.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(e){var t=e.inputs,e=e.backend,t=t.x,e=e;Hh(t,"square");for(var n=e.data.get(t.dataId).values,r=new Float32Array(n.length),o=0;o<n.length;++o){var i=n[o];r[o]=i*i}return{dataId:e.write(r,t.shape,t.dtype),shape:t.shape,dtype:t.dtype}}},{kernelName:eu,backendName:"cpu",kernelFunc:function(e){var t=e.inputs,n=e.backend,r=t.a,o=t.b,e=n;Hh([r,o],eu);t=e.data.get(r.dataId).values,n=e.data.get(o.dataId).values,t=function(e,t,i,a,n,s){var r=Ro(e,t),u=r.length,c=$(r),l=B(n,k(r)),h=e.length,d=t.length,p=$(e),f=$(t),m=Co(e,r),g=Co(t,r);if(m.length+g.length===0)for(var o=0;o<l.length;++o)l[o]=s(i[o%i.length],a[o%a.length]);else for(o=0;o<l.length;++o)!function(e){var t=it(e,u,c),n=t.slice(-h);m.forEach(function(e){return n[e]=0});var r=at(n,h,p),o=t.slice(-d);g.forEach(function(e){return o[e]=0});t=at(o,d,f);l[e]=s(i[r],a[t])}(o);return[l,r]}(r.shape,o.shape,t,n,r.dtype,function(e,t){t=e-t;return t*t}),n=t[0],t=t[1];return{dataId:e.write(n,t,r.dtype),shape:t,dtype:r.dtype}}}];jh<Xh.length;jh++)d(Xh[jh]);for(var Yh,$h=function(e){this.variableNames=["A"];var t=ua(),n=e[0],r=e[1];this.outputShape=e,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+r+".0, "+n+".0);\n\n        vec4 values = "+t.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},Qh=function(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var t=ua(),n=e[0],r=e[1];this.outputShape=e,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+r+".0, "+n+".0);\n            vec4 values = "+t.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+t.output+" = result;\n      }\n    "},Jh=0,Zh=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(e){var t=e.inputs,n=e.backend,r=e.attrs,o=t.pixels,a=r.numChannels,s="undefined"!=typeof HTMLVideoElement&&o instanceof HTMLVideoElement,u="undefined"!=typeof HTMLImageElement&&o instanceof HTMLImageElement,e=s?[o.videoWidth,o.videoHeight]:[o.width,o.height],t=e[0],r=e[1],e=[r,t],a=[r,t,a];(u||s)&&((Yh=null==Yh?document.createElement("canvas").getContext("2d"):Yh).canvas.width=t,Yh.canvas.height=r,Yh.drawImage(o,0,0,t,r),o=Yh.canvas);e=n.makeTensorInfo(e,"int32");n.texData.get(e.dataId).usage=zt.PIXELS,n.gpgpu.uploadPixelDataToTexture(n.getTexture(e.dataId),o);a=new(i().getBool("WEBGL_PACK")?Qh:$h)(a),a=n.runWebGLProgram(a,[e],"int32");return n.disposeData(e.dataId),a}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(e){var t=e.inputs,n=e.backend,r=e.attrs;dn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var o=t.boxes,i=t.scores,a=r.maxOutputSize,e=r.iouThreshold,t=r.scoreThreshold,r=r.softNmsSigma,n=n,r=Xo(n.readSync(o.dataId),n.readSync(i.dataId),a,e,t,r);return[r.selectedIndices,r.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(e){var t=e.inputs,n=e.backend,e=t.x,t=n,n=new Cs(e.shape,"return x * x;");return t.runWebGLProgram(n,[e],e.dtype)}},{kernelName:eu,backendName:"webgl",kernelFunc:function(e){var t=e.inputs,n=e.backend,r=t.a,e=t.b,t=n,n=new(i().getBool("WEBGL_PACK_BINARY_OPERATIONS")?La:Ba)("return (a - b) * (a - b);",r.shape,e.shape);return t.compileAndRun(n,[r,e])}}];Jh<Zh.length;Jh++)d(Zh[Jh]);for(var tf=0,ef=[{kernelName:"Square",gradFunc:function(e,t){var n=t[0];return{x:function(){return e.mul(n.toFloat().mul(2))}}}},{kernelName:eu,gradFunc:function(e,t){var n=t[0],r=t[1],o=On(2);return{a:function(){return gc(e,gc(o,Cc(n,r)))},b:function(){return gc(e,gc(o,Cc(r,n)))}}}}];tf<ef.length;tf++)p(ef[tf]);var nf=(EQ0.prototype.fetch=function(e,t){return fetch(e,t)},EQ0.prototype.now=function(){return performance.now()},EQ0.prototype.encode=function(e,t){if("utf-8"!==t&&"utf8"!==t)throw new Error("Browser's encoder only supports utf-8, but got "+t);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(e)},EQ0.prototype.decode=function(e,t){return new TextDecoder(t).decode(e)},EQ0);function EQ0(){}i().get("IS_BROWSER")&&i().setPlatform("browser",new nf);var rf,of=function(){return require("node-fetch")},af=(LQ0.prototype.fetch=function(e,t){return null!=i().global.fetch?i().global.fetch(e,t):(rf=null==rf?of():rf)(e,t)},LQ0.prototype.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6},LQ0.prototype.encode=function(e,t){if("utf-8"!==t&&"utf8"!==t)throw new Error("Node built-in encoder only supports utf-8, but got "+t);return this.textEncoder.encode(e)},LQ0.prototype.decode=function(e,t){return 0===e.length?"":new this.util.TextDecoder(t).decode(e)},LQ0);function LQ0(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}i().get("IS_NODE")&&i().setPlatform("node",new af);var sf={float32:4,int32:4,uint16:2,uint8:1,bool:1},uf=4;function cf(f,e){for(var m={},g=0,t=0,n=e;t<n.length;t++)!function(e){var t=e.name,n=e.dtype,r=e.shape,o=k(r),i=void 0;if("quantization"in e){var a=e.quantization;if("uint8"!==a.dtype&&"uint16"!==a.dtype)throw new Error("Weight "+e.name+" has unknown quantization dtype "+a.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var s=sf[a.dtype],u=f.slice(g,g+o*s),c=new("uint8"===a.dtype?Uint8Array:Uint16Array)(u);if("float32"===n)i=Float32Array.from(c,function(e){return e*a.scale+a.min});else{if("int32"!==n)throw new Error("Unsupported dtype in weight '"+t+"': "+n);i=Int32Array.from(c,function(e){return Math.round(e*a.scale+a.min)})}g+=o*s}else if("string"===n)for(var l=k(e.shape),i=[],h=0;h<l;h++){var d=new Uint32Array(f.slice(g,g+uf))[0];g+=uf;var p=new Uint8Array(f.slice(g,g+d));i.push(p),g+=d}else{e=sf[n],u=f.slice(g,g+o*e);if("float32"===n)i=new Float32Array(u);else if("int32"===n)i=new Int32Array(u);else{if("bool"!==n)throw new Error("Unsupported dtype in weight '"+t+"': "+n);i=new Uint8Array(u)}g+=o*e}m[t]=Fn(i,r,n)}(n[t]);return m}function lf(e){if(null===e)throw new Error("Invalid input value: "+JSON.stringify(e));var t=0,n=[];e.forEach(function(e){if(t+=e.byteLength,n.push(e.byteLength===e.buffer.byteLength?e:new e.constructor(e)),!(e instanceof Float32Array||e instanceof Int32Array||e instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+e.constructor.name)});var r=new Uint8Array(t),o=0;return n.forEach(function(e){r.set(new Uint8Array(e.buffer),o),o+=e.byteLength}),r.buffer}var hf="undefined"!=typeof Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function ff(e){return hf?Buffer.byteLength(e):new Blob([e]).size}function df(e){var t=0;e.forEach(function(e){t+=e.byteLength});var n=new Uint8Array(t),r=0;return e.forEach(function(e){n.set(new Uint8Array(e),r),r+=e.byteLength}),n.buffer}function pf(e){for(e=e.trim();e.endsWith("/");)e=e.slice(0,e.length-1);var t=e.split("/");return t[t.length-1]}function vf(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==e.modelTopology?0:ff(JSON.stringify(e.modelTopology)),weightSpecsBytes:null==e.weightSpecs?0:ff(JSON.stringify(e.weightSpecs)),weightDataBytes:null==e.weightData?0:e.weightData.byteLength}}var mf=(GR0.getInstance=function(){return GR0.instance=null==GR0.instance?new GR0:GR0.instance},GR0.registerSaveRouter=function(e){GR0.getInstance().saveRouters.push(e)},GR0.registerLoadRouter=function(e){GR0.getInstance().loadRouters.push(e)},GR0.getSaveHandlers=function(e){return GR0.getHandlers(e,"save")},GR0.getLoadHandlers=function(e,t){return GR0.getHandlers(e,"load",t)},GR0.getHandlers=function(t,e,n){var r=[];return("load"===e?GR0.getInstance().loadRouters:GR0.getInstance().saveRouters).forEach(function(e){e=e(t,n);null!==e&&r.push(e)}),r},GR0),gf="://",yf=(SR0.getInstance=function(){return SR0.instance=null==SR0.instance?new SR0:SR0.instance},SR0.registerManager=function(e,t){C(null!=e,function(){return"scheme must not be undefined or null."}),C(0<(e=e.endsWith(gf)?e.slice(0,e.indexOf(gf)):e).length,function(){return"scheme must not be an empty string."});var n=SR0.getInstance();C(null==n.managers[e],function(){return"A model store manager is already registered for scheme '"+e+"'."}),n.managers[e]=t},SR0.getManager=function(e){var t=this.getInstance().managers[e];if(null==t)throw new Error("Cannot find model manager for scheme '"+e+"'");return t},SR0.getSchemes=function(){return Object.keys(this.getInstance().managers)},SR0);function SR0(){this.managers={}}function GR0(){this.saveRouters=[],this.loadRouters=[]}function xf(e){if(-1===e.indexOf(gf))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+yf.getSchemes().join(","));return{scheme:e.split(gf)[0],path:e.split(gf)[1]}}function bf(l,h,d){return void 0===d&&(d=!1),n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c;return r(this,function(e){switch(e.label){case 0:return C(l!==h,function(){return"Old path and new path are the same: '"+l+"'"}),C(0<(t=mf.getLoadHandlers(l)).length,function(){return"Copying failed because no load handler is found for source URL "+l+"."}),C(t.length<2,function(){return"Copying failed because more than one ("+t.length+") load handlers for source URL "+l+"."}),n=t[0],C(0<(s=mf.getSaveHandlers(h)).length,function(){return"Copying failed because no save handler is found for destination URL "+h+"."}),C(s.length<2,function(){return"Copying failed because more than one ("+t.length+") save handlers for destination URL "+h+"."}),o=s[0],i=xf(l).scheme,a=xf(l).path,s=i===xf(l).scheme,[4,n.load()];case 1:return u=e.sent(),d&&s?[4,yf.getManager(i).removeModel(a)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[4,o.save(u)];case 4:return c=e.sent(),!d||s?[3,6]:[4,yf.getManager(i).removeModel(a)];case 5:e.sent(),e.label=6;case 6:return[2,c.modelArtifactsInfo]}})})}var wf="models_store",Cf="model_info_store";function Ef(){if(!i().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var e=window||self,e=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB||e.shimIndexedDB;if(null==e)throw new Error("The current browser does not appear to support IndexedDB.");return e}function Rf(e){e=e.result;e.createObjectStore(wf,{keyPath:"modelPath"}),e.createObjectStore(Cf,{keyPath:"modelPath"})}var If=(oS0.prototype.save=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,t)]})})},oS0.prototype.load=function(){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,this.databaseAction(this.modelPath)]})})},oS0.prototype.databaseAction=function(e,h){var d=this;return new Promise(function(u,c){var l=d.indexedDB.open("tensorflowjs",1);l.onupgradeneeded=function(){return Rf(l)},l.onsuccess=function(){var e,t,r,o,i,a,n,s=l.result;null==h?(e=s.transaction(wf,"readonly"),(t=e.objectStore(wf).get(d.modelPath)).onsuccess=function(){if(null==t.result)return s.close(),c(new Error("Cannot find model with path '"+d.modelPath+"' in IndexedDB."));u(t.result.modelArtifacts)},t.onerror=function(e){return s.close(),c(t.error)},e.oncomplete=function(){return s.close()}):(o=vf(h),i=s.transaction(Cf,"readwrite"),a=i.objectStore(Cf),(n=a.put({modelPath:d.modelPath,modelArtifactsInfo:o})).onsuccess=function(){var n=(r=s.transaction(wf,"readwrite")).objectStore(wf).put({modelPath:d.modelPath,modelArtifacts:h,modelArtifactsInfo:o});n.onsuccess=function(){return u({modelArtifactsInfo:o})},n.onerror=function(e){var t=(a=i.objectStore(Cf)).delete(d.modelPath);t.onsuccess=function(){return s.close(),c(n.error)},t.onerror=function(e){return s.close(),c(n.error)}}},n.onerror=function(e){return s.close(),c(n.error)},i.oncomplete=function(){null==r?s.close():r.oncomplete=function(){return s.close()}})},l.onerror=function(e){return c(l.error)}})},oS0.URL_SCHEME="indexeddb://",oS0),kf=function(e){return i().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(If.URL_SCHEME)?(e=e.slice(If.URL_SCHEME.length),new If(e)):null};function oS0(e){if(this.indexedDB=Ef(),null==e||!e)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=e}mf.registerSaveRouter(kf),mf.registerLoadRouter(kf);var Sf=(QS0.prototype.listModels=function(){return n(this,void 0,void 0,function(){var t=this;return r(this,function(e){return[2,new Promise(function(i,n){var r=t.indexedDB.open("tensorflowjs",1);r.onupgradeneeded=function(){return Rf(r)},r.onsuccess=function(){var t=r.result,e=t.transaction(Cf,"readonly"),o=e.objectStore(Cf).getAll();o.onsuccess=function(){for(var e={},t=0,n=o.result;t<n.length;t++){var r=n[t];e[r.modelPath]=r.modelArtifactsInfo}i(e)},o.onerror=function(e){return t.close(),n(o.error)},e.oncomplete=function(){return t.close()}},r.onerror=function(e){return n(r.error)}})]})})},QS0.prototype.removeModel=function(u){return n(this,void 0,void 0,function(){var n=this;return r(this,function(e){var t;return u=(t=u).startsWith(If.URL_SCHEME)?t.slice(If.URL_SCHEME.length):t,[2,new Promise(function(a,s){var t=n.indexedDB.open("tensorflowjs",1);t.onupgradeneeded=function(){return Rf(t)},t.onsuccess=function(){var n,r=t.result,e=r.transaction(Cf,"readwrite"),o=e.objectStore(Cf),i=o.get(u);i.onsuccess=function(){if(null==i.result)return r.close(),s(new Error("Cannot find model with path '"+u+"' in IndexedDB."));function t(){var e=(n=r.transaction(wf,"readwrite")).objectStore(wf).delete(u);e.onsuccess=function(){return a(i.result.modelArtifactsInfo)},e.onerror=function(e){return s(i.error)}}var e=o.delete(u);e.onsuccess=t,e.onerror=function(e){return t(),r.close(),s(i.error)}},i.onerror=function(e){return r.close(),s(i.error)},e.oncomplete=function(){null==n?r.close():n.oncomplete=function(){return r.close()}}},t.onerror=function(e){return s(t.error)}})]})})},QS0);function QS0(){this.indexedDB=Ef()}if(i().getBool("IS_BROWSER"))try{yf.registerManager(If.URL_SCHEME,new Sf)}catch(t){}var Af="/",Df="tensorflowjs_models",Tf="info",Nf="model_topology",Ff="weight_specs",_f="weight_data",Of="model_metadata";function Mf(e){return{info:[Df,e,Tf].join(Af),topology:[Df,e,Nf].join(Af),weightSpecs:[Df,e,Ff].join(Af),weightData:[Df,e,_f].join(Af),modelMetadata:[Df,e,Of].join(Af)}}function Bf(e){var t=e.split(Af);if(t.length<3)throw new Error("Invalid key format: "+e);return t.slice(1,t.length-1).join(Af)}var Pf=(zT0.prototype.save=function(i){return n(this,void 0,void 0,function(){var t,n,o;return r(this,function(e){if(i.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");t=JSON.stringify(i.modelTopology),n=JSON.stringify(i.weightSpecs),o=vf(i);try{return this.LS.setItem(this.keys.info,JSON.stringify(o)),this.LS.setItem(this.keys.topology,t),this.LS.setItem(this.keys.weightSpecs,n),this.LS.setItem(this.keys.weightData,function(e){if(hf)return Buffer.from(e).toString("base64");for(var t=new Uint8Array(e),n="",r=0,o=t.length;r<o;r++)n+=String.fromCharCode(t[r]);return btoa(n)}(i.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:i.format,generatedBy:i.generatedBy,convertedBy:i.convertedBy,userDefinedMetadata:i.userDefinedMetadata})),[2,{modelArtifactsInfo:o}]}catch(e){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+o.modelTopologyBytes+", weightSpecsBytes="+o.weightSpecsBytes+", weightDataBytes="+o.weightDataBytes+".")}return[2]})})},zT0.prototype.load=function(){return n(this,void 0,void 0,function(){var t,n,o;return r(this,function(e){if(null==(n=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==n.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(t={},null==(n=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(t.modelTopology=n,null==(n=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(t.weightSpecs=n,null!=(n=this.LS.getItem(this.keys.modelMetadata))&&(o=JSON.parse(n),t.format=o.format,t.generatedBy=o.generatedBy,t.convertedBy=o.convertedBy,t.userDefinedMetadata=o.userDefinedMetadata),null==(o=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return t.weightData=function(e){if(hf){var t=Buffer.from(e,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}for(var n=atob(e),r=new Uint8Array(n.length),o=0;o<n.length;++o)r.set([n.charCodeAt(o)],o);return r.buffer}(o),[2,t]})})},zT0.URL_SCHEME="localstorage://",zT0),Lf=function(e){return i().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Pf.URL_SCHEME)?(e=e.slice(Pf.URL_SCHEME.length),new Pf(e)):null};function zT0(e){if(!i().getBool("IS_BROWSER")||"undefined"==typeof window||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==e||!e)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=e,this.keys=Mf(this.modelPath)}mf.registerSaveRouter(Lf),mf.registerLoadRouter(Lf);var Wf=(_T0.prototype.listModels=function(){return n(this,void 0,void 0,function(){var t,n,o,i,a,s;return r(this,function(e){for(t={},n=Df+Af,o=Af+Tf,i=0;i<this.LS.length;++i)(a=this.LS.key(i)).startsWith(n)&&a.endsWith(o)&&(s=Bf(a),t[s]=JSON.parse(this.LS.getItem(a)));return[2,t]})})},_T0.prototype.removeModel=function(i){return n(this,void 0,void 0,function(){var n,o;return r(this,function(e){var t;if(i=(t=i).startsWith(Pf.URL_SCHEME)?t.slice(Pf.URL_SCHEME.length):t,n=Mf(i),null==this.LS.getItem(n.info))throw new Error("Cannot find model at path '"+i+"'");return o=JSON.parse(this.LS.getItem(n.info)),this.LS.removeItem(n.info),this.LS.removeItem(n.topology),this.LS.removeItem(n.weightSpecs),this.LS.removeItem(n.weightData),[2,o]})})},_T0);function _T0(){C(i().getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),C("undefined"==typeof window||void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}if(i().getBool("IS_BROWSER"))try{yf.registerManager(Pf.URL_SCHEME,new Wf)}catch(t){}var Uf="model",Vf=".json",zf=".weights.bin";function Gf(e){return new Promise(function(e){return setTimeout(e)}).then(e)}var Hf=(oU0.prototype.save=function(a){return n(this,void 0,void 0,function(){var t,n,o,i;return r(this,function(e){switch(e.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(t=window.URL.createObjectURL(new Blob([a.weightData],{type:"application/octet-stream"})),!(a.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return n=[{paths:["./"+this.weightDataFileName],weights:a.weightSpecs}],n={modelTopology:a.modelTopology,format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,weightsManifest:n},n=window.URL.createObjectURL(new Blob([JSON.stringify(n)],{type:"application/json"})),(o=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,o.href=n,[4,Gf(function(){return o.dispatchEvent(new MouseEvent("click"))})];case 2:return e.sent(),null==a.weightData?[3,4]:((i=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,i.href=t,[4,Gf(function(){return i.dispatchEvent(new MouseEvent("click"))})]);case 3:e.sent(),e.label=4;case 4:return[2,{modelArtifactsInfo:vf(a)}]}})})},oU0.URL_SCHEME="downloads://",oU0),qf=(yU0.prototype.load=function(){return n(this,void 0,void 0,function(){var n,l,h=this;return r(this,function(e){return n=this.files[0],l=this.files.slice(1),[2,new Promise(function(u,c){var e=new FileReader;e.onload=function(e){var r=JSON.parse(e.target.result),o=r.modelTopology;if(null!=o){0===l.length&&u({modelTopology:o});var t,e=r.weightsManifest;if(null!=e){try{t=h.checkManifestAndWeightFiles(e,l)}catch(e){return void c(e)}var i=[],a=[],s=[];e.forEach(function(e){e.paths.forEach(function(e){a.push(e),s.push(null)}),i.push.apply(i,e.weights)}),e.forEach(function(e){e.paths.forEach(function(n){var e=new FileReader;e.onload=function(e){var t=e.target.result,e=a.indexOf(n);s[e]=t,-1===s.indexOf(null)&&u({modelTopology:o,weightSpecs:i,weightData:df(s),format:r.format,generatedBy:r.generatedBy,convertedBy:r.convertedBy,userDefinedMetadata:r.userDefinedMetadata})},e.onerror=function(e){return c("Failed to weights data from file of path '"+n+"'.")},e.readAsArrayBuffer(t[n])})})}else c(new Error("weightManifest field is missing from file "+n.name))}else c(new Error("modelTopology field is missing from file "+n.name))},e.onerror=function(e){return c("Failed to read model topology and weights manifest JSON from file '"+n.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},e.readAsText(n)})]})})},yU0.prototype.checkManifestAndWeightFiles=function(e,n){for(var r=[],o=n.map(function(e){return pf(e.name)}),i={},t=0,a=e;t<a.length;t++)a[t].paths.forEach(function(e){var t=pf(e);if(-1!==r.indexOf(t))throw new Error("Duplicate file basename found in weights manifest: '"+t+"'");if(r.push(t),-1===o.indexOf(t))throw new Error("Weight file with basename '"+t+"' is not provided.");i[e]=n[o.indexOf(t)]});if(r.length!==n.length)throw new Error("Mismatch in the number of files in weights manifest ("+r.length+") and the number of weight files provided ("+n.length+").");return i},yU0);function yU0(e){if(null==e||e.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+e);this.files=e}function oU0(e){if(!i().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");null!=(e=e.startsWith(oU0.URL_SCHEME)?e.slice(oU0.URL_SCHEME.length):e)&&0!==e.length||(e=Uf),this.modelTopologyFileName=e+Vf,this.weightDataFileName=e+zf}function Kf(n,r,o,i){var e,t,a;C(null!=(a=n)&&Array.isArray(a)&&0<a.length,function(){return"promises must be a none empty array"}),e=o=null==o?0:o,t=i=null==i?1:i,C(0<=e&&e<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+e}),C(0<=t&&t<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+t}),C(e<=t,function(){return"startFraction must be no more than endFraction, but got startFraction "+e+" and endFraction "+t});var s=0;return Promise.all(n.map(function(e){return e.then(function(e){var t=o+ ++s/n.length*(i-o);return r(t),e}),e}))}function jf(d,p){return n(this,void 0,void 0,function(){var t,n,o,a,s,u,c,l,h;return r(this,function(e){switch(e.label){case 0:return t=null==(p=null==p?{}:p).fetchFunc?i().platform.fetch:p.fetchFunc,n=d.map(function(e){return t(e,p.requestInit,{isBinary:!0})}),o=0,a=.5,null!=p.onProgress?[3,2]:[4,Promise.all(n)];case 1:return s=e.sent(),[3,4];case 2:return[4,Kf(n,p.onProgress,o,a)];case 3:s=e.sent(),e.label=4;case 4:return u=s.map(function(e){return e.arrayBuffer()}),c=.5,l=1,null!=p.onProgress?[3,6]:[4,Promise.all(u)];case 5:return h=e.sent(),[3,8];case 6:return[4,Kf(u,p.onProgress,c,l)];case 7:h=e.sent(),e.label=8;case 8:return[2,h]}})})}function Xf(i){var e=this;return function(p,o,f){return void 0===o&&(o=""),n(e,void 0,void 0,function(){var a,c,s,u,t,n,l,h,d;return r(this,function(e){switch(e.label){case 0:if(a=p.map(function(){return!1}),c={},s=null!=f?f.map(function(){return!1}):[],u=[],p.forEach(function(e,o){var i=0;e.weights.forEach(function(n){function r(){a[o]=!0,null==c[o]&&(c[o]=[]),c[o].push({manifestEntry:n,groupOffset:i,sizeBytes:t})}var e=("quantization"in n?n.quantization:n).dtype,t=sf[e]*k(n.shape);null!=f?f.forEach(function(e,t){e===n.name&&(r(),s[t]=!0)}):r(),u.push(n.name),i+=t})}),!s.every(function(e){return e}))throw t=f.filter(function(e,t){return!s[t]}),new Error("Could not find weights in manifest with names: "+t.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return t=a.reduce(function(e,t,n){return t&&e.push(n),e},[]),n=[],t.forEach(function(e){p[e].paths.forEach(function(e){e=o+(o.endsWith("/")?"":"/")+e;n.push(e)})}),[4,i(n)];case 1:return l=e.sent(),h={},d=0,t.forEach(function(e){for(var t=p[e].paths.length,n=0,r=0;r<t;r++)n+=l[d+r].byteLength;for(var o=new ArrayBuffer(n),i=new Uint8Array(o),a=0,s=0;s<t;s++){var u=new Uint8Array(l[d+s]);i.set(u,a),a+=u.byteLength}c[e].forEach(function(e){var t,n=cf(o.slice(e.groupOffset,e.groupOffset+e.sizeBytes),[e.manifestEntry]);for(t in n)h[t]=n[t]}),d+=t}),[2,h]}})})}}mf.registerSaveRouter(function(e){return i().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Hf.URL_SCHEME)?(e=e.slice(Hf.URL_SCHEME.length),new Hf(e=void 0===e?"model":e)):null});var Yf=(BW0.prototype.save=function(o){return n(this,void 0,void 0,function(){var t,n;return r(this,function(e){switch(e.label){case 0:if(o.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(n=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,t=[{paths:["./model.weights.bin"],weights:o.weightSpecs}],t={modelTopology:o.modelTopology,format:o.format,generatedBy:o.generatedBy,convertedBy:o.convertedBy,userDefinedMetadata:o.userDefinedMetadata,weightsManifest:t},n.body.append("model.json",new Blob([JSON.stringify(t)],{type:"application/json"}),"model.json"),null!=o.weightData&&n.body.append("model.weights.bin",new Blob([o.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,n)];case 1:if((n=e.sent()).ok)return[2,{modelArtifactsInfo:vf(o),responses:[n]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+n.status+".")}})})},BW0.prototype.load=function(){return n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c,l,h;return r(this,function(e){switch(e.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(t=e.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+t.status+". Please verify this URL points to the model JSON of the model to load.");e.label=2;case 2:return e.trys.push([2,4,,5]),[4,t.json()];case 3:return n=e.sent(),[3,5];case 4:throw e.sent(),i="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?i+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":i+=" Please make sure the server is serving valid JSON for this request.",new Error(i);case 5:if(o=n.modelTopology,i=n.weightsManifest,a=n.generatedBy,s=n.convertedBy,u=n.format,c=n.userDefinedMetadata,null==o&&null==i)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==i?[3,7]:[4,this.loadWeights(i)];case 6:h=e.sent(),l=h[0],h=h[1],e.label=7;case 7:return[2,{modelTopology:o,weightSpecs:l,weightData:h,userDefinedMetadata:c,generatedBy:a,convertedBy:s,format:u}]}})})},BW0.prototype.loadWeights=function(p){return n(this,void 0,void 0,function(){var o,i,a,s,u,c,l,h,d;return r(this,function(e){switch(e.label){case 0:for(d=Array.isArray(this.path)?this.path[1]:this.path,n=(t=d).lastIndexOf("/"),r=t.lastIndexOf("?"),o=[t.substring(0,n)+"/",n<r?t.substring(r):""],d=o[0],i=o[1],a=this.weightPathPrefix||d,s=[],u=0,c=p;u<c.length;u++)l=c[u],s.push.apply(s,l.weights);return h=[],p.forEach(function(e){e.paths.forEach(function(e){h.push(a+e+i)})}),[4,jf(h,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return d=e.sent(),[2,[s,df(d)]]}var t,n,r})})},BW0.URL_SCHEME_REGEX=/^https?:\/\//,BW0);function BW0(e,t){if(this.DEFAULT_METHOD="POST",this.weightPathPrefix=(t=null==t?{}:t).weightPathPrefix,this.onProgress=t.onProgress,null!=t.fetchFunc?(C("function"==typeof t.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=t.fetchFunc):this.fetch=i().platform.fetch,C(null!=e&&0<e.length,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(e)&&C(2===e.length,function(){return"URL paths for http must have a length of 2, (actual length is "+e.length+")."}),this.path=e,null!=t.requestInit&&null!=t.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=t.requestInit||{}}function $f(e){return null!=e.match(Yf.URL_SCHEME_REGEX)}var Qf=function(e,t){return"undefined"!=typeof fetch&&(Array.isArray(e)?e.every(function(e){return $f(e)}):$f(e))?Jf(e,{onProgress:t}):null};function Jf(e,t){return new Yf(e,t)}mf.registerSaveRouter(Qf),mf.registerLoadRouter(Qf);var Zf=(vX0.prototype.load=function(){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,this.modelArtifacts]})})},vX0),td=(yX0.prototype.save=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,this.saveHandler(t)]})})},yX0);function yX0(e){this.saveHandler=e}function vX0(e){this.modelArtifacts=e}var ed=Object.freeze({browserFiles:function(e){return new qf(e)},browserHTTPRequest:function(e,t){return Jf(e,t)},concatenateArrayBuffers:df,decodeWeights:cf,encodeWeights:function(c,h){return n(this,void 0,void 0,function(){var o,i,a,t,s,u=this;return r(this,function(e){switch(e.label){case 0:for(o=[],i=[],a=Array.isArray(c)?c.map(function(e){return e.name}):Object.keys(c),t=function(e){var t=a[e],l=Array.isArray(c)?c[e].tensor:c[t];if("float32"!==l.dtype&&"int32"!==l.dtype&&"bool"!==l.dtype&&"string"!==l.dtype)throw new Error("Unsupported dtype in weight '"+t+"': "+l.dtype);e={name:t,shape:l.shape,dtype:l.dtype};"string"===l.dtype?(t=new Promise(function(c){return n(u,void 0,void 0,function(){var t,n,o,i,a,s,u;return r(this,function(e){switch(e.label){case 0:return[4,l.bytes()];case 1:for(t=e.sent(),n=t.reduce(function(e,t){return e+t.length},0)+uf*t.length,o=new Uint8Array(n),a=i=0;a<t.length;a++)s=t[a],u=new Uint8Array(new Uint32Array([s.length]).buffer),o.set(u,i),i+=uf,o.set(s,i),i+=s.length;return c(o),[2]}})})}),i.push(t)):i.push(l.data()),null!=h&&(e.group=h),o.push(e)},s=0;s<a.length;++s)t(s);return[4,Promise.all(i)];case 1:return[2,{data:lf(e.sent()),specs:o}]}})})},fromMemory:function(e,t,n,r){return 1===arguments.length?null!=e.modelTopology||null!=e.weightSpecs?new Zf(e):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new Zf({modelTopology:e})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new Zf({modelTopology:e,weightSpecs:t,weightData:n,trainingConfig:r}))},getLoadHandlers:function(e,t){return mf.getLoadHandlers(e,t)},getModelArtifactsInfoForJSON:vf,getSaveHandlers:function(e){return mf.getSaveHandlers(e)},http:Jf,isHTTPScheme:$f,loadWeights:function(t,o,i,a){return void 0===o&&(o=""),n(this,void 0,void 0,function(){return r(this,function(e){return[2,Xf(function(e){return jf(e,{requestInit:a})})(t,o,i)]})})},registerLoadRouter:function(e){return mf.registerLoadRouter(e)},registerSaveRouter:function(e){return mf.registerSaveRouter(e)},weightsLoaderFactory:Xf,withSaveHandler:function(e){return new td(e)},copyModel:function(t,o){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,bf(t,o,!1)]})})},listModels:function(){return n(this,void 0,void 0,function(){var t,n,o,i,a,s;return r(this,function(e){switch(e.label){case 0:o=yf.getSchemes(),t={},n=0,o=o,e.label=1;case 1:return n<o.length?(i=o[n],[4,yf.getManager(i).listModels()]):[3,4];case 2:for(s in a=e.sent())t[i+gf+s]=a[s];e.label=3;case 3:return n++,[3,1];case 4:return[2,t]}})})},moveModel:function(t,o){return n(this,void 0,void 0,function(){return r(this,function(e){return[2,bf(t,o,!0)]})})},removeModel:function(o){return n(this,void 0,void 0,function(){var t;return r(this,function(e){return t=xf(o),[2,yf.getManager(t.scheme).removeModel(t.path)]})})}}),nd,rd=An({confusionMatrix_:function(e,t,n){var r=mn(e,"labels","confusionMatrix"),o=mn(t,"predictions","confusionMatrix");C(null==n||0<n&&Number.isInteger(n),function(){return"If provided, numClasses must be a positive integer, but got "+n}),C(1===r.rank,function(){return"Expected the rank of labels to be 1, but got "+r.rank}),C(1===o.rank,function(){return"Expected the rank of predictions to be 1, but got "+o.rank}),C(r.shape[0]===o.shape[0],function(){return"Mismatch in the number of examples: "+r.shape[0]+" vs. "+o.shape[0]+". Labels and predictions should have the same number of elements."}),C(0<n&&Number.isInteger(n),function(){return"numClasses is required to be a positive integer, but got "+n});e=Rr(r.asType("int32"),n),t=Rr(o.asType("int32"),n);return e.transpose().matMul(t).asType("int32")}});Object.freeze({confusionMatrix:rd});var ad=An({fromPixels_:function(e,t){if(4<(t=void 0===t?3:t))throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==e)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var n=!1,r=!1,o=!1,i=!1,a=!1;if(e.data instanceof Uint8Array)n=!0;else if("undefined"!=typeof ImageData&&e instanceof ImageData)r=!0;else if("undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement)o=!0;else if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement)i=!0;else{if(null==e.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+e.constructor.name);a=!0}if(o&&e.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=l("FromPixels",Lt.backendName))return Lt.runKernel("FromPixels",{pixels:e},{numChannels:t});var s,u=o?[e.videoWidth,e.videoHeight]:[e.width,e.height],c=u[0],u=u[1];if(a?s=e.getContext("2d").getImageData(0,0,c,u).data:r||n?s=e.data:(i||o)&&((nd=null==nd?document.createElement("canvas").getContext("2d"):nd).canvas.width=c,nd.canvas.height=u,nd.drawImage(e,0,0,c,u),s=nd.getImageData(0,0,c,u).data),4===t)d=new Int32Array(s);else for(var h=c*u,d=new Int32Array(h*t),p=0;p<h;p++)for(var f=0;f<t;++f)d[p*t+f]=s[4*p+f];return Pn(d,[u,c,t],"int32")}}),id=Object.freeze({toPixels:function(y,x){return n(this,void 0,void 0,function(){var t,n,o,i,a,s,u,c,l,h,d,p,f,m,g,v,b;return r(this,function(e){switch(e.label){case 0:if(t=mn(y,"img","toPixels"),2!==(t=!(y instanceof wt)?t.toInt():t).rank&&3!==t.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+t.rank+".");if(v=t.shape.slice(0,2),n=v[0],o=v[1],4<(i=2===t.rank?1:t.shape[2])||2===i)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+i);return[4,t.data()];case 1:return a=e.sent(),s=t.min(),u=t.max(),[4,Promise.all([s.data(),u.data()])];case 2:if(b=e.sent(),v=b[0],b=b[1],v=v[0],b=b[0],s.dispose(),u.dispose(),"float32"===t.dtype){if(v<0||1<b)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+v+" - "+b+"].")}else{if("int32"!==t.dtype)throw new Error("Unsupported type for toPixels: "+t.dtype+". Please use float32 or int32 tensors.");if(v<0||255<b)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+v+" - "+b+"].")}for(c="float32"===t.dtype?255:1,l=new Uint8ClampedArray(o*n*4),h=0;h<n*o;++h)m=f=p=d=void 0,1===i?(d=a[h]*c,p=a[h]*c,f=a[h]*c,m=255):3===i?(d=a[3*h]*c,p=a[3*h+1]*c,f=a[3*h+2]*c,m=255):4===i&&(d=a[4*h]*c,p=a[4*h+1]*c,f=a[4*h+2]*c,m=a[4*h+3]*c),l[0+(g=4*h)]=Math.round(d),l[1+g]=Math.round(p),l[2+g]=Math.round(f),l[3+g]=Math.round(m);return null!=x&&(x.width=o,x.height=n,v=x.getContext("2d"),b=new ImageData(l,o,n),v.putImageData(b,0,0)),t!==y&&t.dispose(),[2,l]}})})},fromPixels:ad}),sd=(EZ0.prototype.getClassName=function(){return this.constructor.className},EZ0.fromConfig=function(e,t){return new e(t)},EZ0),ud=(HZ0.getMap=function(){return HZ0.instance=null==HZ0.instance?new HZ0:HZ0.instance},HZ0.register=function(e){HZ0.getMap().classNameMap[e.className]=[e,e.fromConfig]},HZ0);function HZ0(){this.classNameMap={}}function EZ0(){}function cd(e){C(null!=e.className,function(){return"Class being registered does not have the static className property defined."}),C("string"==typeof e.className,function(){return"className is required to be a string, but got type "+typeof e.className}),C(0<e.className.length,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),ud.register(e)}Object.freeze({Serializable:sd,SerializationMap:ud,registerClass:cd});var hd=.001,fd=.1;function dd(){return 32===Lt.backend.floatPrecision()?hd:fd}function pd(e,t,n){var r=!0;if((V(e)||V(t))&&(r=!1),r=V(e)&&V(t)?!0:r){var o=e.constructor.name,i=t.constructor.name;if(o!==i)throw new Error("Arrays are of different type. Actual: "+o+". Expected: "+i)}if(Array.isArray(e)&&Array.isArray(t)){o=pn(e),i=pn(t);if(!S(o,i))throw new Error("Arrays have different shapes. Actual: ["+o+"]. Expected: ["+i+"]")}var a=V(e)?e:I(e),s=V(t)?t:I(t);if(a.length!==s.length)throw new Error("Arrays have different lengths actual: "+a.length+" vs expected: "+s.length+".\nActual:   "+a+".\nExpected: "+s+".");for(var u=0;u<s.length;++u){var c=a[u],l=s[u];if(!n(c,l))throw new Error("Arrays differ: actual["+u+"] = "+c+", expected["+u+"] = "+l+".\nActual:   "+a+".\nExpected: "+s+".")}}function vd(e,t,n){return!isFinite(e)&&!isFinite(t)||!(isNaN(e)||isNaN(t)||Math.abs(e-t)>n)}Object.freeze({TEST_EPSILON_FLOAT16:fd,expectArraysClose:function(e,t,n){return null==n&&(n=dd()),pd(e,t,function(e,t){return vd(e,t,n)})},testEpsilon:dd,expectPromiseToFail:function(e,t){e().then(function(){return t.fail()},function(){return t()})},expectArraysEqual:function(e,t){var n="string"==typeof t||"number"==typeof t||"boolean"==typeof t?[t]:t;return H(e)||H(e[0])||H(t)||H(t[0])?pd(e,n,function(e,t){return e==t}):pd(e,t,function(e,t){return vd(e,t,0)})},expectNumbersClose:function(e,t,n){if(!vd(e,t,n=null==n?dd():n))throw new Error("Numbers differ: actual === "+e+", expected === "+t)},expectValuesInRange:function(e,t,n){for(var r=0;r<e.length;r++)if(e[r]<t||e[r]>n)throw new Error("Value out of range:"+e[r]+" low: "+t+", high: "+n)},expectArrayBuffersEqual:function(e,t){expect(new Float32Array(e)).toEqual(new Float32Array(t))}}),Object.freeze({gpgpu_util:Mi,webgl_util:Ge,forceHalfFloat:function(){i().set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:Zs,setWebGLContext:Kt,GPGPUContext:Bi});var xd=(v$0=sd,e(w$0,v$0),w$0.prototype.minimize=function(e,t,n){void 0===t&&(t=!1);var r=this.computeGradients(e,n),e=r.value,o=r.grads;return null!=n?(n=n.map(function(e){return{name:e.name,tensor:o[e.name]}}),this.applyGradients(n)):this.applyGradients(o),tn(o),t?e:(e.dispose(),null)},Object.defineProperty(w$0.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),w$0.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},w$0.prototype.computeGradients=function(e,t){return po(e,t)},w$0.prototype.dispose=function(){null!=this.iterations_&&tn(this.iterations_)},w$0.prototype.saveIterations=function(){return n(this,void 0,void 0,function(){return r(this,function(e){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:On(this.iterations_,"int32")}]})})},w$0.prototype.getWeights=function(){return n(this,void 0,void 0,function(){return r(this,function(e){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},w$0.prototype.setWeights=function(e){return n(this,void 0,void 0,function(){return r(this,function(e){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},w$0.prototype.extractIterations=function(o){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return t=this,[4,o[0].tensor.data()];case 1:return t.iterations_=e.sent()[0],[2,o.slice(1)]}})})},w$0),v$0;function w$0(){return null!==v$0&&v$0.apply(this,arguments)||this}Object.defineProperty(xd,Symbol.hasInstance,{value:function(e){return null!=e.minimize&&null!=e.computeGradients&&null!=e.applyGradients}});var bd=(P$0=xd,e(Q$0,P$0),Q$0.prototype.applyGradients=function(n){var s=this;(Array.isArray(n)?n.map(function(e){return e.name}):Object.keys(n)).forEach(function(e,t){var r=Lt.registeredVariables[e];null==s.accumulatedGrads[t]&&(s.accumulatedGrads[t]={originalName:e+"/accum_grad",variable:Ze(function(){return Xn(r).variable(!1)})}),null==s.accumulatedUpdates[t]&&(s.accumulatedUpdates[t]={originalName:e+"/accum_var",variable:Ze(function(){return Xn(r).variable(!1)})});var o,i,a=Array.isArray(n)?n[t].tensor:n[e];null!=a&&(o=s.accumulatedGrads[t].variable,i=s.accumulatedUpdates[t].variable,Ze(function(){var e=o.mul(s.rho).add(a.square().mul(1-s.rho)),t=i.add(s.epsilon).sqrt().div(o.add(s.epsilon).sqrt()).mul(a),n=i.mul(s.rho).add(t.square().mul(1-s.rho));o.assign(e),i.assign(n);t=t.mul(-s.learningRate).add(r);r.assign(t)}))}),this.incrementIterations()},Q$0.prototype.dispose=function(){null!=this.accumulatedUpdates&&(tn(this.accumulatedGrads.map(function(e){return e.variable})),tn(this.accumulatedUpdates.map(function(e){return e.variable})))},Q$0.prototype.getWeights=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return t=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(e){return{name:e.originalName,tensor:e.variable}}))]}})})},Q$0.prototype.setWeights=function(o){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(o)];case 1:return o=e.sent(),t=o.length/2,this.accumulatedGrads=o.slice(0,t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),this.accumulatedUpdates=o.slice(t,2*t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),[2]}})})},Q$0.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},Q$0.fromConfig=function(e,t){return new e(t.learningRate,t.rho,t.epsilon)},Q$0.className="Adadelta",Q$0),P$0;function Q$0(e,t,n){void 0===n&&(n=null);var r=P$0.call(this)||this;return r.learningRate=e,r.rho=t,r.epsilon=n,r.accumulatedGrads=[],r.accumulatedUpdates=[],null==n&&(r.epsilon=Lt.backend.epsilon()),r}cd(bd);var wd=(s_0=xd,e(t_0,s_0),t_0.prototype.applyGradients=function(i){var a=this;(Array.isArray(i)?i.map(function(e){return e.name}):Object.keys(i)).forEach(function(e,t){var n=Lt.registeredVariables[e];null==a.accumulatedGrads[t]&&(a.accumulatedGrads[t]={originalName:e+"/accumulator",variable:Ze(function(){return Hn(n.shape,a.initialAccumulatorValue).variable(!1)})});var r,o=Array.isArray(i)?i[t].tensor:i[e];null!=o&&(r=a.accumulatedGrads[t].variable,Ze(function(){var e=r.add(o.square());r.assign(e);e=o.div(e.add(Lt.backend.epsilon()).sqrt()).mul(-a.learningRate).add(n);n.assign(e)}))}),this.incrementIterations()},t_0.prototype.dispose=function(){null!=this.accumulatedGrads&&tn(this.accumulatedGrads.map(function(e){return e.variable}))},t_0.prototype.getWeights=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulatedGrads.map(function(e){return{name:e.originalName,tensor:e.variable}}))]}})})},t_0.prototype.setWeights=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:return t=e.sent(),this.accumulatedGrads=t.map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),[2]}})})},t_0.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},t_0.fromConfig=function(e,t){return new e(t.learningRate,t.initialAccumulatorValue)},t_0.className="Adagrad",t_0),s_0;function t_0(e,t){void 0===t&&(t=.1);var n=s_0.call(this)||this;return n.learningRate=e,n.initialAccumulatorValue=t,n.accumulatedGrads=[],n}cd(wd);var Cd=(P_0=xd,e(Q_0,P_0),Q_0.prototype.applyGradients=function(c){var l=this,e=Array.isArray(c)?c.map(function(e){return e.name}):Object.keys(c);Ze(function(){var s=Cc(1,l.accBeta1),u=Cc(1,l.accBeta2);e.forEach(function(e,t){var n=Lt.registeredVariables[e];null==l.accumulatedFirstMoment[t]&&(l.accumulatedFirstMoment[t]={originalName:e+"/m",variable:Ze(function(){return Xn(n).variable(!1)})}),null==l.accumulatedSecondMoment[t]&&(l.accumulatedSecondMoment[t]={originalName:e+"/v",variable:Ze(function(){return Xn(n).variable(!1)})});var r,o,i,a=Array.isArray(c)?c[t].tensor:c[e];null!=a&&(r=l.accumulatedFirstMoment[t].variable,o=l.accumulatedSecondMoment[t].variable,i=r.mul(l.beta1).add(a.mul(1-l.beta1)),e=o.mul(l.beta2).add(a.square().mul(1-l.beta2)),t=i.div(s),a=e.div(u),r.assign(i),o.assign(e),a=t.div(a.sqrt().add(l.epsilon)).mul(-l.learningRate).add(n),n.assign(a))}),l.accBeta1.assign(l.accBeta1.mul(l.beta1)),l.accBeta2.assign(l.accBeta2.mul(l.beta2))}),this.incrementIterations()},Q_0.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&tn(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedSecondMoment&&tn(this.accumulatedSecondMoment.map(function(e){return e.variable}))},Q_0.prototype.getWeights=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return t=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(e){return{name:e.originalName,tensor:e.variable}}))]}})})},Q_0.prototype.setWeights=function(o){return n(this,void 0,void 0,function(){var t,n=this;return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(o)];case 1:return o=e.sent(),Ze(function(){n.accBeta1.assign(xc(n.beta1,n.iterations_+1)),n.accBeta2.assign(xc(n.beta2,n.iterations_+1))}),t=o.length/2,this.accumulatedFirstMoment=o.slice(0,t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),this.accumulatedSecondMoment=o.slice(t,2*t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),[2]}})})},Q_0.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},Q_0.fromConfig=function(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon)},Q_0.className="Adam",Q_0),P_0;function Q_0(e,t,n,r){void 0===r&&(r=null);var o=P_0.call(this)||this;return o.learningRate=e,o.beta1=t,o.beta2=n,o.epsilon=r,o.accumulatedFirstMoment=[],o.accumulatedSecondMoment=[],Ze(function(){o.accBeta1=On(t).variable(),o.accBeta2=On(n).variable()}),null==r&&(o.epsilon=Lt.backend.epsilon()),o}cd(Cd);var Ed=(yab=xd,e(zab,yab),zab.prototype.applyGradients=function(u){var c=this,e=Array.isArray(u)?u.map(function(e){return e.name}):Object.keys(u);Ze(function(){var a=Cc(1,c.accBeta1),s=sc(-c.learningRate,c.iteration.mul(c.decay).add(1));e.forEach(function(e,t){var n=Lt.registeredVariables[e];null==c.accumulatedFirstMoment[t]&&(c.accumulatedFirstMoment[t]={originalName:e+"/m",variable:Xn(n).variable(!1)}),null==c.accumulatedWeightedInfNorm[t]&&(c.accumulatedWeightedInfNorm[t]={originalName:e+"/v",variable:Xn(n).variable(!1)});var r,o,i=Array.isArray(u)?u[t].tensor:u[e];null!=i&&(r=c.accumulatedFirstMoment[t].variable,o=c.accumulatedWeightedInfNorm[t].variable,e=r.mul(c.beta1).add(i.mul(1-c.beta1)),t=o.mul(c.beta2),i=i.abs(),i=t.maximum(i),r.assign(e),o.assign(i),i=s.div(a).mul(e.div(i.add(c.epsilon))).add(n),n.assign(i))}),c.iteration.assign(c.iteration.add(1)),c.accBeta1.assign(c.accBeta1.mul(c.beta1))}),this.incrementIterations()},zab.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&tn(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedWeightedInfNorm&&tn(this.accumulatedWeightedInfNorm.map(function(e){return e.variable}))},zab.prototype.getWeights=function(){return n(this,void 0,void 0,function(){return r(this,function(e){throw new Error("getWeights() is not implemented for Adamax yet.")})})},zab.prototype.setWeights=function(e){return n(this,void 0,void 0,function(){return r(this,function(e){throw new Error("setWeights() is not implemented for Adamax yet.")})})},zab.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},zab.fromConfig=function(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon,t.decay)},zab.className="Adamax",zab),yab;function zab(e,t,n,r,o){void 0===r&&(r=null),void 0===o&&(o=0);var i=yab.call(this)||this;return i.learningRate=e,i.beta1=t,i.beta2=n,i.epsilon=r,i.decay=o,i.accumulatedFirstMoment=[],i.accumulatedWeightedInfNorm=[],Ze(function(){i.iteration=On(0).variable(),i.accBeta1=On(t).variable()}),null==r&&(i.epsilon=Lt.backend.epsilon()),i}cd(Ed);var Rd=(c0b=xd,e(d0b,c0b),d0b.prototype.applyGradients=function(o){var i=this;(Array.isArray(o)?o.map(function(e){return e.name}):Object.keys(o)).forEach(function(e,t){var n,r=Array.isArray(o)?o[t].tensor:o[e];null!=r&&(n=Lt.registeredVariables[e],Ze(function(){var e=i.c.mul(r).add(n);n.assign(e)}))}),this.incrementIterations()},d0b.prototype.setLearningRate=function(e){this.learningRate=e,null!=this.c&&this.c.dispose(),this.c=en(On(-e))},d0b.prototype.dispose=function(){this.c.dispose()},d0b.prototype.getWeights=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()]]}})})},d0b.prototype.setWeights=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:if(0!==(t=e.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},d0b.prototype.getConfig=function(){return{learningRate:this.learningRate}},d0b.fromConfig=function(e,t){return new e(t.learningRate)},d0b.className="SGD",d0b),c0b;function d0b(e){var t=c0b.call(this)||this;return t.learningRate=e,t.setLearningRate(e),t}cd(Rd);var Id=(u0b=Rd,e(v0b,u0b),v0b.prototype.applyGradients=function(i){var a=this;(Array.isArray(i)?i.map(function(e){return e.name}):Object.keys(i)).forEach(function(e,t){var n=Lt.registeredVariables[e];null==a.accumulations[t]&&(a.accumulations[t]={originalName:e+"/momentum",variable:Ze(function(){return Xn(n).variable(!1)})});var r=a.accumulations[t].variable,o=Array.isArray(i)?i[t].tensor:i[e];null!=o&&Ze(function(){var e=a.m.mul(r).add(o),t=(a.useNesterov?a.c.mul(o.add(e.mul(a.m))):a.c.mul(e)).add(n);r.assign(e),n.assign(t)})}),this.incrementIterations()},v0b.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&tn(this.accumulations.map(function(e){return e.variable}))},v0b.prototype.setMomentum=function(e){this.momentum=e},v0b.prototype.getWeights=function(){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulations.map(function(e){return{name:e.originalName,tensor:e.variable}}))]}})})},v0b.prototype.setWeights=function(t){return n(this,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(t)];case 1:return t=e.sent(),this.accumulations=t.map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),[2]}})})},v0b.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},v0b.fromConfig=function(e,t){return new e(t.learningRate,t.momentum,t.useNesterov)},v0b.className="Momentum",v0b),u0b;function v0b(e,t,n){void 0===n&&(n=!1);var r=u0b.call(this,e)||this;return r.learningRate=e,r.momentum=t,r.useNesterov=n,r.accumulations=[],r.m=On(r.momentum),r}cd(Id);var kd=(T0b=xd,e(U0b,T0b),U0b.prototype.applyGradients=function(t){var c=this;(Array.isArray(t)?t.map(function(e){return e.name}):Object.keys(t)).forEach(function(e,o){var i=Lt.registeredVariables[e];null==c.accumulatedMeanSquares[o]&&(c.accumulatedMeanSquares[o]={originalName:e+"/rms",variable:Ze(function(){return Xn(i).variable(!1)})}),null==c.accumulatedMoments[o]&&(c.accumulatedMoments[o]={originalName:e+"/momentum",variable:Ze(function(){return Xn(i).variable(!1)})}),null==c.accumulatedMeanGrads[o]&&c.centered&&(c.accumulatedMeanGrads[o]={originalName:e+"/mg",variable:Ze(function(){return Xn(i).variable(!1)})});var a,s,u=Array.isArray(t)?t[o].tensor:t[e];null!=u&&(a=c.accumulatedMeanSquares[o].variable,s=c.accumulatedMoments[o].variable,Ze(function(){var e,t,n=a.mul(c.decay).add(u.square().mul(1-c.decay)),r=(c.centered?(t=(e=c.accumulatedMeanGrads[o].variable).mul(c.decay).add(u.mul(1-c.decay)),r=s.mul(c.momentum).add(u.mul(c.learningRate).div(n.sub(t.square().add(c.epsilon)).sqrt())),a.assign(n),e.assign(t)):(t=a.mul(c.decay).add(u.square().mul(1-c.decay)),r=s.mul(c.momentum).add(u.mul(c.learningRate).div(t.add(c.epsilon).sqrt())),a.assign(t)),s.assign(r),i.sub(r));i.assign(r)}))}),this.incrementIterations()},U0b.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&tn(this.accumulatedMeanSquares.map(function(e){return e.variable})),null!=this.accumulatedMeanGrads&&this.centered&&tn(this.accumulatedMeanGrads.map(function(e){return e.variable})),null!=this.accumulatedMoments&&tn(this.accumulatedMoments.map(function(e){return e.variable}))},U0b.prototype.getWeights=function(){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return t=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&t.push.apply(t,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(t.map(function(e){return{name:e.originalName,tensor:e.variable}}))]}})})},U0b.prototype.setWeights=function(o){return n(this,void 0,void 0,function(){var t;return r(this,function(e){switch(e.label){case 0:return[4,this.extractIterations(o)];case 1:return o=e.sent(),t=this.centered?o.length/3:o.length/2,this.accumulatedMeanSquares=o.slice(0,t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),this.accumulatedMoments=o.slice(t,2*t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=o.slice(2*t,3*t).map(function(e){return{originalName:e.name,variable:e.tensor.variable(!1)}})),[2]}})})},U0b.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},U0b.fromConfig=function(e,t){return new e(t.learningRate,t.decay,t.momentum,t.epsilon,t.centered)},U0b.className="RMSProp",U0b),T0b;function U0b(e,t,n,r,o){void 0===t&&(t=.9),void 0===n&&(n=0),void 0===r&&(r=null),void 0===o&&(o=!1);var i=T0b.call(this)||this;if(i.learningRate=e,i.decay=t,i.momentum=n,i.epsilon=r,i.accumulatedMeanSquares=[],i.accumulatedMoments=[],i.accumulatedMeanGrads=[],i.centered=o,null==r&&(i.epsilon=Lt.backend.epsilon()),null==e)throw new Error("learningRate for RMSPropOptimizer must be defined.");return i}cd(kd),wt.prototype.squaredDifference=function(e){return nu(this,e)};var xt=Gh,extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function __extends(e,t){function n(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function __awaiter(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})}function __generator(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function __spreadArrays(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),o=0,t=0;t<n;t++)for(var i=arguments[t],a=0,s=i.length;a<s;a++,o++)r[o]=i[a];return r}var Dimensions=(Object.defineProperty(E1b.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(E1b.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),E1b.prototype.reverse=function(){return new E1b(1/this.width,1/this.height)},E1b);function E1b(e,t){if(!isValidNumber(e)||!isValidNumber(t))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:e,height:t}));this._width=e,this._height=t}function isTensor(e,t){return e instanceof wt&&e.shape.length===t}function isTensor2D(e){return isTensor(e,2)}function isTensor3D(e){return isTensor(e,3)}function isTensor4D(e){return isTensor(e,4)}function isFloat(e){return e%1!=0}function isEven(e){return e%2==0}function round(e,t){void 0===t&&(t=2);t=Math.pow(10,t);return Math.floor(e*t)/t}function isDimensions(e){return e&&e.width&&e.height}function computeReshapedDimensions(e,t){var n=e.width,e=e.height,t=t/Math.max(e,n);return new Dimensions(Math.round(n*t),Math.round(e*t))}function getCenterPoint(e){return e.reduce(function(e,t){return e.add(t)},new Point(0,0)).div(new Point(e.length,e.length))}function range(e,n,r){return Array(e).fill(0).map(function(e,t){return n+t*r})}function isValidNumber(e){return!!e&&e!==1/0&&e!==-1/0&&!isNaN(e)||0===e}function isValidProbablitiy(e){return isValidNumber(e)&&0<=e&&e<=1}var Point=(Object.defineProperty(fcb.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(fcb.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),fcb.prototype.add=function(e){return new fcb(this.x+e.x,this.y+e.y)},fcb.prototype.sub=function(e){return new fcb(this.x-e.x,this.y-e.y)},fcb.prototype.mul=function(e){return new fcb(this.x*e.x,this.y*e.y)},fcb.prototype.div=function(e){return new fcb(this.x/e.x,this.y/e.y)},fcb.prototype.abs=function(){return new fcb(Math.abs(this.x),Math.abs(this.y))},fcb.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},fcb.prototype.floor=function(){return new fcb(Math.floor(this.x),Math.floor(this.y))},fcb);function fcb(e,t){this._x=e,this._y=t}var Box=(mcb.isRect=function(e){return!!e&&[e.x,e.y,e.width,e.height].every(isValidNumber)},mcb.assertIsValidBox=function(e,t,n){if(void 0===n&&(n=!1),!mcb.isRect(e))throw new Error(t+" - invalid box: "+JSON.stringify(e)+", expected object with properties x, y, width, height");if(!n&&(e.width<0||e.height<0))throw new Error(t+" - width ("+e.width+") and height ("+e.height+") must be positive numbers")},Object.defineProperty(mcb.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"topLeft",{get:function(){return new Point(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"topRight",{get:function(){return new Point(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"bottomLeft",{get:function(){return new Point(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(mcb.prototype,"bottomRight",{get:function(){return new Point(this.right,this.bottom)},enumerable:!0,configurable:!0}),mcb.prototype.round=function(){var e=[this.x,this.y,this.width,this.height].map(function(e){return Math.round(e)});return new mcb({x:e[0],y:e[1],width:e[2],height:e[3]})},mcb.prototype.floor=function(){var e=[this.x,this.y,this.width,this.height].map(function(e){return Math.floor(e)});return new mcb({x:e[0],y:e[1],width:e[2],height:e[3]})},mcb.prototype.toSquare=function(){var e=this.x,t=this.y,n=this.width,r=this.height,o=Math.abs(n-r);return n<r&&(e-=o/2,n+=o),r<n&&(t-=o/2,r+=o),new mcb({x:e,y:t,width:n,height:r})},mcb.prototype.rescale=function(e){var t=isDimensions(e)?e.width:e,e=isDimensions(e)?e.height:e;return new mcb({x:this.x*t,y:this.y*e,width:this.width*t,height:this.height*e})},mcb.prototype.pad=function(e,t){t=[this.x-e/2,this.y-t/2,this.width+e,this.height+t];return new mcb({x:t[0],y:t[1],width:t[2],height:t[3]})},mcb.prototype.clipAtImageBorders=function(e,t){var n=this.x,r=this.y,o=this.right,i=this.bottom,n=Math.max(n,0),r=Math.max(r,0),i=i-r;return new mcb({x:n,y:r,width:Math.min(o-n,e-n),height:Math.min(i,t-r)}).floor()},mcb.prototype.shift=function(e,t){var n=this.width,r=this.height;return new mcb({x:this.x+e,y:this.y+t,width:n,height:r})},mcb.prototype.padAtBorders=function(e,t){var n=this.width+1,r=this.height+1,o=n,i=r,a=this.left,s=this.top,u=this.right,c=this.bottom;return t<u&&(o=-u+t+n,u=t),e<c&&(i=-c+e+r,c=e),a<1&&(i=2-a,a=1),s<1&&(i=2-s,s=1),{dy:1,edy:i,dx:1,edx:o,y:s,ey:c,x:a,ex:u,w:n,h:r}},mcb.prototype.calibrate=function(e){return new mcb({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()},mcb);function mcb(e,t){void 0===t&&(t=!0);var n=e||{},r=[n.left,n.top,n.right,n.bottom].every(isValidNumber),o=[n.x,n.y,n.width,n.height].every(isValidNumber);if(!o&&!r)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(n));e=o?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top],r=e[0],o=e[1],n=e[2],e=e[3];mcb.assertIsValidBox({x:r,y:o,width:n,height:e},"Box.constructor",t),this._x=r,this._y=o,this._width=n,this._height=e}var BoundingBox=(I2b=Box,__extends(J2b,I2b),J2b),I2b;function J2b(e,t,n,r,o){return I2b.call(this,{left:e,top:t,right:n,bottom:r},o=void 0===o?!1:o)||this}var ObjectDetection=(Object.defineProperty(P2b.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(P2b.prototype,"relativeBox",{get:function(){return new Box(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),P2b.prototype.forSize=function(e,t){return new P2b(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:t})},P2b);function P2b(e,t,n,r,o){this._imageDims=new Dimensions(o.width,o.height),this._score=e,this._classScore=t,this._className=n,this._box=new Box(r).rescale(this._imageDims)}var FaceDetection=(X2b=ObjectDetection,__extends(Y2b,X2b),Y2b.prototype.forSize=function(e,t){t=X2b.prototype.forSize.call(this,e,t);return new Y2b(t.score,t.relativeBox,t.imageDims)},Y2b),X2b;function Y2b(e,t,n){return X2b.call(this,e,e,"",t,n)||this}function iou(e,t,n){void 0===n&&(n=!0);var r=Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left))*Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return n?r/(e.area+t.area-r):r/Math.min(e.area,t.area)}function minBbox(e){var t=e.map(function(e){return e.x}),n=e.map(function(e){return e.y}),r=t.reduce(function(e,t){return t<e?t:e},1/0),e=n.reduce(function(e,t){return t<e?t:e},1/0),t=t.reduce(function(e,t){return e<t?t:e},0),n=n.reduce(function(e,t){return e<t?t:e},0);return new BoundingBox(r,e,t,n)}function nonMaxSuppression$1(a,e,s,u){void 0===u&&(u=!0);for(var c=e.map(function(e,t){return{score:e,boxIndex:t}}).sort(function(e,t){return e.score-t.score}).map(function(e){return e.boxIndex}),l=[];0<c.length;)!function(){var e=c.pop();l.push(e);for(var t=c,n=[],r=0;r<t.length;r++){var o=t[r],i=a[e],o=a[o];n.push(iou(i,o,u))}c=c.filter(function(e,t){return n[t]<=s})}();return l}function normalize$1(r,o){return Ze(function(){var e=o[0],t=o[1],n=o[2],e=Hn(__spreadArrays(r.shape.slice(0,3),[1]),e),t=Hn(__spreadArrays(r.shape.slice(0,3),[1]),t),n=Hn(__spreadArrays(r.shape.slice(0,3),[1]),n),n=Yn([e,t,n],3);return Cc(r,n)})}function padToSquare(i,a){return void 0===a&&(a=!1),Ze(function(){var e=i.shape.slice(1),t=e[0],n=e[1];if(t===n)return i;var r=Math.abs(t-n),e=Math.round(r*(a?.5:1)),o=n<t?2:1,t=function(e){var t=i.shape.slice();return t[o]=e,Hn(t,0)},e=t(e),r=r-e.shape[o],e=[a&&r?t(r):null,i,e].filter(function(e){return!!e}).map(function(e){return e.toFloat()});return Yn(e,o)})}function sigmoid(e){return 1/(1+Math.exp(-e))}var Rect=(x3b=Box,__extends(y3b,x3b),y3b),x3b;function y3b(e,t,n,r,o){return x3b.call(this,{x:e,y:t,width:n,height:r},o=void 0===o?!1:o)||this}var relX=.5,relY=.43,relScale=.45,FaceLandmarks=(Object.defineProperty(E3b.prototype,"shift",{get:function(){return new Point(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(E3b.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(E3b.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(E3b.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(E3b.prototype,"relativePositions",{get:function(){var t=this;return this._positions.map(function(e){return e.sub(t._shift).div(new Point(t.imageWidth,t.imageHeight))})},enumerable:!0,configurable:!0}),E3b.prototype.forSize=function(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})},E3b.prototype.shiftBy=function(e,t){return new this.constructor(this.relativePositions,this._imgDims,new Point(e,t))},E3b.prototype.shiftByPoint=function(e){return this.shiftBy(e.x,e.y)},E3b.prototype.align=function(e,t){if(void 0===t&&(t={}),e){var n=e instanceof FaceDetection?e.box.floor():new Box(e);return this.shiftBy(n.x,n.y).align(null,t)}n=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},t),t=n.useDlibAlignment,n=n.minBoxPadding;return t?this.alignDlib():this.alignMinBbox(n)},E3b.prototype.alignDlib=function(){var e=this.getRefPointsForAlignment(),t=e[0],n=e[1],r=e[2],o=function(e){return r.sub(e).magnitude()},o=(o(t)+o(n))/2,n=Math.floor(o/relScale),o=getCenterPoint(e),e=Math.floor(Math.max(0,o.x-relX*n)),o=Math.floor(Math.max(0,o.y-relY*n));return new Rect(e,o,Math.min(n,this.imageWidth+e),Math.min(n,this.imageHeight+o))},E3b.prototype.alignMinBbox=function(e){var t=minBbox(this.positions);return t.pad(t.width*e,t.height*e)},E3b.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},E3b);function E3b(e,t,n){void 0===n&&(n=new Point(0,0));var r=t.width,o=t.height;this._imgDims=new Dimensions(r,o),this._shift=n,this._positions=e.map(function(e){return e.mul(new Point(r,o)).add(n)})}var FaceLandmarks5=(jeb=FaceLandmarks,__extends(keb,jeb),keb.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],getCenterPoint([e[3],e[4]])]},keb),jeb;function keb(){return null!==jeb&&jeb.apply(this,arguments)||this}var FaceLandmarks68=(meb=FaceLandmarks,__extends(neb,meb),neb.prototype.getJawOutline=function(){return this.positions.slice(0,17)},neb.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},neb.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},neb.prototype.getNose=function(){return this.positions.slice(27,36)},neb.prototype.getLeftEye=function(){return this.positions.slice(36,42)},neb.prototype.getRightEye=function(){return this.positions.slice(42,48)},neb.prototype.getMouth=function(){return this.positions.slice(48,68)},neb.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(getCenterPoint)},neb),meb;function neb(){return null!==meb&&meb.apply(this,arguments)||this}var FaceMatch=(Object.defineProperty(oeb.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(oeb.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),oeb.prototype.toString=function(e){return this.label+((e=void 0===e?!0:e)?" ("+round(this.distance)+")":"")},oeb);function oeb(e,t){this._label=e,this._distance=t}var LabeledBox=(seb=Box,__extends(teb,seb),teb.assertIsValidLabeledBox=function(e,t){if(Box.assertIsValidBox(e,t),!isValidNumber(e.label))throw new Error(t+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(teb.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),teb),seb;function teb(e,t){e=seb.call(this,e)||this;return e._label=t,e}var LabeledFaceDescriptors=(Object.defineProperty(zeb.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(zeb.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),zeb.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(e){return Array.from(e)})}},zeb.fromJSON=function(e){var t=e.descriptors.map(function(e){return new Float32Array(e)});return new zeb(e.label,t)},zeb),Heb,environment;function zeb(e,t){if("string"!=typeof e)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(t)||t.some(function(e){return!(e instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e,this._descriptors=t}function Ieb(e,t,n,r){t=Heb.call(this,e,t)||this;return t._score=n,t._classScore=r,t}function isWithFaceDetection(e){return e.detection instanceof FaceDetection}function extendWithFaceDetection(e,t){return Object.assign({},e,{detection:t})}function createBrowserEnv(){var e=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D:CanvasRenderingContext2D,Image:HTMLImageElement,ImageData:ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:e,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function createFileSystem(t){var n="";if(!t)try{t=require("fs")}catch(e){n=e.toString()}return{readFile:t?function(e){return new Promise(function(n,r){t.readFile(e,function(e,t){return e?r(e):n(t)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+n)}}}function createNodejsEnv(){var e=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,n=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},r=createFileSystem();return __assign({Canvas:e||function(){},CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){},Image:t||function(){},ImageData:global.ImageData||function(){},Video:global.HTMLVideoElement||function(){},createCanvasElement:function(){if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:n},r)}function isBrowser(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}function isNodejs(){return"object"==typeof global&&"function"==typeof require&&"undefined"!=typeof module&&"undefined"!=typeof process&&!!process.version}function getEnv(){if(!environment)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return environment}function setEnv(e){environment=e}function initialize(){isBrowser()&&setEnv(createBrowserEnv()),isNodejs()&&setEnv(createNodejsEnv())}function monkeyPatch(e){if(environment||initialize(),!environment)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var t=e.Canvas,n=void 0===t?environment.Canvas:t,t=e.Image,r=void 0===t?environment.Image:t;environment.Canvas=n,environment.Image=r,environment.createCanvasElement=e.createCanvasElement||function(){return new n},environment.createImageElement=e.createImageElement||function(){return new r},environment.ImageData=e.ImageData||environment.ImageData,environment.Video=e.Video||environment.Video,environment.fetch=e.fetch||environment.fetch,environment.readFile=e.readFile||environment.readFile}Heb=LabeledBox,__extends(Ieb,Heb),Ieb.assertIsValidPredictedBox=function(e,t){if(LabeledBox.assertIsValidLabeledBox(e,t),!isValidProbablitiy(e.score)||!isValidProbablitiy(e.classScore))throw new Error(t+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(Ieb.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(Ieb.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0});var env={getEnv:getEnv,setEnv:setEnv,initialize:initialize,createBrowserEnv:createBrowserEnv,createFileSystem:createFileSystem,createNodejsEnv:createNodejsEnv,monkeyPatch:monkeyPatch,isBrowser:isBrowser,isNodejs:isNodejs},AnchorPosition,B4b;function resolveInput(e){return env.isNodejs()||"string"!=typeof e?e:document.getElementById(e)}function getContext2dOrThrow(e){var t=env.getEnv(),n=t.Canvas;if(e instanceof t.CanvasRenderingContext2D)return e;e=resolveInput(e);if(!(e instanceof n))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");e=e.getContext("2d");if(!e)throw new Error("resolveContext2d - canvas 2d context is null");return e}function isMediaLoaded(e){var t=env.getEnv(),n=t.Image,t=t.Video;return e instanceof n&&e.complete||e instanceof t&&3<=e.readyState}function awaitMediaLoaded(e){return new Promise(function(t,n){if(e instanceof env.getEnv().Canvas||isMediaLoaded(e))return t();function r(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",r),e.currentTarget.removeEventListener("error",o),t(e))}function o(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",r),e.currentTarget.removeEventListener("error",o),n(e))}e.addEventListener("load",r),e.addEventListener("error",o)})}function getMediaDimensions(e){var t=env.getEnv(),n=t.Image,t=t.Video;return e instanceof n?new Dimensions(e.naturalWidth,e.naturalHeight):e instanceof t?new Dimensions(e.videoWidth,e.videoHeight):new Dimensions(e.width,e.height)}function createCanvas(e){var t=e.width,n=e.height,e=(0,env.getEnv().createCanvasElement)();return e.width=t,e.height=n,e}function createCanvasFromMedia(e,t){var n=env.getEnv().ImageData;if(!(e instanceof n||isMediaLoaded(e)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var r=t||getMediaDimensions(e),o=r.width,t=r.height,r=createCanvas({width:o,height:t});return e instanceof n?getContext2dOrThrow(r).putImageData(e,0,0):getContext2dOrThrow(r).drawImage(e,0,0,o,t),r}function imageTensorToCanvas(a,s){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return t=s||env.getEnv().createCanvasElement(),i=a.shape.slice(isTensor4D(a)?1:0),n=i[0],r=i[1],o=i[2],i=Ze(function(){return a.as3D(n,r,o).toInt()}),[4,id.toPixels(i,t)];case 1:return e.sent(),i.dispose(),[2,t]}})})}function isMediaElement(e){var t=env.getEnv(),n=t.Image,r=t.Canvas,t=t.Video;return e instanceof n||e instanceof r||e instanceof t}function imageToSquare(e,t,n){void 0===n&&(n=!1);var r=env.getEnv(),o=r.Image,i=r.Canvas;if(!(e instanceof o||e instanceof i))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var a=getMediaDimensions(e),r=t/Math.max(a.height,a.width),o=r*a.width,r=r*a.height,a=createCanvas({width:t,height:t}),t=e instanceof i?e:createCanvasFromMedia(e),i=Math.abs(o-r)/2,e=n&&o<r?i:0,i=n&&r<o?i:0;return getContext2dOrThrow(a).drawImage(t,e,i,o,r),a}initialize(),B4b=AnchorPosition=AnchorPosition||{},B4b.TOP_LEFT="TOP_LEFT",B4b.TOP_RIGHT="TOP_RIGHT",B4b.BOTTOM_LEFT="BOTTOM_LEFT",B4b.BOTTOM_RIGHT="BOTTOM_RIGHT";var NetInput=(Object.defineProperty(Efb.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"isBatchInput",{get:function(){return 1<this.batchSize||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(Efb.prototype,"reshapedInputDimensions",{get:function(){var n=this;return range(this.batchSize,0,1).map(function(e,t){return n.getReshapedInputDimensions(t)})},enumerable:!0,configurable:!0}),Efb.prototype.getInput=function(e){return this.canvases[e]||this.imageTensors[e]},Efb.prototype.getInputDimensions=function(e){return this._inputDimensions[e]},Efb.prototype.getInputHeight=function(e){return this._inputDimensions[e][0]},Efb.prototype.getInputWidth=function(e){return this._inputDimensions[e][1]},Efb.prototype.getReshapedInputDimensions=function(e){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return computeReshapedDimensions({width:this.getInputWidth(e),height:this.getInputHeight(e)},this.inputSize)},Efb.prototype.toBatchTensor=function(r,o){var i=this;return void 0===o&&(o=!0),this._inputSize=r,Ze(function(){var e=range(i.batchSize,0,1).map(function(e){var t=i.getInput(e);if(t instanceof wt){var n=isTensor4D(t)?t:t.expandDims();return(n=(n=padToSquare(n,o)).shape[1]!==r||n.shape[2]!==r?Oh.resizeBilinear(n,[r,r]):n).as3D(r,r,3)}if(t instanceof env.getEnv().Canvas)return id.fromPixels(imageToSquare(t,r,o));throw new Error("toBatchTensor - at batchIdx "+e+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+t)});return Pr(e.map(function(e){return e.toFloat()})).as4D(i.batchSize,r,r,3)})},Efb);function Efb(e,t){var r=this;if(void 0===t&&(t=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(e))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+e);this._treatAsBatchInput=t,this._batchSize=e.length,e.forEach(function(e,t){if(isTensor3D(e))return r._imageTensors[t]=e,void(r._inputDimensions[t]=e.shape);if(isTensor4D(e)){var n=e.shape[0];if(1!==n)throw new Error("NetInput - tf.Tensor4D with batchSize "+n+" passed, but not supported in input array");return r._imageTensors[t]=e,void(r._inputDimensions[t]=e.shape.slice(1))}e=e instanceof env.getEnv().Canvas?e:createCanvasFromMedia(e);r._canvases[t]=e,r._inputDimensions[t]=[e.height,e.width,3]})}function toNetInput(o){return __awaiter(this,void 0,void 0,function(){var n,r,t;return __generator(this,function(e){switch(e.label){case 0:if(o instanceof NetInput)return[2,o];if(!(n=Array.isArray(o)?o:[o]).length)throw new Error("toNetInput - empty array passed as input");return r=function(e){return Array.isArray(o)?" at input index "+e+":":""},(t=n.map(resolveInput)).forEach(function(e,t){if(!isMediaElement(e)&&!isTensor3D(e)&&!isTensor4D(e)){if("string"==typeof n[t])throw new Error("toNetInput -"+r(t)+" string passed, but could not resolve HTMLElement for element id "+n[t]);throw new Error("toNetInput -"+r(t)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(isTensor4D(e)){e=e.shape[0];if(1!==e)throw new Error("toNetInput -"+r(t)+" tf.Tensor4D with batchSize "+e+" passed, but not supported in input array")}}),[4,Promise.all(t.map(function(e){return isMediaElement(e)&&awaitMediaLoaded(e)}))];case 1:return e.sent(),[2,new NetInput(t,Array.isArray(o))]}})})}function extractFaces(a,s){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return t=env.getEnv().Canvas,(n=a)instanceof t?[3,5]:[4,toNetInput(a)];case 1:if(1<(r=e.sent()).batchSize)throw new Error("extractFaces - batchSize > 1 not supported");return(r=r.getInput(0))instanceof t?(o=r,[3,4]):[3,2];case 2:return[4,imageTensorToCanvas(r)];case 3:o=e.sent(),e.label=4;case 4:n=o,e.label=5;case 5:return i=getContext2dOrThrow(n),[2,s.map(function(e){return e instanceof FaceDetection?e.forSize(n.width,n.height).box.floor():e}).map(function(e){return e.clipAtImageBorders(n.width,n.height)}).map(function(e){var t=e.x,n=e.y,r=e.width,o=e.height,e=createCanvas({width:r,height:o});return getContext2dOrThrow(e).putImageData(i.getImageData(t,n,r,o),0,0),e})]}})})}function extractFaceTensors(s,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){if(!isTensor3D(s)&&!isTensor4D(s))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(isTensor4D(s)&&1<s.shape[0])throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,Ze(function(){var e=s.shape.slice(isTensor4D(s)?1:0),o=e[0],i=e[1],a=e[2];return t.map(function(e){return e instanceof FaceDetection?e.forSize(i,o).box:e}).map(function(e){return e.clipAtImageBorders(i,o)}).map(function(e){var t=e.x,n=e.y,r=e.width,e=e.height;return xl(s.as3D(o,i,a),[n,t,0],[e,r,a])})})]})})}function fetchOrThrow(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,env.getEnv().fetch)(n,r)];case 1:if(!((t=e.sent()).status<400))throw new Error("failed to fetch: ("+t.status+") "+t.statusText+", from url: "+t.url);return[2,t]}})})}function fetchJson(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetchOrThrow(t)];case 1:return[2,e.sent().json()]}})})}function getModelUris(e,t){var n=t+"-weights_manifest.json";if(!e)return{modelBaseUri:"",manifestUri:n};if("/"===e)return{modelBaseUri:"/",manifestUri:"/"+n};var r=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"",t=(e=e.replace(r,"")).split("/").filter(function(e){return e}),n=e.endsWith(".json")?t[t.length-1]:n,t=r+(e.endsWith(".json")?t.slice(0,t.length-1):t).join("/");return{modelBaseUri:t=e.startsWith("/")?"/"+t:t,manifestUri:"/"===t?"/"+n:t+"/"+n}}function loadWeightMap(r,o){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=getModelUris(r,o),n=t.manifestUri,t=t.modelBaseUri,[4,fetchJson(n)];case 1:return n=e.sent(),[2,ed.loadWeights(n,t)]}})})}function matchDimensions(e,t,n){n=(n=void 0===n?!1:n)?getMediaDimensions(t):t,t=n.width,n=n.height;return{width:e.width=t,height:e.height=n}}var NeuralNetwork=(Object.defineProperty(vgb.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(vgb.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(vgb.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),vgb.prototype.getParamFromPath=function(e){e=this.traversePropertyPath(e);return e.obj[e.objProp]},vgb.prototype.reassignParamFromPath=function(e,t){var n=this.traversePropertyPath(e),e=n.obj,n=n.objProp;e[n].dispose(),e[n]=t},vgb.prototype.getParamList=function(){var t=this;return this._paramMappings.map(function(e){e=e.paramPath;return{path:e,tensor:t.getParamFromPath(e)}})},vgb.prototype.getTrainableParams=function(){return this.getParamList().filter(function(e){return e.tensor instanceof St})},vgb.prototype.getFrozenParams=function(){return this.getParamList().filter(function(e){return!(e.tensor instanceof St)})},vgb.prototype.variable=function(){var n=this;this.getFrozenParams().forEach(function(e){var t=e.path,e=e.tensor;n.reassignParamFromPath(t,e.variable())})},vgb.prototype.freeze=function(){var r=this;this.getTrainableParams().forEach(function(e){var t=e.path,n=e.tensor,e=Fn(n.dataSync());n.dispose(),r.reassignParamFromPath(t,e)})},vgb.prototype.dispose=function(t){void 0===t&&(t=!0),this.getParamList().forEach(function(e){if(t&&e.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+e.path);e.tensor.dispose()}),this._params=void 0},vgb.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(e){e=e.tensor;return Array.from(e.dataSync())}).reduce(function(e,t){return e.concat(t)}))},vgb.prototype.load=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t instanceof Float32Array?(this.extractWeights(t),[2]):[4,this.loadFromUri(t)];case 1:return e.sent(),[2]}})})},vgb.prototype.loadFromUri=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:if(n&&"string"!=typeof n)throw new Error(this._name+".loadFromUri - expected model uri");return[4,loadWeightMap(n,this.getDefaultModelName())];case 1:return t=e.sent(),this.loadFromWeightMap(t),[2]}})})},vgb.prototype.loadFromDisk=function(u){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a,s;return __generator(this,function(e){switch(e.label){case 0:if(u&&"string"!=typeof u)throw new Error(this._name+".loadFromDisk - expected model file path");return t=env.getEnv().readFile,i=getModelUris(u,this.getDefaultModelName()),n=i.manifestUri,r=i.modelBaseUri,a=function(e){return Promise.all(e.map(function(e){return t(e).then(function(e){return e.buffer})}))},o=ed.weightsLoaderFactory(a),a=(i=JSON).parse,[4,t(n)];case 1:return s=a.apply(i,[e.sent().toString()]),[4,o(s,r)];case 2:return s=e.sent(),this.loadFromWeightMap(s),[2]}})})},vgb.prototype.loadFromWeightMap=function(e){var t=this.extractParamsFromWeigthMap(e),e=t.paramMappings,t=t.params;this._paramMappings=e,this._params=t},vgb.prototype.extractWeights=function(e){var t=this.extractParams(e),e=t.paramMappings,t=t.params;this._paramMappings=e,this._params=t},vgb.prototype.traversePropertyPath=function(n){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var e=n.split("/").reduce(function(e,t){if(!e.nextObj.hasOwnProperty(t))throw new Error("traversePropertyPath - object does not have property "+t+", for path "+n);return{obj:e.nextObj,objProp:t,nextObj:e.nextObj[t]}},{nextObj:this.params}),t=e.obj,e=e.objProp;if(!(t&&e&&t[e]instanceof wt))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+n);return{obj:t,objProp:e}},vgb);function vgb(e){this._name=e,this._params=void 0,this._paramMappings=[]}function depthwiseSeparableConv$1(t,n,r){return Ze(function(){var e=Jc(t,n.depthwise_filter,n.pointwise_filter,r,"same");return e=rc(e,n.bias)})}function denseBlock3(r,o,i){return void 0===i&&(i=!1),Ze(function(){var e=Bl(i?rc(qc(r,o.conv0.filters,[2,2],"same"),o.conv0.bias):depthwiseSeparableConv$1(r,o.conv0,[2,2])),t=depthwiseSeparableConv$1(e,o.conv1,[1,1]),n=depthwiseSeparableConv$1(Bl(rc(e,t)),o.conv2,[1,1]);return Bl(rc(e,rc(t,n)))})}function denseBlock4(o,i,a,s){return void 0===a&&(a=!1),void 0===s&&(s=!0),Ze(function(){var e=Bl(a?rc(qc(o,i.conv0.filters,s?[2,2]:[1,1],"same"),i.conv0.bias):depthwiseSeparableConv$1(o,i.conv0,s?[2,2]:[1,1])),t=depthwiseSeparableConv$1(e,i.conv1,[1,1]),n=depthwiseSeparableConv$1(Bl(rc(e,t)),i.conv2,[1,1]),r=depthwiseSeparableConv$1(Bl(rc(e,rc(t,n))),i.conv3,[1,1]);return Bl(rc(e,rc(t,rc(n,r))))})}function convLayer$1(t,n,r,o){return void 0===r&&(r="same"),void 0===o&&(o=!1),Ze(function(){var e=rc(qc(t,n.filters,[1,1],r),n.bias);return o?Bl(e):e})}function disposeUnusedWeightTensors(e,n){Object.keys(e).forEach(function(t){n.some(function(e){return e.originalPath===t})||e[t].dispose()})}function extractConvParamsFactory(o,i){return function(e,t,n,r){e=Ln(o(e*t*n*n),[n,n,e,t]),t=Mn(o(t));return i.push({paramPath:r+"/filters"},{paramPath:r+"/bias"}),{filters:e,bias:t}}}function extractFCParamsFactory(r,o){return function(e,t,n){e=Bn(r(e*t),[e,t]),t=Mn(r(t));return o.push({paramPath:n+"/weights"},{paramPath:n+"/bias"}),{weights:e,bias:t}}}var SeparableConvParams=function(e,t,n){this.depthwise_filter=e,this.pointwise_filter=t,this.bias=n};function extractSeparableConvParamsFactory(o,i){return function(e,t,n){var r=Ln(o(9*e),[3,3,e,1]),e=Ln(o(e*t),[1,1,e,t]),t=Mn(o(t));return i.push({paramPath:n+"/depthwise_filter"},{paramPath:n+"/pointwise_filter"},{paramPath:n+"/bias"}),new SeparableConvParams(r,e,t)}}function loadSeparableConvParamsFactory(r){return function(e){var t=r(e+"/depthwise_filter",4),n=r(e+"/pointwise_filter",4),e=r(e+"/bias",1);return new SeparableConvParams(t,n,e)}}function extractWeightEntryFactory(o,i){return function(e,t,n){var r=o[e];if(!isTensor(r,t))throw new Error("expected weightMap["+e+"] to be a Tensor"+t+"D, instead have "+r);return i.push({originalPath:e,paramPath:n||e}),r}}function extractWeightsFactory(e){var n=e;return{extractWeights:function(e){var t=n.slice(0,e);return n=n.slice(e),t},getRemainingWeights:function(){return n}}}function extractorsFactory$9(e,t){var o=extractConvParamsFactory(e,t),i=extractSeparableConvParamsFactory(e,t);function a(e,t,n,r){return{conv0:(r=void 0===r?!1:r)?o(e,t,3,n+"/conv0"):i(e,t,n+"/conv0"),conv1:i(t,t,n+"/conv1"),conv2:i(t,t,n+"/conv2")}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:function(e,t,n,r){return{conv0:(r=a(e,t,n,r=void 0===r?!1:r)).conv0,conv1:r.conv1,conv2:r.conv2,conv3:i(t,t,n+"/conv3")}}}}function extractParams$7(e){var t=[],n=extractWeightsFactory(e),r=n.extractWeights,o=n.getRemainingWeights,i=extractorsFactory$9(r,t).extractDenseBlock4Params,e=i(3,32,"dense0",!0),n=i(32,64,"dense1"),r=i(64,128,"dense2"),i=i(128,256,"dense3");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:t,params:{dense0:e,dense1:n,dense2:r,dense3:i}}}function loadConvParamsFactory(t){return function(e){return{filters:t(e+"/filters",4),bias:t(e+"/bias",1)}}}function loadParamsFactory$1(e,t){var t=extractWeightEntryFactory(e,t),n=loadConvParamsFactory(t),r=loadSeparableConvParamsFactory(t);return{extractDenseBlock3Params:function(e,t){return{conv0:((t=void 0===t?!1:t)?n:r)(e+"/conv0"),conv1:r(e+"/conv1"),conv2:r(e+"/conv2")}},extractDenseBlock4Params:function(e,t){return{conv0:((t=void 0===t?!1:t)?n:r)(e+"/conv0"),conv1:r(e+"/conv1"),conv2:r(e+"/conv2"),conv3:r(e+"/conv3")}}}}function extractParamsFromWeigthMap$7(e){var t=[],n=loadParamsFactory$1(e,t).extractDenseBlock4Params,n={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2"),dense3:n("dense3")};return disposeUnusedWeightTensors(e,t),{params:n,paramMappings:t}}var FaceFeatureExtractor=(cib=NeuralNetwork,__extends(dib,cib),dib.prototype.forwardInput=function(t){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return Ze(function(){var e=denseBlock4(normalize$1(t.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(On(255)),n.dense0,!0),e=denseBlock4(e,n.dense1);return e=denseBlock4(e,n.dense2),e=denseBlock4(e,n.dense3),fl(e,[7,7],[2,2],"valid")})},dib.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},dib.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},dib.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$7(e)},dib.prototype.extractParams=function(e){return extractParams$7(e)},dib),cib;function dib(){return cib.call(this,"FaceFeatureExtractor")||this}function fullyConnectedLayer(e,t){return Ze(function(){return rc(el(e,t.weights),t.bias)})}function extractParams$6(e,t,n){var r=[],o=extractWeightsFactory(e),e=o.extractWeights,o=o.getRemainingWeights,n=extractFCParamsFactory(e,r)(t,n,"fc");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:r,params:{fc:n}}}function extractParamsFromWeigthMap$6(e){var t=[],n=extractWeightEntryFactory(e,t);var r,o={fc:{weights:n((r="fc")+"/weights",2),bias:n(r+"/bias",1)}};return disposeUnusedWeightTensors(e,t),{params:o,paramMappings:t}}function seperateWeightMaps(t){var n={},r={};return Object.keys(t).forEach(function(e){(e.startsWith("fc")?r:n)[e]=t[e]}),{featureExtractorMap:n,classifierMap:r}}var FaceProcessor=(Nib=NeuralNetwork,__extends(Oib,Nib),Object.defineProperty(Oib.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),Oib.prototype.runNet=function(t){var n=this,r=this.params;if(!r)throw new Error(this._name+" - load model before inference");return Ze(function(){var e=t instanceof NetInput?n.faceFeatureExtractor.forwardInput(t):t;return fullyConnectedLayer(e.as2D(e.shape[0],-1),r.fc)})},Oib.prototype.dispose=function(e){this.faceFeatureExtractor.dispose(e=void 0===e?!0:e),Nib.prototype.dispose.call(this,e)},Oib.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),e=t.params,t=t.paramMappings;this._params=e,this._paramMappings=t},Oib.prototype.extractClassifierParams=function(e){return extractParams$6(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},Oib.prototype.extractParamsFromWeigthMap=function(e){var t=seperateWeightMaps(e),e=t.featureExtractorMap,t=t.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(e),extractParamsFromWeigthMap$6(t)},Oib.prototype.extractParams=function(e){var t=this.getClassifierChannelsIn(),n=this.getClassifierChannelsOut(),t=n*t+n,n=e.slice(0,e.length-t),t=e.slice(e.length-t);return this.faceFeatureExtractor.extractWeights(n),this.extractClassifierParams(t)},Oib),Nib;function Oib(e,t){e=Nib.call(this,e)||this;return e._faceFeatureExtractor=t,e}var FACE_EXPRESSION_LABELS=["neutral","happy","sad","angry","fearful","disgusted","surprised"],FaceExpressions=(k8b.prototype.asSortedArray=function(){var t=this;return FACE_EXPRESSION_LABELS.map(function(e){return{expression:e,probability:t[e]}}).sort(function(e,t){return t.probability-e.probability})},k8b);function k8b(n){var r=this;if(7!==n.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+n.length);FACE_EXPRESSION_LABELS.forEach(function(e,t){r[e]=n[t]})}var FaceExpressionNet=(t8b=FaceProcessor,__extends(u8b,t8b),u8b.prototype.forwardInput=function(e){var t=this;return Ze(function(){return go(t.runNet(e))})},u8b.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},u8b.prototype.predictExpressions=function(i){return __awaiter(this,void 0,void 0,function(){var t,n,r,o=this;return __generator(this,function(e){switch(e.label){case 0:return[4,toNetInput(i)];case 1:return t=e.sent(),[4,this.forwardInput(t)];case 2:return n=e.sent(),[4,Promise.all(Ur(n).map(function(n){return __awaiter(o,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,n.data()];case 1:return t=e.sent(),n.dispose(),[2,t]}})})}))];case 3:return r=e.sent(),n.dispose(),r=r.map(function(e){return new FaceExpressions(e)}),[2,t.isBatchInput?r:r[0]]}})})},u8b.prototype.getDefaultModelName=function(){return"face_expression_model"},u8b.prototype.getClassifierChannelsIn=function(){return 256},u8b.prototype.getClassifierChannelsOut=function(){return 7},u8b),t8b;function u8b(e){return void 0===e&&(e=new FaceFeatureExtractor),t8b.call(this,"FaceExpressionNet",e)||this}function extendWithFaceExpressions(e,t){return Object.assign({},e,{expressions:t})}function isWithFaceLandmarks(e){return isWithFaceDetection(e)&&e.landmarks instanceof FaceLandmarks&&e.unshiftedLandmarks instanceof FaceLandmarks&&e.alignedRect instanceof FaceDetection}function extendWithFaceLandmarks(e,t){var n=e.detection.box,r=t.shiftBy(n.x,n.y),o=r.align(),n=e.detection.imageDims,n=new FaceDetection(e.detection.score,o.rescale(n.reverse()),n);return Object.assign({},e,{landmarks:r,unshiftedLandmarks:t,alignedRect:n})}function extractorsFactory$8(e,t){var r=extractConvParamsFactory(e,t),o=extractSeparableConvParamsFactory(e,t);return{extractConvParams:r,extractSeparableConvParams:o,extractReductionBlockParams:function(e,t,n){return{separable_conv0:o(e,t,n+"/separable_conv0"),separable_conv1:o(t,t,n+"/separable_conv1"),expansion_conv:r(e,t,1,n+"/expansion_conv")}},extractMainBlockParams:function(e,t){return{separable_conv0:o(e,e,t+"/separable_conv0"),separable_conv1:o(e,e,t+"/separable_conv1"),separable_conv2:o(e,e,t+"/separable_conv2")}}}}function extractParams$5(e,t){var n=[],r=extractWeightsFactory(e),o=r.extractWeights,i=r.getRemainingWeights,a=extractorsFactory$8(o,n),e=a.extractConvParams,r=a.extractSeparableConvParams,o=a.extractReductionBlockParams,s=a.extractMainBlockParams,e={conv_in:e(3,32,3,"entry_flow/conv_in"),reduction_block_0:o(32,64,"entry_flow/reduction_block_0"),reduction_block_1:o(64,128,"entry_flow/reduction_block_1")},u={};range(t,0,1).forEach(function(e){u["main_block_"+e]=s(128,"middle_flow/main_block_"+e)});r={reduction_block:o(128,256,"exit_flow/reduction_block"),separable_conv:r(256,512,"exit_flow/separable_conv")};if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{paramMappings:n,params:{entry_flow:e,middle_flow:u,exit_flow:r}}}function loadParamsFactory(e,t){var t=extractWeightEntryFactory(e,t),n=loadConvParamsFactory(t),r=loadSeparableConvParamsFactory(t);return{extractConvParams:n,extractSeparableConvParams:r,extractReductionBlockParams:function(e){return{separable_conv0:r(e+"/separable_conv0"),separable_conv1:r(e+"/separable_conv1"),expansion_conv:n(e+"/expansion_conv")}},extractMainBlockParams:function(e){return{separable_conv0:r(e+"/separable_conv0"),separable_conv1:r(e+"/separable_conv1"),separable_conv2:r(e+"/separable_conv2")}}}}function extractParamsFromWeigthMap$5(e,t){var n=[],r=loadParamsFactory(e,n),o=r.extractConvParams,i=r.extractSeparableConvParams,a=r.extractReductionBlockParams,s=r.extractMainBlockParams,o={conv_in:o("entry_flow/conv_in"),reduction_block_0:a("entry_flow/reduction_block_0"),reduction_block_1:a("entry_flow/reduction_block_1")},u={};range(t,0,1).forEach(function(e){u["main_block_"+e]=s("middle_flow/main_block_"+e)});i={reduction_block:a("exit_flow/reduction_block"),separable_conv:i("exit_flow/separable_conv")};return disposeUnusedWeightTensors(e,n),{params:{entry_flow:o,middle_flow:u,exit_flow:i},paramMappings:n}}function conv$1(e,t,n){return rc(qc(e,t.filters,n,"same"),t.bias)}function reductionBlock(e,t,n){n=depthwiseSeparableConv$1(n=(n=void 0===n?!0:n)?Bl(e):e,t.separable_conv0,[1,1]);return n=depthwiseSeparableConv$1(Bl(n),t.separable_conv1,[1,1]),n=hl(n,[3,3],[2,2],"same"),n=rc(n,conv$1(e,t.expansion_conv,[2,2]))}function mainBlock(e,t){var n=depthwiseSeparableConv$1(Bl(e),t.separable_conv0,[1,1]),n=depthwiseSeparableConv$1(Bl(n),t.separable_conv1,[1,1]);return n=depthwiseSeparableConv$1(Bl(n),t.separable_conv2,[1,1]),rc(n,e)}var TinyXception=(v9b=NeuralNetwork,__extends(w9b,v9b),w9b.prototype.forwardInput=function(n){var r=this,o=this.params;if(!o)throw new Error("TinyXception - load model before inference");return Ze(function(){var e=normalize$1(n.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(On(256)),t=reductionBlock(t=Bl(conv$1(e,o.entry_flow.conv_in,[2,2])),o.entry_flow.reduction_block_0,!1);return t=reductionBlock(t,o.entry_flow.reduction_block_1),range(r._numMainBlocks,0,1).forEach(function(e){t=mainBlock(t,o.middle_flow["main_block_"+e])}),t=reductionBlock(t,o.exit_flow.reduction_block),t=Bl(depthwiseSeparableConv$1(t,o.exit_flow.separable_conv,[1,1]))})},w9b.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},w9b.prototype.getDefaultModelName=function(){return"tiny_xception_model"},w9b.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$5(e,this._numMainBlocks)},w9b.prototype.extractParams=function(e){return extractParams$5(e,this._numMainBlocks)},w9b),v9b,Gender,akb;function w9b(e){var t=v9b.call(this,"TinyXception")||this;return t._numMainBlocks=e,t}function extractParams$4(e){var t=[],n=extractWeightsFactory(e),r=n.extractWeights,e=n.getRemainingWeights,n=extractFCParamsFactory(r,t),r=n(512,1,"fc/age"),n=n(512,2,"fc/gender");if(0!==e().length)throw new Error("weights remaing after extract: "+e().length);return{paramMappings:t,params:{fc:{age:r,gender:n}}}}function extractParamsFromWeigthMap$4(e){var t=[],n=extractWeightEntryFactory(e,t);function r(e){return{weights:n(e+"/weights",2),bias:n(e+"/bias",1)}}var o={fc:{age:r("fc/age"),gender:r("fc/gender")}};return disposeUnusedWeightTensors(e,t),{params:o,paramMappings:t}}akb=Gender=Gender||{},akb.FEMALE="female",akb.MALE="male";var AgeGenderNet=(bkb=NeuralNetwork,__extends(ckb,bkb),Object.defineProperty(ckb.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),ckb.prototype.runNet=function(t){var n=this,r=this.params;if(!r)throw new Error(this._name+" - load model before inference");return Ze(function(){var e=t instanceof NetInput?n.faceFeatureExtractor.forwardInput(t):t,e=fl(e,[7,7],[2,2],"valid").as2D(e.shape[0],-1);return{age:fullyConnectedLayer(e,r.fc.age).as1D(),gender:fullyConnectedLayer(e,r.fc.gender)}})},ckb.prototype.forwardInput=function(n){var r=this;return Ze(function(){var e=r.runNet(n),t=e.age,e=e.gender;return{age:t,gender:go(e)}})},ckb.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},ckb.prototype.predictAgeAndGender=function(i){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,s=this;return __generator(this,function(e){switch(e.label){case 0:return[4,toNetInput(i)];case 1:return t=e.sent(),[4,this.forwardInput(t)];case 2:return n=e.sent(),o=Ur(n.age),r=Ur(n.gender),o=o.map(function(e,t){return{ageTensor:e,genderTensor:r[t]}}),[4,Promise.all(o.map(function(e){var i=e.ageTensor,a=e.genderTensor;return __awaiter(s,void 0,void 0,function(){var t,n,r,o;return __generator(this,function(e){switch(e.label){case 0:return[4,i.data()];case 1:return t=e.sent()[0],[4,a.data()];case 2:return o=e.sent()[0],r=(n=.5<o)?Gender.MALE:Gender.FEMALE,o=n?o:1-o,i.dispose(),a.dispose(),[2,{age:t,gender:r,genderProbability:o}]}})})}))];case 3:return o=e.sent(),n.age.dispose(),n.gender.dispose(),[2,t.isBatchInput?o:o[0]]}})})},ckb.prototype.getDefaultModelName=function(){return"age_gender_model"},ckb.prototype.dispose=function(e){this.faceFeatureExtractor.dispose(e=void 0===e?!0:e),bkb.prototype.dispose.call(this,e)},ckb.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),e=t.params,t=t.paramMappings;this._params=e,this._paramMappings=t},ckb.prototype.extractClassifierParams=function(e){return extractParams$4(e)},ckb.prototype.extractParamsFromWeigthMap=function(e){var t=seperateWeightMaps(e),e=t.featureExtractorMap,t=t.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(e),extractParamsFromWeigthMap$4(t)},ckb.prototype.extractParams=function(e){var t=e.slice(0,e.length-1539),e=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(t),this.extractClassifierParams(e)},ckb),bkb;function ckb(e){void 0===e&&(e=new TinyXception(2));var t=bkb.call(this,"AgeGenderNet")||this;return t._faceFeatureExtractor=e,t}var FaceLandmark68NetBase=(alb=FaceProcessor,__extends(blb,alb),blb.prototype.postProcess=function(e,o,t){var i=t.map(function(e){var t=e.width,n=e.height,e=o/Math.max(n,t);return{width:t*e,height:n*e}}),a=i.length;return Ze(function(){function n(e,t){return Pr([Hn([68],e),Hn([68],t)],1).as2D(1,136).as1D()}function r(e,t){var e=(n=i[e]).width,n=n.height;return t(e,n)?Math.abs(e-n)/2:0}return e.mul(Hn([a,136],o)).sub(Pr(Array.from(Array(a),function(e,t){return n(r(t,function(e,t){return e<t}),r(t,function(e,t){return t<e}))}))).div(Pr(Array.from(Array(a),function(e,t){return n(i[t].width,i[t].height)})))})},blb.prototype.forwardInput=function(t){var n=this;return Ze(function(){var e=n.runNet(t);return n.postProcess(e,t.inputSize,t.inputDimensions.map(function(e){return{height:e[0],width:e[1]}}))})},blb.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},blb.prototype.detectLandmarks=function(o){return __awaiter(this,void 0,void 0,function(){var u,t,n,r=this;return __generator(this,function(e){switch(e.label){case 0:return[4,toNetInput(o)];case 1:return u=e.sent(),t=Ze(function(){return Ur(r.forwardInput(u))}),[4,Promise.all(t.map(function(a,s){return __awaiter(r,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return r=(n=Array).from,[4,a.data()];case 1:return t=r.apply(n,[e.sent()]),o=t.filter(function(e,t){return isEven(t)}),i=t.filter(function(e,t){return!isEven(t)}),[2,new FaceLandmarks68(Array(68).fill(0).map(function(e,t){return new Point(o[t],i[t])}),{height:u.getInputHeight(s),width:u.getInputWidth(s)})]}})})}))];case 2:return n=e.sent(),t.forEach(function(e){return e.dispose()}),[2,u.isBatchInput?n:n[0]]}})})},blb.prototype.getClassifierChannelsOut=function(){return 136},blb),alb;function blb(){return null!==alb&&alb.apply(this,arguments)||this}var FaceLandmark68Net=(jmb=FaceLandmark68NetBase,__extends(kmb,jmb),kmb.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},kmb.prototype.getClassifierChannelsIn=function(){return 256},kmb),jmb;function kmb(e){return void 0===e&&(e=new FaceFeatureExtractor),jmb.call(this,"FaceLandmark68Net",e)||this}function extractParamsFromWeigthMapTiny(e){var t=[],n=loadParamsFactory$1(e,t).extractDenseBlock3Params,n={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2")};return disposeUnusedWeightTensors(e,t),{params:n,paramMappings:t}}function extractParamsTiny(e){var t=[],n=extractWeightsFactory(e),r=n.extractWeights,o=n.getRemainingWeights,e=extractorsFactory$9(r,t).extractDenseBlock3Params,n=e(3,32,"dense0",!0),r=e(32,64,"dense1"),e=e(64,128,"dense2");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:t,params:{dense0:n,dense1:r,dense2:e}}}var TinyFaceFeatureExtractor=(zmb=NeuralNetwork,__extends(Amb,zmb),Amb.prototype.forwardInput=function(t){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return Ze(function(){var e=denseBlock3(normalize$1(t.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(On(255)),n.dense0,!0),e=denseBlock3(e,n.dense1);return e=denseBlock3(e,n.dense2),fl(e,[14,14],[2,2],"valid")})},Amb.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},Amb.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},Amb.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMapTiny(e)},Amb.prototype.extractParams=function(e){return extractParamsTiny(e)},Amb),zmb;function Amb(){return zmb.call(this,"TinyFaceFeatureExtractor")||this}var FaceLandmark68TinyNet=(Mmb=FaceLandmark68NetBase,__extends(Nmb,Mmb),Nmb.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},Nmb.prototype.getClassifierChannelsIn=function(){return 128},Nmb),Mmb,Pmb;function Nmb(e){return void 0===e&&(e=new TinyFaceFeatureExtractor),Mmb.call(this,"FaceLandmark68TinyNet",e)||this}function Qmb(){return null!==Pmb&&Pmb.apply(this,arguments)||this}function scale(e,t){return rc(gc(e,t.weights),t.biases)}function convLayer(e,t,n,r,o){var i=t.conv,a=i.filters,i=i.bias,o=qc(e,a,n,o=void 0===o?"same":o);return o=scale(o=rc(o,i),t.scale),r?Bl(o):o}function conv(e,t){return convLayer(e,t,[1,1],!0)}function convNoRelu(e,t){return convLayer(e,t,[1,1],!1)}function convDown(e,t){return convLayer(e,t,[2,2],!0,"valid")}function extractorsFactory$7(i,o){function a(e,t,n,r){n=function(e,t,n){var r=i(e),o=r.length/(t*n*n);if(isFloat(o))throw new Error("depth has to be an integer: "+o+", weights.length: "+r.length+", numFilters: "+t+", filterSize: "+n);return Ze(function(){return Wl(Ln(r,[t,o,n,n]),[2,3,1,0])})}(e,t,n),t=Mn(i(t));return o.push({paramPath:r+"/filters"},{paramPath:r+"/bias"}),{filters:n,bias:t}}function s(e,t,n,r){return{conv:a(e,t,n,r+"/conv"),scale:(n=r+"/scale",t=Mn(i(r=t)),r=Mn(i(r)),o.push({paramPath:n+"/weights"},{paramPath:n+"/biases"}),{weights:t,biases:r})}}return{extractConvLayerParams:s,extractResidualLayerParams:function(e,t,n,r,o){return{conv1:s(((o=void 0===o?!1:o)?.5:1)*e,t,n,r+"/conv1"),conv2:s(e,t,n,r+"/conv2")}}}}function extractParams$3(e){var t=extractWeightsFactory(e),n=t.extractWeights,r=t.getRemainingWeights,o=[],i=extractorsFactory$7(n,o),a=i.extractConvLayerParams,s=i.extractResidualLayerParams,u=a(4704,32,7,"conv32_down"),c=s(9216,32,3,"conv32_1"),l=s(9216,32,3,"conv32_2"),h=s(9216,32,3,"conv32_3"),d=s(36864,64,3,"conv64_down",!0),p=s(36864,64,3,"conv64_1"),f=s(36864,64,3,"conv64_2"),m=s(36864,64,3,"conv64_3"),g=s(147456,128,3,"conv128_down",!0),v=s(147456,128,3,"conv128_1"),b=s(147456,128,3,"conv128_2"),e=s(589824,256,3,"conv256_down",!0),t=s(589824,256,3,"conv256_1"),i=s(589824,256,3,"conv256_2"),a=s(589824,256,3,"conv256_down_out"),s=Ze(function(){return Wl(Bn(n(32768),[128,256]),[1,0])});if(o.push({paramPath:"fc"}),0!==r().length)throw new Error("weights remaing after extract: "+r().length);return{params:{conv32_down:u,conv32_1:c,conv32_2:l,conv32_3:h,conv64_down:d,conv64_1:p,conv64_2:f,conv64_3:m,conv128_down:g,conv128_1:v,conv128_2:b,conv256_down:e,conv256_1:t,conv256_2:i,conv256_down_out:a,fc:s},paramMappings:o}}function extractorsFactory$6(e,t){var n=extractWeightEntryFactory(e,t);function r(e){return{conv:{filters:n(e+"/conv/filters",4),bias:n(e+"/conv/bias",1)},scale:{weights:n((e=e)+"/scale/weights",1),biases:n(e+"/scale/biases",1)}}}return{extractConvLayerParams:r,extractResidualLayerParams:function(e){return{conv1:r(e+"/conv1"),conv2:r(e+"/conv2")}}}}function extractParamsFromWeigthMap$3(e){var t=[],n=extractorsFactory$6(e,t),r=n.extractConvLayerParams,o=n.extractResidualLayerParams,i=r("conv32_down"),a=o("conv32_1"),s=o("conv32_2"),u=o("conv32_3"),c=o("conv64_down"),l=o("conv64_1"),h=o("conv64_2"),d=o("conv64_3"),p=o("conv128_down"),f=o("conv128_1"),m=o("conv128_2"),g=o("conv256_down"),v=o("conv256_1"),n=o("conv256_2"),r=o("conv256_down_out"),o=e.fc;if(t.push({originalPath:"fc",paramPath:"fc"}),!isTensor2D(o))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+o);o={conv32_down:i,conv32_1:a,conv32_2:s,conv32_3:u,conv64_down:c,conv64_1:l,conv64_2:h,conv64_3:d,conv128_down:p,conv128_1:f,conv128_2:m,conv256_down:g,conv256_1:v,conv256_2:n,conv256_down_out:r,fc:o};return disposeUnusedWeightTensors(e,t),{params:o,paramMappings:t}}function residual(e,t){var n=convNoRelu(n=conv(e,t.conv1),t.conv2);return n=rc(n,e),n=Bl(n)}function residualDown(e,t){var n=convDown(e,t.conv1);n=convNoRelu(n,t.conv2);var r=fl(e,2,2,"valid"),o=Gn(r.shape),t=r.shape[3]!==n.shape[3];return(r.shape[1]!==n.shape[1]||r.shape[2]!==n.shape[2])&&((e=__spreadArrays(n.shape))[1]=1,e=Gn(e),(e=__spreadArrays((n=Yn([n,e],1)).shape))[2]=1,e=Gn(e),n=Yn([n,e],2)),r=t?Yn([r,o],3):r,n=rc(r,n),n=Bl(n)}Pmb=FaceLandmark68Net,__extends(Qmb,Pmb);var FaceRecognitionNet=(ipb=NeuralNetwork,__extends(jpb,ipb),jpb.prototype.forwardInput=function(t){var n=this.params;if(!n)throw new Error("FaceRecognitionNet - load model before inference");return Ze(function(){var e=convDown(normalize$1(t.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div(On(256)),n.conv32_down);e=residual(e=hl(e,3,2,"valid"),n.conv32_1),e=residual(e,n.conv32_2),e=residual(e,n.conv32_3),e=residual(e=residualDown(e,n.conv64_down),n.conv64_1),e=residual(e,n.conv64_2),e=residual(e,n.conv64_3),e=residual(e=residualDown(e,n.conv128_down),n.conv128_1),e=residual(e,n.conv128_2),e=residual(e=residualDown(e,n.conv256_down),n.conv256_1);e=(e=residualDown(e=residual(e,n.conv256_2),n.conv256_down_out)).mean([1,2]);return el(e,n.fc)})},jpb.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},jpb.prototype.computeFaceDescriptor=function(i){return __awaiter(this,void 0,void 0,function(){var t,n,r,o=this;return __generator(this,function(e){switch(e.label){case 0:return[4,toNetInput(i)];case 1:return t=e.sent(),n=Ze(function(){return Ur(o.forwardInput(t))}),[4,Promise.all(n.map(function(e){return e.data()}))];case 2:return r=e.sent(),n.forEach(function(e){return e.dispose()}),[2,t.isBatchInput?r:r[0]]}})})},jpb.prototype.getDefaultModelName=function(){return"face_recognition_model"},jpb.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$3(e)},jpb.prototype.extractParams=function(e){return extractParams$3(e)},jpb),ipb;function jpb(){return ipb.call(this,"FaceRecognitionNet")||this}function extendWithFaceDescriptor(e,t){return Object.assign({},e,{descriptor:t})}function extendWithAge(e,t){return Object.assign({},e,{age:t})}function extendWithGender(e,t,n){return Object.assign({},e,{gender:t,genderProbability:n})}var MtcnnOptions=(Object.defineProperty(Ppb.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(Ppb.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(Ppb.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(Ppb.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(Ppb.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),Ppb);function Ppb(e){var t=void 0===e?{}:e,n=t.minFaceSize,r=t.scaleFactor,o=t.maxNumScales,e=t.scoreThresholds,t=t.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=n||20,this._scaleFactor=r||.709,this._maxNumScales=o||10,this._scoreThresholds=e||[.6,.7,.7],this._scaleSteps=t,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||1<=this._scaleFactor)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(e){return"number"!=typeof e}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(e){return"number"!=typeof e})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}function extractorsFactory$5(c,l){function o(e,t,n,r,o){e=Ln(c(e*t*n*n),[n,n,e,t]),t=Mn(c(t));return l.push({paramPath:r+"/filters"},{paramPath:r+"/"+(o?"batch_norm_offset":"bias")}),{filters:e,bias:t}}function h(e,t,n,r){r=o(e,t,n,r,!0);return{filters:r.filters,batch_norm_offset:r.bias}}function e(e,t,n){var r,o,i,a,s,u;return{depthwise_conv:(o=n+"/depthwise_conv",i=Ln(c(9*(r=e)),[3,3,r,1]),a=Mn(c(r)),s=Mn(c(r)),u=Mn(c(r)),r=Mn(c(r)),l.push({paramPath:o+"/filters"},{paramPath:o+"/batch_norm_scale"},{paramPath:o+"/batch_norm_offset"},{paramPath:o+"/batch_norm_mean"},{paramPath:o+"/batch_norm_variance"}),{filters:i,batch_norm_scale:a,batch_norm_offset:s,batch_norm_mean:u,batch_norm_variance:r}),pointwise_conv:h(e,t,1,n+"/pointwise_conv")}}return{extractMobilenetV1Params:function(){return{conv_0:h(3,32,3,"mobilenetv1/conv_0"),conv_1:e(32,64,"mobilenetv1/conv_1"),conv_2:e(64,128,"mobilenetv1/conv_2"),conv_3:e(128,128,"mobilenetv1/conv_3"),conv_4:e(128,256,"mobilenetv1/conv_4"),conv_5:e(256,256,"mobilenetv1/conv_5"),conv_6:e(256,512,"mobilenetv1/conv_6"),conv_7:e(512,512,"mobilenetv1/conv_7"),conv_8:e(512,512,"mobilenetv1/conv_8"),conv_9:e(512,512,"mobilenetv1/conv_9"),conv_10:e(512,512,"mobilenetv1/conv_10"),conv_11:e(512,512,"mobilenetv1/conv_11"),conv_12:e(512,1024,"mobilenetv1/conv_12"),conv_13:e(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:h(1024,256,1,"prediction_layer/conv_0"),conv_1:h(256,512,3,"prediction_layer/conv_1"),conv_2:h(512,128,1,"prediction_layer/conv_2"),conv_3:h(128,256,3,"prediction_layer/conv_3"),conv_4:h(256,128,1,"prediction_layer/conv_4"),conv_5:h(128,256,3,"prediction_layer/conv_5"),conv_6:h(256,64,1,"prediction_layer/conv_6"),conv_7:h(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:o(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:o(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:o(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:o(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:o(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:o(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:o(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:o(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:o(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:o(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:o(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:o(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}function extractParams$2(e){var t=[],n=extractWeightsFactory(e),r=n.extractWeights,o=n.getRemainingWeights,e=extractorsFactory$5(r,t),n=e.extractMobilenetV1Params,e=e.extractPredictionLayerParams,n=n(),e=e(),r={extra_dim:Pn(r(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{mobilenetv1:n,prediction_layer:e,output_layer:r},paramMappings:t}}function extractorsFactory$4(e,t){var o=extractWeightEntryFactory(e,t);function i(e,t,n){return{filters:o(e+"/Conv2d_"+t+"_pointwise/weights",4,n+"/filters"),batch_norm_offset:o(e+"/Conv2d_"+t+"_pointwise/convolution_bn_offset",1,n+"/batch_norm_offset")}}function n(e){var t="mobilenetv1/conv_"+e,n="MobilenetV1/Conv2d_"+e+"_depthwise",r=t+"/depthwise_conv",t=t+"/pointwise_conv";return{depthwise_conv:{filters:o(n+"/depthwise_weights",4,r+"/filters"),batch_norm_scale:o(n+"/BatchNorm/gamma",1,r+"/batch_norm_scale"),batch_norm_offset:o(n+"/BatchNorm/beta",1,r+"/batch_norm_offset"),batch_norm_mean:o(n+"/BatchNorm/moving_mean",1,r+"/batch_norm_mean"),batch_norm_variance:o(n+"/BatchNorm/moving_variance",1,r+"/batch_norm_variance")},pointwise_conv:i("MobilenetV1",e,t)}}function r(e,t){return{filters:o(e+"/weights",4,t+"/filters"),bias:o(e+"/biases",1,t+"/bias")}}function a(e){return{box_encoding_predictor:r("Prediction/BoxPredictor_"+e+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+e+"/box_encoding_predictor"),class_predictor:r("Prediction/BoxPredictor_"+e+"/ClassPredictor","prediction_layer/box_predictor_"+e+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:i("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:n(1),conv_2:n(2),conv_3:n(3),conv_4:n(4),conv_5:n(5),conv_6:n(6),conv_7:n(7),conv_8:n(8),conv_9:n(9),conv_10:n(10),conv_11:n(11),conv_12:n(12),conv_13:n(13)}},extractPredictionLayerParams:function(){return{conv_0:i("Prediction",0,"prediction_layer/conv_0"),conv_1:i("Prediction",1,"prediction_layer/conv_1"),conv_2:i("Prediction",2,"prediction_layer/conv_2"),conv_3:i("Prediction",3,"prediction_layer/conv_3"),conv_4:i("Prediction",4,"prediction_layer/conv_4"),conv_5:i("Prediction",5,"prediction_layer/conv_5"),conv_6:i("Prediction",6,"prediction_layer/conv_6"),conv_7:i("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:a(0),box_predictor_1:a(1),box_predictor_2:a(2),box_predictor_3:a(3),box_predictor_4:a(4),box_predictor_5:a(5)}}}}function extractParamsFromWeigthMap$2(e){var t=[],n=extractorsFactory$4(e,t),r=n.extractMobilenetV1Params,o=n.extractPredictionLayerParams,n=e["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!isTensor3D(n))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+n);n={mobilenetv1:r(),prediction_layer:o(),output_layer:{extra_dim:n}};return disposeUnusedWeightTensors(e,t),{params:n,paramMappings:t}}function pointwiseConvLayer(t,n,r){return Ze(function(){var e=qc(t,n.filters,r,"same"),e=rc(e,n.batch_norm_offset);return hu(e,0,6)})}var epsilon=.0010000000474974513;function depthwiseConvLayer(t,n,r){return Ze(function(){var e=Yc(t,n.filters,r,"same"),e=ju(e,n.batch_norm_mean,n.batch_norm_variance,n.batch_norm_offset,n.batch_norm_scale,epsilon);return hu(e,0,6)})}function getStridesForLayerIdx(t){return[2,4,6,12].some(function(e){return e===t})?[2,2]:[1,1]}function mobileNetV1(e,t){return Ze(function(){var r=null,o=pointwiseConvLayer(e,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach(function(e,t){var n=t+1,t=getStridesForLayerIdx(n);o=pointwiseConvLayer(o=depthwiseConvLayer(o,e.depthwise_conv,t),e.pointwise_conv,[1,1]),11===n&&(r=o)}),null===r)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:o,conv11:r}})}function nonMaxSuppression(o,e,t,i,a){var n=o.shape[0],s=Math.min(t,n),e=e.map(function(e,t){return{score:e,boxIndex:t}}).filter(function(e){return e.score>a}).sort(function(e,t){return t.score-e.score}),u=[];return e.forEach(function(e){if(!(u.length>=s)){for(var t=e.score,n=u.length-1;0<=n;--n){var r=IOU(o,e.boxIndex,u[n]);if(0!==r&&(e.score*=r<=i?1:0,e.score<=a))break}t===e.score&&u.push(e.boxIndex)}}),u}function IOU(e,t,n){var r=e.arraySync(),o=Math.min(r[t][0],r[t][2]),i=Math.min(r[t][1],r[t][3]),a=Math.max(r[t][0],r[t][2]),s=Math.max(r[t][1],r[t][3]),u=Math.min(r[n][0],r[n][2]),c=Math.min(r[n][1],r[n][3]),e=Math.max(r[n][0],r[n][2]),t=Math.max(r[n][1],r[n][3]),r=(a-o)*(s-i),n=(e-u)*(t-c);if(r<=0||n<=0)return 0;u=Math.max(o,u),c=Math.max(i,c),e=Math.min(a,e),t=Math.min(s,t),c=Math.max(e-u,0)*Math.max(t-c,0);return c/(r+n-c)}function getCenterCoordinatesAndSizesLayer(e){var t=Ur(Wl(e,[1,0])),e=[Cc(t[2],t[0]),Cc(t[3],t[1])];return{sizes:e,centers:[rc(t[0],sc(e[0],On(2))),rc(t[1],sc(e[1],On(2)))]}}function decodeBoxesLayer(e,t){var n=getCenterCoordinatesAndSizesLayer(e),r=n.sizes,o=n.centers,i=Ur(Wl(t,[1,0])),e=sc(gc(vu(sc(i[2],On(5))),r[0]),On(2)),n=rc(gc(sc(i[0],On(10)),r[0]),o[0]),t=sc(gc(vu(sc(i[3],On(5))),r[1]),On(2)),o=rc(gc(sc(i[1],On(10)),r[1]),o[1]);return Wl(Pr([Cc(n,e),Cc(o,t),rc(n,e),rc(o,t)]),[1,0])}function outputLayer(r,o,i){return Ze(function(){var e=r.shape[0],t=decodeBoxesLayer(Or(Lr(i.extra_dim,[e,1,1]),[-1,4]),Or(r,[-1,4])),t=Or(t,[e,t.shape[0]/e,4]),n=Iu(ml(o,[0,0,1],[-1,-1,-1])),n=ml(n,[0,0,0],[-1,-1,1]),n=Or(n,[e,n.shape[1]]);return{boxes:Ur(t),scores:Ur(n)}})}function boxPredictionLayer(t,n){return Ze(function(){var e=t.shape[0];return{boxPredictionEncoding:Or(convLayer$1(t,n.box_encoding_predictor),[e,-1,1,4]),classPrediction:Or(convLayer$1(t,n.class_predictor),[e,-1,3])}})}function predictionLayer(a,s,u){return Ze(function(){var e=pointwiseConvLayer(a,u.conv_0,[1,1]),t=pointwiseConvLayer(e,u.conv_1,[2,2]),n=pointwiseConvLayer(t,u.conv_2,[1,1]),r=pointwiseConvLayer(n,u.conv_3,[2,2]),o=pointwiseConvLayer(r,u.conv_4,[1,1]),i=pointwiseConvLayer(o,u.conv_5,[2,2]),e=pointwiseConvLayer(i,u.conv_6,[1,1]),n=pointwiseConvLayer(e,u.conv_7,[2,2]),o=boxPredictionLayer(s,u.box_predictor_0),e=boxPredictionLayer(a,u.box_predictor_1),t=boxPredictionLayer(t,u.box_predictor_2),r=boxPredictionLayer(r,u.box_predictor_3),i=boxPredictionLayer(i,u.box_predictor_4),n=boxPredictionLayer(n,u.box_predictor_5);return{boxPredictions:Yn([o.boxPredictionEncoding,e.boxPredictionEncoding,t.boxPredictionEncoding,r.boxPredictionEncoding,i.boxPredictionEncoding,n.boxPredictionEncoding],1),classPredictions:Yn([o.classPrediction,e.classPrediction,t.classPrediction,r.classPrediction,i.classPrediction,n.classPrediction],1)}})}var SsdMobilenetv1Options=(Object.defineProperty(kub.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(kub.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),kub);function kub(e){var t=void 0===e?{}:e,e=t.minConfidence,t=t.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=e||.5,this._maxResults=t||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||1<=this._minConfidence)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}var SsdMobilenetv1=(pub=NeuralNetwork,__extends(qub,pub),qub.prototype.forwardInput=function(t){var n=this.params;if(!n)throw new Error("SsdMobilenetv1 - load model before inference");return Ze(function(){var e=t.toBatchTensor(512,!1).toFloat(),e=mobileNetV1(Cc(gc(e,On(.007843137718737125)),On(1)),n.mobilenetv1),e=predictionLayer(e.out,e.conv11,n.prediction_layer);return outputLayer(e.boxPredictions,e.classPredictions,n.output_layer)})},qub.prototype.forward=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent()])]}})})},qub.prototype.locateFaces=function(b,y){return void 0===y&&(y={}),__awaiter(this,void 0,void 0,function(){var t,n,i,r,o,a,s,u,c,l,h,d,p,f,m,g,v;return __generator(this,function(e){switch(e.label){case 0:return d=new SsdMobilenetv1Options(y),t=d.maxResults,n=d.minConfidence,[4,toNetInput(b)];case 1:for(i=e.sent(),p=this.forwardInput(i),r=p.boxes,o=p.scores,a=r[0],s=o[0],u=1;u<r.length;u++)r[u].dispose(),o[u].dispose();return h=(l=Array).from,[4,s.data()];case 2:return c=h.apply(l,[e.sent()]),v=nonMaxSuppression(a,c,t,.5,n),d=i.getReshapedInputDimensions(0),p=i.inputSize,f=p/d.width,m=p/d.height,g=a.arraySync(),v=v.map(function(e){var t=[Math.max(0,g[e][0]),Math.min(1,g[e][2])].map(function(e){return e*m}),n=t[0],r=t[1],o=[Math.max(0,g[e][1]),Math.min(1,g[e][3])].map(function(e){return e*f}),t=o[0],o=o[1];return new FaceDetection(c[e],new Rect(t,n,o-t,r-n),{height:i.getInputHeight(0),width:i.getInputWidth(0)})}),a.dispose(),s.dispose(),[2,v]}})})},qub.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},qub.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$2(e)},qub.prototype.extractParams=function(e){return extractParams$2(e)},qub),pub,jvb;function qub(){return pub.call(this,"SsdMobilenetv1")||this}function kvb(){return null!==jvb&&jvb.apply(this,arguments)||this}jvb=SsdMobilenetv1,__extends(kvb,jvb);var IOU_THRESHOLD$1=.4,BOX_ANCHORS$1=[new Point(.738768,.874946),new Point(2.42204,2.65704),new Point(4.30971,7.04493),new Point(10.246,4.59428),new Point(12.6868,11.8741)],BOX_ANCHORS_SEPARABLE=[new Point(1.603231,2.094468),new Point(6.041143,7.080126),new Point(2.882459,3.518061),new Point(4.266906,5.178857),new Point(9.041765,10.66308)],MEAN_RGB_SEPARABLE=[117.001,114.697,97.404],DEFAULT_MODEL_NAME="tiny_yolov2_model",DEFAULT_MODEL_NAME_SEPARABLE_CONV="tiny_yolov2_separable_conv_model",isNumber=function(e){return"number"==typeof e},TinyYolov2SizeType,Pwb;function validateConfig(e){if(!e)throw new Error("invalid config: "+e);if("boolean"!=typeof e.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+e.withSeparableConvs);if(!isNumber(e.iouThreshold)||e.iouThreshold<0||1<e.iouThreshold)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+e.iouThreshold);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every(function(e){return"string"==typeof e}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(e.classes));if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map(function(e){return e||{}}).every(function(e){return isNumber(e.x)&&isNumber(e.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(e.anchors));if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(isNumber)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(e.meanRgb))}function leaky(t){return Ze(function(){var e=gc(t,On(.10000000149011612));return rc(Bl(Cc(t,e)),e)})}function convWithBatchNorm(t,n){return Ze(function(){var e=Ir(t,[[0,0],[1,1],[1,1],[0,0]]),e=qc(e,n.conv.filters,[1,1],"valid");return e=Cc(e,n.bn.sub),e=gc(e,n.bn.truediv),leaky(rc(e,n.conv.bias))})}function depthwiseSeparableConv(t,n){return Ze(function(){var e=Ir(t,[[0,0],[1,1],[1,1],[0,0]]),e=Jc(e,n.depthwise_filter,n.pointwise_filter,[1,1],"valid");return leaky(rc(e,n.bias))})}function extractorsFactory$3(r,o){var i=extractConvParamsFactory(r,o);var e=extractSeparableConvParamsFactory(r,o);return{extractConvParams:i,extractConvWithBatchNormParams:function(e,t,n){return{conv:i(e,t,3,n+"/conv"),bn:(e=n+"/bn",t=Mn(r(n=t)),n=Mn(r(n)),o.push({paramPath:e+"/sub"},{paramPath:e+"/truediv"}),{sub:t,truediv:n})}},extractSeparableConvParams:e}}function extractParams$1(e,t,n,r){var o,i,a,s,u,c,l,h,d,p=extractWeightsFactory(e),f=p.extractWeights,m=p.getRemainingWeights,g=[],e=extractorsFactory$3(f,g),p=e.extractConvParams,f=e.extractConvWithBatchNormParams,e=e.extractSeparableConvParams;if(n=t.withSeparableConvs?(o=r[0],i=r[1],a=r[2],s=r[3],u=r[4],c=r[5],l=r[6],h=r[7],d=r[8],{conv0:t.isFirstLayerConv2d?p(o,i,3,"conv0"):e(o,i,"conv0"),conv1:e(i,a,"conv1"),conv2:e(a,s,"conv2"),conv3:e(s,u,"conv3"),conv4:e(u,c,"conv4"),conv5:e(c,l,"conv5"),conv6:h?e(l,h,"conv6"):void 0,conv7:d?e(h,d,"conv7"):void 0,conv8:p(d||h||l,5*n,1,"conv8")}):(o=r[0],i=r[1],a=r[2],s=r[3],u=r[4],c=r[5],l=r[6],h=r[7],d=r[8],{conv0:f(o,i,"conv0"),conv1:f(i,a,"conv1"),conv2:f(a,s,"conv2"),conv3:f(s,u,"conv3"),conv4:f(u,c,"conv4"),conv5:f(c,l,"conv5"),conv6:f(l,h,"conv6"),conv7:f(h,d,"conv7"),conv8:p(d,5*n,1,"conv8")}),0!==m().length)throw new Error("weights remaing after extract: "+m().length);return{params:n,paramMappings:g}}function extractorsFactory$2(e,t){var n=extractWeightEntryFactory(e,t);function r(e){return{filters:n(e+"/filters",4),bias:n(e+"/bias",1)}}return{extractConvParams:r,extractConvWithBatchNormParams:function(e){return{conv:r(e+"/conv"),bn:{sub:n((e=e+"/bn")+"/sub",1),truediv:n(e+"/truediv",1)}}},extractSeparableConvParams:loadSeparableConvParamsFactory(n)}}function extractParamsFromWeigthMap$1(e,t){var n=[],r=extractorsFactory$2(e,n),o=r.extractConvParams,i=r.extractConvWithBatchNormParams,a=r.extractSeparableConvParams;return o=t.withSeparableConvs?(r=t.filterSizes&&t.filterSizes.length||9,{conv0:(t.isFirstLayerConv2d?o:a)("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:7<r?a("conv6"):void 0,conv7:8<r?a("conv7"):void 0,conv8:o("conv8")}):{conv0:i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:i("conv6"),conv7:i("conv7"),conv8:o("conv8")},disposeUnusedWeightTensors(e,n),{params:o,paramMappings:n}}Pwb=TinyYolov2SizeType=TinyYolov2SizeType||{},Pwb[Pwb.XS=224]="XS",Pwb[Pwb.SM=320]="SM",Pwb[Pwb.MD=416]="MD",Pwb[Pwb.LG=608]="LG";var TinyYolov2Options=(Object.defineProperty(Qwb.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(Qwb.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),Qwb);function Qwb(e){var t=void 0===e?{}:e,e=t.inputSize,t=t.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=e||416,this._scoreThreshold=t||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||1<=this._scoreThreshold)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}var TinyYolov2Base=(Vwb=NeuralNetwork,__extends(Wwb,Vwb),Object.defineProperty(Wwb.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(Wwb.prototype,"withClassScores",{get:function(){return this.config.withClassScores||1<this.config.classes.length},enumerable:!0,configurable:!0}),Object.defineProperty(Wwb.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),Wwb.prototype.runTinyYolov2=function(e,t){e=convWithBatchNorm(e,t.conv0);return e=convWithBatchNorm(e=hl(e,[2,2],[2,2],"same"),t.conv1),e=convWithBatchNorm(e=hl(e,[2,2],[2,2],"same"),t.conv2),e=convWithBatchNorm(e=hl(e,[2,2],[2,2],"same"),t.conv3),e=convWithBatchNorm(e=hl(e,[2,2],[2,2],"same"),t.conv4),e=convWithBatchNorm(e=hl(e,[2,2],[2,2],"same"),t.conv5),e=convWithBatchNorm(e=hl(e,[2,2],[1,1],"same"),t.conv6),convLayer$1(e=convWithBatchNorm(e,t.conv7),t.conv8,"valid",!1)},Wwb.prototype.runMobilenet=function(e,t){e=this.config.isFirstLayerConv2d?leaky(convLayer$1(e,t.conv0,"valid",!1)):depthwiseSeparableConv(e,t.conv0);return e=depthwiseSeparableConv(e=hl(e,[2,2],[2,2],"same"),t.conv1),e=depthwiseSeparableConv(e=hl(e,[2,2],[2,2],"same"),t.conv2),e=depthwiseSeparableConv(e=hl(e,[2,2],[2,2],"same"),t.conv3),e=depthwiseSeparableConv(e=hl(e,[2,2],[2,2],"same"),t.conv4),e=depthwiseSeparableConv(e=hl(e,[2,2],[2,2],"same"),t.conv5),e=hl(e,[2,2],[1,1],"same"),e=t.conv6?depthwiseSeparableConv(e,t.conv6):e,convLayer$1(e=t.conv7?depthwiseSeparableConv(e,t.conv7):e,t.conv8,"valid",!1)},Wwb.prototype.forwardInput=function(t,n){var r=this,o=this.params;if(!o)throw new Error("TinyYolov2 - load model before inference");return Ze(function(){var e=t.toBatchTensor(n,!1).toFloat();return e=(e=r.config.meanRgb?normalize$1(e,r.config.meanRgb):e).div(On(256)),r.config.withSeparableConvs?r.runMobilenet(e,o):r.runTinyYolov2(e,o)})},Wwb.prototype.forward=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[4,t.apply(this,[e.sent(),r])];case 2:return[2,e.sent()]}})})},Wwb.prototype.detect=function(p,f){return void 0===f&&(f={}),__awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a,s,u,c,l,h,d=this;return __generator(this,function(e){switch(e.label){case 0:return h=new TinyYolov2Options(f),t=h.inputSize,n=h.scoreThreshold,[4,toNetInput(p)];case 1:return r=e.sent(),[4,this.forwardInput(r,t)];case 2:return o=e.sent(),i=Ze(function(){return Ur(o)[0].expandDims()}),a={width:r.getInputWidth(0),height:r.getInputHeight(0)},[4,this.extractBoxes(i,r.getReshapedInputDimensions(0),n)];case 3:return h=e.sent(),o.dispose(),i.dispose(),s=h.map(function(e){return e.box}),u=h.map(function(e){return e.score}),c=h.map(function(e){return e.classScore}),l=h.map(function(e){return d.config.classes[e.label]}),h=nonMaxSuppression$1(s.map(function(e){return e.rescale(t)}),u,this.config.iouThreshold,!0),[2,h.map(function(e){return new ObjectDetection(u[e],c[e],l[e],s[e],a)})]}})})},Wwb.prototype.getDefaultModelName=function(){return""},Wwb.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$1(e,this.config)},Wwb.prototype.extractParams=function(e){var t=this.config.filterSizes||Wwb.DEFAULT_FILTER_SIZES,n=t?t.length:void 0;if(7!==n&&8!==n&&9!==n)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+n+" filterSizes in config");return extractParams$1(e,this.config,this.boxEncodingSize,t)},Wwb.prototype.extractBoxes=function(_,S,R){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a,s,u,c,l,h,d,p,f,m,g,v,b,y,x,w,C,E=this;return __generator(this,function(e){switch(e.label){case 0:return i=S.width,s=S.height,a=Math.max(i,s),t=a/i,n=a/s,r=_.shape[1],o=this.config.anchors.length,u=Ze(function(){var e=_.reshape([r,r,o,E.boxEncodingSize]);return[e.slice([0,0,0,0],[r,r,o,4]),e.slice([0,0,0,4],[r,r,o,1]),E.withClassScores?go(e.slice([0,0,0,5],[r,r,o,E.config.classes.length]),3):On(0)]}),i=u[0],a=u[1],s=u[2],u=[],[4,a.array()];case 1:return c=e.sent(),[4,i.array()];case 2:l=e.sent(),h=0,e.label=3;case 3:if(!(h<r))return[3,12];d=0,e.label=4;case 4:if(!(d<r))return[3,11];p=0,e.label=5;case 5:return p<o?(f=sigmoid(c[h][d][p][0]),!R||R<f?(w=(d+sigmoid(l[h][d][p][0]))/r*t,x=(h+sigmoid(l[h][d][p][1]))/r*n,m=Math.exp(l[h][d][p][2])*this.config.anchors[p].x/r*t,g=Math.exp(l[h][d][p][3])*this.config.anchors[p].y/r*n,v=w-m/2,b=x-g/2,y={row:h,col:d,anchor:p},this.withClassScores?[4,this.extractPredictedClass(s,y)]:[3,7]):[3,9]):[3,10];case 6:return C=e.sent(),[3,8];case 7:C={classScore:1,label:0},e.label=8;case 8:x=(w=C).classScore,w=w.label,u.push(__assign({box:new BoundingBox(v,b,v+m,b+g),score:f,classScore:f*x,label:w},y)),e.label=9;case 9:return p++,[3,5];case 10:return d++,[3,4];case 11:return h++,[3,3];case 12:return i.dispose(),a.dispose(),s.dispose(),[2,u]}})})},Wwb.prototype.extractPredictedClass=function(t,a){return __awaiter(this,void 0,void 0,function(){var n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return n=a.row,r=a.col,o=a.anchor,[4,t.array()];case 1:return i=e.sent(),[2,Array(this.config.classes.length).fill(0).map(function(e,t){return i[n][r][o][t]}).map(function(e,t){return{classScore:e,label:t}}).reduce(function(e,t){return e.classScore>t.classScore?e:t})]}})})},Wwb.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],Wwb),Vwb;function Wwb(e){var t=Vwb.call(this,"TinyYolov2")||this;return validateConfig(e),t._config=e,t}var TinyYolov2=(Lyb=TinyYolov2Base,__extends(Myb,Lyb),Object.defineProperty(Myb.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(Myb.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),Myb.prototype.locateFaces=function(t,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.detect(t,n)];case 1:return[2,e.sent().map(function(e){return new FaceDetection(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})})]}})})},Myb.prototype.getDefaultModelName=function(){return this.withSeparableConvs?DEFAULT_MODEL_NAME_SEPARABLE_CONV:DEFAULT_MODEL_NAME},Myb.prototype.extractParamsFromWeigthMap=function(e){return Lyb.prototype.extractParamsFromWeigthMap.call(this,e)},Myb),Lyb;function Myb(e){void 0===e&&(e=!0);e=Object.assign({},{withSeparableConvs:e,iouThreshold:IOU_THRESHOLD$1,classes:["face"]},e?{anchors:BOX_ANCHORS_SEPARABLE,meanRgb:MEAN_RGB_SEPARABLE}:{anchors:BOX_ANCHORS$1,withClassScores:!0});return Lyb.call(this,e)||this}var TinyFaceDetectorOptions=(Wyb=TinyYolov2Options,__extends(Xyb,Wyb),Xyb),Wyb;function Xyb(){var e=null!==Wyb&&Wyb.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}var ComposableTask=(Zyb.prototype.then=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=n,[4,this.run()];case 1:return[2,t.apply(void 0,[e.sent()])]}})})},Zyb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){throw new Error("ComposableTask - run is not implemented")})})},Zyb);function Zyb(){}function extractAllFacesAndComputeResults(a,s,u,c,l){return void 0===l&&(l=function(e){return e.alignedRect}),__awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return t=a.map(function(e){return isWithFaceLandmarks(e)?l(e):e.detection}),(r=c)?[3,5]:s instanceof wt?[4,extractFaceTensors(s,t)]:[3,2];case 1:return o=e.sent(),[3,4];case 2:return[4,extractFaces(s,t)];case 3:o=e.sent(),e.label=4;case 4:r=o,e.label=5;case 5:return[4,u(n=r)];case 6:return i=e.sent(),n.forEach(function(e){return e instanceof wt&&e.dispose()}),[2,i]}})})}function extractSingleFaceAndComputeResult(t,r,o,i,a){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(e){return[2,extractAllFacesAndComputeResults([t],r,function(t){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){return[2,o(t[0])]})})},i,a)]})})}function bgrToRgbTensor(e){return Ze(function(){return Pr(Ur(e,3).reverse(),3)})}var CELL_STRIDE=2,CELL_SIZE=12;function extractorsFactory$1(n,r){var u=extractConvParamsFactory(n,r),c=extractFCParamsFactory(n,r);function l(e,t){e=Mn(n(e));return r.push({paramPath:t}),e}function h(e,t,n){return void 0===n&&(n=!1),{conv1:u(e[0],e[1],3,t+"/conv1"),prelu1_alpha:l(e[1],t+"/prelu1_alpha"),conv2:u(e[1],e[2],3,t+"/conv2"),prelu2_alpha:l(e[2],t+"/prelu2_alpha"),conv3:u(e[2],e[3],n?2:3,t+"/conv3"),prelu3_alpha:l(e[3],t+"/prelu3_alpha")}}return{extractPNetParams:function(){var e=h([3,10,16,32],"pnet"),t=u(32,2,1,"pnet/conv4_1"),n=u(32,4,1,"pnet/conv4_2");return __assign(__assign({},e),{conv4_1:t,conv4_2:n})},extractRNetParams:function(){var e=h([3,28,48,64],"rnet",!0),t=c(576,128,"rnet/fc1"),n=l(128,"rnet/prelu4_alpha"),r=c(128,2,"rnet/fc2_1"),o=c(128,4,"rnet/fc2_2");return __assign(__assign({},e),{fc1:t,prelu4_alpha:n,fc2_1:r,fc2_2:o})},extractONetParams:function(){var e=h([3,32,64,64],"onet"),t=u(64,128,2,"onet/conv4"),n=l(128,"onet/prelu4_alpha"),r=c(1152,256,"onet/fc1"),o=l(256,"onet/prelu5_alpha"),i=c(256,2,"onet/fc2_1"),a=c(256,4,"onet/fc2_2"),s=c(256,10,"onet/fc2_3");return __assign(__assign({},e),{conv4:t,prelu4_alpha:n,fc1:r,prelu5_alpha:o,fc2_1:i,fc2_2:a,fc2_3:s})}}}function extractParams(e){var t=extractWeightsFactory(e),n=t.extractWeights,r=t.getRemainingWeights,o=[],e=extractorsFactory$1(n,o),t=e.extractPNetParams,n=e.extractRNetParams,e=e.extractONetParams,t=t(),n=n(),e=e();if(0!==r().length)throw new Error("weights remaing after extract: "+r().length);return{params:{pnet:t,rnet:n,onet:e},paramMappings:o}}function extractorsFactory(e,t){var n=extractWeightEntryFactory(e,t);function u(e){return{filters:n(e+"/weights",4,e+"/filters"),bias:n(e+"/bias",1)}}function c(e){return{weights:n(e+"/weights",2),bias:n(e+"/bias",1)}}function l(e){return n(e,1)}function h(e){return{conv1:u(e+"/conv1"),prelu1_alpha:l(e+"/prelu1_alpha"),conv2:u(e+"/conv2"),prelu2_alpha:l(e+"/prelu2_alpha"),conv3:u(e+"/conv3"),prelu3_alpha:l(e+"/prelu3_alpha")}}return{extractPNetParams:function(){var e=h("pnet"),t=u("pnet/conv4_1"),n=u("pnet/conv4_2");return __assign(__assign({},e),{conv4_1:t,conv4_2:n})},extractRNetParams:function(){var e=h("rnet"),t=c("rnet/fc1"),n=l("rnet/prelu4_alpha"),r=c("rnet/fc2_1"),o=c("rnet/fc2_2");return __assign(__assign({},e),{fc1:t,prelu4_alpha:n,fc2_1:r,fc2_2:o})},extractONetParams:function(){var e=h("onet"),t=u("onet/conv4"),n=l("onet/prelu4_alpha"),r=c("onet/fc1"),o=l("onet/prelu5_alpha"),i=c("onet/fc2_1"),a=c("onet/fc2_2"),s=c("onet/fc2_3");return __assign(__assign({},e),{conv4:t,prelu4_alpha:n,fc1:r,prelu5_alpha:o,fc2_1:i,fc2_2:a,fc2_3:s})}}}function extractParamsFromWeigthMap(e){var t=[],n=extractorsFactory(e,t),r=n.extractPNetParams,o=n.extractRNetParams,n=n.extractONetParams,r=r(),o=o(),n=n();return disposeUnusedWeightTensors(e,t),{params:{pnet:r,rnet:o,onet:n},paramMappings:t}}function getSizesForScale(e,t){var n=t[0],t=t[1];return{height:Math.floor(n*e),width:Math.floor(t*e)}}function pyramidDown(e,t,n){for(var r=n[0],n=n[1],o=CELL_SIZE/e,i=[],a=Math.min(r,n)*o,s=0;12<=a;)i.push(o*Math.pow(t,s)),a*=t,s+=1;return i}var MtcnnBox=(EBb=Box,__extends(FBb,EBb),FBb),EBb;function FBb(e,t,n,r){return EBb.call(this,{left:e,top:t,right:n,bottom:r},!0)||this}function normalize(e){return Ze(function(){return gc(Cc(e,On(127.5)),On(.0078125))})}function prelu(e,t){return Ze(function(){return rc(Bl(e),gc(t,wu(Bl(wu(e)))))})}function sharedLayer(t,n,r){return void 0===r&&(r=!1),Ze(function(){var e=prelu(e=convLayer$1(t,n.conv1,"valid"),n.prelu1_alpha);return e=prelu(e=convLayer$1(e=hl(e,r?[2,2]:[3,3],[2,2],"same"),n.conv2,"valid"),n.prelu2_alpha),e=prelu(e=convLayer$1(e=r?e:hl(e,[3,3],[2,2],"valid"),n.conv3,"valid"),n.prelu3_alpha)})}function PNet(r,o){return Ze(function(){var e=sharedLayer(r,o,!0),t=convLayer$1(e,o.conv4_1,"valid"),n=wr(Sl(t,3),3);return{prob:go(Cc(t,n),3),regions:convLayer$1(e,o.conv4_2,"valid")}})}function rescaleAndNormalize(n,r){return Ze(function(){var e=getSizesForScale(r,n.shape.slice(1)),t=e.height,e=e.width,e=normalize(Oh.resizeBilinear(n,[t,e]));return Wl(e,[0,2,1,3])})}function extractBoundingBoxes(e,o,i,t){for(var n=[],a=e.arraySync(),r=0;r<e.shape[0];r++)for(var s=0;s<e.shape[1];s++)a[r][s]>=t&&n.push(new Point(s,r));return n.map(function(e){var t=new BoundingBox(Math.round((e.y*CELL_STRIDE+1)/i),Math.round((e.x*CELL_STRIDE+1)/i),Math.round((e.y*CELL_STRIDE+CELL_SIZE)/i),Math.round((e.x*CELL_STRIDE+CELL_SIZE)/i)),n=a[e.y][e.x],r=o.arraySync();return{cell:t,score:n,region:new MtcnnBox(r[e.y][e.x][0],r[e.y][e.x][1],r[e.y][e.x][2],r[e.y][e.x][3])}})}function stage1(i,e,a,s,u){u.stage1=[];var t,n=e.map(function(o){return Ze(function(){var e={scale:o},t=rescaleAndNormalize(i,o),n=Date.now(),r=PNet(t,s),t=r.prob,r=r.regions;return e.pnet=Date.now()-n,{scoresTensor:Ur(Ur(t,3)[1])[0],regionsTensor:Ur(r)[0],scale:o,statsForScale:e}})}).map(function(e){var t=e.scoresTensor,n=e.regionsTensor,r=e.scale,e=e.statsForScale,o=extractBoundingBoxes(t,n,r,a);if(t.dispose(),n.dispose(),!o.length)return u.stage1.push(e),[];t=Date.now(),n=nonMaxSuppression$1(o.map(function(e){return e.cell}),o.map(function(e){return e.score}),.5);return e.nms=Date.now()-t,e.numBoxes=n.length,u.stage1.push(e),n.map(function(e){return o[e]})}).reduce(function(e,t){return e.concat(t)},[]),r=[],o=[];return 0<n.length&&(t=Date.now(),e=nonMaxSuppression$1(n.map(function(e){return e.cell}),n.map(function(e){return e.score}),.7),u.stage1_nms=Date.now()-t,o=e.map(function(e){return n[e].score}),r=e.map(function(e){return n[e]}).map(function(e){var t=e.cell,e=e.region;return new BoundingBox(t.left+e.left*t.width,t.top+e.top*t.height,t.right+e.right*t.width,t.bottom+e.bottom*t.height).toSquare().round()})),{boxes:r,scores:o}}function extractImagePatches(s,r,e){var u=e.width,c=e.height;return __awaiter(this,void 0,void 0,function(){var a,t,i,n=this;return __generator(this,function(e){switch(e.label){case 0:return a=getContext2dOrThrow(s),[4,Promise.all(r.map(function(i){return __awaiter(n,void 0,void 0,function(){var t,n,r,o;return __generator(this,function(e){return n=i.padAtBorders(s.height,s.width),o=n.y,t=n.ey,r=n.x,n=n.ex,r=r-1,o=o-1,o=a.getImageData(r,o,n-r,t-o),[2,(env.isNodejs()?createCanvasFromMedia:createImageBitmap)(o)]})})}))];case 1:return t=e.sent(),i=[],t.forEach(function(e){var t=getContext2dOrThrow(createCanvas({width:u,height:c}));t.drawImage(e,0,0,u,c);for(var n=t.getImageData(0,0,u,c).data,r=[],o=0;o<n.length;o+=4)r.push(n[o+2]),r.push(n[o+1]),r.push(n[o]);i.push(r)}),[2,i.map(function(e){return Ze(function(){return normalize(Wl(Ln(e,[1,u,c,3]),[0,2,1,3]).toFloat())})})]}})})}function RNet(r,o){return Ze(function(){var e=sharedLayer(r,o),t=prelu(fullyConnectedLayer(Or(e,[e.shape[0],o.fc1.weights.shape[0]]),o.fc1),o.prelu4_alpha),n=fullyConnectedLayer(t,o.fc2_1),e=wr(Sl(n,1),1),e=go(Cc(n,e),1),t=fullyConnectedLayer(t,o.fc2_2);return{scores:Ur(e,1)[1],regions:t}})}function stage2(f,m,g,v,b){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a,s,u,c,l,h,d,p;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),[4,extractImagePatches(f,m,{width:24,height:24})];case 1:return d=e.sent(),b.stage2_extractImagePatches=Date.now()-t,t=Date.now(),n=d.map(function(e){var t=RNet(e,v);return e.dispose(),t}),b.stage2_rnet=Date.now()-t,r=1<n.length?Yn(n.map(function(e){return e.scores})):n[0].scores,a=(i=Array).from,[4,r.data()];case 2:return o=a.apply(i,[e.sent()]),r.dispose(),s=o.map(function(e,t){return{score:e,idx:t}}).filter(function(e){return e.score>g}).map(function(e){return e.idx}),u=s.map(function(e){return m[e]}),c=s.map(function(e){return o[e]}),l=[],h=[],0<u.length&&(t=Date.now(),d=nonMaxSuppression$1(u,c,.7),b.stage2_nms=Date.now()-t,p=d.map(function(e){e=n[s[e]].regions.arraySync();return new MtcnnBox(e[0][0],e[0][1],e[0][2],e[0][3])}),h=d.map(function(e){return c[e]}),l=d.map(function(e,t){return u[e].calibrate(p[t])})),n.forEach(function(e){e.regions.dispose(),e.scores.dispose()}),[2,{boxes:l,scores:h}]}})})}function ONet(r,o){return Ze(function(){var e=sharedLayer(r,o);e=prelu(e=convLayer$1(e=hl(e,[2,2],[2,2],"same"),o.conv4,"valid"),o.prelu4_alpha);var t=prelu(fullyConnectedLayer(Or(e,[e.shape[0],o.fc1.weights.shape[0]]),o.fc1),o.prelu5_alpha),n=fullyConnectedLayer(t,o.fc2_1),e=wr(Sl(n,1),1),n=go(Cc(n,e),1),e=fullyConnectedLayer(t,o.fc2_2),t=fullyConnectedLayer(t,o.fc2_3);return{scores:Ur(n,1)[1],regions:e,points:t}})}function stage3(f,m,g,v,b){return __awaiter(this,void 0,void 0,function(){var t,i,n,r,o,a,s,u,c,l,h,d,p;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),[4,extractImagePatches(f,m,{width:48,height:48})];case 1:return d=e.sent(),b.stage3_extractImagePatches=Date.now()-t,t=Date.now(),i=d.map(function(e){var t=ONet(e,v);return e.dispose(),t}),b.stage3_onet=Date.now()-t,n=1<i.length?Yn(i.map(function(e){return e.scores})):i[0].scores,a=(o=Array).from,[4,n.data()];case 2:return r=a.apply(o,[e.sent()]),n.dispose(),p=r.map(function(e,t){return{score:e,idx:t}}).filter(function(e){return e.score>g}).map(function(e){return e.idx}),s=p.map(function(e){e=i[e].regions.arraySync();return new MtcnnBox(e[0][0],e[0][1],e[0][2],e[0][3])}),u=p.map(function(e,t){return m[e].calibrate(s[t])}),c=p.map(function(e){return r[e]}),l=[],h=[],d=[],0<u.length&&(t=Date.now(),p=nonMaxSuppression$1(u,c,.7,!1),b.stage3_nms=Date.now()-t,l=p.map(function(e){return u[e]}),h=p.map(function(e){return c[e]}),d=p.map(function(r,o){return Array(5).fill(0).map(function(e,t){var n=i[r].points.arraySync();return new Point(n[0][t]*(l[o].width+1)+l[o].left,n[0][t+5]*(l[o].height+1)+l[o].top)})})),i.forEach(function(e){e.regions.dispose(),e.scores.dispose(),e.points.dispose()}),[2,{boxes:l,scores:h,points:d}]}})})}var Mtcnn=(AFb=NeuralNetwork,__extends(BFb,AFb),BFb.prototype.load=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return console.warn("mtcnn is deprecated and will be removed soon"),[2,AFb.prototype.load.call(this,t)]})})},BFb.prototype.loadFromDisk=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return console.warn("mtcnn is deprecated and will be removed soon"),[2,AFb.prototype.loadFromDisk.call(this,t)]})})},BFb.prototype.forwardInput=function(g,v){return void 0===v&&(v={}),__awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a,s,u,c,l,h,d,p,f,m;return __generator(this,function(e){switch(e.label){case 0:if(!(t=this.params))throw new Error("Mtcnn - load model before inference");if(!(n=g.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return r={},o=Date.now(),i=Ze(function(){return bgrToRgbTensor(wr(id.fromPixels(n)).toFloat())}),a=function(e){return i.dispose(),r.total=Date.now()-o,e},l=i.shape.slice(1),s=l[0],u=l[1],h=new MtcnnOptions(v),c=h.minFaceSize,p=h.scaleFactor,d=h.maxNumScales,l=h.scoreThresholds,h=h.scaleSteps,p=(h||pyramidDown(c,p,[s,u])).filter(function(e){e=getSizesForScale(e,[s,u]);return Math.min(e.width,e.height)>CELL_SIZE}).slice(0,d),r.scales=p,r.pyramid=p.map(function(e){return getSizesForScale(e,[s,u])}),d=Date.now(),[4,stage1(i,p,l[0],t.pnet,r)];case 1:return(p=e.sent(),r.total_stage1=Date.now()-d,p.boxes.length)?(r.stage2_numInputBoxes=p.boxes.length,d=Date.now(),[4,stage2(n,p.boxes,l[1],t.rnet,r)]):[2,a({results:[],stats:r})];case 2:return(m=e.sent(),r.total_stage2=Date.now()-d,m.boxes.length)?(r.stage3_numInputBoxes=m.boxes.length,d=Date.now(),[4,stage3(n,m.boxes,l[2],t.onet,r)]):[2,a({results:[],stats:r})];case 3:return f=e.sent(),r.total_stage3=Date.now()-d,m=f.boxes.map(function(t,e){return extendWithFaceLandmarks(extendWithFaceDetection({},new FaceDetection(f.scores[e],new Rect(t.left/u,t.top/s,t.width/u,t.height/s),{height:s,width:u})),new FaceLandmarks5(f.points[e].map(function(e){return e.sub(new Point(t.left,t.top)).div(new Point(t.width,t.height))}),{width:t.width,height:t.height}))}),[2,a({results:m,stats:r})]}})})},BFb.prototype.forward=function(n,r){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[4,t.apply(this,[e.sent(),r])];case 2:return[2,e.sent().results]}})})},BFb.prototype.forwardWithStats=function(n,r){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.forwardInput,[4,toNetInput(n)];case 1:return[2,t.apply(this,[e.sent(),r])]}})})},BFb.prototype.getDefaultModelName=function(){return"mtcnn_model"},BFb.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap(e)},BFb.prototype.extractParams=function(e){return extractParams(e)},BFb),AFb;function BFb(){return AFb.call(this,"Mtcnn")||this}var IOU_THRESHOLD=.4,BOX_ANCHORS=[new Point(1.603231,2.094468),new Point(6.041143,7.080126),new Point(2.882459,3.518061),new Point(4.266906,5.178857),new Point(9.041765,10.66308)],MEAN_RGB=[117.001,114.697,97.404],TinyFaceDetector=(tGb=TinyYolov2Base,__extends(uGb,tGb),Object.defineProperty(uGb.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),uGb.prototype.locateFaces=function(t,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.detect(t,n)];case 1:return[2,e.sent().map(function(e){return new FaceDetection(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})})]}})})},uGb.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},uGb.prototype.extractParamsFromWeigthMap=function(e){return tGb.prototype.extractParamsFromWeigthMap.call(this,e)},uGb),tGb;function uGb(){return tGb.call(this,{withSeparableConvs:!0,iouThreshold:IOU_THRESHOLD,classes:["face"],anchors:BOX_ANCHORS,meanRgb:MEAN_RGB,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}var nets={ssdMobilenetv1:new SsdMobilenetv1,tinyFaceDetector:new TinyFaceDetector,tinyYolov2:new TinyYolov2,mtcnn:new Mtcnn,faceLandmark68Net:new FaceLandmark68Net,faceLandmark68TinyNet:new FaceLandmark68TinyNet,faceRecognitionNet:new FaceRecognitionNet,faceExpressionNet:new FaceExpressionNet,ageGenderNet:new AgeGenderNet},PredictFaceExpressionsTaskBase=(DGb=ComposableTask,__extends(EGb,DGb),EGb),DGb;function EGb(e,t,n){var r=DGb.call(this)||this;return r.parentTask=e,r.input=t,r.extractedFaces=n,r}var PredictAllFaceExpressionsTask=(JGb=PredictFaceExpressionsTaskBase,__extends(KGb,JGb),KGb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r=this;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return[4,extractAllFacesAndComputeResults(t=e.sent(),this.input,function(t){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,Promise.all(t.map(function(e){return nets.faceExpressionNet.predictExpressions(e)}))];case 1:return[2,e.sent()]}})})},this.extractedFaces)];case 2:return n=e.sent(),[2,t.map(function(e,t){return extendWithFaceExpressions(e,n[t])})]}})})},KGb.prototype.withAgeAndGender=function(){return new PredictAllAgeAndGenderTask(this,this.input)},KGb),JGb;function KGb(){return null!==JGb&&JGb.apply(this,arguments)||this}var PredictSingleFaceExpressionsTask=(UGb=PredictFaceExpressionsTaskBase,__extends(VGb,UGb),VGb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return(t=e.sent())?[4,extractSingleFaceAndComputeResult(t,this.input,function(e){return nets.faceExpressionNet.predictExpressions(e)},this.extractedFaces)]:[2];case 2:return n=e.sent(),[2,extendWithFaceExpressions(t,n)]}})})},VGb.prototype.withAgeAndGender=function(){return new PredictSingleAgeAndGenderTask(this,this.input)},VGb),UGb;function VGb(){return null!==UGb&&UGb.apply(this,arguments)||this}var PredictAllFaceExpressionsWithFaceAlignmentTask=($Gb=PredictAllFaceExpressionsTask,__extends(_Gb,$Gb),_Gb.prototype.withAgeAndGender=function(){return new PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},_Gb.prototype.withFaceDescriptors=function(){return new ComputeAllFaceDescriptorsTask(this,this.input)},_Gb),$Gb;function _Gb(){return null!==$Gb&&$Gb.apply(this,arguments)||this}var PredictSingleFaceExpressionsWithFaceAlignmentTask=(aHb=PredictSingleFaceExpressionsTask,__extends(bHb,aHb),bHb.prototype.withAgeAndGender=function(){return new PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},bHb.prototype.withFaceDescriptor=function(){return new ComputeSingleFaceDescriptorTask(this,this.input)},bHb),aHb;function bHb(){return null!==aHb&&aHb.apply(this,arguments)||this}var PredictAgeAndGenderTaskBase=(cHb=ComposableTask,__extends(dHb,cHb),dHb),cHb;function dHb(e,t,n){var r=cHb.call(this)||this;return r.parentTask=e,r.input=t,r.extractedFaces=n,r}var PredictAllAgeAndGenderTask=(iHb=PredictAgeAndGenderTaskBase,__extends(jHb,iHb),jHb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n=this;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return[4,extractAllFacesAndComputeResults(t=e.sent(),this.input,function(t){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,Promise.all(t.map(function(e){return nets.ageGenderNet.predictAgeAndGender(e)}))];case 1:return[2,e.sent()]}})})},this.extractedFaces)];case 2:return r=e.sent(),[2,t.map(function(e,t){var n=r[t],t=n.age;return extendWithAge(extendWithGender(e,n.gender,n.genderProbability),t)})]}})})},jHb.prototype.withFaceExpressions=function(){return new PredictAllFaceExpressionsTask(this,this.input)},jHb),iHb;function jHb(){return null!==iHb&&iHb.apply(this,arguments)||this}var PredictSingleAgeAndGenderTask=(xHb=PredictAgeAndGenderTaskBase,__extends(yHb,xHb),yHb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r,o;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return(t=e.sent())?[4,extractSingleFaceAndComputeResult(t,this.input,function(e){return nets.ageGenderNet.predictAgeAndGender(e)},this.extractedFaces)]:[2];case 2:return o=e.sent(),n=o.age,r=o.gender,o=o.genderProbability,[2,extendWithAge(extendWithGender(t,r,o),n)]}})})},yHb.prototype.withFaceExpressions=function(){return new PredictSingleFaceExpressionsTask(this,this.input)},yHb),xHb;function yHb(){return null!==xHb&&xHb.apply(this,arguments)||this}var PredictAllAgeAndGenderWithFaceAlignmentTask=(GHb=PredictAllAgeAndGenderTask,__extends(HHb,GHb),HHb.prototype.withFaceExpressions=function(){return new PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},HHb.prototype.withFaceDescriptors=function(){return new ComputeAllFaceDescriptorsTask(this,this.input)},HHb),GHb;function HHb(){return null!==GHb&&GHb.apply(this,arguments)||this}var PredictSingleAgeAndGenderWithFaceAlignmentTask=(IHb=PredictSingleAgeAndGenderTask,__extends(JHb,IHb),JHb.prototype.withFaceExpressions=function(){return new PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},JHb.prototype.withFaceDescriptor=function(){return new ComputeSingleFaceDescriptorTask(this,this.input)},JHb),IHb;function JHb(){return null!==IHb&&IHb.apply(this,arguments)||this}var ComputeFaceDescriptorsTaskBase=(KHb=ComposableTask,__extends(LHb,KHb),LHb),KHb;function LHb(e,t){var n=KHb.call(this)||this;return n.parentTask=e,n.input=t,n}var ComputeAllFaceDescriptorsTask=(PHb=ComputeFaceDescriptorsTaskBase,__extends(QHb,PHb),QHb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return[4,extractAllFacesAndComputeResults(n=e.sent(),this.input,function(e){return Promise.all(e.map(function(e){return nets.faceRecognitionNet.computeFaceDescriptor(e)}))},null,function(e){return e.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,e.sent().map(function(e,t){return extendWithFaceDescriptor(n[t],e)})]}})})},QHb.prototype.withFaceExpressions=function(){return new PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},QHb.prototype.withAgeAndGender=function(){return new PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},QHb),PHb;function QHb(){return null!==PHb&&PHb.apply(this,arguments)||this}var ComputeSingleFaceDescriptorTask=(ZHb=ComputeFaceDescriptorsTaskBase,__extends($Hb,ZHb),$Hb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return(t=e.sent())?[4,extractSingleFaceAndComputeResult(t,this.input,function(e){return nets.faceRecognitionNet.computeFaceDescriptor(e)},null,function(e){return e.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return n=e.sent(),[2,extendWithFaceDescriptor(t,n)]}})})},$Hb.prototype.withFaceExpressions=function(){return new PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},$Hb.prototype.withAgeAndGender=function(){return new PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},$Hb),ZHb;function $Hb(){return null!==ZHb&&ZHb.apply(this,arguments)||this}var DetectFaceLandmarksTaskBase=(eIb=ComposableTask,__extends(fIb,eIb),Object.defineProperty(fIb.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?nets.faceLandmark68TinyNet:nets.faceLandmark68Net},enumerable:!0,configurable:!0}),fIb),eIb;function fIb(e,t,n){var r=eIb.call(this)||this;return r.parentTask=e,r.input=t,r.useTinyLandmarkNet=n,r}var DetectAllFaceLandmarksTask=(kIb=DetectFaceLandmarksTaskBase,__extends(lIb,kIb),lIb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,a=this;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return t=e.sent(),n=t.map(function(e){return e.detection}),this.input instanceof wt?[4,extractFaceTensors(this.input,n)]:[3,3];case 2:return o=e.sent(),[3,5];case 3:return[4,extractFaces(this.input,n)];case 4:o=e.sent(),e.label=5;case 5:return r=o,[4,Promise.all(r.map(function(e){return a.landmarkNet.detectLandmarks(e)}))];case 6:return i=e.sent(),r.forEach(function(e){return e instanceof wt&&e.dispose()}),[2,t.map(function(e,t){return extendWithFaceLandmarks(e,i[t])})]}})})},lIb.prototype.withFaceExpressions=function(){return new PredictAllFaceExpressionsWithFaceAlignmentTask(this,this.input)},lIb.prototype.withAgeAndGender=function(){return new PredictAllAgeAndGenderWithFaceAlignmentTask(this,this.input)},lIb.prototype.withFaceDescriptors=function(){return new ComputeAllFaceDescriptorsTask(this,this.input)},lIb),kIb;function lIb(){return null!==kIb&&kIb.apply(this,arguments)||this}var DetectSingleFaceLandmarksTask=(yIb=DetectFaceLandmarksTaskBase,__extends(zIb,yIb),zIb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return[4,this.parentTask];case 1:return(t=e.sent())?(n=t.detection,this.input instanceof wt?[4,extractFaceTensors(this.input,[n])]:[3,3]):[2];case 2:return o=e.sent(),[3,5];case 3:return[4,extractFaces(this.input,[n])];case 4:o=e.sent(),e.label=5;case 5:return r=o,[4,this.landmarkNet.detectLandmarks(r[0])];case 6:return i=e.sent(),r.forEach(function(e){return e instanceof wt&&e.dispose()}),[2,extendWithFaceLandmarks(t,i)]}})})},zIb.prototype.withFaceExpressions=function(){return new PredictSingleFaceExpressionsWithFaceAlignmentTask(this,this.input)},zIb.prototype.withAgeAndGender=function(){return new PredictSingleAgeAndGenderWithFaceAlignmentTask(this,this.input)},zIb.prototype.withFaceDescriptor=function(){return new ComputeSingleFaceDescriptorTask(this,this.input)},zIb),yIb;function zIb(){return null!==yIb&&yIb.apply(this,arguments)||this}var DetectFacesTaskBase=(HIb=ComposableTask,__extends(IIb,HIb),IIb),HIb;function IIb(e,t){void 0===t&&(t=new SsdMobilenetv1Options);var n=HIb.call(this)||this;return n.input=e,n.options=t,n}var DetectAllFacesTask=(MIb=DetectFacesTaskBase,__extends(NIb,MIb),NIb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=(r=this).input,(n=r.options)instanceof MtcnnOptions?[4,nets.mtcnn.forward(t,n)]:[3,2];case 1:return[2,e.sent().map(function(e){return e.detection})];case 2:if(!(r=n instanceof TinyFaceDetectorOptions?function(e){return nets.tinyFaceDetector.locateFaces(e,n)}:n instanceof SsdMobilenetv1Options?function(e){return nets.ssdMobilenetv1.locateFaces(e,n)}:n instanceof TinyYolov2Options?function(e){return nets.tinyYolov2.locateFaces(e,n)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,r(t)]}})})},NIb.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(n){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.run()];case 1:return t=e.sent(),[2,n(t.map(function(e){return extendWithFaceDetection({},e)}))]}})})})},NIb.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new DetectAllFaceLandmarksTask(this.runAndExtendWithFaceDetections(),this.input,e)},NIb.prototype.withFaceExpressions=function(){return new PredictAllFaceExpressionsTask(this.runAndExtendWithFaceDetections(),this.input)},NIb.prototype.withAgeAndGender=function(){return new PredictAllAgeAndGenderTask(this.runAndExtendWithFaceDetections(),this.input)},NIb),MIb;function NIb(){return null!==MIb&&MIb.apply(this,arguments)||this}var DetectSingleFaceTask=(bJb=DetectFacesTaskBase,__extends(cJb,bJb),cJb.prototype.run=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,new DetectAllFacesTask(this.input,this.options)];case 1:return t=e.sent(),n=t[0],t.forEach(function(e){e.score>n.score&&(n=e)}),[2,n]}})})},cJb.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(n){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.run()];case 1:return t=e.sent(),[2,n(t?extendWithFaceDetection({},t):void 0)]}})})})},cJb.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new DetectSingleFaceLandmarksTask(this.runAndExtendWithFaceDetection(),this.input,e)},cJb.prototype.withFaceExpressions=function(){return new PredictSingleFaceExpressionsTask(this.runAndExtendWithFaceDetection(),this.input)},cJb.prototype.withAgeAndGender=function(){return new PredictSingleAgeAndGenderTask(this.runAndExtendWithFaceDetection(),this.input)},cJb),bJb;function cJb(){return null!==bJb&&bJb.apply(this,arguments)||this}function detectSingleFace(e,t){return void 0===t&&(t=new SsdMobilenetv1Options),new DetectSingleFaceTask(e,t)}function euclideanDistance(e,t){if(e.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var e=Array.from(e),n=Array.from(t);return Math.sqrt(e.map(function(e,t){return e-n[t]}).reduce(function(e,t){return e+Math.pow(t,2)},0))}function wJb(e,t){this._distanceThreshold=t=void 0===t?.6:t;e=Array.isArray(e)?e:[e];if(!e.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");function n(){return"person "+r++}var r=1;this._labeledDescriptors=e.map(function(e){if(e instanceof LabeledFaceDescriptors)return e;if(e instanceof Float32Array)return new LabeledFaceDescriptors(n(),[e]);if(e.descriptor&&e.descriptor instanceof Float32Array)return new LabeledFaceDescriptors(n(),[e.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}function resizeResults(e,t){var n=new Dimensions(t.width,t.height),r=n.width,o=n.height;if(r<=0||o<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:r,height:o}));if(Array.isArray(e))return e.map(function(e){return resizeResults(e,{width:r,height:o})});if(isWithFaceLandmarks(e)){t=e.detection.forSize(r,o),n=e.unshiftedLandmarks.forSize(t.box.width,t.box.height);return extendWithFaceLandmarks(extendWithFaceDetection(e,t),n)}return isWithFaceDetection(e)?extendWithFaceDetection(e,e.detection.forSize(r,o)):e instanceof FaceLandmarks||e instanceof FaceDetection?e.forSize(r,o):e}Object.defineProperty(wJb.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(wJb.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),wJb.prototype.computeMeanDistance=function(t,e){return e.map(function(e){return euclideanDistance(e,t)}).reduce(function(e,t){return e+t},0)/(e.length||1)},wJb.prototype.matchDescriptor=function(n){var r=this;return this.labeledDescriptors.map(function(e){var t=e.descriptors,e=e.label;return new FaceMatch(e,r.computeMeanDistance(n,t))}).reduce(function(e,t){return e.distance<t.distance?e:t})},wJb.prototype.findBestMatch=function(e){e=this.matchDescriptor(e);return e.distance<this.distanceThreshold?e:new FaceMatch("unknown",e.distance)},wJb.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(e){return e.toJSON()})}},wJb.fromJSON=function(e){return new wJb(e.labeledDescriptors.map(function(e){return LabeledFaceDescriptors.fromJSON(e)}),e.distanceThreshold)};const CODE_ERROR={ERROR_DEFAULT_100:100,ERROR_101:101,ERROR_102:102,ERROR_103:103,ERROR_104:104,ERROR_105:105,ERROR_106:106,ERROR_107:107,ERROR_108:108,ERROR_109:109,ERROR_110:110,ERROR_111:111,ERROR_112:112,ERROR_113:113,ERROR_114:114},TYPE_ERROR={DEFAULT:"DefaultError",PERMISSION:"PermissionError",MODEL:"ModelError",SUPPORT:"SupportError",LIFECICLE:"LifecicleError",SESSION:"SessionError",IMPLEMENTATION:"ImplementationError"};class WebframeError{constructor(e,t,n,r=null){this.code=e,this.message=n,this.type=t,this.stack=r}}let errors=[new WebframeError(CODE_ERROR.ERROR_DEFAULT_100,TYPE_ERROR.DEFAULT,"Ops! Algo inesperado aconteceu"),new WebframeError(CODE_ERROR.ERROR_101,TYPE_ERROR.PERMISSION,"Usuário negou permissão de acesso a câmera"),new WebframeError(CODE_ERROR.ERROR_102,TYPE_ERROR.SESSION,"Timeout, sessão expirada por tempo máximo para captura excedido"),new WebframeError(CODE_ERROR.ERROR_103,TYPE_ERROR.SESSION,"Timeout, sessão expirada por inatividade"),new WebframeError(CODE_ERROR.ERROR_104,TYPE_ERROR.LIFECICLE,"Captura encerrada por estar com orientação no modo LANDSCAPE"),new WebframeError(CODE_ERROR.ERROR_105,TYPE_ERROR.LIFECICLE,"Captura encerrada por inatividade de tela"),new WebframeError(CODE_ERROR.ERROR_106,TYPE_ERROR.LIFECICLE,"Captura encerrada pelo usuário desligar o display"),new WebframeError(CODE_ERROR.ERROR_107,TYPE_ERROR.IMPLEMENTATION,"O elemento com id #box-camera não foi encontrado"),new WebframeError(CODE_ERROR.ERROR_108,TYPE_ERROR.IMPLEMENTATION,"Tipo de câmera inválido"),new WebframeError(CODE_ERROR.ERROR_109,TYPE_ERROR.MODEL,"Modelos não foram carregados previamente"),new WebframeError(CODE_ERROR.ERROR_110,TYPE_ERROR.IMPLEMENTATION,"Métodos de Callback não implementados corretamente"),new WebframeError(CODE_ERROR.ERROR_111,TYPE_ERROR.MODEL,"Não foi possível baixar os modelos, pode ser erro de diretório"),new WebframeError(CODE_ERROR.ERROR_112,TYPE_ERROR.SUPPORT,"Browser não suportado"),new WebframeError(CODE_ERROR.ERROR_113,TYPE_ERROR.SESSION,"Não foi possível criptografar a sessão. Tente novamente e caso persista, veja os possíveis motivos em nossa Central de Ajuda: <link aqui>"),new WebframeError(CODE_ERROR.ERROR_114,TYPE_ERROR.PERMISSION,"Câmera ocupada por outra aplicação")];function validateCodeError(e){return e===CODE_ERROR.ERROR_DEFAULT_100||e===CODE_ERROR.ERROR_101||e===CODE_ERROR.ERROR_102||e===CODE_ERROR.ERROR_103||e===CODE_ERROR.ERROR_104||e===CODE_ERROR.ERROR_105||e===CODE_ERROR.ERROR_106||e===CODE_ERROR.ERROR_107||e===CODE_ERROR.ERROR_108||e===CODE_ERROR.ERROR_109||e===CODE_ERROR.ERROR_110||e===CODE_ERROR.ERROR_111||e===CODE_ERROR.ERROR_112||e===CODE_ERROR.ERROR_113||e===CODE_ERROR.ERROR_114}function getError(t,n=null){if(validateCodeError(t)){let e=errors.find(e=>e.code===t);return e.stack=n,e}throw"Code not found in list of codes"}let _isChrome=!(!navigator.userAgent.toLowerCase().match(/chrome/i)&&!navigator.userAgent.toLowerCase().match(/crios/i)),_isFirefox=!(!navigator.userAgent.toLowerCase().match(/firefox/i)&&!navigator.userAgent.toLowerCase().match(/fxios/i)),_isSafari=!!navigator.userAgent.toLowerCase().match(/safari/i),_isEdge=!!(navigator.userAgent.toLowerCase().match(/edge/i)||navigator.userAgent.toLowerCase().match(/edgios/i)||navigator.userAgent.toLowerCase().match(/edg/i)),_isOpera=!!(navigator.userAgent.toLowerCase().match(/opera/i)||navigator.userAgent.toLowerCase().match(/opt/i)||navigator.userAgent.toLowerCase().match(/opr/i));function isMobile(){return!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))}function isIOS(){return!!(navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Mac OS/i))}function isAndroid(){return!!navigator.userAgent.match(/Android/i)}function isSafari(){return!(!_isSafari||_isChrome||_isEdge||_isFirefox||_isOpera)}function verifyBrowserSupport(){return isMobile()?isAndroid()?!(!_isChrome&&!_isFirefox||_isOpera||_isEdge):isIOS()&&!!isSafari():isIOS()?isIOS()&&!!isSafari():!(!_isChrome&&!_isFirefox||_isOpera||_isEdge)}function browserNotSupport(){return isMobile()?isAndroid()?getError(CODE_ERROR.ERROR_112,[{message:"Navegadores permitidos:",listBrowsersSupport:["Chrome","Firefox"]}]):isIOS()?getError(CODE_ERROR.ERROR_112,[{message:"Navegadores permitidos:",listBrowsersSupport:["Safari"]}]):void 0:isIOS()?getError(CODE_ERROR.ERROR_112,[{message:"Navegadores permitidos:",listBrowsersSupport:["Safari"]}]):getError(CODE_ERROR.ERROR_112,[{message:"Navegadores permitidos:",listBrowsersSupport:["Chrome","Firefox"]}])}function isEmulatedDevice$1(){return isTouchDevice()&&1===navigator.maxTouchPoints&&(getHasLiedBrowser()||-1!==window.navigator.userAgent.indexOf("Mobile"))}function getHasLiedBrowser(){var e=navigator.userAgent.toLowerCase(),t=navigator.productSub;if(0<=e.indexOf("edge/")||0<=e.indexOf("iemobile/"))return!1;if(0<=e.indexOf("opera mini"))return!1;if(("Chrome"===(e=0<=e.indexOf("firefox/")?"Firefox":0<=e.indexOf("opera/")||0<=e.indexOf(" opr/")?"Opera":0<=e.indexOf("chrome/")?"Chrome":0<=e.indexOf("safari/")?0<=e.indexOf("android 1.")||0<=e.indexOf("android 2.")||0<=e.indexOf("android 3.")||0<=e.indexOf("android 4.")?"AOSP":"Safari":0<=e.indexOf("trident/")?"Internet Explorer":"Other")||"Safari"===e||"Opera"===e)&&"20030107"!==t)return!0;var n,t=eval.toString().length;if(37===t&&"Safari"!==e&&"Firefox"!==e&&"Other"!==e)return!0;if(39===t&&"Internet Explorer"!==e&&"Other"!==e)return!0;if(33===t&&"Chrome"!==e&&"AOSP"!==e&&"Opera"!==e&&"Other"!==e)return!0;try{throw"a"}catch(e){try{e.toSource(),n=!0}catch(e){n=!1}}return n&&"Firefox"!==e&&"Other"!==e}function isTouchDevice(){var e=window.matchMedia||window.msMatchMedia;return!!e&&e("(pointer:coarse)").matches}const isFirefox="undefined"!=typeof InstallTrigger;let Message="",boxLoading=null,boxLoadingHtml=null;function showBoxLoading(){boxLoading&&(boxLoading.style.display="block")}function hideBoxLoading(){boxLoading&&(boxLoading.style.display="none")}function showMessage(e){Message&&Message.innerHTML!==e&&(Message.innerHTML=e,Message.style.visibility="visible",Message.style.opacity=1)}function hideMessage(){Message.innerHTML="",Message.style.visibility="hidden",Message.style.opacity=0}function setStyleMessage(e,t){Message.style.backgroundColor=e,Message.style.color=t}function setTopLabelMessage(e,t){Message.style.top=`${e.offsetHeight/2-t/2-25}px`}function setConfigurationHtml(e){boxLoadingHtml=void 0!==e||null!==e?e:""}function addHtmlToPopup(){boxLoading.innerHTML=boxLoadingHtml}function setBoxCamera(e){boxLoading=e.querySelector("#box--loading"),Message=e.querySelector("#camera--message"),addHtmlToPopup()}let timerLogs=[];class TimerLog{constructor(e,t,n){this.id=e,this.description=t,this.initial=n,this.final=null,this.timer=null}}function addManually(e){timerLogs.push(e)}function add$2(t,e,n,r){0<timerLogs.filter(function(e){return e.id===t}).length?r&&reset$1(t,n):timerLogs.push(new TimerLog(t,e,n))}function set(t,n){for(let e=0;e<timerLogs.length;e++)if(timerLogs[e].id===t){timerLogs[e].final=n,timerLogs[e].timer=n-timerLogs[e].initial;break}}function reset$1(t,n){for(let e=0;e<timerLogs.length;e++)if(timerLogs[e].id===t){timerLogs[e].initial=n,timerLogs[e].final=null,timerLogs[e].timer=null;break}}function get$1(t){var e=timerLogs.find(function(e){return e.id===t});return void 0===e?null:e}function convertMillisecondsToSeconds(e){e/=1e3;return e<1?1:Math.round(e)}function compareMilliseconds(e,t){return convertMillisecondsToSeconds(e<t?t-e:e-t)}function getObjectLog(e){var t=get$1(2),n=get$1(4),r=get$1(6),o=get$1(3),i=get$1(1);return{tt:null!=t?t.timer:0,ta:null!=n?n.timer:0,tw:null!=r?r.timer:0,tc:null!=o?o.timer:0,tm:null!=i?i.timer:0,tp:e}}function clearAll(){timerLogs=[]}let isfaceApiLoaded=!1;async function loadModelsCameraInteligence(e){return isfaceApiLoaded?Promise.resolve():(add$2(1,"Loaded models face api",Date.now(),!0),Promise.all([nets.tinyFaceDetector.loadFromUri(e),nets.faceLandmark68Net.loadFromUri(e)]).then(()=>(set(1,Date.now()),isFaceDetectionModelLoaded&&isFaceLandmark68NetLoaded?(isfaceApiLoaded=!0,Promise.resolve()):Promise.reject(getError(CODE_ERROR.ERROR_111)))).catch(()=>(set(1,Date.now()),Promise.reject(getError(CODE_ERROR.ERROR_111)))))}function getFaceDetectorOptions(){return new TinyFaceDetectorOptions({inputSize:224,scoreThreshold:.5})}function isFaceDetectionModelLoaded(){return!!nets.tinyFaceDetector.params}function isFaceLandmark68NetLoaded(){return!!nets.faceLandmark68Net.params}var acessoWebFrameModel=Object.freeze({__proto__:null,get isfaceApiLoaded(){return isfaceApiLoaded},loadModelsCameraInteligence:loadModelsCameraInteligence,getFaceDetectorOptions:getFaceDetectorOptions,isFaceDetectionModelLoaded:isFaceDetectionModelLoaded,isFaceLandmark68NetLoaded:isFaceLandmark68NetLoaded});let isCentralized=!1,centralized={silhoutteWidth:null,topSILHOUETTEThresholdVertical:null,bottomSILHOUETTEThresholdVertical:null,inSILHOUETTEThresholdHorizontal:null,overSILHOUETTEThresholdHorizontal:null,faceTurnedSILHOUETTEThresholdHorizontal:null,CSPWidthLeft:null,CSPWidthRight:null,CSPHeightTop:null,CSPHeightBottom:null,distanceLeftByNose:null,distanceRightByNose:null,differenceInDistance:null,differenceLeftY:null,differenceRightY:null,differenceNoseYThreshold:null},porcentages={topSilhouetteThresholdVertical:0,bottomSilhouetteThresholdVertical:0,inSilhouetteThresholdHorizontal:0,overSilhouetteThresholdHorizontal:0,faceTurnedSilhouetteThresholdHorizontal:0,differenceNoseYThreshold:0};const messageNotCheck="Enquadre o rosto no contorno";function resetCentralized(){isCentralized=!1}function isCentralizedFace(e,t,n,r,o,i,a,s,u,c,l){setCentralizedParameters(e,t,n,r,o,i,a,s,u,c,l),isCentralized=verifyCentralizedIsCheck(e,n,i)}function getPercentagesCalc(e,t,n,r){r?(porcentages.topSilhouetteThresholdVertical=8,porcentages.bottomSilhouetteThresholdVertical=3.47,porcentages.inSilhouetteThresholdHorizontal=10,porcentages.overSilhouetteThresholdHorizontal=4,porcentages.faceTurnedSilhouetteThresholdHorizontal=15,porcentages.differenceNoseYThreshold=7):640===e&&480===t?1500<n.offsetWidth?(porcentages.topSilhouetteThresholdVertical=6,porcentages.bottomSilhouetteThresholdVertical=5,porcentages.inSilhouetteThresholdHorizontal=4,porcentages.overSilhouetteThresholdHorizontal=14,porcentages.faceTurnedSilhouetteThresholdHorizontal=9,porcentages.differenceNoseYThreshold=9):n.offsetWidth<1499&&850<n.offsetWidth?(porcentages.topSilhouetteThresholdVertical=6,porcentages.bottomSilhouetteThresholdVertical=2,porcentages.inSilhouetteThresholdHorizontal=-1.5,porcentages.overSilhouetteThresholdHorizontal=6,porcentages.faceTurnedSilhouetteThresholdHorizontal=9,porcentages.differenceNoseYThreshold=9):(porcentages.topSilhouetteThresholdVertical=5,porcentages.bottomSilhouetteThresholdVertical=4,porcentages.inSilhouetteThresholdHorizontal=2,porcentages.overSilhouetteThresholdHorizontal=6,porcentages.faceTurnedSilhouetteThresholdHorizontal=15,porcentages.differenceNoseYThreshold=10):1500<n.offsetWidth?(porcentages.topSilhouetteThresholdVertical=5,porcentages.bottomSilhouetteThresholdVertical=4,porcentages.inSilhouetteThresholdHorizontal=1.5,porcentages.overSilhouetteThresholdHorizontal=4,porcentages.faceTurnedSilhouetteThresholdHorizontal=10,porcentages.differenceNoseYThreshold=8):n.offsetWidth<1499&&600<n.offsetWidth?(porcentages.topSilhouetteThresholdVertical=9,porcentages.bottomSilhouetteThresholdVertical=7,porcentages.inSilhouetteThresholdHorizontal=3,porcentages.overSilhouetteThresholdHorizontal=3.5,porcentages.faceTurnedSilhouetteThresholdHorizontal=19,porcentages.differenceNoseYThreshold=15):(porcentages.topSilhouetteThresholdVertical=10,porcentages.bottomSilhouetteThresholdVertical=8,porcentages.inSilhouetteThresholdHorizontal=5,porcentages.overSilhouetteThresholdHorizontal=10,porcentages.faceTurnedSilhouetteThresholdHorizontal=20,porcentages.differenceNoseYThreshold=16),centralized.topSilhouetteThresholdVertical=porcentages.topSilhouetteThresholdVertical/100*n.offsetHeight,centralized.bottomSilhouetteThresholdVertical=porcentages.bottomSilhouetteThresholdVertical/100*n.offsetHeight,centralized.inSilhouetteThresholdHorizontal=porcentages.inSilhouetteThresholdHorizontal/100*n.offsetWidth,centralized.overSilhouetteThresholdHorizontal=porcentages.overSilhouetteThresholdHorizontal/100*n.offsetWidth,centralized.faceTurnedSilhouetteThresholdHorizontal=porcentages.faceTurnedSilhouetteThresholdHorizontal/100*n.offsetWidth,centralized.differenceNoseYThreshold=porcentages.differenceNoseYThreshold/100*n.offsetHeight}function verifyCentralizedIsCheck(e,t,n){return e>=centralized.CSPWidthLeft-centralized.overSilhouetteThresholdHorizontal&&e<=centralized.CSPWidthLeft+centralized.inSilhouetteThresholdHorizontal&&t<=centralized.CSPWidthRight+centralized.overSilhouetteThresholdHorizontal&&t>=centralized.CSPWidthRight-centralized.inSilhouetteThresholdHorizontal&&n>=centralized.CSPHeightTop&&n<=centralized.CSPHeightBottom&&centralized.differenceInDistance<centralized.faceTurnedSilhouetteThresholdHorizontal&&centralized.differenceLeftY<centralized.differenceNoseYThreshold&&centralized.differenceRightY<centralized.differenceNoseYThreshold&&centralized.differenceLeftY>-centralized.differenceNoseYThreshold&&centralized.differenceRightY>-centralized.differenceNoseYThreshold}function setCentralizedParameters(e,t,n,r,o,i,a,s,u,c,l){centralized.silhoutteWidth=a,getPercentagesCalc(s,u,c,l),centralized.differenceLeftY=t-i,centralized.differenceRightY=r-i,centralized.CSPWidthLeft=c.offsetWidth/2-centralized.silhoutteWidth/2,centralized.CSPWidthRight=c.offsetWidth/2+centralized.silhoutteWidth/2,centralized.CSPHeightTop=c.offsetHeight/2-centralized.topSilhouetteThresholdVertical,centralized.CSPHeightBottom=c.offsetHeight/2+centralized.bottomSilhouetteThresholdVertical,centralized.distanceLeftByNose=o-e,centralized.distanceRightByNose=n-o,centralized.distanceLeftByNose>=centralized.distanceRightByNose?centralized.differenceInDistance=centralized.distanceLeftByNose-centralized.distanceRightByNose:centralized.differenceInDistance=centralized.distanceRightByNose-centralized.distanceLeftByNose}function getMessageCentralizedIsNotCheck(e,t,n){return t-e>centralized.silhoutteWidth||t-e<centralized.silhoutteWidth-centralized.inSilhouetteThresholdHorizontal||n<=centralized.CSPHeightTop||n>=centralized.CSPHeightBottom||e<=centralized.CSPWidthLeft-centralized.overSilhouetteThresholdHorizontal||t>=centralized.CSPWidthRight+centralized.overSilhouetteThresholdHorizontal||centralized.differenceLeftY>centralized.differenceNoseYThreshold&&centralized.differenceRightY>centralized.differenceNoseYThreshold||centralized.differenceLeftY<-centralized.differenceNoseYThreshold&&centralized.differenceRightY<-centralized.differenceNoseYThreshold||centralized.distanceLeftByNose>centralized.distanceRightByNose||centralized.distanceLeftByNose<centralized.distanceRightByNose?messageNotCheck:void 0}class SmartBlink{constructor(){this.countBlink=0,this.lastBlink,this.blinks=[!1]}}let smartBlink=new SmartBlink;function add$1(e,t){var n=t-e,t=diff(smartBlink.lastBlink,Math.abs(n)),e=smartBlink.blinks.length-1,e=smartBlink.blinks[e];.7<t&&!e?(smartBlink.countBlink++,smartBlink.blinks.push(!0)):smartBlink.blinks.push(!1),smartBlink.lastBlink=Math.abs(n)}function reset(){smartBlink=new SmartBlink}function getTotalblinks(){return smartBlink.countBlink}function diff(e,t){return t<e?e-t:t-e}let TYPE_PROCESS=null,TYPE_PROCESS_INITIAL=null;const TYPE_CAMERA={CAMERA_NORMAL:1,CAMERA_INTELIGENCE:2};let TYPE_PROCESS_DOCUMENT=null;const TYPE_DOCUMENT={CNH:1,CPF:3,OTHERS:5,RG_FRONT:6,RG_BACK:7,NEW_RG_FRONT:8,NEW_RG_BACK:9};let FACE_MODE=null;const FACE_MODE_TYPE={FRONT:1,BACK:2},Orientation={PORTRAIT:1,LANDSCAPE:2};function isDocumentCapture(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CNH||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CPF||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.OTHERS||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_FRONT||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_BACK||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_FRONT||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_BACK}function isDocumentType(e){return e===TYPE_DOCUMENT.CNH||e===TYPE_DOCUMENT.CPF||e===TYPE_DOCUMENT.RG_FRONT||e===TYPE_DOCUMENT.RG_BACK||e===TYPE_DOCUMENT.NEW_RG_FRONT||e===TYPE_DOCUMENT.NEW_RG_BACK||e===TYPE_DOCUMENT.OTHERS}function isCameraNormalAndFaceModeBack(){return TYPE_PROCESS===TYPE_CAMERA.CAMERA_NORMAL&&FACE_MODE===FACE_MODE_TYPE.BACK}function isFrontSelfie(){return TYPE_PROCESS===TYPE_CAMERA.CAMERA_NORMAL&&FACE_MODE===FACE_MODE_TYPE.FRONT||TYPE_PROCESS===TYPE_CAMERA.CAMERA_INTELIGENCE}function isSmartSelfie(){return TYPE_PROCESS===TYPE_CAMERA.CAMERA_INTELIGENCE}function isNormalSelfie(){return TYPE_PROCESS===TYPE_CAMERA.CAMERA_NORMAL}function isRGFront(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_FRONT}function isRGBack(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_BACK}function isNewRGFront(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_FRONT}function isNewRGBack(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_BACK}function resetProcessVariables(){TYPE_PROCESS=null,TYPE_PROCESS_INITIAL=null,TYPE_PROCESS_DOCUMENT=null}function setSelfieTypeProcess(e){TYPE_PROCESS=e}function setSelfieTypeProcessInitial(e){TYPE_PROCESS_INITIAL=e}function setDocumentTypeProcess(e){TYPE_PROCESS_DOCUMENT=e}function setFaceModeType(e){FACE_MODE=e}let svgMask=null,borderColor=null,borderWidth=5;const backgroundOpacity="0.7";let defs=null,style=null,groupMain=null,groupMask=null,pathBackground=null,pathLine=null,pathFocus=null,react1=null,react2=null,svgText=null,svgText2=null,bottomSilhouetteDocument=null,FocusSilhouette=null;function resetVariables$1(){svgMask=null,defs=null,style=null,groupMain=null,groupMask=null,pathBackground=null,pathLine=null,pathFocus=null,react1=null,react2=null,svgText=null,svgText2=null,bottomSilhouetteDocument=null,FocusSilhouette=null}function showToDisplayMask(){svgMask&&(svgMask.style.display="unset")}function hideToDisplayMask(){svgMask&&(svgMask.style.display="none")}function setBorderColor(e){borderColor=e}function setBorderWidth(e){borderWidth=e}function createSelfieMask(e,t,n,r,o){var i=null!==e.querySelector("#svgMask"),a=r/2,s=o/2,u=t/2,c=n/2,l=n/4,h=.15*u,d=a-u,p=s-c,f=u-h,s=`M0,0${"V"+o}${"H"+r}V0Z${`M${a+u},${s+l}`}${`A${f},${f},0,0,1,${a+h},${s+c}`}${`H${a-2*h}`}${`A${f},${f},0,0,1,${d},${s+l}`}${`V${s-l}`}${`A${f},${f},0,0,1,${a-h},${p}`}${`h${2*h}`}${`A${f},${f},0,0,1,${a+u},${s-l}`}Z`,l="http://www.w3.org/2000/svg";svgMask=svgMask||document.createElementNS(l,"svg"),svgMask.setAttributeNS(null,"viewBox","0 0 "+r+" "+o),svgMask.setAttributeNS(null,"width",r),svgMask.style.display="block",svgMask.setAttributeNS(null,"id","svgMask"),defs=defs||document.createElementNS(l,"defs"),style=style||document.createElementNS(l,"style"),style.textContent=`.cls-background{opacity:${backgroundOpacity};}.cls-focus{fill:none;stroke:${borderColor};stroke-miterlimit:10;stroke-width:${borderWidth}px;}`,groupMain=groupMain||document.createElementNS(l,"g"),groupMain.setAttributeNS(null,"id","main"),groupMain.setAttributeNS(null,"data-name","main"),groupMask=groupMask||document.createElementNS(l,"g"),groupMask.setAttributeNS(null,"id","mask"),pathBackground=pathBackground||document.createElementNS(l,"path"),pathBackground.setAttributeNS(null,"id","background"),pathBackground.setAttributeNS(null,"class","cls-background"),pathBackground.setAttributeNS(null,"d",s),pathFocus=pathFocus||document.createElementNS(l,"rect"),pathFocus.setAttributeNS(null,"id","focus-silhouette"),pathFocus.setAttributeNS(null,"class","cls-focus"),pathFocus.setAttributeNS(null,"x",d),pathFocus.setAttributeNS(null,"y",p),pathFocus.setAttributeNS(null,"width",t),pathFocus.setAttributeNS(null,"height",n),pathFocus.setAttributeNS(null,"rx",f),pathFocus.setAttributeNS(null,"style",`stroke: ${borderColor};`),i||(groupMask.appendChild(pathBackground),groupMask.appendChild(pathFocus),groupMain.appendChild(groupMask),defs.appendChild(style),svgMask.appendChild(defs),svgMask.appendChild(groupMain),e.appendChild(svgMask))}function createDocumentMask(e,t,n,r,o){var i=null!==e.querySelector("#svgMask"),a=r/2,s=o/2-Math.round(.09*o),u=t/2,c=n/2,l=.15*u,h=a+u;let d=s+c;var p=a+l;let f=s+c;var m=a-2*l,g=a-u;let v=s+c,b=s-c;var y=a-l;let x=s-c;l*=2,u=a+u;let w=s-c;isMobile()&&(x/=2,w/=2,f-=x,v-=x,d-=x,b/=2);var C,E,l=`M0,0${"V"+o}${"H"+r}V0Z${`M${h},${d}`}${`A0,0,0,0,1,${p},${f}`}${`H${m}`}${`A0,0,0,0,1,${g},${v}`}${`V${b}`}${`A0,0,0,0,1,${y},${x}`}${`h${l}`}${`A0,0,0,0,1,${u},${w}`}Z`,u="http://www.w3.org/2000/svg";bottomSilhouetteDocument=x+n,svgMask=svgMask||document.createElementNS(u,"svg"),svgMask.setAttributeNS(null,"viewBox","0 0 "+r+" "+o),svgMask.setAttributeNS(null,"width",r),svgMask.setAttributeNS(null,"height",o),svgMask.style.display="block",svgMask.setAttributeNS(null,"id","svgMask"),defs=defs||document.createElementNS(u,"defs"),style=style||document.createElementNS(u,"style"),style.textContent=`.cls-background{opacity:${backgroundOpacity};}.cls-focus{fill:none;stroke:${borderColor};stroke-miterlimit:10;stroke-width:${borderWidth}px;}`,groupMain=groupMain||document.createElementNS(u,"g"),groupMain.setAttributeNS(null,"id","main"),groupMain.setAttributeNS(null,"data-name","main"),groupMask=groupMask||document.createElementNS(u,"g"),groupMask.setAttributeNS(null,"id","mask"),pathBackground=pathBackground||document.createElementNS(u,"path"),pathBackground.setAttributeNS(null,"id","background"),pathBackground.setAttributeNS(null,"class","cls-background"),pathBackground.setAttributeNS(null,"d",l),pathFocus=pathFocus||document.createElementNS(u,"rect"),pathFocus.setAttributeNS(null,"id","focus-silhouette"),pathFocus.setAttributeNS(null,"class","cls-focus"),pathFocus.setAttributeNS(null,"x",g),pathFocus.setAttributeNS(null,"y",x),pathFocus.setAttributeNS(null,"width",t),pathFocus.setAttributeNS(null,"height",n),pathFocus.setAttributeNS(null,"rx",0),TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CNH?(pathLine=pathLine||document.createElementNS(u,"path"),pathLine.setAttributeNS(null,"id","line"),pathLine.setAttributeNS(null,"d",`M ${g} ${isMobile()?s-x:s} l ${h-g} 0`),pathLine.setAttributeNS(null,"fill","none"),pathLine.setAttributeNS(null,"stroke",borderColor),pathLine.setAttributeNS(null,"stroke-width","3"),react1=react1||document.createElementNS(u,"rect"),react1.setAttributeNS(null,"id","rect-top-cnh"),react1.setAttributeNS(null,"class","cls-focus"),react1.setAttributeNS(null,"x",g+.19*t),react1.setAttributeNS(null,"y",(isMobile()?s-x:s)-(.13*c+.57*c)),react1.setAttributeNS(null,"width",.3*t),react1.setAttributeNS(null,"height",.57*c),react1.setAttributeNS(null,"stroke-width",3),react1.setAttributeNS(null,"fill","none"),react1.setAttributeNS(null,"stroke",borderColor),react2=react2||document.createElementNS(u,"rect"),react2.setAttributeNS(null,"id","rect-bottom-cnh"),react2.setAttributeNS(null,"class","cls-focus"),react2.setAttributeNS(null,"x",g+.16*t),react2.setAttributeNS(null,"y",(isMobile()?s-x:s)+.05*c),react2.setAttributeNS(null,"width",.77*t),react2.setAttributeNS(null,"height",.4*c),react2.setAttributeNS(null,"stroke-width",3),react2.setAttributeNS(null,"fill","none"),react2.setAttributeNS(null,"stroke",borderColor),svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text"),svgText.setAttributeNS(null,"x",g+.19*t),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)-(.13*c+.57*c)-10),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"stroke",borderColor),svgText.innerHTML="",c=document.createTextNode("FOTO"),svgText.appendChild(c)):isRGFront()?(react1=react1||document.createElementNS(u,"rect"),react1.setAttributeNS(null,"id","rect1"),react1.setAttributeNS(null,"class","cls-focus"),react1.setAttributeNS(null,"x",g+(t-.45*t)/2),react1.setAttributeNS(null,"y",(isMobile()?s-x:s)-.4*n),react1.setAttributeNS(null,"width",.45*t),react1.setAttributeNS(null,"height",.4*n),react1.setAttributeNS(null,"stroke-width",3),react1.setAttributeNS(null,"fill","none"),react1.setAttributeNS(null,"stroke",borderColor),react2=react2||document.createElementNS(u,"rect"),react2.setAttributeNS(null,"id","rect2"),react2.setAttributeNS(null,"class","cls-focus"),react2.setAttributeNS(null,"x",g+(t-.45*t)/2),react2.setAttributeNS(null,"y",(isMobile()?s-x:s)+.05*n),react2.setAttributeNS(null,"width",.45*t),react2.setAttributeNS(null,"height",.38*n),react2.setAttributeNS(null,"stroke-width",3),react2.setAttributeNS(null,"fill","none"),react2.setAttributeNS(null,"stroke",borderColor),svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text"),svgText.setAttributeNS(null,"x",a-25),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)-.42*n),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"stroke",borderColor),svgText.innerHTML="",a=document.createTextNode("FOTO"),svgText.appendChild(a)):isRGBack()?(react1=react1||document.createElementNS(u,"rect"),react1.setAttributeNS(null,"id","rect1"),react1.setAttributeNS(null,"class","cls-focus"),react1.setAttributeNS(null,"x",t-.15*t+g),react1.setAttributeNS(null,"y",(isMobile()?s-x:s)-.28*n),react1.setAttributeNS(null,"width",.0735*t),react1.setAttributeNS(null,"height",.198*n),react1.setAttributeNS(null,"stroke-width",3),react1.setAttributeNS(null,"fill","none"),react1.setAttributeNS(null,"stroke",borderColor),react2=react2||document.createElementNS(u,"rect"),react2.setAttributeNS(null,"id","rect2"),react2.setAttributeNS(null,"class","cls-focus"),react2.setAttributeNS(null,"x",t-.3*t+g),react2.setAttributeNS(null,"y",(isMobile()?s-x:s)-.28*n),react2.setAttributeNS(null,"width",.0735*t),react2.setAttributeNS(null,"height",.49*n),react2.setAttributeNS(null,"stroke-width",3),react2.setAttributeNS(null,"fill","none"),react2.setAttributeNS(null,"stroke",borderColor),svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text"),svgText.setAttributeNS(null,"x",t-(.3*t-.0735*t/2)+g),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)-.45*n),svgText.setAttributeNS(null,"stroke",borderColor),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"style","writing-mode: tb;"),svgText.innerHTML="",C=document.createTextNode("NOME"),svgText.appendChild(C)):isNewRGFront()?(react1=react1||document.createElementNS(u,"rect"),react1.setAttributeNS(null,"id","rect1"),react1.setAttributeNS(null,"class","cls-focus"),react1.setAttributeNS(null,"x",t-.58*t-.09*t+g),react1.setAttributeNS(null,"y",(isMobile()?s-x:s)-.4*n),react1.setAttributeNS(null,"width",.58*t),react1.setAttributeNS(null,"height",.3*n),react1.setAttributeNS(null,"stroke-width",3),react1.setAttributeNS(null,"fill","none"),react1.setAttributeNS(null,"stroke",borderColor),svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text"),svgText.setAttributeNS(null,"x",t-.58*t-.09*t+g),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)-.42*n),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"stroke",borderColor),svgText.innerHTML="",C=document.createTextNode("FOTO"),svgText.appendChild(C)):isNewRGBack()?(react1=react1||document.createElementNS(u,"rect"),react1.setAttributeNS(null,"id","rect1"),react1.setAttributeNS(null,"class","cls-focus"),react1.setAttributeNS(null,"x",g+.09*t),react1.setAttributeNS(null,"y",(isMobile()?s-x:s)+.25*n/2),react1.setAttributeNS(null,"width",.62*t),react1.setAttributeNS(null,"height",.3*n),react1.setAttributeNS(null,"stroke-width",3),react1.setAttributeNS(null,"fill","none"),react1.setAttributeNS(null,"stroke",borderColor),svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text"),svgText.setAttributeNS(null,"x",g+.09*t),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)+.25*n/2-10),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"stroke",borderColor),svgText.innerHTML="",E=document.createTextNode("DIGITAL"),svgText.appendChild(E)):TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CPF&&(svgText=svgText||document.createElementNS(u,"text"),svgText.setAttributeNS(null,"id","text1"),svgText.setAttributeNS(null,"class","cls-text-medium"),svgText.setAttributeNS(null,"x",g+.4*t),svgText.setAttributeNS(null,"y",(isMobile()?s-x:s)-.45*n),svgText.setAttributeNS(null,"stroke",borderColor),svgText.setAttributeNS(null,"fill",borderColor),svgText.setAttributeNS(null,"style","writing-mode: tb;"),svgText.innerHTML="",E=document.createTextNode("000.000.000-00"),svgText.appendChild(E),svgText2=svgText2||document.createElementNS(u,"text"),svgText2.setAttributeNS(null,"id","text2"),svgText2.setAttributeNS(null,"class","cls-text-big"),svgText2.setAttributeNS(null,"x",t-(.3*t-.09*t/2)+g),svgText2.setAttributeNS(null,"y",(isMobile()?s-x:s)-.3*n),svgText2.setAttributeNS(null,"stroke",borderColor),svgText2.setAttributeNS(null,"fill",borderColor),svgText2.setAttributeNS(null,"style","writing-mode: tb;"),svgText2.innerHTML="",n=document.createTextNode("CPF"),svgText2.appendChild(n)),i||(groupMask.appendChild(pathBackground),groupMask.appendChild(pathFocus),TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CNH&&groupMask.appendChild(pathLine),TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.CNH&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_FRONT&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_BACK&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG_FRONT&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG_BACK||groupMask.appendChild(react1),TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.CNH&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_FRONT&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_BACK||groupMask.appendChild(react2),TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.CNH&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_FRONT&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.RG_BACK&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG_FRONT&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.NEW_RG_BACK&&TYPE_PROCESS_DOCUMENT!==TYPE_DOCUMENT.CPF||groupMask.appendChild(svgText),TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CPF&&groupMask.appendChild(svgText2),groupMain.appendChild(groupMask),defs.appendChild(style),svgMask.appendChild(defs),svgMask.appendChild(groupMain),e.appendChild(svgMask))}function changeColorMask(e,t){FocusSilhouette=FocusSilhouette||t.querySelector("#focus-silhouette"),FocusSilhouette.getAttribute("style")!==`stroke: ${e};`&&FocusSilhouette.setAttribute("style",`stroke: ${e};`)}const bp_encrypt=(t,e)=>{const n=e=>e.split("").map(e=>e.charCodeAt(0));return e.split("").map(n).map(e=>n(t).reduce((e,t)=>e^t,e)).map(e=>("0"+Number(e).toString(16)).substr(-2)).join("")};function isValidString(e){return e&&""!==e}let deviceList,videoList,videoLabelsList=[],arrBadOriginsDetected=[],authOriginId,authOriginLabel,firstOriginId,salt="bl@ckp@nth3r";function getAuthenticateOrigins(){return["23242620312c2820","3626276875767d702b"]}function getNotAuthenticateOrigins(){return["2a2736","332c3731302429","28242b3c262428","362b2435262428","362b2435","263c272037292c2b2e","3c2a30262428","2429312037262428","23242e20","23242e20262428","283c"]}function getArrNotAuthOriginsDetected(){return arrBadOriginsDetected}function getAuthenticateOriginId(){return authOriginId}function getAuthenticateOriginLabel(){return authOriginLabel}function getFirstOriginId(){return firstOriginId}function getVideoList(){return videoList=deviceList.filter(e=>"videoinput"===e.kind),videoList}function getVideoLabelsList(){return videoList.forEach(function(e,t){isValidString(e.label)&&videoLabelsList.push(e.label)}),videoLabelsList}function verifyAuthOrigin(){videoList.forEach(function(e,n){let t=e.label;t.split(" ").forEach(function(e,t){getAuthenticateOrigins().includes(bp_encrypt(salt,e.toLowerCase()))&&(e=videoList[n],authOriginId||(authOriginId=e.deviceId,authOriginLabel=e.label))})}),authOriginId||videoList.forEach(function(e,t){firstOriginId=firstOriginId||e.deviceId})}function isValidOrigin(){getVideoList(),getVideoLabelsList(),verifyAuthOrigin();let r=!0;return videoLabelsList.forEach(function(n,e){n.split(" ").forEach(function(e,t){getNotAuthenticateOrigins().includes(bp_encrypt(salt,e.toLowerCase()))&&(isValidString(n)&&arrBadOriginsDetected.push(n),r=!1)})}),r}async function verifyOriginStream(){try{let e=navigator.mediaDevices,t=!1;return e&&e.enumerateDevices||(t=!1),deviceList=await e.enumerateDevices(),t=deviceList.some(e=>"videoinput"===e.kind),t?Promise.resolve(isValidOrigin()):Promise.resolve(!1)}catch(e){return Promise.reject(e)}}let stack=[];function add(e){e?(e={column:e.column||null,line:e.line||null,message:e.message||null,constraint:e.constraint||null,name:e.name||null,stack:e.stack||null},stack.push(e)):stack.push({message:"objeto de erro nulo"})}function get(){return stack}var devtoolsDetector=createCommonjsModule(function(e,t){e.exports=function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=6)}([function(e,t,n){!function(e){t.b=function(e){for(var t=(e=void 0===e?{}:e).includes,e=e.excludes,e=void 0===e?[]:e,n=!1,r=!1,o=0,i=void 0===t?[]:t;o<i.length;o++)if(!0===i[o]){n=!0;break}for(var a=0,s=e;a<s.length;a++)if(!0===s[a]){r=!0;break}return n&&!r},t.c=function(e,t,n){e=o.a[e];return void 0!==e&&Object(r.compare)(e,t,n)},t.a=function(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==e?e:this};var r=n(11),o=(n.n(r),n(4))}.call(t,n(10))},function(e,t,n){n.d(t,"c",function(){return o}),n.d(t,"d",function(){return i}),n.d(t,"b",function(){return a}),n.d(t,"f",function(){return s}),n.d(t,"a",function(){return u}),n.d(t,"e",function(){return c});var r=n(3),t=n(0),n=Object(t.a)(),o="InstallTrigger"in((null==n?void 0:n.window)||{})||/firefox/i.test(r.b),i=/trident/i.test(r.b)||/msie/i.test(r.b),a=/edge/i.test(r.b),s=/webkit/i.test(r.b)&&!a,u=void 0!==(null===(t=null==n?void 0:n.window)||void 0===t?void 0:t.chrome)||/chrome/i.test(r.b),c="[object SafariRemoteNotification]"===((null===(n=null===(n=null==n?void 0:n.window)||void 0===n?void 0:n.safari)||void 0===n?void 0:n.pushNotification)||!1).toString()||/safari/i.test(r.b)&&!u},function(e,t,n){n.d(t,"b",function(){return i}),n.d(t,"c",function(){return a}),n.d(t,"a",function(){return s});var r=n(1);function o(n){if(console){if(!r.d&&!r.b)return console[n];if("log"===n||"clear"===n)return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console[n].apply(console,e)}}return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]}}var i=o("log"),a=o("table"),s=o("clear")},function(e,t,n){t.a=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return null!=r&&r.document?(e=r.document).createElement.apply(e,t):{}},n.d(t,"b",function(){return o});var n=n(0),r=Object(n.a)(),o=(null===(n=null==r?void 0:r.navigator)||void 0===n?void 0:n.userAgent)||"xxxxx"},function(e,t,n){n.d(t,"a",function(){return r});for(var r={},o=0,i=(n(3).b||"").match(/\w+\/(\d|\.)+(\s|$)/gi)||[];o<i.length;o++){var a=i[o].split("/"),s=a[0],a=a[1];r[s]=a}},function(e,t,n){n.d(t,"b",function(){return r}),n.d(t,"d",function(){return o}),n.d(t,"c",function(){return i}),n.d(t,"a",function(){return a}),n.d(t,"e",function(){return s});var n=n(3),r=/ipad/i.test(n.b),o=/macintosh/i.test(n.b),i=/iphone/i.test(n.b),a=/android/i.test(n.b),s=/windows/i.test(n.b)},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.addListener=function(e){h.addListener(e)},t.removeListener=function(e){h.removeListener(e)},t.isLaunch=function(){return h.isLaunch()},t.launch=function(){h.launch()},t.stop=function(){h.stop()},t.setDetectDelay=function(e){h.setDetectDelay(e)};var r=n(7),o=n(8);n.d(t,"DevtoolsDetector",function(){return r.a}),n.d(t,"checkers",function(){return o});var i=n(0);n.d(t,"match",function(){return i.b}),n.d(t,"specificVersionMatch",function(){return i.c});var a=n(1);n.d(t,"isFirefox",function(){return a.c}),n.d(t,"isIE",function(){return a.d}),n.d(t,"isEdge",function(){return a.b}),n.d(t,"isWebkit",function(){return a.f}),n.d(t,"isChrome",function(){return a.a}),n.d(t,"isSafari",function(){return a.e});var s=n(2);n.d(t,"log",function(){return s.b}),n.d(t,"table",function(){return s.c}),n.d(t,"clear",function(){return s.a});var u=n(17);n.d(t,"isMobile",function(){return u.a});var c=n(4);n.d(t,"versionMap",function(){return c.a});var l=n(5);n.d(t,"isIpad",function(){return l.b}),n.d(t,"isMac",function(){return l.d}),n.d(t,"isIphone",function(){return l.c}),n.d(t,"isAndroid",function(){return l.a}),n.d(t,"isWindows",function(){return l.e});var h=new r.a({checkers:[o.elementIdChecker,o.regToStringChecker,o.functionToStringChecker,o.depRegToStringChecker,o.dateToStringChecker,o.debuggerChecker]});t.default=h},function(e,t,n){n.d(t,"a",function(){return o});var r=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},s=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},o=(i.prototype.launch=function(){this._detectLoopDelay<=0&&this.setDetectDelay(500),this._detectLoopStopped&&(this._detectLoopStopped=!1,this._detectLoop())},i.prototype.stop=function(){this._detectLoopStopped||(this._detectLoopStopped=!0,clearTimeout(this._timer))},i.prototype.isLaunch=function(){return!this._detectLoopStopped},i.prototype.setDetectDelay=function(e){this._detectLoopDelay=e},i.prototype.addListener=function(e){this._listeners.push(e)},i.prototype.removeListener=function(t){this._listeners=this._listeners.filter(function(e){return e!==t})},i.prototype._broadcast=function(e){for(var t=0,n=this._listeners;t<n.length;t++){var r=n[t];try{r(e.isOpen,e)}catch(e){}}},i.prototype._detectLoop=function(){return r(this,void 0,void 0,function(){var t,n,r,o,i,a=this;return s(this,function(e){switch(e.label){case 0:t=!1,n="",r=0,o=this._checkers,e.label=1;case 1:return r<o.length?[4,(i=o[r]).isEnable()]:[3,6];case 2:return e.sent()?(n=i.name,[4,i.isOpen()]):[3,4];case 3:t=e.sent(),e.label=4;case 4:if(t)return[3,6];e.label=5;case 5:return r++,[3,1];case 6:return t!=this._isOpen&&(this._isOpen=t,this._broadcast({isOpen:t,checkerName:n})),0<this._detectLoopDelay?this._timer=setTimeout(function(){return a._detectLoop()},this._detectLoopDelay):this.stop(),[2]}})})},i);function i(e){e=e.checkers;this._listeners=[],this._isOpen=!1,this._detectLoopStopped=!0,this._detectLoopDelay=500,this._checkers=e.slice()}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(9);n.d(t,"depRegToStringChecker",function(){return r.a});var o=n(12);n.d(t,"elementIdChecker",function(){return o.a});var i=n(13);n.d(t,"functionToStringChecker",function(){return i.a});var a=n(14);n.d(t,"regToStringChecker",function(){return a.a});var s=n(15);n.d(t,"debuggerChecker",function(){return s.a});var u=n(16);n.d(t,"dateToStringChecker",function(){return u.a})},function(e,t,n){n.d(t,"a",function(){return l});var r=n(1),o=n(2),i=n(0),a=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},s=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},u=/ /,c=!1;u.toString=function(){return c=!0,l.name};var l={name:"dep-reg-to-string",isOpen:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return c=!1,Object(o.c)({dep:u}),Object(o.a)(),[2,c]})})},isEnable:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,Object(i.b)({includes:[!0],excludes:[r.c,r.d]})]})})}}},function(e,t){var n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){var r;void 0===(r="function"==typeof(r=function(){var t=/^v?(?:\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+))?(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i;function h(e){var t=e.replace(/^v/,"").replace(/\+.*$/,""),n=function(e,t){return-1===e.indexOf(t)?e.length:e.indexOf(t)}(t,"-"),r=t.substring(0,n).split(".");return r.push(t.substring(n+1)),r}function d(e){return isNaN(Number(e))?e:Number(e)}function p(e){if("string"!=typeof e)throw new TypeError("Invalid argument expected string");if(!t.test(e))throw new Error("Invalid argument not valid semver ('"+e+"' received)")}function o(e,t){[e,t].forEach(p);for(var n=h(e),r=h(t),o=0;o<Math.max(n.length-1,r.length-1);o++){var i=parseInt(n[o]||0,10),a=parseInt(r[o]||0,10);if(i>a)return 1;if(a>i)return-1}var s=n[n.length-1],u=r[r.length-1];if(s&&u){var c=s.split(".").map(d),l=u.split(".").map(d);for(o=0;o<Math.max(c.length,l.length);o++){if(void 0===c[o]||"string"==typeof l[o]&&"number"==typeof c[o])return-1;if(void 0===l[o]||"string"==typeof c[o]&&"number"==typeof l[o])return 1;if(c[o]>l[o])return 1;if(l[o]>c[o])return-1}}else if(s||u)return s?-1:1;return 0}var i=[">",">=","=","<","<="],a={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]};return o.validate=function(e){return"string"==typeof e&&t.test(e)},o.compare=function(e,t,n){!function(e){if("string"!=typeof e)throw new TypeError("Invalid operator type, expected string but got "+typeof e);if(-1===i.indexOf(e))throw new TypeError("Invalid operator, expected one of "+i.join("|"))}(n);var r=o(e,t);return a[n].indexOf(r)>-1},o})?r.apply(t,[]):r)||(e.exports=r)},function(e,t,n){n.d(t,"a",function(){return l});var r=n(1),o=n(2),i=n(0),n=n(3),a=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},s=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},u=Object(n.a)("div"),c=!1;Object.defineProperty(u,"id",{get:function(){return c=!0,l.name},configurable:!0});var l={name:"element-id",isOpen:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return c=!1,Object(o.b)(u),Object(o.a)(),[2,c]})})},isEnable:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,Object(i.b)({includes:[!0],excludes:[r.d,r.b,r.c]})]})})}}},function(e,t,n){n.d(t,"a",function(){return h});var r=n(1),o=n(2),i=n(5),a=n(0),s=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},u=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};function c(){}var l=0;c.toString=function(){return l++,""};var h={name:"function-to-string",isOpen:function(){return s(this,void 0,void 0,function(){return u(this,function(e){return l=0,Object(o.b)(c),Object(o.a)(),[2,2===l]})})},isEnable:function(){return s(this,void 0,void 0,function(){return u(this,function(e){return[2,Object(a.b)({includes:[!0],excludes:[r.c,(i.b||i.c)&&r.a]})]})})}}},function(e,t,n){n.d(t,"a",function(){return l});var r=n(2),o=n(1),i=n(0),a=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},s=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},u=/ /,c=!1;u.toString=function(){return c=!0,l.name};var l={name:"reg-to-string",isOpen:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return c=!1,Object(r.b)(u),Object(r.a)(),[2,c]})})},isEnable:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,Object(i.b)({includes:[!0],excludes:[o.f]})]})})}}},function(e,t,n){n.d(t,"a",function(){return a});var r=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},o=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};function i(){return(performance||Date).now()}var a={name:"debugger-checker",isOpen:function(){return r(this,void 0,void 0,function(){var t;return o(this,function(e){return t=i(),function(){}.constructor("debugger")(),[2,100<i()-t]})})},isEnable:function(){return r(this,void 0,void 0,function(){return o(this,function(e){return[2,!0]})})}}},function(e,t,n){n.d(t,"a",function(){return l});var r=n(1),o=n(2),i=n(0),a=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((u=u.apply(e,a||[])).next())})},s=this&&this.__generator||function(n,r){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},u=new Date,c=0;u.toString=function(){return c++,""};var l={name:"date-to-string",isOpen:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return c=0,Object(o.b)(u),Object(o.a)(),[2,2===c]})})},isEnable:function(){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,Object(i.b)({includes:[r.a],excludes:[]})]})})}}},function(e,t,n){n.d(t,"a",function(){return r});var n=n(3),r=/mobile/i.test(n.b)}])});let isOpenDevtools=!1;function startDetect(){isOpenDevtools=!1,devtoolsDetector.setDetectDelay(1e3),devtoolsDetector.addListener(function(e){isOpenDevtools=isOpenDevtools||e}),devtoolsDetector.launch()}function stopDetect(){devtoolsDetector.stop(),devtoolsDetector.removeListener()}function isOpenDevtoolsOpened(){return isOpenDevtools}const encoder=new TextEncoder,decoder=new TextDecoder;function concat(...e){var t=e.reduce((e,{length:t})=>e+t,0);const n=new Uint8Array(t);let r=0;return e.forEach(e=>{n.set(e,r),r+=e.length}),n}function getGlobal(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;throw new Error("unable to locate global object")}var globalThis$1=getGlobal();function isCloudflareWorkers(){try{return void 0!==getGlobal().WebSocketPair}catch(e){return!1}}function isNodeJs(){var e,t;try{return void 0!==(null===(t=null===(e=getGlobal().process)||void 0===e?void 0:e.versions)||void 0===t?void 0:t.node)}catch(e){return!1}}const encodeBase64=e=>{let t=e;"string"==typeof t&&(t=encoder.encode(t));const n=[];for(let e=0;e<t.length;e+=32768)n.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return globalThis$1.btoa(n.join(""))},encode=e=>encodeBase64(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");class JOSEError extends Error{constructor(e){super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,null!==(e=Error.captureStackTrace)&&void 0!==e&&e.call(Error,this,this.constructor)}static get code(){return"ERR_JOSE_GENERIC"}}class JOSENotSupported extends JOSEError{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class JWSInvalid extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class JWTInvalid extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}function subtleDsa(e,t){switch(e){case"HS256":return{hash:{name:"SHA-256"},name:"HMAC"};case"HS384":return{hash:{name:"SHA-384"},name:"HMAC"};case"HS512":return{hash:{name:"SHA-512"},name:"HMAC"};case"PS256":return{hash:{name:"SHA-256"},name:"RSA-PSS",saltLength:32};case"PS384":return{hash:{name:"SHA-384"},name:"RSA-PSS",saltLength:48};case"PS512":return{hash:{name:"SHA-512"},name:"RSA-PSS",saltLength:64};case"RS256":return{hash:{name:"SHA-256"},name:"RSASSA-PKCS1-v1_5"};case"RS384":return{hash:{name:"SHA-384"},name:"RSASSA-PKCS1-v1_5"};case"RS512":return{hash:{name:"SHA-512"},name:"RSASSA-PKCS1-v1_5"};case"ES256":return{hash:{name:"SHA-256"},name:"ECDSA",namedCurve:"P-256"};case"ES384":return{hash:{name:"SHA-384"},name:"ECDSA",namedCurve:"P-384"};case"ES512":return{hash:{name:"SHA-512"},name:"ECDSA",namedCurve:"P-521"};case(isCloudflareWorkers()||isNodeJs())&&"EdDSA":return{name:t,namedCurve:t};default:throw new JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}var crypto=globalThis$1.crypto;function isCryptoKey(e){return void 0!==globalThis$1.CryptoKey&&(null!=e&&e instanceof globalThis$1.CryptoKey)}var checkKeyLength=(e,t)=>{if(e.startsWith("HS")){var n=parseInt(e.substr(-3),10),r=t.algorithm["length"];if("number"!=typeof r||r<n)throw new TypeError(`${e} requires symmetric keys to be ${n} bits or larger`)}if(e.startsWith("RS")||e.startsWith("PS")){var t=t.algorithm["modulusLength"];if("number"!=typeof t||t<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}},invalidKeyInput=(e,...t)=>{let n="Key must be ";var r;return 2<t.length?(r=t.pop(),n+=`one of type ${t.join(", ")}, or ${r}.`):2===t.length?n+=`one of type ${t[0]} or ${t[1]}.`:n+=`of type ${t[0]}.`,null==e?n+=` Received ${e}`:"function"==typeof e&&e.name?n+=` Received function ${e.name}`:"object"==typeof e&&null!=e&&e.constructor&&e.constructor.name&&(n+=` Received an instance of ${e.constructor.name}`),n};function getCryptoKey(e,t,n){if(isCryptoKey(t))return t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(invalidKeyInput(t,"CryptoKey"));return crypto.subtle.importKey("raw",t,{hash:{name:`SHA-${e.substr(-3)}`},name:"HMAC"},!1,[n])}throw new TypeError(invalidKeyInput(t,"CryptoKey","Uint8Array"))}const sign=async(e,t,n)=>{t=await getCryptoKey(e,t,"sign");checkKeyLength(e,t);n=await crypto.subtle.sign(subtleDsa(e,t.algorithm.namedCurve),t,n);return new Uint8Array(n)};var sign$1=sign;const isDisjoint=(...e)=>{e=e.filter(Boolean);if(0===e.length||1===e.length)return!0;let t;for(const r of e){var n=Object.keys(r);if(t&&0!==t.size)for(const o of n){if(t.has(o))return!1;t.add(o)}else t=new Set(n)}return!0};var isDisjoint$1=isDisjoint,isKeyLike=e=>isCryptoKey(e);const types=["CryptoKey"],symmetricTypeCheck=e=>{if(!(e instanceof Uint8Array)){if(!isKeyLike(e))throw new TypeError(invalidKeyInput(e,...types,"Uint8Array"));if("secret"!==e.type)throw new TypeError(`${types.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}},asymmetricTypeCheck=(e,t)=>{if(!isKeyLike(e))throw new TypeError(invalidKeyInput(e,...types));if("secret"===e.type)throw new TypeError(`${types.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===t&&"public"===e.type)throw new TypeError(`${types.join(" or ")} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===t&&"public"===e.type)throw new TypeError(`${types.join(" or ")} instances for asymmetric algorithm decryption must be of type "private"`);if(e.algorithm&&"verify"===t&&"private"===e.type)throw new TypeError(`${types.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);if(e.algorithm&&"encrypt"===t&&"private"===e.type)throw new TypeError(`${types.join(" or ")} instances for asymmetric algorithm encryption must be of type "public"`)},checkKeyType=(e,t,n)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?symmetricTypeCheck(t):asymmetricTypeCheck(t,n)};var checkKeyType$1=checkKeyType;function validateCrit(e,t,n,r,o){if(void 0!==o.crit&&void 0===r.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!r||void 0===r.crit)return new Set;if(!Array.isArray(r.crit)||0===r.crit.length||r.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==n?new Map([...Object.entries(n),...t.entries()]):t;for(const a of r.crit){if(!i.has(a))throw new JOSENotSupported(`Extension Header Parameter "${a}" is not recognized`);if(void 0===o[a])throw new e(`Extension Header Parameter "${a}" is missing`);if(i.get(a)&&void 0===r[a])throw new e(`Extension Header Parameter "${a}" MUST be integrity protected`)}return new Set(r.crit)}class FlattenedSign{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!isDisjoint$1(this._protectedHeader,this._unprotectedHeader))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");var n={...this._protectedHeader,...this._unprotectedHeader};const r=validateCrit(JWSInvalid,new Map([["b64",!0]]),null==t?void 0:t.crit,this._protectedHeader,n);let o=!0;if(r.has("b64")&&(o=this._protectedHeader.b64,"boolean"!=typeof o))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');var t=n["alg"];if("string"!=typeof t||!t)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');checkKeyType$1(t,e,"sign");let i=this._payload;o&&(i=encoder.encode(encode(i)));let a;a=this._protectedHeader?encoder.encode(encode(JSON.stringify(this._protectedHeader))):encoder.encode("");n=concat(a,encoder.encode("."),i),n=await sign$1(t,e,n);const s={signature:encode(n),payload:""};return o&&(s.payload=decoder.decode(i)),this._unprotectedHeader&&(s.header=this._unprotectedHeader),this._protectedHeader&&(s.protected=decoder.decode(a)),s}}var FlattenedSign$1=FlattenedSign;class CompactSign{constructor(e){this._flattened=new FlattenedSign$1(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){t=await this._flattened.sign(e,t);if(void 0===t.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${t.protected}.${t.payload}.${t.signature}`}}var CompactSign$1=CompactSign,epoch=e=>Math.floor(e.getTime()/1e3);function isObjectLike(e){return"object"==typeof e&&null!==e}function isObject(t){if(isObjectLike(t)&&"[object Object]"===Object.prototype.toString.call(t)){if(null===Object.getPrototypeOf(t))return 1;let e=t;for(;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}}const minute=60,hour=60*minute,day=24*hour,week=7*day,year=365.25*day,REGEX=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;var secs=e=>{const t=REGEX.exec(e);if(!t)throw new TypeError("Invalid time period format");var n=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(n);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(n*minute);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(n*hour);case"day":case"days":case"d":return Math.round(n*day);case"week":case"weeks":case"w":return Math.round(n*week);default:return Math.round(n*year)}};class ProduceJWT{constructor(e){if(!isObject(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return this._payload="number"==typeof e?{...this._payload,nbf:e}:{...this._payload,nbf:epoch(new Date)+secs(e)},this}setExpirationTime(e){return this._payload="number"==typeof e?{...this._payload,exp:e}:{...this._payload,exp:epoch(new Date)+secs(e)},this}setIssuedAt(e){return this._payload=void 0===e?{...this._payload,iat:epoch(new Date)}:{...this._payload,iat:e},this}}class SignJWT extends ProduceJWT{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){var n;const r=new CompactSign$1(encoder.encode(JSON.stringify(this._payload)));if(r.setProtectedHeader(this._protectedHeader),Array.isArray(null===(n=this._protectedHeader)||void 0===n?void 0:n.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}async function encrypt(e,t){return new SignJWT({info:e,image:t}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setIssuedAt().setIssuer(window.location.href).setExpirationTime("10m").sign((new TextEncoder).encode(atob("aHlwaGVuIGNvbnRlbnRseSBiYWtpbmcgc3RhbGVtYXRl")))}function getInitialConstraint(){return{}}function getInitialBaseConstraint(){return{video:{facingMode:"user"},audio:!1}}function getInitialDefaultConstraint(){return{video:{width:{min:640,ideal:1280,max:1920},height:{min:480,ideal:720,max:1080}}}}function styleInject(e,t){var n,r=(t=void 0===t?{}:t).insertAt;e&&"undefined"!=typeof document&&(n=document.head||document.getElementsByTagName("head")[0],(t=document.createElement("style")).type="text/css","top"===r&&n.firstChild?n.insertBefore(t,n.firstChild):n.appendChild(t),t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)))}var css_248z="body,html{border:0;font-size:100%;margin:0;padding:0;vertical-align:baseline}#box-camera{align-items:center;background-color:transparent;box-sizing:border-box;display:block;height:100%;justify-content:center;margin:0;object-fit:cover;overflow:hidden;padding:0;position:absolute;width:100%}#box-camera .canvas{bottom:0;left:50%;margin:0 auto;position:absolute;top:0;top:50%;transform:translate(-50%,-50%) scaleX(-1);z-index:50}#box-camera #camera--canvas{display:none}#box-camera #svgMask{bottom:0;position:absolute}#box-camera #camera--canvas,#box-camera #camera--video{filter:FlipH;height:100%;transform:scaleX(-1);width:100%}#box-camera #camera--overlay{height:100%;left:0;position:absolute;top:0;transform:scaleX(-1);width:100%}#box-camera #camera--trigger{border:none;border-radius:30px;box-shadow:0 5px 10px 0 rgba(0,0,0,.2);cursor:pointer;display:none;font-size:16px;height:60px;left:0;margin:0 auto;position:absolute;right:0;text-align:center;width:60px;z-index:10}#box-camera audio,#box-camera canvas,#box-camera video{*zoom:1;display:inline-block;*display:inline;max-width:100%}#box-camera #camera--message{border-radius:2px;font-size:15px;font-weight:700;height:30px;left:0;line-height:30px;margin:0 auto;opacity:0;position:absolute;right:0;text-align:center;transition:visibility 0s,opacity .5s linear;visibility:hidden;width:250px;z-index:61}#box-camera #box--document-info{bottom:0;left:0;position:absolute;z-index:9}#box-camera #box--document-info #label--document{display:inline-block;left:0;position:absolute;right:0;text-align:center;vertical-align:middle}#box-camera #svgMask .cls-text{font-family:inherit;font-size:20px}#box-camera #svgMask .cls-text-medium{font-size:25px}#box-camera #svgMask .cls-text-big{font-family:inherit;font-size:29px}#box-camera ::-webkit-media-controls-panel,#box-camera ::-webkit-media-controls-start-playback-button{-webkit-appearance:none;display:none!important}#box-camera ::--webkit-media-controls-play-button,#box-camera video::-webkit-media-controls-panel{-webkit-appearance:none;display:none!important}#box-camera video::--webkit-media-controls-play-button,#box-camera video::-webkit-media-controls-start-playback-button{-webkit-appearance:none;display:none!important}html>#detach-button-host{display:none!important}html>#detach-button-host:host{display:none!important}#box-camera #box--loading{background-color:#fff;margin:0 auto;right:0;z-index:62}#box-camera #box--loading,#box-camera #camera--fade{height:100%;left:0;position:absolute;top:0;width:100%}#box-camera #camera--fade{background-color:rgba(255,255,255,.8);opacity:0;-webkit-transition:background-color .2s ease-out;-moz-transition:background-color .2s ease-out;-o-transition:background-color .2s ease-out;transition:background-color .2s ease-out;z-index:5}";styleInject(css_248z);const version="2.0.2",webFrameModel=acessoWebFrameModel,SILHOUETTE_CONFIGURATIONS={CLOSE:{WIDTH:isMobile()?285:307.8,HEIGHT:isMobile()?456:492.48}};let constraints=getInitialConstraint(),constraintsBase=getInitialBaseConstraint(),defaultConstraints=getInitialDefaultConstraint(),videoOrientation=null,track=null,cameraOpen=null,stream=null,aspectRatioVideo=1280/720,videoWidth=0,videoHeight=0,mWidth=0,mHeight=0,resolutionWidth=1280,resolutionHeight=720,isResolutionRead=!1,forwardTimes=[],isCaptureReady=!1,isLoading=!1,isFaceApiIsRunning=!1,counterIsRunning=0,isEnabledInactivity=!1,onCallback=null,LABEL_DOCUMENT_OTHERS=null,isTimerTaking=!1,timerTake=null,isEmulatedDevice=!1,source_notallowed_info=[],all_sources_label=[],source_allowed_label=[],hasDetectBlackBorder=!1,hasDetectWhiteBorder=!1;const COLOR_SILHOUETTE={PRIMARY:"#297fff",SECONDARY:"#fff",NEUTRAL:"#fff"};let COLOR_BUTTON_CAPTURE={BACKGROUND:"#297fff",COLOR:"#fff"},COLOR_MESSAGE={BACKGROUND:"#297fff",COLOR:"#fff"};const MAX_TIME_SESSION=40,MAX_INACTIVITY_TIME_SESSION=20,TIMER_TAKE_DELAY_MILLISECONDS=1700;let COLOR_BOX_DOCUMENT={BACKGROUND:"#fff",COLOR:"#000"},cameraVideo=null,cameraCanvas=null,cameraOverlay=null,buttonCapture=null,boxCamera=null,cameraFade=null;function addClickEvent(){buttonCapture&&(buttonCapture.onclick=takePicture)}function gotStream(e){e&&(stream=window.stream=e,setTrack(cameraVideo.srcObject=e))}function setTrack(e){e&&(track=e.getVideoTracks()[0],track.getSettings()&&(isResolutionRead||(isResolutionRead=!0,resolutionWidth=track.getSettings().width,resolutionHeight=track.getSettings().height)),setConstraint(track.getConstraints()))}function setConstraint(e){var t;e&&(t={},Object.assign(t,constraints),Object.assign(t,e),constraints=t,setAspectRatio(constraints))}function setAspectRatio(e){let t=resolutionWidth,n=resolutionHeight;e&&e.video&&e.video.width&&e.video.width.exact&&(t=e.video.width.exact),e&&e.video&&e.video.height&&e.video.height.exact&&(n=e.video.height.exact),t&&n&&(aspectRatioVideo=t>n?t/n:n/t)}function isPermissionDenied(e){return!!(e.toLowerCase().match(/failed due to shutdown/i)||e.toLowerCase().match(/permission dismissed/i)||e.toLowerCase().match(/permission denied/i)||e.toLowerCase().match(/denied permission/i)||e.toLowerCase().match(/not allowed/i))}function isCameraBusy(e){return!(!e.match(/starting videoinput failed/i)&&!e.match(/start video source/i))}function handleError(e){closeCamera(),add(e),e?isCameraBusy(e.message)?onCallback.on.error(getError(CODE_ERROR.ERROR_114,get())):isPermissionDenied(e.message)?onCallback.on.error(getError(CODE_ERROR.ERROR_101,get())):onCallback.on.error(getError(CODE_ERROR.ERROR_DEFAULT_100,get())):(e=get(),onCallback.on.error(getError(CODE_ERROR.ERROR_DEFAULT_100,e||{name:"StartCamera"})))}function setMobileStyle(){cameraVideo&&(isMobile()?cameraVideo.style["object-fit"]="cover":cameraVideo.style["object-fit"]="")}function startCamera(){try{window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),constraints&&constraints.video&&constraints.video.width&&constraints.video.height&&constraints.video.width.min&&constraints.video.width.ideal&&constraints.video.width.max&&constraints.video.height.min&&constraints.video.height.ideal&&constraints.video.height.max||(isMobile()&&(isDocumentCapture()||isCameraNormalAndFaceModeBack())&&setCameraBack(),configureConstraints())}catch(e){throw add(e),e}getUserMedia()}function verifyEmulatedDevice(){isEmulatedDevice=isEmulatedDevice$1(),!isEmulatedDevice&&cameraOpen&&setTimeout(function(){verifyEmulatedDevice()},1e3)}function getUserMedia(){navigator.mediaDevices.getUserMedia(getConstraints()).then(function(t){verifyOriginStream().then(e=>{try{all_sources_label=getVideoLabelsList(),e?forceFirstOrigin(t):(source_notallowed_info=getArrNotAuthOriginsDetected(),getAuthenticateOriginId()?(source_allowed_label=getAuthenticateOriginLabel(),forceAuthenticateOrigin(t)):forceFirstOrigin(t))}catch(e){throw add(e),e}}).catch(function(e){throw add(e),e})}).catch(function(e){handleError(e)})}function successStreamUserMedia(e){try{gotStream(e),setMobileStyle(),setTypeSilhouette(),calcBtnCapturePos(),calcMarginMask(),setConfiguration(),set(4,Date.now()),monitoringAfterCameraOpen()}catch(e){throw add(e),e}}function configureConstraints(){Object.assign(constraints,constraintsBase),isFirefox&&isMobile()&&isFrontSelfie()&&(defaultConstraints.video.facingMode="user"),Object.assign(constraints,defaultConstraints),setConstraint(constraints)}function forceAuthenticateOrigin(e){let t=constraints.video;t.deviceId=getAuthenticateOriginId()?{exact:getAuthenticateOriginId()}:void 0,constraints.video=t,window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),navigator.mediaDevices.getUserMedia(getConstraints()).then(function(e){successStreamUserMedia(e)}).catch(function(e){handleError(e)})}function forceFirstOrigin(e){if(!isMobile()||isEmulatedDevice){let e=constraints.video;e.deviceId=getFirstOriginId()?{exact:getFirstOriginId()}:void 0,constraints.video=e}window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),navigator.mediaDevices.getUserMedia(getConstraints()).then(function(e){successStreamUserMedia(e)}).catch(function(e){handleError(e)})}function setCameraBack(){constraintsBase.video.facingMode="environment",defaultConstraints.video.facingMode="environment",cameraVideo.style.webkitTransform="none",cameraCanvas.style.webkitTransform="none"}function monitoringAfterCameraOpen(){isSmartSelfie()?(add$2(6,"Time waiting inference models",Date.now(),!0),verifyFaceApiIsRunning(),setConfiguration()):isLoading&&(hideBoxLoading(),hideMessage(),isLoading=!1,add$2(3,"global timer",Date.now(),!0))}function stopStuffsAfterTake(){track&&track.stop(),window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),cameraVideo[0]&&cameraVideo[0].pause(),cameraVideo.srcObject=null,stream&&stream.getTracks().forEach(function(e){e.stop()}),setVisibilityAfterTake(),hideMessage(),hideButtonCapture(),hideBoxDocumentInfo(),cameraOpen=!1,removeEventsGlobal()}function showCameraVideo(){cameraVideo.style.display="unset"}function hideCameraVideo(){cameraVideo.style.display="none"}function setVisibilityOpenCamera(){showToDisplayMask(),showCameraVideo(),hideBoxLoading()}function setVisibilityAfterTake(){hideToDisplayMask(),hideCameraVideo()}function calcBtnCapturePos(){var e;isNormalSelfie()?(e=cameraVideo.offsetHeight/2-Math.round(.04*cameraVideo.offsetHeight),buttonCapture.style.top=e+.1*mHeight+mHeight/2+"px",buttonCapture.style.display="inline-block"):isDocumentCapture()?(buttonCapture.style.bottom="",buttonCapture.style.top=bottomSilhouetteDocument+10+"px",buttonCapture.style.display="inline-block",createBoxDocumentInfo()):isSmartSelfie()&&hideButtonCapture()}function calcMarginMask(){var e=getCalcMarginMask();cameraOverlay.style.padding=`${e.paddingH}px ${e.paddingW}px`,cameraOverlay.style.width=`calc(100% - ${2*e.paddingW}px)`,cameraOverlay.style.height=`calc(100% - ${2*e.paddingH}px)`}function getCalcMarginMask(){var e=boxCamera.offsetHeight-videoHeight,t=boxCamera.offsetWidth-videoWidth;return{paddingW:0<t?t/2:0,paddingH:0<e?e/2:0}}function toggleFullScreen(){document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen()}function orientationChange(e){try{setOrientation(),window.scrollTo(0,document.body.scrollHeight),updateView(),toggleFullScreen()}catch(e){throw add(e),e}}function updateView(){cameraOpen&&((isNormalSelfie()||isSmartSelfie()?loadMask:loadMaskDocument)(),calcBtnCapturePos(),calcMarginMask(),setMobileStyle(),setTopLabelMessage(cameraVideo,mHeight))}async function addEventResize(){window.addEventListener("resize",e=>{setOrientation(),updateView(),toggleFullScreen()})}function updateTimeStats(e){forwardTimes=[e].concat(forwardTimes).slice(0,30),forwardTimes.reduce((e,t)=>e+t),forwardTimes.length}function verifyFaceApiIsRunning(){isFaceApiIsRunning||(8<=counterIsRunning?(setSelfieTypeProcess(TYPE_CAMERA.CAMERA_NORMAL),loadMask(),calcBtnCapturePos(),hideBoxLoading(),hideMessage(),isLoading=!1,onPlay()):setTimeout(()=>{counterIsRunning++,verifyFaceApiIsRunning()},1e3))}function setVariablesIfIsLoading(){isFaceApiIsRunning=!0,hideBoxLoading(),isLoading=!1,set(6,Date.now()),hideMessage(),add$2(3,"global timer",Date.now(),!0)}function verifyMaxTimeSession(e){var t=get$1(3);return null!==t&&compareMilliseconds(t.initial,Date.now())>e}function verifyMaxInactivityTimeSession(e){var t=get$1(7);return null!==t&&compareMilliseconds(t.initial,Date.now())>e}function showFade(){cameraFade.style.display="block",cameraFade.style.opacity="1"}function hideFade(){cameraFade.style.display="none",cameraFade.style.opacity="0"}async function onPlay(){try{if(isCaptureReady||!cameraOpen||0===cameraVideo.offsetWidth)return setIntervalRecursivePlay(!0);if(isSmartSelfie()){if(verifyMaxTimeSession(MAX_TIME_SESSION))return closeByMaxSessionTime(),setIntervalRecursivePlay(!0);if(verifyConditionsToCapture())return setIntervalRecursivePlay(!1,!0);var e=Date.now(),t=await detectSingleFace(cameraVideo,getFaceDetectorOptions()).withFaceLandmarks();if(updateTimeStats(Date.now()-e),isLoading)return setVariablesIfIsLoading(),setIntervalRecursivePlay();if(t){if(isCaptureReady||!cameraOpen||0===cameraVideo.offsetWidth)return setIntervalRecursivePlay();const n=getResizeLandmarks(cameraOverlay,cameraVideo,t);return isCentralizedFace(n.positions[0]._x,n.positions[0]._y,n.positions[16]._x,n.positions[16]._y,n.positions[27]._x,n.positions[27]._y,mWidth,resolutionWidth,resolutionHeight,cameraVideo,isMobile()),add$1(n.getLeftEye()[4].y,n.getLeftEye()[2].y),isCentralized?(changeColorMask(COLOR_SILHOUETTE.PRIMARY,boxCamera),isSmartSelfie()&&(showMessage("Não se mexa..."),isTimerTaking||initTimerTake(TIMER_TAKE_DELAY_MILLISECONDS))):(changeColorMask(COLOR_SILHOUETTE.SECONDARY,boxCamera),showMessage(getMessageCentralizedIsNotCheck(n.positions[0]._x,n.positions[16]._x,n.positions[27]._y)),isTimerTaking=!1,clearTimeout(timerTake)),isEnabledInactivity=isEnabledInactivity&&!1,setIntervalRecursivePlay()}if(changeColorMask(COLOR_SILHOUETTE.NEUTRAL,boxCamera),hideMessage(),isTimerTaking=!1,clearTimeout(timerTake),isEnabledInactivity){if(verifyMaxInactivityTimeSession(MAX_INACTIVITY_TIME_SESSION))return closeByMaxInactivitySessionTime(),setIntervalRecursivePlay(!0)}else add$2(7,"inactivity",Date.now(),!0),isEnabledInactivity=!0;return setIntervalRecursivePlay()}return verifyMaxTimeSession(MAX_TIME_SESSION)?(closeByMaxSessionTime(),setIntervalRecursivePlay(!0)):setIntervalRecursivePlay()}catch(e){add(e),closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_DEFAULT_100,"onPlay "+e.message))}}function getResizeLandmarks(e,t,n){let r=matchDimensions(e,t,!0);return r.height=t.offsetHeight,r.width=t.offsetWidth,resizeResults(n,r).landmarks}function verifyConditionsToCapture(){return cameraVideo.paused||cameraVideo.ended||!isFaceDetectionModelLoaded()||isCaptureReady}function closeByMaxSessionTime(){isCaptureReady=!0,setLoading(),hideButtonCapture(),set(3,Date.now()),set(2,Date.now()),closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_102))}function closeByMaxInactivitySessionTime(){isCaptureReady=!0,setLoading(),hideButtonCapture(),set(3,Date.now()),set(2,Date.now()),set(7,Date.now()),closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_103))}function setLoading(){showBoxLoading()}function hideButtonCapture(){buttonCapture.style.display="none"}function initTimerTake(e){isTimerTaking=!0,timerTake=setTimeout(()=>{isCentralized?(clearTimeout(timerTake),takePicture()):(isTimerTaking=!1,clearTimeout(timerTake))},e)}function takePictureOneStep(){try{let t=getBase64Canvas();isCaptureReady=!0,set(3,Date.now()),set(2,Date.now()),showFade(),setTimeout(function(){hideFade(),setLoading(),hideButtonCapture(),encrypt(getLog(),t).then(e=>{onCallback.on.success({base64:t,encrypted:e})}),closeCamera()},300)}catch(e){throw add(e),e}}function takePicture(){try{cameraOpen?takePictureOneStep():(setVisibilityOpenCamera(),startCamera())}catch(e){throw add(e),e}}function removeAllControlsAfterCapture(){boxCamera.innerHTML="",cameraVideo=null,cameraCanvas=null,cameraOverlay=null,buttonCapture=null,boxCamera=null,cameraFade=null}function closeCamera(){cameraOpen=!1,stopStuffsAfterTake(),hideBoxLoading(),removeAllControlsAfterCapture()}function getTypePlatform(){let e="js-";return isIOS()?isMobile()?e+="ios":e+="macos":isAndroid()?e+="android":e+="windows",e}function getStatusIInfo(){return!!(isEmulatedDevice||isOpenDevtoolsOpened()||0<source_notallowed_info.length||hasDetectBlackBorder||hasDetectWhiteBorder)}function getLog(){return{lib:{version:version,date:Date.now()},device:{ua:platform.ua,model:platform.product,os:platform.os.family,platform:getTypePlatform(),api:platform.os.family},url_domain:window.location.href,capture:getTypeCapture(),blinks:getTotalblinks(),silhouette:{w:Math.round(mWidth),h:Math.round(mHeight)},i_info:{status:getStatusIInfo(),info:{dev:isOpenDevtoolsOpened(),ied:isEmulatedDevice,snai:source_notallowed_info,sai:source_allowed_label,asl:all_sources_label,hbb:hasDetectBlackBorder,hwb:hasDetectWhiteBorder}},video:{w:Math.round(videoWidth),h:Math.round(videoHeight)},connections:getConnection(),asp_rd:aspectRatioVideo,timers:getObjectLog(null!==TYPE_PROCESS?TYPE_PROCESS:TYPE_PROCESS_DOCUMENT)}}function getTypeCapture(){let e="",t,n;return null!==TYPE_PROCESS?(e="selfie",n=TYPE_PROCESS_INITIAL,t=TYPE_PROCESS):null!==TYPE_PROCESS_DOCUMENT&&(e="doc",n=TYPE_PROCESS_DOCUMENT,t=TYPE_PROCESS_DOCUMENT),{type:e,type_exc:t,type_init:n}}function getConnection(){let e={effectiveType:"",rtt:null,type:"",downlink:null};return navigator.connection&&(navigator.connection.effectiveType&&(e.effectiveType=navigator.connection.effectiveType),navigator.connection.rtt&&(e.rtt=navigator.connection.rtt),navigator.connection.type&&(e.type=navigator.connection.type),navigator.connection.downlink&&(e.downlink=navigator.connection.downlink)),e}function isBlack(n){if(0<n.length){let e=arrayRemove(n,255),t=!0;return e.forEach(e=>{0<e&&(t=!1)}),t}return!1}function isWhite(n){if(0<n.length){let e=arrayRemove(n,0),t=!0;return e.forEach(e=>{e<255&&(t=!1)}),t}return!1}function arrayRemove(e,t){return e.filter(function(e){return e!=t})}function getPixelsBorders(e){return{pixelDataTop:e.getContext("2d").getImageData(0,0,e.width,1).data,pixelDataBottom:e.getContext("2d").getImageData(0,e.height-1,e.width,1).data,pixelDataLeft:e.getContext("2d").getImageData(0,0,1,e.height).data,pixelDataRight:e.getContext("2d").getImageData(e.width-1,0,1,e.height).data}}function detectBlackBorders(e){return isBlack(getPixelsBorders(e).pixelDataTop)||isBlack(getPixelsBorders(e).pixelDataBottom)||isBlack(getPixelsBorders(e).pixelDataLeft)||isBlack(getPixelsBorders(e).pixelDataRight)}function detectWhiteBorders(e){return isWhite(getPixelsBorders(e).pixelDataTop)||isWhite(getPixelsBorders(e).pixelDataBottom)||isWhite(getPixelsBorders(e).pixelDataLeft)||isWhite(getPixelsBorders(e).pixelDataRight)}function getBase64Canvas(){return cameraCanvas.width=cameraVideo.videoWidth,cameraCanvas.height=cameraVideo.videoHeight,cameraCanvas.getContext("2d").drawImage(cameraVideo,0,0),hasDetectBlackBorder=detectBlackBorders(cameraCanvas),hasDetectWhiteBorder=detectWhiteBorders(cameraCanvas),cameraCanvas.toDataURL("image/jpeg")}function addEventPlay(){cameraVideo.addEventListener("play",()=>{cameraOpen=!0,verifyEmulatedDevice(),toWork(),onPlay()})}function toWork(){setTimeout(function(){toWork()},1e3)}function setVideoDisplayFace(e,t){var n;t<e&&(videoOrientation=Orientation.LANDSCAPE),isMobile()?(videoWidth=cameraVideo.offsetWidth,videoHeight=cameraVideo.offsetHeight):(n=cameraVideo.offsetWidth/cameraVideo.offsetHeight,videoWidth=aspectRatioVideo>n?(videoHeight=cameraVideo.offsetWidth/aspectRatioVideo,cameraVideo.offsetWidth):(videoHeight=cameraVideo.offsetHeight,cameraVideo.offsetHeight*aspectRatioVideo))}function setSilhouetteSizesFace(){var e,t;isMobile()&&resolutionHeight>resolutionWidth&&(e=resolutionHeight,t=resolutionWidth,resolutionHeight=t,resolutionWidth=e);let n=null,r=null;(isNormalSelfie()||isSmartSelfie())&&(n=videoWidth/resolutionWidth*SILHOUETTE_CONFIGURATIONS.CLOSE.WIDTH,r=videoHeight/resolutionHeight*SILHOUETTE_CONFIGURATIONS.CLOSE.HEIGHT),mHeight=isMobile()?(mWidth=videoOrientation===Orientation.PORTRAIT?r/(SILHOUETTE_CONFIGURATIONS.CLOSE.HEIGHT/SILHOUETTE_CONFIGURATIONS.CLOSE.WIDTH):n,r):640===resolutionWidth&&480===resolutionHeight?(mWidth=.65*videoHeight*.7,.65*videoHeight):(mWidth=n,r)}function loadMask(){var e=cameraVideo.offsetWidth,t=cameraVideo.offsetHeight;setBorderColor(COLOR_SILHOUETTE.NEUTRAL),setBorderWidth(5),setVideoDisplayFace(e,t),setSilhouetteSizesFace(),createSelfieMask(boxCamera,mWidth,mHeight,e,t)}function setTypeSilhouette(){(isNormalSelfie()||isSmartSelfie()?loadMask:loadMaskDocument)()}function setVideoDisplayDocument(e,t){var n=0;t<e&&(videoOrientation=Orientation.LANDSCAPE),isMobile()?(videoWidth=cameraVideo.offsetWidth,videoHeight=cameraVideo.offsetHeight):(n=cameraVideo.offsetWidth/cameraVideo.offsetHeight,videoWidth=aspectRatioVideo>n?(videoHeight=cameraVideo.offsetWidth/aspectRatioVideo,cameraVideo.offsetWidth):(videoHeight=cameraVideo.offsetHeight,cameraVideo.offsetHeight*aspectRatioVideo)),isMobile()&&isIOS()&&resolutionHeight>resolutionWidth&&(e=resolutionHeight,n=resolutionWidth,resolutionHeight=n,resolutionWidth=e)}function setSilhouetteSizesDocument(){let e,t;t=isMobile()?(e=.95*videoWidth,.75*videoHeight):(e=.7*videoHeight*.75,.7*videoHeight),mHeight=(mWidth=isMobile()&&videoOrientation===Orientation.PORTRAIT?t/(.75*videoHeight/(.95*videoWidth)):e,t),mHeight=(isMobile(),mWidth=e,t)}function loadMaskDocument(){var e=cameraVideo.offsetWidth,t=cameraVideo.offsetHeight;setBorderColor(COLOR_SILHOUETTE.NEUTRAL),setBorderWidth(3),setVideoDisplayDocument(e,t),setSilhouetteSizesDocument(),createDocumentMask(boxCamera,mWidth,mHeight,e,t)}function browserNotSupportCallback(){var e=browserNotSupport();return onCallback.on.support(e)}function resetVariables(){constraints=getInitialConstraint(),constraintsBase=getInitialBaseConstraint(),defaultConstraints=getInitialDefaultConstraint(),aspectRatioVideo=1280/720,resolutionWidth=1280,resolutionHeight=720,isResolutionRead=!1,forwardTimes=[],isCaptureReady=!1,isFaceApiIsRunning=!1,isTimerTaking=!1,timerTake=null,track=null,cameraOpen=null,resetVariables$1(),stream=null,videoWidth=0,videoHeight=0,mWidth=0,mHeight=0,isResolutionRead=!1,forwardTimes=[],isEnabledInactivity=!1,resetCentralized(),reset(),counterIsRunning=0,boxCamera.querySelector("#svgMask")&&boxCamera.querySelector("#svgMask").remove(),boxCamera.querySelector("#box--document-info")&&boxCamera.querySelector("#box--document-info").remove()}function setIntervalRecursivePlay(e=!1,t=!1){var n=0<forwardTimes.length?forwardTimes[forwardTimes.length-1]:50;return isSmartSelfie()?e?setTimeout(null,0):t?setTimeout(function(){onPlay()},500):n<=100?setTimeout(function(){onPlay()},200):100<n&&n<=350?setTimeout(function(){onPlay()},80):350<n?setTimeout(function(){onPlay()},50):setTimeout(function(){onPlay()},200):e?setTimeout(null,0):setTimeout(function(){onPlay()},500)}function createElements(){boxCamera.innerHTML="";let e=document.createElement("canvas");e.id="camera--canvas";let t=document.createElement("canvas");t.id="camera--overlay";let n=document.createElement("video");n.id="camera--video",n.autoplay=!0,n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline","");let r=document.createElement("span");r.id="camera--message";let o=document.createElement("div");o.id="camera--trigger",o.innerHTML=`<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m511.914062 256c0-141.386719-114.59375-256-255.957031-256-141.359375 0-255.957031 114.613281-255.957031 256s114.597656 256 255.957031 256c141.363281 0 255.957031-114.613281 255.957031-256zm0 0" fill="${COLOR_BUTTON_CAPTURE.BACKGROUND}"/><path d="m420.035156 59.527344c33.199219 43.175781 52.953125 97.234375 52.953125 155.910156 0 141.386719-114.597656 256-255.957031 256-62.441406 0-119.652344-22.371094-164.078125-59.527344 46.792969 60.859375 120.3125 100.089844 203.003906 100.089844 141.363281 0 255.957031-114.613281 255.957031-256 0-78.933594-35.726562-149.511719-91.878906-196.472656zm0 0" fill="${COLOR_BUTTON_CAPTURE.BACKGROUND}"/><path d="m369.839844 177.828125h-41.277344c-8.878906 0-16.699219-5.839844-19.222656-14.351563l-.523438-1.769531c-3.582031-12.074219-14.671875-20.355469-27.265625-20.355469h-51.308593c-12.667969 0-23.808594 8.378907-27.324219 20.550782l-.414063 1.4375c-2.476562 8.582031-10.332031 14.488281-19.261718 14.488281h-41.167969c-10.300781 0-18.648438 8.351563-18.648438 18.652344v148.265625c0 10.300781 8.347657 18.652344 18.648438 18.652344h227.765625c10.300781 0 18.652344-8.351563 18.652344-18.652344v-148.265625c0-10.300781-8.351563-18.652344-18.652344-18.652344zm0 0" fill="${COLOR_BUTTON_CAPTURE.COLOR}"/><path d="m369.839844 177.828125h-41.277344c-8.878906 0-16.699219-5.839844-19.222656-14.351563l-.523438-1.769531c-3.582031-12.074219-14.671875-20.355469-27.265625-20.355469h-25.59375c12.59375 0 23.683594 8.28125 27.265625 20.355469l.523438 1.769531c2.523437 8.511719 10.34375 14.351563 19.222656 14.351563h37.1875c10.304688 0 18.652344 8.351563 18.652344 18.652344v148.265625c0 10.300781-8.347656 18.652344-18.652344 18.652344h29.683594c10.300781 0 18.652344-8.351563 18.652344-18.652344v-148.265625c0-10.300781-8.351563-18.652344-18.652344-18.652344zm0 0" fill="${COLOR_BUTTON_CAPTURE.COLOR}"/><path d="m313.4375 266.28125c0-29.632812-24.019531-53.652344-53.644531-53.652344s-53.644531 24.019532-53.644531 53.652344 24.019531 53.652344 53.644531 53.652344 53.644531-24.019532 53.644531-53.652344zm0 0" fill="${COLOR_BUTTON_CAPTURE.BACKGROUND}"/><path d="m295.304688 266.28125c0-19.613281-15.898438-35.515625-35.511719-35.515625s-35.511719 15.902344-35.511719 35.515625c0 19.617188 15.898438 35.515625 35.511719 35.515625s35.511719-15.898437 35.511719-35.515625zm0 0" fill="${COLOR_BUTTON_CAPTURE.BACKGROUND}"/><path d="m366.574219 207.671875c0 4.289063-3.476563 7.765625-7.765625 7.765625-4.289063 0-7.765625-3.476562-7.765625-7.765625s3.476562-7.765625 7.765625-7.765625c4.289062 0 7.765625 3.476562 7.765625 7.765625zm0 0" fill="${COLOR_BUTTON_CAPTURE.BACKGROUND}"/></svg>`;let i=document.createElement("div");i.id="box--loading",i.style.display="none";let a=document.createElement("div");a.id="camera--fade",boxCamera.appendChild(e),boxCamera.appendChild(n),boxCamera.appendChild(t),boxCamera.appendChild(r),boxCamera.appendChild(o),boxCamera.appendChild(i),boxCamera.appendChild(a)}function createBoxDocumentInfo(){let e=boxCamera.querySelector("#box--document-info");if(e){var t=cameraVideo.offsetHeight-parseFloat(buttonCapture.style.top.replace("px",""))-buttonCapture.offsetHeight/2;e.style.height=t+"px",e.style.backgroundColor=COLOR_BOX_DOCUMENT.BACKGROUND,boxCamera.querySelector("#label--document").style.top=t/2+"px"}else{let e=document.createElement("div");e.id="box--document-info",e.style.width="100%";t=cameraVideo.offsetHeight-parseFloat(buttonCapture.style.top.replace("px",""))-buttonCapture.offsetHeight/2;e.style.height=t+"px",e.style.backgroundColor=COLOR_BOX_DOCUMENT.BACKGROUND,e.innerHTML=`<span id="label--document" style="top: ${t/2}px; color: ${COLOR_BOX_DOCUMENT.COLOR};">${getLabelDocument()}</span>`,boxCamera.appendChild(e)}}function hideBoxDocumentInfo(){let e=boxCamera.querySelector("#box--document-info");e&&(e.style.display="none")}function setControls(){boxCamera=document.querySelector("#box-camera"),createElements(),cameraVideo=boxCamera.querySelector("#camera--video"),cameraCanvas=boxCamera.querySelector("#camera--canvas"),cameraOverlay=boxCamera.querySelector("#camera--overlay"),buttonCapture=boxCamera.querySelector("#camera--trigger"),cameraFade=boxCamera.querySelector("#camera--fade"),cameraFade.style.display="none",cameraFade.style.opacity="0",setBoxCamera(boxCamera),setStyleMessage(COLOR_MESSAGE.BACKGROUND,COLOR_MESSAGE.COLOR)}function callAllMethodsInit(){try{addEventsGlobal(),addClickEvent(),setOrientation(),addEventPlay(),addEventResize()}catch(e){throw add(e),e}startCamera()}function setConfiguration(){isSmartSelfie()&&setTopLabelMessage(cameraVideo,mHeight)}function getLabelDocument(){return TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CNH?"CNH Aberta":TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.CPF?"CPF":TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_FRONT||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_FRONT?"RG Frente":TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.RG_BACK||TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.NEW_RG_BACK?"RG Verso":TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.OTHERS?LABEL_DOCUMENT_OTHERS:void 0}function setOrientation(){var e=(screen.orientation||{}).type||screen.mozOrientation||screen.msOrientation;videoOrientation=e?"landscape-primary"==e||"landscape-secondary"==e?Orientation.LANDSCAPE:Orientation.PORTRAIT:boxCamera.offsetWidth>boxCamera.offsetHeight?Orientation.LANDSCAPE:Orientation.PORTRAIT,cameraOpen&&isMobile()&&videoOrientation===Orientation.LANDSCAPE&&(closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_104)))}function getConstraints(){return constraints}function visibilityChange(){cameraOpen&&document.hidden&&(closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_106)))}function focusOutScreen(){cameraOpen&&(closeCamera(),onCallback.on.error(getError(CODE_ERROR.ERROR_105)))}function addEventsGlobal(){navigator.mediaDevices.enumerateDevices().catch(handleError),window.addEventListener("orientationchange",orientationChange),navigator.mediaDevices.ondevicechange=orientationChange,document.addEventListener("visibilitychange",visibilityChange,!1),window.addEventListener("blur",focusOutScreen),startDetect()}function removeEventsGlobal(){window.removeEventListener("orientationchange",orientationChange),navigator.mediaDevices.ondevicechange=null,document.removeEventListener("visibilitychange",visibilityChange,!1),window.removeEventListener("blur",focusOutScreen),stopDetect()}function setLayoutProperties(e){null!=e&&(e.silhouette&&(e.silhouette.primaryColor&&isHexaColorValid(e.silhouette.primaryColor)&&(COLOR_SILHOUETTE.PRIMARY=e.silhouette.primaryColor),e.silhouette.secondaryColor&&isHexaColorValid(e.silhouette.secondaryColor)&&(COLOR_SILHOUETTE.SECONDARY=e.silhouette.secondaryColor),e.silhouette.neutralColor&&isHexaColorValid(e.silhouette.neutralColor)&&(COLOR_SILHOUETTE.NEUTRAL=e.silhouette.neutralColor)),e.buttonCapture&&(e.buttonCapture.backgroundColor&&isHexaColorValid(e.buttonCapture.backgroundColor)&&(COLOR_BUTTON_CAPTURE.BACKGROUND=e.buttonCapture.backgroundColor),e.buttonCapture.iconColor&&isHexaColorValid(e.buttonCapture.iconColor)&&(COLOR_BUTTON_CAPTURE.COLOR=e.buttonCapture.iconColor)),e.boxMessage&&(e.boxMessage.backgroundColor&&isHexaColorValid(e.boxMessage.backgroundColor)&&(COLOR_MESSAGE.BACKGROUND=e.boxMessage.backgroundColor),e.boxMessage.fontColor&&isHexaColorValid(e.boxMessage.fontColor)&&(COLOR_MESSAGE.COLOR=e.boxMessage.fontColor)),e.boxDocument&&(e.boxDocument.backgroundColor&&isHexaColorValid(e.boxDocument.backgroundColor)&&(COLOR_BOX_DOCUMENT.BACKGROUND=e.boxDocument.backgroundColor),e.boxDocument.fontColor&&isHexaColorValid(e.boxDocument.fontColor)&&(COLOR_BOX_DOCUMENT.COLOR=e.boxDocument.fontColor)),setConfigurationHtml(e.popupLoadingHtml||""))}function isHexaColorValid(e){return/^#([0-9A-F]{3}){1,2}$/i.test(e)}function verifyBoxCamera(){return null!==document.querySelector("#box-camera")}function verifyCallbackProperties(e){return null!=e&&(e.on&&("function"==typeof e.on.success&&(1===e.on.success.length&&("function"==typeof e.on.error&&(1===e.on.error.length&&("function"==typeof e.on.support&&1===e.on.support.length))))))}function setFaceMode(e){var t;e.optional&&((t=parseInt(e.optional.FACE_MODE))===FACE_MODE_TYPE.FRONT||t===FACE_MODE_TYPE.BACK)?setFaceModeType(t):setFaceModeType(FACE_MODE_TYPE.FRONT)}function verifyTypeCamera(e){return null!=e&&!(!e.TYPE||e.TYPE!==TYPE_CAMERA.CAMERA_NORMAL&&e.TYPE!==TYPE_CAMERA.CAMERA_INTELIGENCE)}function setTypeCamera(e){e.TYPE===TYPE_CAMERA.CAMERA_NORMAL?(setSelfieTypeProcess(TYPE_CAMERA.CAMERA_NORMAL),setSelfieTypeProcessInitial(TYPE_CAMERA.CAMERA_NORMAL),setFaceMode(e)):e.TYPE===TYPE_CAMERA.CAMERA_INTELIGENCE&&(setSelfieTypeProcess(TYPE_CAMERA.CAMERA_INTELIGENCE),setSelfieTypeProcessInitial(TYPE_CAMERA.CAMERA_INTELIGENCE))}function initCamera(e,t,n){if(verifyCallbackProperties(t))if(onCallback=t,verifyBrowserSupport())if(verifyBoxCamera())if(verifyTypeCamera(e))if(e.TYPE!==TYPE_CAMERA.CAMERA_INTELIGENCE||isfaceApiLoaded){try{var r=get$1(1);clearAll(),r&&addManually(r),addTimersInitial(),setLayoutProperties(n),resetProcessVariables(),setTypeCamera(e),setControls(),isLoading=!0,showBoxLoading(),resetVariables()}catch(e){throw add(e),e}callAllMethodsInit()}else onCallback.on.error(getError(CODE_ERROR.ERROR_109));else onCallback.on.error(getError(CODE_ERROR.ERROR_108));else onCallback.on.error(getError(CODE_ERROR.ERROR_107));else browserNotSupportCallback();else{e=getError(CODE_ERROR.ERROR_110);window.console.error(e.type,e)}}function initDocument(e,t,n){if(verifyCallbackProperties(t))if(onCallback=t,verifyBrowserSupport())if(verifyBoxCamera())if(verifyTypeDocument(e)){try{clearAll(),addTimersInitial(),setLayoutProperties(n),resetProcessVariables(),setControls(),isLoading=!0,showBoxLoading(),resetVariables(),setTypeDocument(e)}catch(e){throw add(e),e}callAllMethodsInit()}else onCallback.on.error(getError(CODE_ERROR.ERROR_108));else onCallback.on.error(getError(CODE_ERROR.ERROR_107));else browserNotSupportCallback();else{e=getError(CODE_ERROR.ERROR_110);window.console.error(e.type,e)}}function verifyTypeDocument(e){return null!=e&&!(!e.TYPE||!isDocumentType(e.TYPE))}function addTimersInitial(){add$2(2,"all steps timer",Date.now(),!0),add$2(4,"start camera",Date.now(),!0)}function setTypeDocument(e){isDocumentType(e.TYPE)&&(setDocumentTypeProcess(e.TYPE),TYPE_PROCESS_DOCUMENT===TYPE_DOCUMENT.OTHERS&&setTypeDocumentOthers(e))}function setTypeDocumentOthers(e){LABEL_DOCUMENT_OTHERS=e.optional&&""!==e.optional.LABEL_DOCUMENT_TYPE_OTHERS&&void 0!==e.optional.LABEL_DOCUMENT_TYPE_OTHERS&&null!==e.optional.LABEL_DOCUMENT_TYPE_OTHERS?e.optional.LABEL_DOCUMENT_TYPE_OTHERS:"Outros"}export{closeCamera,initCamera,initDocument,webFrameModel};
//# sourceMappingURL=unico-webframe.min.js.map
